<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PICurv: poisson.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PICurv
   &#160;<span id="projectnumber">0.1.0</span>
   </div>
   <div id="projectbrief">A Parallel Particle-In-Cell Solver for Curvilinear LES</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('poisson_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">poisson.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="poisson_8h_source.html">poisson.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="logging_8h_source.html">logging.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for poisson.c:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c__incl.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
</div>
<p><a href="poisson_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;GhostNodeVelocity&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a846185bb780db2d5f6e9e58c09a08819"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a846185bb780db2d5f6e9e58c09a08819">GridInterpolation</a>(i,  j,  k,  ic,  jc,  kc,  ia,  ja,  ka,  user)</td></tr>
<tr class="separator:a846185bb780db2d5f6e9e58c09a08819"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;GridRestriction&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6594e57d1fff186da0a254a3742dcff7"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>&#160;&#160;&#160;0</td></tr>
<tr class="separator:a6594e57d1fff186da0a254a3742dcff7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb5bf6fbe6405b09bad71e89e1da5850"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>&#160;&#160;&#160;1</td></tr>
<tr class="separator:adb5bf6fbe6405b09bad71e89e1da5850"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2c73b81722187c48d6186148091162fb"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>&#160;&#160;&#160;2</td></tr>
<tr class="separator:a2c73b81722187c48d6186148091162fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab04c88bedc6b2be8ddfe7aa8d3e93f06"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>&#160;&#160;&#160;3</td></tr>
<tr class="separator:ab04c88bedc6b2be8ddfe7aa8d3e93f06"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aecd69d9a67487cc45c38eb184c50538a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>&#160;&#160;&#160;4</td></tr>
<tr class="separator:aecd69d9a67487cc45c38eb184c50538a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af972ebfdd064fdb489daf84443a12f35"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>&#160;&#160;&#160;5</td></tr>
<tr class="separator:af972ebfdd064fdb489daf84443a12f35"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82b271e081de4cfb35eb87b0c13dddba"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>&#160;&#160;&#160;6</td></tr>
<tr class="separator:a82b271e081de4cfb35eb87b0c13dddba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5af9139e882aef6c820ae908589a40d6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>&#160;&#160;&#160;7</td></tr>
<tr class="separator:a5af9139e882aef6c820ae908589a40d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a18bbe716f5be6adbd2150139244c0262"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>&#160;&#160;&#160;8</td></tr>
<tr class="separator:a18bbe716f5be6adbd2150139244c0262"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af9cccf331f045b89a9f12366df5f7687"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>&#160;&#160;&#160;9</td></tr>
<tr class="separator:af9cccf331f045b89a9f12366df5f7687"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4b95e941f44a20ea60512bbe2065f0b6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>&#160;&#160;&#160;10</td></tr>
<tr class="separator:a4b95e941f44a20ea60512bbe2065f0b6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adda1ea75ba8153e72cfb5c87606c55a6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>&#160;&#160;&#160;11</td></tr>
<tr class="separator:adda1ea75ba8153e72cfb5c87606c55a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d0ece5ecf0d2437c47afedee891058c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>&#160;&#160;&#160;12</td></tr>
<tr class="separator:a1d0ece5ecf0d2437c47afedee891058c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaade3232ef08cf18b4f3a20a0a2c6fb6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>&#160;&#160;&#160;13</td></tr>
<tr class="separator:aaade3232ef08cf18b4f3a20a0a2c6fb6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a580a88f98668df1ac5e1683cae31c0b3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>&#160;&#160;&#160;14</td></tr>
<tr class="separator:a580a88f98668df1ac5e1683cae31c0b3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a91c0a910ad7ea895ed9093c9286df2f2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>&#160;&#160;&#160;15</td></tr>
<tr class="separator:a91c0a910ad7ea895ed9093c9286df2f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a78add0c4a98afa82e663ee5cfb1bdc9f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>&#160;&#160;&#160;16</td></tr>
<tr class="separator:a78add0c4a98afa82e663ee5cfb1bdc9f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a051c83d6554c006261a198d0682d84e4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>&#160;&#160;&#160;17</td></tr>
<tr class="separator:a051c83d6554c006261a198d0682d84e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a84909b16209480034c40276c4f84f975"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>&#160;&#160;&#160;18</td></tr>
<tr class="separator:a84909b16209480034c40276c4f84f975"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;Projection&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;UpdatePressure&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;PoissonNullSpaceFunction&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;PoissonLHSNew&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;PoissonRHS&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#ae60511a9aa5cbf216a00a1bb81006bc5">__FUNCT__</a>&#160;&#160;&#160;&quot;PoissonSolver_MG&quot;</td></tr>
<tr class="separator:ae60511a9aa5cbf216a00a1bb81006bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a6046e36e2334fa29a86d652a0b8f0593"><td class="memItemLeft" align="right" valign="top">static PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a6046e36e2334fa29a86d652a0b8f0593">GhostNodeVelocity</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="separator:a6046e36e2334fa29a86d652a0b8f0593"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d538200fed5b9ee9d1ef391bb61036c"><td class="memItemLeft" align="right" valign="top">static PetscInt&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a> (PetscInt i, PetscInt j, PetscInt k, <a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="separator:a3d538200fed5b9ee9d1ef391bb61036c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe58ccf2bd0a359903645f7a0ee76485"><td class="memItemLeft" align="right" valign="top">static PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#afe58ccf2bd0a359903645f7a0ee76485">GridRestriction</a> (PetscInt i, PetscInt j, PetscInt k, PetscInt *ih, PetscInt *jh, PetscInt *kh, <a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="separator:afe58ccf2bd0a359903645f7a0ee76485"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34a113dcc9ca606d914c3d021a4d85fc"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a34a113dcc9ca606d914c3d021a4d85fc">Projection</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a34a113dcc9ca606d914c3d021a4d85fc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Performs the projection step to enforce an incompressible velocity field.  <a href="poisson_8c.html#a34a113dcc9ca606d914c3d021a4d85fc">More...</a><br /></td></tr>
<tr class="separator:a34a113dcc9ca606d914c3d021a4d85fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7cf2cfc0383ba0076f827f7d3856f2ed"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a7cf2cfc0383ba0076f827f7d3856f2ed">UpdatePressure</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a7cf2cfc0383ba0076f827f7d3856f2ed"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the pressure field and handles periodic boundary conditions.  <a href="poisson_8c.html#a7cf2cfc0383ba0076f827f7d3856f2ed">More...</a><br /></td></tr>
<tr class="separator:a7cf2cfc0383ba0076f827f7d3856f2ed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a49aa74e97b8b23d5bb66ac4aec7bb5f9"><td class="memItemLeft" align="right" valign="top">static PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a49aa74e97b8b23d5bb66ac4aec7bb5f9">mymatmultadd</a> (Mat mat, Vec v1, Vec v2)</td></tr>
<tr class="separator:a49aa74e97b8b23d5bb66ac4aec7bb5f9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2648a0c6cafb7916a706cd757e5b92f5"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a2648a0c6cafb7916a706cd757e5b92f5">PoissonNullSpaceFunction</a> (MatNullSpace nullsp, Vec X, void *ctx)</td></tr>
<tr class="memdesc:a2648a0c6cafb7916a706cd757e5b92f5"><td class="mdescLeft">&#160;</td><td class="mdescRight">The callback function for PETSc's MatNullSpace object.  <a href="poisson_8c.html#a2648a0c6cafb7916a706cd757e5b92f5">More...</a><br /></td></tr>
<tr class="separator:a2648a0c6cafb7916a706cd757e5b92f5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa2fc17959230252f30b2278d81a16caf"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#aa2fc17959230252f30b2278d81a16caf">MyInterpolation</a> (Mat A, Vec X, Vec F)</td></tr>
<tr class="memdesc:aa2fc17959230252f30b2278d81a16caf"><td class="mdescLeft">&#160;</td><td class="mdescRight">The callback function for the multigrid interpolation operator (MatShell).  <a href="poisson_8c.html#aa2fc17959230252f30b2278d81a16caf">More...</a><br /></td></tr>
<tr class="separator:aa2fc17959230252f30b2278d81a16caf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a85e1eff3b6e34605b863323d6336eecd"><td class="memItemLeft" align="right" valign="top">static PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a85e1eff3b6e34605b863323d6336eecd">RestrictResidual_SolidAware</a> (Mat A, Vec X, Vec F)</td></tr>
<tr class="separator:a85e1eff3b6e34605b863323d6336eecd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5fa351d4c691fef0d76cedf5cc5cbb72"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a5fa351d4c691fef0d76cedf5cc5cbb72">MyRestriction</a> (Mat A, Vec X, Vec F)</td></tr>
<tr class="memdesc:a5fa351d4c691fef0d76cedf5cc5cbb72"><td class="mdescLeft">&#160;</td><td class="mdescRight">The callback function for the multigrid restriction operator (MatShell).  <a href="poisson_8c.html#a5fa351d4c691fef0d76cedf5cc5cbb72">More...</a><br /></td></tr>
<tr class="separator:a5fa351d4c691fef0d76cedf5cc5cbb72"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a26f0e6321b7ace56b3b105e1eb10475e"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a26f0e6321b7ace56b3b105e1eb10475e">PoissonLHSNew</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a26f0e6321b7ace56b3b105e1eb10475e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Assembles the Left-Hand Side (LHS) matrix for the Pressure Poisson Equation.  <a href="poisson_8c.html#a26f0e6321b7ace56b3b105e1eb10475e">More...</a><br /></td></tr>
<tr class="separator:a26f0e6321b7ace56b3b105e1eb10475e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9340445ae2c0a3c7be290e2a1aea3d67"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a9340445ae2c0a3c7be290e2a1aea3d67">PoissonRHS</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, Vec B)</td></tr>
<tr class="memdesc:a9340445ae2c0a3c7be290e2a1aea3d67"><td class="mdescLeft">&#160;</td><td class="mdescRight">Computes the Right-Hand-Side (RHS) of the Poisson equation, which is the divergence of the intermediate velocity field.  <a href="poisson_8c.html#a9340445ae2c0a3c7be290e2a1aea3d67">More...</a><br /></td></tr>
<tr class="separator:a9340445ae2c0a3c7be290e2a1aea3d67"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34f6242556bffd27f00a84b377c1bf9d"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a34f6242556bffd27f00a84b377c1bf9d">VolumeFlux_rev</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, PetscReal *ibm_Flux, PetscReal *ibm_Area, PetscInt flg)</td></tr>
<tr class="memdesc:a34f6242556bffd27f00a84b377c1bf9d"><td class="mdescLeft">&#160;</td><td class="mdescRight">A specialized version of VolumeFlux, likely for reversed normals.  <a href="poisson_8c.html#a34f6242556bffd27f00a84b377c1bf9d">More...</a><br /></td></tr>
<tr class="separator:a34f6242556bffd27f00a84b377c1bf9d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c4cb4c082ab40cc20db95c962fc1d5c"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a8c4cb4c082ab40cc20db95c962fc1d5c">VolumeFlux</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, PetscReal *ibm_Flux, PetscReal *ibm_Area, PetscInt flg)</td></tr>
<tr class="memdesc:a8c4cb4c082ab40cc20db95c962fc1d5c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the net flux across the immersed boundary surface.  <a href="poisson_8c.html#a8c4cb4c082ab40cc20db95c962fc1d5c">More...</a><br /></td></tr>
<tr class="separator:a8c4cb4c082ab40cc20db95c962fc1d5c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaec10e12d0e5fba6c1f53e47d62b6efe"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#aaec10e12d0e5fba6c1f53e47d62b6efe">FullyBlocked</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="separator:aaec10e12d0e5fba6c1f53e47d62b6efe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0f0addfc422c642ad5eb5315ace4ff2f"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#a0f0addfc422c642ad5eb5315ace4ff2f">MyNvertRestriction</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user_h, <a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user_c)</td></tr>
<tr class="separator:a0f0addfc422c642ad5eb5315ace4ff2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acfdf6d56006b1b5f68d400deb6cf0959"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="poisson_8c.html#acfdf6d56006b1b5f68d400deb6cf0959">PoissonSolver_MG</a> (<a class="el" href="variables_8h.html#structUserMG">UserMG</a> *usermg)</td></tr>
<tr class="memdesc:acfdf6d56006b1b5f68d400deb6cf0959"><td class="mdescLeft">&#160;</td><td class="mdescRight">Solves the pressure-Poisson equation using a geometric multigrid method.  <a href="poisson_8c.html#acfdf6d56006b1b5f68d400deb6cf0959">More...</a><br /></td></tr>
<tr class="separator:acfdf6d56006b1b5f68d400deb6cf0959"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[1/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;GhostNodeVelocity&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a846185bb780db2d5f6e9e58c09a08819"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a846185bb780db2d5f6e9e58c09a08819">&#9670;&nbsp;</a></span>GridInterpolation</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define GridInterpolation</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">i, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">j, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">k, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ic, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">jc, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">kc, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ia, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ja, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ka, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">user&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00798">798</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[2/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;GridRestriction&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a6594e57d1fff186da0a254a3742dcff7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6594e57d1fff186da0a254a3742dcff7">&#9670;&nbsp;</a></span>CP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CP&#160;&#160;&#160;0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00886">886</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="adb5bf6fbe6405b09bad71e89e1da5850"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb5bf6fbe6405b09bad71e89e1da5850">&#9670;&nbsp;</a></span>EP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define EP&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00888">888</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a2c73b81722187c48d6186148091162fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2c73b81722187c48d6186148091162fb">&#9670;&nbsp;</a></span>WP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define WP&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00889">889</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ab04c88bedc6b2be8ddfe7aa8d3e93f06"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab04c88bedc6b2be8ddfe7aa8d3e93f06">&#9670;&nbsp;</a></span>NP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NP&#160;&#160;&#160;3</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00890">890</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="aecd69d9a67487cc45c38eb184c50538a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aecd69d9a67487cc45c38eb184c50538a">&#9670;&nbsp;</a></span>SP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SP&#160;&#160;&#160;4</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00891">891</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="af972ebfdd064fdb489daf84443a12f35"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af972ebfdd064fdb489daf84443a12f35">&#9670;&nbsp;</a></span>TP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TP&#160;&#160;&#160;5</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00892">892</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a82b271e081de4cfb35eb87b0c13dddba"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82b271e081de4cfb35eb87b0c13dddba">&#9670;&nbsp;</a></span>BP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BP&#160;&#160;&#160;6</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00893">893</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a5af9139e882aef6c820ae908589a40d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5af9139e882aef6c820ae908589a40d6">&#9670;&nbsp;</a></span>NE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NE&#160;&#160;&#160;7</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00896">896</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a18bbe716f5be6adbd2150139244c0262"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a18bbe716f5be6adbd2150139244c0262">&#9670;&nbsp;</a></span>SE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SE&#160;&#160;&#160;8</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00897">897</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="af9cccf331f045b89a9f12366df5f7687"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af9cccf331f045b89a9f12366df5f7687">&#9670;&nbsp;</a></span>NW</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NW&#160;&#160;&#160;9</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00898">898</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a4b95e941f44a20ea60512bbe2065f0b6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4b95e941f44a20ea60512bbe2065f0b6">&#9670;&nbsp;</a></span>SW</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SW&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00899">899</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="adda1ea75ba8153e72cfb5c87606c55a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adda1ea75ba8153e72cfb5c87606c55a6">&#9670;&nbsp;</a></span>TN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TN&#160;&#160;&#160;11</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00900">900</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a1d0ece5ecf0d2437c47afedee891058c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1d0ece5ecf0d2437c47afedee891058c">&#9670;&nbsp;</a></span>BN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BN&#160;&#160;&#160;12</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00901">901</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="aaade3232ef08cf18b4f3a20a0a2c6fb6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaade3232ef08cf18b4f3a20a0a2c6fb6">&#9670;&nbsp;</a></span>TS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TS&#160;&#160;&#160;13</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00902">902</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a580a88f98668df1ac5e1683cae31c0b3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a580a88f98668df1ac5e1683cae31c0b3">&#9670;&nbsp;</a></span>BS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BS&#160;&#160;&#160;14</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00903">903</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a91c0a910ad7ea895ed9093c9286df2f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a91c0a910ad7ea895ed9093c9286df2f2">&#9670;&nbsp;</a></span>TE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TE&#160;&#160;&#160;15</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00904">904</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a78add0c4a98afa82e663ee5cfb1bdc9f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a78add0c4a98afa82e663ee5cfb1bdc9f">&#9670;&nbsp;</a></span>BE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BE&#160;&#160;&#160;16</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00905">905</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a051c83d6554c006261a198d0682d84e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a051c83d6554c006261a198d0682d84e4">&#9670;&nbsp;</a></span>TW</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TW&#160;&#160;&#160;17</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00906">906</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="a84909b16209480034c40276c4f84f975"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a84909b16209480034c40276c4f84f975">&#9670;&nbsp;</a></span>BW</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BW&#160;&#160;&#160;18</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00907">907</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[3/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;Projection&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[4/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;UpdatePressure&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[5/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;PoissonNullSpaceFunction&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[6/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;PoissonLHSNew&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[7/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;PoissonRHS&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<a id="ae60511a9aa5cbf216a00a1bb81006bc5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae60511a9aa5cbf216a00a1bb81006bc5">&#9670;&nbsp;</a></span>__FUNCT__ <span class="overload">[8/8]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __FUNCT__&#160;&#160;&#160;&quot;PoissonSolver_MG&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03958">3958</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a6046e36e2334fa29a86d652a0b8f0593"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6046e36e2334fa29a86d652a0b8f0593">&#9670;&nbsp;</a></span>GhostNodeVelocity()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static PetscErrorCode GhostNodeVelocity </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00008">8</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;{</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160; </div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  <span class="comment">// --- CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  <span class="comment">// Get the master simulation context from the UserCtx.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  <a class="code" href="variables_8h.html#structSimCtx">SimCtx</a> *simCtx = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;  <span class="comment">// Create local variables to mirror the legacy globals for minimal code changes.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;  PetscInt wallfunction = simCtx-&gt;<a class="code" href="variables_8h.html#aa60ee4e3f8eca251ee470427f1ebac13">wallfunction</a>;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  <span class="keyword">const</span> PetscInt les = simCtx-&gt;<a class="code" href="variables_8h.html#ad87ed7266a1bc272ab8d4cea4e39d4d2">les</a>;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  <span class="keyword">const</span> PetscInt rans = simCtx-&gt;<a class="code" href="variables_8h.html#a3279024cc316f957e89c05949a1ab441">rans</a>;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  <span class="keyword">const</span> PetscInt ti = simCtx-&gt;<a class="code" href="variables_8h.html#ac9684d6e871566d55c997416270b5b99">step</a>;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;  <span class="keyword">const</span> PetscReal U_bc = simCtx-&gt;<a class="code" href="variables_8h.html#ac12eb831808e07c80a03e393a986f93f">U_bc</a>;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  <span class="comment">// --- END CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;  </div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  DM            da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, fda = user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160; </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  PetscInt  i, j, k;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  PetscInt  lxs, lxe, lys, lye, lzs, lze;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160; </div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a>        ***ubcs, ***ucat,***lucat, ***csi, ***eta, ***zet,***cent;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160; </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160; </div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  PetscReal Un, nx,ny,nz,A;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160; </div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  lxs = xs; lxe = xe;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  lys = ys; lye = ye;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  lzs = zs; lze = ze;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160; </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  PetscInt  gxs, gxe, gys, gye, gzs, gze;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  gxs = info.gxs; gxe = gxs + info.gxm;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  gys = info.gys; gye = gys + info.gym;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  gzs = info.gzs; gze = gzs + info.gzm;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="keywordflow">if</span> (xs==0) lxs = xs+1;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="keywordflow">if</span> (ys==0) lys = ys+1;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="keywordflow">if</span> (zs==0) lzs = zs+1;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="keywordflow">if</span> (xe==mx) lxe = xe-1;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <span class="keywordflow">if</span> (ye==my) lye = ye-1;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keywordflow">if</span> (ze==mz) lze = ze-1;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  PetscFunctionBeginUser;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160; </div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>,  &amp;csi);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>,  &amp;eta);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>,  &amp;zet);</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">/*   WALL FUNCTION */</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keywordflow">if</span> (wallfunction) {</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    PetscReal ***ustar, ***aj, ***nvert;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a58d3237c97d6f16130867370858d5bad">lUstar</a>, &amp;ustar);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>,  &amp;aj);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>,  &amp;nvert);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="comment">// wall function for boundary</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="comment">//Dec 2015</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordflow">if</span>( nvert[k][j][i]&lt;1.1 &amp;&amp; ( (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==-1 &amp;&amp; i==1) || (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==-1 &amp;&amp;  i==mx-2) ) ) {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      <span class="keywordtype">double</span> area = sqrt( csi[k][j][i].x*csi[k][j][i].x + csi[k][j][i].y*csi[k][j][i].y + csi[k][j][i].z*csi[k][j][i].z );</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      <span class="keywordtype">double</span> sb, sc; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;      <span class="keywordtype">double</span> ni[3], nj[3], nk[3];</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> Uc, Ua;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;      </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;      Ua.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = Ua.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = Ua.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;      sb = 0.5/aj[k][j][i]/area;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;      </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      <span class="keywordflow">if</span>(i==1) {</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        sc = 2*sb + 0.5/aj[k][j][i+1]/area;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        Uc = ucat[k][j][i+1];</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;      }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        sc = 2*sb + 0.5/aj[k][j][i-1]/area;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        Uc = ucat[k][j][i-1];</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;      }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;      </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      <a class="code" href="rhs_8h.html#aecbb71daf364f9c5810052e4b9ad1840">CalculateNormalAndArea</a>(csi[k][j][i], eta[k][j][i], zet[k][j][i], ni, nj, nk,NULL,NULL,NULL); <span class="comment">// Passing Null pointers for area calculation.</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      <span class="keywordflow">if</span>(i==mx-2) ni[0]*=-1, ni[1]*=-1, ni[2]*=-1;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;      </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;      <span class="comment">//if(i==1) printf(&quot;%f %f, %f %f %f, %e %e %e, %e\n&quot;, sc, sb, Ua.x, Ua.y, Ua.z, Uc.x, Uc.y, Uc.z, ucat[k][j][i+2].z);</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      <a class="code" href="wallfunction_8h.html#a74ed1b371c557b826d503a1627351eec">wall_function</a> (user, sc, sb, Ua, Uc, &amp;ucat[k][j][i], &amp;ustar[k][j][i], ni[0], ni[1], ni[2]);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      nvert[k][j][i]=1; <span class="comment">/* set nvert to 1 to exclude from rhs */</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      <span class="comment">//      ucat[k][j][i] = lucat[k][j][i];     </span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    }</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">if</span>( nvert[k][j][i]&lt;1.1 &amp;&amp; ( (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==-1 &amp;&amp; j==1) || (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==-1 &amp;&amp;  j==my-2) ) ) {</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      <span class="keywordtype">double</span> area = sqrt( eta[k][j][i].x*eta[k][j][i].x + eta[k][j][i].y*eta[k][j][i].y + eta[k][j][i].z*eta[k][j][i].z );</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      <span class="keywordtype">double</span> sb, sc; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      <span class="keywordtype">double</span> ni[3], nj[3], nk[3];</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;      <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> Uc, Ua;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;      Ua.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = Ua.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = Ua.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      sb = 0.5/aj[k][j][i]/area;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      <span class="keywordflow">if</span>(j==1) {</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        sc = 2*sb + 0.5/aj[k][j+1][i]/area;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        Uc = ucat[k][j+1][i];</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      }</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        sc = 2*sb + 0.5/aj[k][j-1][i]/area;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        Uc = ucat[k][j-1][i];</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;      }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      <a class="code" href="rhs_8h.html#aecbb71daf364f9c5810052e4b9ad1840">CalculateNormalAndArea</a>(csi[k][j][i], eta[k][j][i], zet[k][j][i], ni, nj, nk,NULL,NULL,NULL); <span class="comment">// Passing Null pointers for Area.</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;      <span class="comment">//if(j==my-2) nj[0]*=-1, nj[1]*=-1, nj[2]*=-1;</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;      <a class="code" href="wallfunction_8h.html#a74ed1b371c557b826d503a1627351eec">wall_function</a> (user, sc, sb, Ua, Uc, &amp;ucat[k][j][i], &amp;ustar[k][j][i], nj[0], nj[1], nj[2]);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      nvert[k][j][i]=1; <span class="comment">/* set nvert to 1 to exclude from rhs */</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;      <span class="comment">//      ucat[k][j][i] = lucat[k][j][i];</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    </div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      }</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>,  &amp;aj);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>,  &amp;nvert);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a58d3237c97d6f16130867370858d5bad">lUstar</a>, &amp;ustar);   </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  } <span class="comment">// if wallfunction</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">/*   Driven Cavity  */</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160; </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a77c29afd999c79749fc4a0163da98d2e">Bcs</a>.<a class="code" href="variables_8h.html#a6ef13ed6ab8f82c44bd8a81739ff90e2">Ubcs</a>, &amp;ubcs);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>,  &amp;ucat);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160; </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">/* Designed for driven cavity problem (top(k=kmax) wall moving)</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">   u_x = 1 at k==kmax */</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==2) {</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="keywordflow">if</span> (ze==mz) {</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      k = ze-1;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.;<span class="comment">// - ucat[k-1][j][i].x;</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 1.;<span class="comment">//- ucat[k-1][j][i].y;</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.;<span class="comment">//- ucat[k-1][j][i].z;</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  }</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="comment">/*  ==================================================================================== */</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="comment">/*     Cylinder O-grid */</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="comment">/*  ==================================================================================== */</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==12) {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="comment">/* Designed to test O-grid for flow over a cylinder at jmax velocity is 1 (horizontal) </span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">   u_x = 1 at k==kmax */</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span> (ye==my) {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      j = ye-1;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 1.;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    }</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  }</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">/*  ==================================================================================== */</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">/*     Annulus */</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">/*  ==================================================================================== */</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">/* designed to test periodic boundary condition for c grid j=0 rotates */</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160; </div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==11) {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad744b47ca3c5f3df2d1b737e432d6f07">Cent</a>, &amp;cent); </div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;   <span class="keywordflow">if</span> (ys==0){</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      j=0;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> =cent[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/sqrt(cent[k][j+1][i].x*cent[k][j+1][i].x+cent[k][j+1][i].y*cent[k][j+1][i].y);;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      <span class="comment">// ubcs[k][j][i].x=0.0;</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> =-cent[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/sqrt(cent[k][j+1][i].x*cent[k][j+1][i].x+cent[k][j+1][i].y*cent[k][j+1][i].y);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="comment">// ubcs[k][j][i].y = -cent[k][j+1][i].z/sqrt(cent[k][j+1][i].z*cent[k][j+1][i].z+cent[k][j+1][i].y*cent[k][j+1][i].y);</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.0;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="comment">// ubcs[k][j][i].z =cent[k][j+1][i].y/sqrt(cent[k][j+1][i].z*cent[k][j+1][i].z+cent[k][j+1][i].y*cent[k][j+1][i].y);</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    }</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;   DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad744b47ca3c5f3df2d1b737e432d6f07">Cent</a>,  &amp;cent);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  }</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160; </div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">/*   SYMMETRY BC */</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==3) {</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">if</span> (xs==0) {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    i= xs;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    A=sqrt(csi[k][j][i].z*csi[k][j][i].z +</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;           csi[k][j][i].y*csi[k][j][i].y +</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;           csi[k][j][i].x*csi[k][j][i].x);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    nx=csi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/A;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    ny=csi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/A;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    nz=csi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>/A;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    Un=ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>*nx+ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>*ny+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>*nz;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>-Un*nx;<span class="comment">//-V_frame.x;</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>-Un*ny;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>-Un*nz;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;      }</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    }</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  }</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==3) {</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">if</span> (xe==mx) {</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    i= xe-1;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    A=sqrt(csi[k][j][i-1].z*csi[k][j][i-1].z +</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;           csi[k][j][i-1].y*csi[k][j][i-1].y +</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;           csi[k][j][i-1].x*csi[k][j][i-1].x);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    nx=csi[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/A;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    ny=csi[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/A;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    nz=csi[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>/A;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    Un=ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>*nx+ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>*ny+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>*nz;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>-Un*nx;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>-Un*ny;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>-Un*nz;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;      }</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    }</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  }</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==3) {</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">if</span> (ys==0) {</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    j= ys;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    A=sqrt(eta[k][j][i].z*eta[k][j][i].z +</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;           eta[k][j][i].y*eta[k][j][i].y +</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;           eta[k][j][i].x*eta[k][j][i].x);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    nx=eta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/A;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    ny=eta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/A;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    nz=eta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>/A;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    Un=ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>*nx+ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>*ny+ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>*nz;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>-Un*nx;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>-Un*ny;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>-Un*nz;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      }</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    }</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  }</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==3) {</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">if</span> (ye==my) {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    j=ye-1;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    A=sqrt(eta[k][j-1][i].z*eta[k][j-1][i].z +</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;           eta[k][j-1][i].y*eta[k][j-1][i].y +</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;           eta[k][j-1][i].x*eta[k][j-1][i].x);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    nx=eta[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/A;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    ny=eta[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/A;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    nz=eta[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>/A;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    Un=ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>*nx+ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>*ny+ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>*nz;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>-Un*nx;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>-Un*ny;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>-Un*nz;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;      }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    }</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    }</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  }</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160; </div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==3) {</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">if</span> (zs==0) {</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      k = 0;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {  </div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    A=sqrt(zet[k][j][i].z*zet[k][j][i].z +</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;           zet[k][j][i].y*zet[k][j][i].y +</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;           zet[k][j][i].x*zet[k][j][i].x);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    nx=zet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/A;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    ny=zet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/A;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    nz=zet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>/A;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    Un=ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>*nx+ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>*ny+ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>*nz;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>-Un*nx;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>-Un*ny;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>-Un*nz;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    }</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;      }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    }</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  }</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160; </div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==3) {</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">if</span> (ze==mz) {</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      k = ze-1;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {  </div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    A=sqrt(zet[k-1][j][i].z*zet[k-1][j][i].z +</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;           zet[k-1][j][i].y*zet[k-1][j][i].y +</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;           zet[k-1][j][i].x*zet[k-1][j][i].x);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    nx=zet[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>/A;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    ny=zet[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>/A;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    nz=zet[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>/A;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    Un=ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>*nx+ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>*ny+ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>*nz;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>-Un*nx;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>-Un*ny;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>-Un*nz;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    }</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      }</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    }</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  }</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">/*  ==================================================================================== */</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  <span class="comment">/*     Rheology */</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  <span class="comment">/*  ==================================================================================== */</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  <span class="comment">// PetscPrintf(PETSC_COMM_WORLD, &quot;moving plate velocity for rheology setup is %le \n&quot;,U_bc);</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==13){</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keywordflow">if</span> (ys==0){</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      j=0;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      <span class="comment">//ubcs[k][j][i].x = -U_bc;</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> =-U_bc;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;       <span class="comment">//ubcs[k][j][i].z =0.0;</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      }</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    }</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  }</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==13){</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">if</span> (ye==my){</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      j=ye-1;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      <span class="comment">//ubcs[k][j][i].x = U_bc;</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = U_bc;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      <span class="comment">//ubcs[k][j][i].z =0.0;</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    }</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;      }</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    }</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  }</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==13){</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">if</span> (zs==0){</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      k=0;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> =-U_bc;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    }</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;      }</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  }</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==13){</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keywordflow">if</span> (ze==mz){</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      k=ze-1;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = U_bc;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;      ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    }</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      }</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    }</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  }</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="comment">// boundary conditions on ghost nodes</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">//Mohsen Aug 2012</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="keywordflow">if</span> (xs==0 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7) {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    i = xs;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> - ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> - ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> - ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    }</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordflow">if</span> (xe==mx &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7) {</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    i = xe-1;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> - ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> - ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> - ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;      }</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    }</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keywordflow">if</span> (ys==0 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) {</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    j = ys;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> - ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> - ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> - ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      }</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  }</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160; </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="keywordflow">if</span> (ye==my &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    j = ye-1;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> - ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> - ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> - ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    }</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keywordflow">if</span> (zs==0 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) {</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    k = zs;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> - ucat[k+1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> - ucat[k+1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> - ucat[k+1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      }</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    }</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  }</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; </div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordflow">if</span> (ze==mz &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) {</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    k = ze-1;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> - ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> - ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 2 * ubcs[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> - ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      }</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    }</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  }</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a77c29afd999c79749fc4a0163da98d2e">Bcs</a>.<a class="code" href="variables_8h.html#a6ef13ed6ab8f82c44bd8a81739ff90e2">Ubcs</a>, &amp;ubcs);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>,&amp;ucat);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">/*   Periodic BC Mohsen Aug 2012</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">/* ==================================================================================             */</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160; </div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 ||  user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 ){</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160; </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;   </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==7){</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      <span class="keywordflow">if</span> (xs==0){</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    i=xs;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="keywordflow">if</span>(k&gt;0 &amp;&amp; k&lt;user-&gt;KM &amp;&amp; j&gt;0 &amp;&amp; j&lt;user-&gt;JM){</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;          ucat[k][j][i]=lucat[k][j][i-2];</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        }</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      }</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    }</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;      }</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==7){</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      <span class="keywordflow">if</span> (ys==0){</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    j=ys;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="keywordflow">if</span>(k&gt;0 &amp;&amp; k&lt;user-&gt;KM &amp;&amp; i&gt;0 &amp;&amp; i&lt;user-&gt;IM){</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;          ucat[k][j][i]=lucat[k][j-2][i];</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        }</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;      }</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    }</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;      }</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    }</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==7){</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      <span class="keywordflow">if</span> (zs==0){</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    k=zs;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="keywordflow">if</span>(j&gt;0 &amp;&amp; j&lt;user-&gt;JM &amp;&amp; i&gt;0 &amp;&amp; i&lt;user-&gt;IM){</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;          ucat[k][j][i]=lucat[k-2][j][i];</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;      }</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    }</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==7){</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      <span class="keywordflow">if</span> (xe==mx){</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    i=mx-1;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="keywordflow">if</span>(k&gt;0 &amp;&amp; k&lt;user-&gt;KM &amp;&amp; j&gt;0 &amp;&amp; j&lt;user-&gt;JM){</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;          ucat[k][j][i]=lucat[k][j][i+2];</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        }</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      }</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    }</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;      }</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==7){</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      <span class="keywordflow">if</span> (ye==my){</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    j=my-1;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="keywordflow">if</span>(k&gt;0 &amp;&amp; k&lt;user-&gt;KM &amp;&amp; i&gt;0 &amp;&amp; i&lt;user-&gt;IM){</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        ucat[k][j][i]=lucat[k][j+2][i];</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        }</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;      }</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    }</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      }</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    }</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==7){</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      <span class="keywordflow">if</span> (ze==mz){</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    k=mz-1;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">if</span>(j&gt;0 &amp;&amp; j&lt;user-&gt;JM &amp;&amp; i&gt;0 &amp;&amp; i&lt;user-&gt;IM){</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;          ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>=lucat[k+2][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        }</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    }</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; </div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  }</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160; </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  <span class="comment">// velocity on the corner point</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>,  &amp;ucat);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160; </div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  <span class="keywordflow">if</span> (zs==0 ) {</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    k=0;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordflow">if</span> (xs==0) {</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      i=0;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      }</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    }</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordflow">if</span> (xe == mx) {</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      i=mx-1;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      }</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160; </div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordflow">if</span> (ys==0) {</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      j=0;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;      }</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    }</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160; </div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordflow">if</span> (ye==my) {</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;      j=my-1;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k+1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;      }</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    }</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  }</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160; </div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordflow">if</span> (ze==mz) {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    k=mz-1;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">if</span> (xs==0) {</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      i=0;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      }</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    }</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="keywordflow">if</span> (xe == mx) {</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      i=mx-1;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      }</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    }</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">if</span> (ys==0) {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      j=0;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      }</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    }</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160; </div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="keywordflow">if</span> (ye==my) {</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      j=my-1;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k-1][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      }</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    }</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  }</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160; </div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="keywordflow">if</span> (ys==0) {</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    j=0;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keywordflow">if</span> (xs==0) {</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;      i=0;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;      <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      }</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    }</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160; </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">if</span> (xe==mx) {</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      i=mx-1;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k][j+1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k][j+1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k][j+1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      }</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    }</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  }</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160; </div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="keywordflow">if</span> (ye==my) {</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    j=my-1;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">if</span> (xs==0) {</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      i=0;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i+1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;      }</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    }</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160; </div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keywordflow">if</span> (xe==mx) {</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;      i=mx-1;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;      <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = 0.5*(ucat[k][j-1][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>);</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = 0.5*(ucat[k][j-1][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>);</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    ucat[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = 0.5*(ucat[k][j-1][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>+ucat[k][j][i-1].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;      }</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    }</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  }</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160; </div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>,  &amp;ucat);</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160; </div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 ||  user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 ){</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="comment">//i-direction</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7){</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;      <span class="keywordflow">if</span> (xs==0){</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    i=xs;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        ucat[k][j][i]=lucat[k][j][i-2];</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;      }</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    }</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;      }</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    }</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==7){</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;      <span class="keywordflow">if</span> (xe==mx){</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    i=xe-1;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        ucat[k][j][i]=lucat[k][j][i+2];</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;      }</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    }</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;      }</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    }</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160; </div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160; </div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;  <span class="comment">//j-direction</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  </div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160; </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7){</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;      <span class="keywordflow">if</span> (ys==0){</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    j=ys;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        ucat[k][j][i]=lucat[k][j-2][i];</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;      }</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    }</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      }</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    }</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  </div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==7){</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;      <span class="keywordflow">if</span> (ye==my){</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    j=my-1;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;      ucat[k][j][i]=lucat[k][j+2][i];</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      }</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;      }</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    }</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  </div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160; </div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160; </div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="comment">//k-direction</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  </div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160; </div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7){</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;      <span class="keywordflow">if</span> (zs==0){</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    k=zs;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;      ucat[k][j][i]=lucat[k-2][j][i];</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      }</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    }</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;      }</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    }</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==7){</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;      <span class="keywordflow">if</span> (ze==mz){</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    k=mz-1;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        ucat[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>=lucat[k+2][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      }</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    }</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      }</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    }</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;   </div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>, &amp;lucat);</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, &amp;ucat);</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160; </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(fda, user-&gt;lUcat, INSERT_VALUES, user-&gt;Ucat); */</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160; </div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#aa1823d873982755996b7335f43732af4">Ucat</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">lUcat</a>);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  }</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160; </div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>,  &amp;csi);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>,  &amp;eta);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>,  &amp;zet);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  </div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a6046e36e2334fa29a86d652a0b8f0593_cgraph.svg" width="635" height="88"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a6046e36e2334fa29a86d652a0b8f0593_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a3d538200fed5b9ee9d1ef391bb61036c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d538200fed5b9ee9d1ef391bb61036c">&#9670;&nbsp;</a></span>Gidx()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static PetscInt Gidx </td>
          <td>(</td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00833">833</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;{</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  PetscInt nidx;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160; </div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  PetscInt  mx = info.mx, my = info.my;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  AO ao;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  DMDAGetAO(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, &amp;ao);</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  nidx=i+j*mx+k*mx*my;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  </div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  AOApplicationToPetsc(ao,1,&amp;nidx);</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  </div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <span class="keywordflow">return</span> (nidx);</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a3d538200fed5b9ee9d1ef391bb61036c_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="afe58ccf2bd0a359903645f7a0ee76485"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe58ccf2bd0a359903645f7a0ee76485">&#9670;&nbsp;</a></span>GridRestriction()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static PetscErrorCode GridRestriction </td>
          <td>(</td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>ih</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>jh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>kh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00853">853</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;{</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  PetscFunctionBeginUser;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a03772da847da737415fd5a86a97147bd">isc</a>)) {</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    *ih = i;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;  }</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    *ih = 2 * i;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  }</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160; </div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a5fd8588302a68eca03d086e01e8972c1">jsc</a>)) {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    *jh = j;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  }</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    *jh = 2 * j;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  }</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160; </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a3e8bcd710c619c329608b6f7da5f1ea1">ksc</a>)) {</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    *kh = k;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    *kh = 2 * k;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;  }</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160; </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_afe58ccf2bd0a359903645f7a0ee76485_icgraph.svg" width="100%" height="404"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a34a113dcc9ca606d914c3d021a4d85fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34a113dcc9ca606d914c3d021a4d85fc">&#9670;&nbsp;</a></span>Projection()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode Projection </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Performs the projection step to enforce an incompressible velocity field. </p>
<p>Corrects the contravariant velocity field <code>Ucont</code> to be divergence-free using the gradient of the pressure correction field <code>Phi</code>.</p>
<p>This function executes the final "correction" stage of a fractional-step (projection) method for solving the incompressible Navier-Stokes equations. After solving the Pressure Poisson Equation to get a pressure correction <code>Phi</code>, this function uses <code>Phi</code> to correct the intermediate velocity field, making it divergence-free.</p>
<p>The main steps are:</p><ol type="1">
<li><b>Calculate Pressure Gradient</b>: At each velocity point (on the cell faces), it computes the gradient of the pressure correction field (<code></code>). This is done using finite differences on a generalized curvilinear grid.</li>
<li><b>Correct Velocity Field</b>: It updates the contravariant velocity components <code>Ucont</code> by subtracting the scaled pressure gradient. The update rule is: <code>U_new = U_intermediate - t * G * </code>, where <code>G</code> is the metric tensor <code>g_ij</code> that transforms the gradient into contravariant components.</li>
<li><b>Boundary-Aware Gradients</b>: The gradient calculation is highly sensitive to boundaries. The code uses complex, dynamic stencils that switch from centered differences to one-sided differences if a standard stencil would use a point inside an immersed solid (<code>nvert &gt; 0.1</code>). This preserves accuracy at the fluid-solid interface.</li>
<li><b>Periodic Boundary Updates</b>: Includes dedicated loops to correctly calculate the pressure gradient at the domain edges for periodic boundary conditions.</li>
<li><b>Finalization</b>: After correcting <code>Ucont</code>, it calls helper functions to convert the velocity back to Cartesian coordinates (<code>Contra2Cart</code>) and update all ghost cell values.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> struct, containing simulation context, grid metrics, and the velocity/pressure fields.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l00948">948</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;{</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  PetscFunctionBeginUser;</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;  </div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Entering Projection step to correct velocity field.\n&quot;</span>);</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160; </div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  <span class="comment">// Section 1: Initialization and Data Acquisition</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160; </div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="comment">// --- Get simulation and grid context ---</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <a class="code" href="variables_8h.html#structSimCtx">SimCtx</a> *simCtx = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>;</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  DM da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, fda = user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160; </div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <span class="comment">// --- Grid dimensions ---</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;  PetscInt mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  PetscInt xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  PetscInt ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  PetscInt zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160; </div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;  <span class="comment">// --- Loop bounds (excluding outer ghost layers) ---</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;  PetscInt lxs = (xs == 0) ? xs + 1 : xs;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  PetscInt lxe = (xe == mx) ? xe - 1 : xe;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  PetscInt lys = (ys == 0) ? ys + 1 : ys;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  PetscInt lye = (ye == my) ? ye - 1 : ye;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  PetscInt lzs = (zs == 0) ? zs + 1 : zs;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  PetscInt lze = (ze == mz) ? ze - 1 : ze;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160; </div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  <span class="comment">// --- Get direct pointer access to grid metric and field data ---</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;  <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> ***icsi, ***ieta, ***izet, ***jcsi, ***jeta, ***jzet, ***kcsi, ***keta, ***kzet;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  PetscReal ***iaj, ***jaj, ***kaj, ***p, ***nvert;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> ***ucont;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#acbf784310453bd7aec02838cdef24a66">lICsi</a>, &amp;icsi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2276cb159119246bfadea1c234dee31b">lIEta</a>, &amp;ieta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2db602ea5fce7cec91f19f507f922a74">lIZet</a>, &amp;izet);</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a63b70d5ad8338013a2888928d4106f63">lJCsi</a>, &amp;jcsi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a96938d329a797441f228ecddd8e8e607">lJEta</a>, &amp;jeta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ab7a460d0a7eaa2d76d0b6267310c3184">lJZet</a>, &amp;jzet);</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa0f10efbfba88094aa07cee1cdb0baff">lKCsi</a>, &amp;kcsi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a508de73c1c5929cbee04a94091f2799e">lKEta</a>, &amp;keta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a8e6283b2989fae5d0a235baa570e929f">lKZet</a>, &amp;kzet);</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a4d561e219e8bc40951d121cce66d93ce">lIAj</a>, &amp;iaj); DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#ae8527c7cba1c5764994053481722eb01">lJAj</a>, &amp;jaj); DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#aee8a3f32f3bdc0dda2f862651708c0f4">lKAj</a>, &amp;kaj);</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>, &amp;p); <span class="comment">// Note: using lPhi, which is the pressure correction</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;  <span class="comment">//DMDAVecGetArray(da,user-&gt;lP,&amp;p);</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucont);</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160; </div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;  <span class="comment">// --- Constants for clarity ---</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  <span class="keyword">const</span> PetscReal IBM_FLUID_THRESHOLD = 0.1;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  <span class="keyword">const</span> PetscReal scale = simCtx-&gt;<a class="code" href="variables_8h.html#a53b044b8b0e4a4dc8c8fa05387af564c">dt</a> * simCtx-&gt;<a class="code" href="variables_8h.html#a3ff353812541b8ebba309e8d3ba6674b">st</a> / <a class="code" href="variables_8h.html#af0af02fbd08daea87f3523a3754981f0">COEF_TIME_ACCURACY</a>;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160; </div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; Starting velocity correction: Scale = %le .\n&quot;</span>,scale);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160; </div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <span class="comment">// Section 2: Correct Velocity Components</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Calculating pressure gradients and correcting velocity components.\n&quot;</span>);</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  </div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  <span class="comment">// --- Main loop over interior domain points ---</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  <span class="keywordflow">for</span> (PetscInt k = lzs; k &lt; lze; k++) {</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="keywordflow">for</span> (PetscInt j = lys; j &lt; lye; j++) {</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;      <span class="keywordflow">for</span> (PetscInt i = lxs; i &lt; lxe; i++) {</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160; </div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="comment">// --- Correct U_contravariant (x-component of velocity) ---</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        PetscInt i_end = (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0] == 7) ? mx - 1 : mx - 2;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="keywordflow">if</span> (i &lt; i_end) {</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;      </div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;          <span class="keywordflow">if</span> (!(nvert[k][j][i] &gt; IBM_FLUID_THRESHOLD || nvert[k][j][i + 1] &gt; IBM_FLUID_THRESHOLD)) {</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;            <span class="comment">// Compute pressure derivatives (dp/d_csi, dp/d_eta, dp/d_zet) at the i-face</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160; </div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        PetscReal dpdc = p[k][j][i + 1] - p[k][j][i];</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            PetscReal dpde = 0.0, dpdz = 0.0;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160; </div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;            <span class="comment">// Boundary-aware stencil for dp/d_eta</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;          <span class="keywordflow">if</span> ((j==my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j+1][i]+nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i+1] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;          dpde = (p[k][j][i] + p[k][j][i+1] -</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;              p[k][j-1][i] - p[k][j-1][i+1]) * 0.5;</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        }</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;          }</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j==my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i]+nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i+1] &lt; 0.1) { dpde = (p[k][j][i] + p[k][j][i+1] - p[k][j-1][i] - p[k][j-1][i+1]) * 0.5; }</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;          }</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160; </div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) || nvert[k][j-1][i] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i+1] &lt; 0.1) { dpde = (p[k][j+1][i] + p[k][j+1][i+1] - p[k][j][i] - p[k][j][i+1]) * 0.5; }</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;          }</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160; </div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i+1] &lt; 0.1) { dpde = (p[k][j+1][i] + p[k][j+1][i+1] - p[k][j][i] - p[k][j][i+1]) * 0.5; }</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          }</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160; </div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;          <span class="keywordflow">else</span> { dpde = (p[k][j+1][i] + p[k][j+1][i+1] - p[k][j-1][i] - p[k][j-1][i+1]) * 0.25; }</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160; </div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;            <span class="comment">// Boundary-aware stencil for dp/d_zet</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;          <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) || nvert[k+1][j][i] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i+1] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) { dpdz = (p[k][j][i] + p[k][j][i+1] - p[k-1][j][i] - p[k-1][j][i+1]) * 0.5; }</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;          }</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160; </div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;          <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ((k == mz-2 || k==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i+1] &lt; 0.1) { dpdz = (p[k][j][i] + p[k][j][i+1] - p[k-1][j][i] - p[k-1][j][i+1]) * 0.5; }</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;          }</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160; </div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k-1][j][i] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i+1] &lt; 0.1) { dpdz = (p[k+1][j][i] + p[k+1][j][i+1] - p[k][j][i] - p[k][j][i+1]) * 0.5; }</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;          }</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i+1] &lt; 0.1) { dpdz = (p[k+1][j][i] + p[k+1][j][i+1] - p[k][j][i] - p[k][j][i+1]) * 0.5; }</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;          }</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160; </div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;          <span class="keywordflow">else</span> { dpdz = (p[k+1][j][i] + p[k+1][j][i+1] - p[k-1][j][i] - p[k-1][j][i+1]) * 0.25; }</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160; </div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;            <span class="comment">// Apply the correction: U_new = U_old - dt * (g11*dpdc + g12*dpde + g13*dpdz)</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160; </div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;            </div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;          </div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;            PetscReal grad_p_x = (dpdc * (icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                      + icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i] +</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                                dpde * (ieta[k][j][i].x * icsi[k][j][i].x + ieta[k][j][i].y * icsi[k][j][i].y</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                    + ieta[k][j][i].z * icsi[k][j][i].z) * iaj[k][j][i] +</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                                dpdz * (izet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + izet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                    + izet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i]);</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160; </div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        PetscReal correction = grad_p_x*scale;</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        <span class="comment">//LOG_LOOP_ALLOW_EXACT(GLOBAL,LOG_DEBUG,k,5,&quot; Flux correction in Csi Direction: %le.\n&quot;,correction);</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        ucont[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> -= correction;</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160; </div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;          }</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        }</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160; </div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        <span class="comment">// --- Correct V_contravariant (y-component of velocity) ---</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        PetscInt j_end = (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2] == 7) ? my - 1 : my - 2;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        <span class="keywordflow">if</span> (j &lt; j_end) {</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;          <span class="keywordflow">if</span> (!(nvert[k][j][i] &gt; IBM_FLUID_THRESHOLD || nvert[k][j + 1][i] &gt; IBM_FLUID_THRESHOLD)) {</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            PetscReal dpdc = 0.0, dpde = 0.0, dpdz = 0.0;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            dpde = p[k][j + 1][i] - p[k][j][i];</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160; </div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;            <span class="comment">// Boundary-aware stencil for dp/d_csi</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;          <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7) || nvert[k][j][i+1] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j+1][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) { dpdc = (p[k][j][i] + p[k][j+1][i] - p[k][j][i-1] - p[k][j+1][i-1]) * 0.5; }</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j+1][i-1] &lt; 0.1) { dpdc = (p[k][j][i] + p[k][j+1][i] - p[k][j][i-1] - p[k][j+1][i-1]) * 0.5; }</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j+1][i+1] &lt; 0.1) { dpdc = (p[k][j][i+1] + p[k][j+1][i+1] - p[k][j][i] - p[k][j+1][i]) * 0.5; }</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j+1][i+1] &lt; 0.1) { dpdc = (p[k][j][i+1] + p[k][j+1][i+1] - p[k][j][i] - p[k][j+1][i]) * 0.5; }</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;          } <span class="keywordflow">else</span> { dpdc = (p[k][j][i+1] + p[k][j+1][i+1] - p[k][j][i-1] - p[k][j+1][i-1]) * 0.25; }</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160; </div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;            <span class="comment">// Boundary-aware stencil for dp/d_zet</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;          <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k+1][j][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j+1][i] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) { dpdz = (p[k][j][i] + p[k][j+1][i] - p[k-1][j][i] - p[k-1][j+1][i]) * 0.5; }</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == mz-2 || k==1 ) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j+1][i] &lt; 0.1) { dpdz = (p[k][j][i] + p[k][j+1][i] - p[k-1][j][i] - p[k-1][j+1][i]) * 0.5; }</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k-1][j][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j+1][i] &lt; 0.1) { dpdz = (p[k+1][j][i] + p[k+1][j+1][i] - p[k][j][i] - p[k][j+1][i]) * 0.5; }</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j+1][i] &lt; 0.1) { dpdz = (p[k+1][j][i] + p[k+1][j+1][i] - p[k][j][i] - p[k][j+1][i]) * 0.5; }</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;          } <span class="keywordflow">else</span> { dpdz = (p[k+1][j][i] + p[k+1][j+1][i] - p[k-1][j][i] - p[k-1][j+1][i]) * 0.25; }</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160; </div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            PetscReal grad_p_y = (dpdc * (jcsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + jcsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + jcsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i] +</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                                dpde * (jeta[k][j][i].x * jeta[k][j][i].x + jeta[k][j][i].y * jeta[k][j][i].y + jeta[k][j][i].z * jeta[k][j][i].z) * jaj[k][j][i] +</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                                dpdz * (jzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + jzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + jzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i]);</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160; </div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        PetscReal correction = grad_p_y*scale;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        <span class="comment">//LOG_LOOP_ALLOW_EXACT(GLOBAL,LOG_DEBUG,k,5,&quot; Flux correction in Eta Direction: %le.\n&quot;,correction);</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;            ucont[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> -= correction;</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;          }</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        }</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        </div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        <span class="comment">// --- Correct W_contravariant (z-component of velocity) ---</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        PetscInt k_end = (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4] == 7) ? mz - 1 : mz - 2;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        <span class="keywordflow">if</span> (k &lt; k_end) {</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;          <span class="keywordflow">if</span> (!(nvert[k][j][i] &gt; IBM_FLUID_THRESHOLD || nvert[k + 1][j][i] &gt; IBM_FLUID_THRESHOLD)) {</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            PetscReal dpdc = 0.0, dpde = 0.0, dpdz = 0.0;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            dpdz = p[k + 1][j][i] - p[k][j][i];</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;            </div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;            <span class="comment">// Boundary-aware stencil for dp/d_csi</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;          <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i+1] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k+1][j][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) { dpdc = (p[k][j][i] + p[k+1][j][i] - p[k][j][i-1] - p[k+1][j][i-1]) * 0.5; }</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k+1][j][i-1] &lt; 0.1) { dpdc = (p[k][j][i] + p[k+1][j][i] - p[k][j][i-1] - p[k+1][j][i-1]) * 0.5; }</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k+1][j][i+1] &lt; 0.1) { dpdc = (p[k][j][i+1] + p[k+1][j][i+1] - p[k][j][i] - p[k+1][j][i]) * 0.5; }</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k+1][j][i+1] &lt; 0.1) { dpdc = (p[k][j][i+1] + p[k+1][j][i+1] - p[k][j][i] - p[k+1][j][i]) * 0.5; }</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;          } <span class="keywordflow">else</span> { dpdc = (p[k][j][i+1] + p[k+1][j][i+1] - p[k][j][i-1] - p[k+1][j][i-1]) * 0.25; }</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160; </div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;            <span class="comment">// Boundary-aware stencil for dp/d_eta</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;          <span class="keywordflow">if</span> ((j == my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j+1][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k+1][j-1][i] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) { dpde = (p[k][j][i] + p[k+1][j][i] - p[k][j-1][i] - p[k+1][j-1][i]) * 0.5; }</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;          } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ((j == my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k+1][j-1][i] &lt; 0.1) { dpde = (p[k][j][i] + p[k+1][j][i] - p[k][j-1][i] - p[k+1][j-1][i]) * 0.5; }</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j-1][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k+1][j+1][i] &lt; 0.1) { dpde = (p[k][j+1][i] + p[k+1][j+1][i] - p[k][j][i] - p[k+1][j][i]) * 0.5; }</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k+1][j+1][i] &lt; 0.1) { dpde = (p[k][j+1][i] + p[k+1][j+1][i] - p[k][j][i] - p[k+1][j][i]) * 0.5; }</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;          } <span class="keywordflow">else</span> { dpde = (p[k][j+1][i] + p[k+1][j+1][i] - p[k][j-1][i] - p[k+1][j-1][i]) * 0.25; }</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160; </div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;            PetscReal grad_p_z = (dpdc * (kcsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + kcsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + kcsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i] +</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;                                dpde * (keta[k][j][i].x * kzet[k][j][i].x + keta[k][j][i].y * kzet[k][j][i].y + keta[k][j][i].z * kzet[k][j][i].z) * kaj[k][j][i] +</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;                                dpdz * (kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i]);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160; </div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <span class="comment">// ========================= DEBUG PRINT  =========================</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        <a class="code" href="logging_8h.html#aa987297fa072943c2409f3b2cc4e31f9">LOG_LOOP_ALLOW_EXACT</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, k, 5,</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                 <span class="stringliteral">&quot;[k=%d, j=%d, i=%d] ---- Neighbor Pressures ----\n&quot;</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;                 <span class="stringliteral">&quot;  Central Z-Neighbors: p[k+1][j][i] = %g | p[k][j][i] = %g\n&quot;</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                 <span class="stringliteral">&quot;  Eta-Stencil (Y-dir): p[k][j-1][i] = %g, p[k+1][j-1][i] = %g | p[k][j+1][i] = %g, p[k+1][j+1][i] = %g\n&quot;</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                 <span class="stringliteral">&quot;  Csi-Stencil (X-dir): p[k][j][i-1] = %g, p[k+1][j][i-1] = %g | p[k][j][i+1] = %g, p[k+1][j][i+1] = %g\n&quot;</span>,</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                 k, j, i,</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                 p[k + 1][j][i], p[k][j][i],</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;                 p[k][j - 1][i], p[k + 1][j - 1][i], p[k][j + 1][i], p[k + 1][j + 1][i],</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;                 p[k][j][i - 1], p[k + 1][j][i - 1], p[k][j][i + 1], p[k + 1][j][i + 1]);</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        <span class="comment">// ======================= END DEBUG PRINT =======================</span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160; </div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        <a class="code" href="logging_8h.html#aa987297fa072943c2409f3b2cc4e31f9">LOG_LOOP_ALLOW_EXACT</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,k,5,<span class="stringliteral">&quot; dpdc: %le | dpde: %le | dpdz: %le.\n&quot;</span>,dpdc,dpde,dpdz);      </div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        PetscReal correction = grad_p_z*scale;</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <span class="comment">//LOG_LOOP_ALLOW_EXACT(GLOBAL,LOG_DEBUG,k,5,&quot; Flux correction in Zet Direction: %le.\n&quot;,correction);</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;            ucont[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> -= correction;</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;          }</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        }</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      }</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    }</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  }</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160; </div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <span class="comment">// --- Explicit correction for periodic boundaries (if necessary) ---</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="comment">// The main loop handles the interior, but this handles the first physical layer at periodic boundaries.</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="comment">// Note: This logic is largely duplicated from the main loop and could be merged, but is preserved for fidelity.</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0] == 7 &amp;&amp; xs == 0) {</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;    <span class="keywordflow">for</span> (PetscInt k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;      <span class="keywordflow">for</span> (PetscInt j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    PetscInt i=xs;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    </div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    PetscReal dpdc = p[k][j][i+1] - p[k][j][i];</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    </div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    PetscReal dpde = 0.;</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    PetscReal dpdz = 0.;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;        </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="keywordflow">if</span> ((j==my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j+1][i]+nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i+1] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        dpde = (p[k][j  ][i] + p[k][j  ][i+1] -</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;            p[k][j-1][i] - p[k][j-1][i+1]) * 0.5;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;      }</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    }</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j==my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i]+nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        dpde = (p[k][j  ][i] + p[k][j  ][i+1] -</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;            p[k][j-1][i] - p[k][j-1][i+1]) * 0.5;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;      }</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    }</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) || nvert[k][j-1][i] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        dpde = (p[k][j+1][i] + p[k][j+1][i+1] -</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            p[k][j  ][i] - p[k][j  ][i+1]) * 0.5;</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;      }</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    }</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        dpde = (p[k][j+1][i] + p[k][j+1][i+1] -</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            p[k][j  ][i] - p[k][j  ][i+1]) * 0.5;</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      }</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    }</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;      dpde = (p[k][j+1][i] + p[k][j+1][i+1] -</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;          p[k][j-1][i] - p[k][j-1][i+1]) * 0.25;</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    }</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    </div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) || nvert[k+1][j][i] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i+1] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) {</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        dpdz = (p[k  ][j][i] + p[k  ][j][i+1] -</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;            p[k-1][j][i] - p[k-1][j][i+1]) * 0.5;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;      }</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    }</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ((k == mz-2 || k==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;      <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        dpdz = (p[k  ][j][i] + p[k  ][j][i+1] -</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;            p[k-1][j][i] - p[k-1][j][i+1]) * 0.5;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;      }</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    }</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k-1][j][i] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        dpdz = (p[k+1][j][i] + p[k+1][j][i+1] -</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;            p[k  ][j][i] - p[k  ][j][i+1]) * 0.5;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;      }</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    }</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        dpdz = (p[k+1][j][i] + p[k+1][j][i+1] -</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;            p[k  ][j][i] - p[k  ][j][i+1]) * 0.5;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;      }</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    }</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;      dpdz = (p[k+1][j][i] + p[k+1][j][i+1] -</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;          p[k-1][j][i] - p[k-1][j][i+1]) * 0.25;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    }</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    </div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    </div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    </div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <span class="keywordflow">if</span> (!(nvert[k][j][i] + nvert[k][j][i+1])) {</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;      ucont[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> -=</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        (dpdc * (icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> +</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;             icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> +</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;             icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i] +</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;         dpde * (ieta[k][j][i].x * icsi[k][j][i].x +</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;             ieta[k][j][i].y * icsi[k][j][i].y +</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;             ieta[k][j][i].z * icsi[k][j][i].z) * iaj[k][j][i] +</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;         dpdz * (izet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> +</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;             izet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> +</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;             izet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i])</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        * scale;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;      </div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    }</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      }</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    } </div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  }</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2] == 7 &amp;&amp; ys == 0) {</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160; </div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    <span class="keywordflow">for</span> (PetscInt k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      <span class="keywordflow">for</span> (PetscInt i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    PetscInt j=ys;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    </div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    PetscReal dpdc = 0.;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    PetscReal dpdz = 0.;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7) || nvert[k][j][i+1] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j+1][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) {</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;        dpdc = (p[k][j][i  ] + p[k][j+1][i  ] -</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            p[k][j][i-1] - p[k][j+1][i-1]) * 0.5;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;      }</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    }</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j+1][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        dpdc = (p[k][j][i  ] + p[k][j+1][i  ] -</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            p[k][j][i-1] - p[k][j+1][i-1]) * 0.5;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;      }</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    }</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        dpdc = (p[k][j][i+1] + p[k][j+1][i+1] -</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;            p[k][j][i  ] - p[k][j+1][i  ]) * 0.5;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;      }</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    }</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;        dpdc = (p[k][j][i+1] + p[k][j+1][i+1] -</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            p[k][j][i  ] - p[k][j+1][i  ]) * 0.5;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;      }</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    }</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;      dpdc = (p[k][j][i+1] + p[k][j+1][i+1] -</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;          p[k][j][i-1] - p[k][j+1][i-1]) * 0.25;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    }</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    </div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    PetscReal dpde = p[k][j+1][i] - p[k][j][i];</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    </div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k+1][j][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;      <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j+1][i] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) {</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        dpdz = (p[k  ][j][i] + p[k  ][j+1][i] -</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;            p[k-1][j][i] - p[k-1][j+1][i]) * 0.5;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;      }</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    }</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == mz-2 || k==1 ) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;      <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        dpdz = (p[k  ][j][i] + p[k  ][j+1][i] -</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;            p[k-1][j][i] - p[k-1][j+1][i]) * 0.5;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;      }</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    }</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k-1][j][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        dpdz = (p[k+1][j][i] + p[k+1][j+1][i] -</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;            p[k  ][j][i] - p[k  ][j+1][i]) * 0.5;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;      }</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    }</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        dpdz = (p[k+1][j][i] + p[k+1][j+1][i] -</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;            p[k  ][j][i] - p[k  ][j+1][i]) * 0.5;</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;      }</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    }</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;      dpdz = (p[k+1][j][i] + p[k+1][j+1][i] -</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;          p[k-1][j][i] - p[k-1][j+1][i]) * 0.25;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    }</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        </div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    <span class="keywordflow">if</span> (!(nvert[k][j][i] + nvert[k][j+1][i])) {</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;      ucont[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> -=</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        (dpdc * (jcsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> +</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;             jcsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> +</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;             jcsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i] +</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;         dpde * (jeta[k][j][i].x * jeta[k][j][i].x +</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;             jeta[k][j][i].y * jeta[k][j][i].y +</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;             jeta[k][j][i].z * jeta[k][j][i].z) * jaj[k][j][i] +</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;         dpdz * (jzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> +</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;             jzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> +</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;             jzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i])</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        * scale;</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    }</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;      }</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    }</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  }</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160; </div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4] == 7 &amp;&amp; zs == 0) {</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    <span class="keywordflow">for</span> (PetscInt j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;      <span class="keywordflow">for</span> (PetscInt i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    </div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    PetscInt k=zs;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    PetscReal dpdc = 0.;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    PetscReal dpde = 0.;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160; </div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i+1] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k+1][j][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) {</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        dpdc = (p[k][j][i  ] + p[k+1][j][i  ] -</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;            p[k][j][i-1] - p[k+1][j][i-1]) * 0.5;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;      }</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    }</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k+1][j][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        dpdc = (p[k][j][i  ] + p[k+1][j][i  ] -</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            p[k][j][i-1] - p[k+1][j][i-1]) * 0.5;</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;      }</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    }</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        dpdc = (p[k][j][i+1] + p[k+1][j][i+1] -</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            p[k][j][i  ] - p[k+1][j][i  ]) * 0.5;</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;      }</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    }</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        dpdc = (p[k][j][i+1] + p[k+1][j][i+1] -</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;            p[k][j][i  ] - p[k+1][j][i  ]) * 0.5;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;      }</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    }</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;      dpdc = (p[k][j][i+1] + p[k+1][j][i+1] -</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;          p[k][j][i-1] - p[k+1][j][i-1]) * 0.25;</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    }</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    </div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <span class="keywordflow">if</span> ((j == my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j+1][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k+1][j-1][i] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;        dpde = (p[k][j  ][i] + p[k+1][j  ][i] -</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            p[k][j-1][i] - p[k+1][j-1][i]) * 0.5;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;      }</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    }</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ((j == my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k+1][j-1][i] &lt; 0.1) {</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        dpde = (p[k][j  ][i] + p[k+1][j  ][i] -</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;            p[k][j-1][i] - p[k+1][j-1][i]) * 0.5;</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;      }</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    }</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j-1][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        dpde = (p[k][j+1][i] + p[k+1][j+1][i] -</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;            p[k][j  ][i] - p[k+1][j  ][i]) * 0.5;</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;      }</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    }</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        dpde = (p[k][j+1][i] + p[k+1][j+1][i] -</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;            p[k][j  ][i] - p[k+1][j  ][i]) * 0.5;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;      }</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    }</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;      dpde = (p[k][j+1][i] + p[k+1][j+1][i] -</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;          p[k][j-1][i] - p[k+1][j-1][i]) * 0.25;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    }</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    </div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    PetscReal dpdz = p[k+1][j][i] - p[k][j][i];</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    </div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <span class="keywordflow">if</span> (!(nvert[k][j][i] + nvert[k+1][j][i])) {</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;      </div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;      ucont[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> -=</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;       (dpdc * (kcsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> +</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                   kcsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> +</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                   kcsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i] +</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;               dpde * (keta[k][j][i].x * kzet[k][j][i].x +</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                   keta[k][j][i].y * kzet[k][j][i].y +</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;                   keta[k][j][i].z * kzet[k][j][i].z) * kaj[k][j][i] +</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;               dpdz * (kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> +</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;                   kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> +</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;                   kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i])</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                        * scale;</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;      </div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    }</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;      }</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    }</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  }</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  </div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="comment">// --- Optional: Enforce specific mass flow rate for channel flow simulations ---</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  <span class="keywordflow">if</span> (simCtx-&gt;<a class="code" href="variables_8h.html#a2e1d74f612f5443c8ece068511563453">channelz</a>) {</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Applying channel flow mass flux correction.\n&quot;</span>);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <span class="comment">// DMDAVecGetArray(fda, user-&gt;lCsi, &amp;csi); DMDAVecGetArray(fda, user-&gt;lEta, &amp;eta); DMDAVecGetArray(fda, user-&gt;lZet, &amp;zet);</span></div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <span class="comment">//DMDAVecGetArray(da, user-&gt;lAj, &amp;aj);</span></div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <span class="comment">// This entire block was commented out in the original code. It calculates the current</span></div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <span class="comment">// total flux in the z-direction, compares it to a target flux (user-&gt;simCtx-&gt;FluxInSum),</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;    <span class="comment">// and computes a uniform velocity correction `ratio` to enforce the target.</span></div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    <span class="comment">// The implementation for applying the `ratio` was also commented out.</span></div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;    <span class="comment">// Preserving this as-is.</span></div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;  } </div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160; </div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;  <span class="comment">// Section 3: Finalization and Cleanup</span></div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160; </div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  <span class="comment">// --- Restore access to all PETSc vector arrays ---</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucont);</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  <span class="comment">// DMDAVecRestoreArray(fda, user-&gt;lCsi, &amp;csi); DMDAVecRestoreArray(fda, user-&gt;lEta, &amp;eta); DMDAVecRestoreArray(fda, user-&gt;lZet, &amp;zet);</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  <span class="comment">//DMDAVecRestoreArray(da, user-&gt;lAj, &amp;aj);</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#acbf784310453bd7aec02838cdef24a66">lICsi</a>, &amp;icsi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2276cb159119246bfadea1c234dee31b">lIEta</a>, &amp;ieta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2db602ea5fce7cec91f19f507f922a74">lIZet</a>, &amp;izet);</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a63b70d5ad8338013a2888928d4106f63">lJCsi</a>, &amp;jcsi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a96938d329a797441f228ecddd8e8e607">lJEta</a>, &amp;jeta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ab7a460d0a7eaa2d76d0b6267310c3184">lJZet</a>, &amp;jzet);</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa0f10efbfba88094aa07cee1cdb0baff">lKCsi</a>, &amp;kcsi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a508de73c1c5929cbee04a94091f2799e">lKEta</a>, &amp;keta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a8e6283b2989fae5d0a235baa570e929f">lKZet</a>, &amp;kzet);</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a4d561e219e8bc40951d121cce66d93ce">lIAj</a>, &amp;iaj); DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#ae8527c7cba1c5764994053481722eb01">lJAj</a>, &amp;jaj); DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#aee8a3f32f3bdc0dda2f862651708c0f4">lKAj</a>, &amp;kaj);</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>, &amp;p);</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160; </div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;  <span class="comment">// --- Update ghost cells for the newly corrected velocity field ---</span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Updating ghost cells for corrected velocity.\n&quot;</span>);</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;  DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160; </div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="comment">// --- Convert velocity to Cartesian and update ghost nodes ---</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Converting velocity to Cartesian and finalizing ghost nodes.\n&quot;</span>);</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  <a class="code" href="setup_8h.html#a515c9a96eb4bcac29f79e78c8882d7aa">Contra2Cart</a>(user);</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <a class="code" href="poisson_8c.html#a6046e36e2334fa29a86d652a0b8f0593">GhostNodeVelocity</a>(user);</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160; </div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Exiting Projection step.\n&quot;</span>);</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a34a113dcc9ca606d914c3d021a4d85fc_cgraph.svg" width="100%" height="385"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a34a113dcc9ca606d914c3d021a4d85fc_icgraph.svg" width="546" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a7cf2cfc0383ba0076f827f7d3856f2ed"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7cf2cfc0383ba0076f827f7d3856f2ed">&#9670;&nbsp;</a></span>UpdatePressure()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode UpdatePressure </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Updates the pressure field and handles periodic boundary conditions. </p>
<p>Updates the pressure field <code>P</code> with the pressure correction <code>Phi</code> computed by the Poisson solver.</p>
<p>This function is a core part of the projection method in a CFD solver. It is called after the Pressure Poisson Equation has been solved to obtain a pressure correction field, <code>Phi</code>.</p>
<p>The function performs two main operations:</p>
<ol type="1">
<li><b>Core Pressure Update</b>: It updates the main pressure field <code>P</code> by adding the pressure correction <code>Phi</code> at every grid point in the fluid domain. The operation is <code>P_new = P_old + Phi</code>.</li>
<li><b>Periodic Boundary Synchronization</b>: If any of the domain boundaries are periodic (<code>bctype == 7</code>), this function manually updates the pressure values in the ghost cells. It copies values from the physical cells on one side of the domain to the corresponding ghost cells on the opposite side. This ensures that subsequent calculations involving pressure gradients are correct across periodic boundaries. The refactored version consolidates the original code's redundant updates into a single, efficient pass.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> struct, containing simulation context and the pressure vectors <code>P</code> and <code>Phi</code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l01502">1502</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;{</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  PetscFunctionBeginUser;</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Entering UpdatePressure.\n&quot;</span>);</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160; </div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;  <span class="comment">// Section 1: Initialization and Data Acquisition</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;  DM da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160; </div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;  <span class="comment">// Local grid extents for the main update loop</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;  PetscInt xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  PetscInt ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  PetscInt zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;  PetscInt mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160; </div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  PetscInt i,j,k;</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160; </div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  <span class="comment">// --- Get direct pointer access to PETSc vector data for performance ---</span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;  PetscReal ***p, ***phi;</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, &amp;p);</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, &amp;phi);</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160; </div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;  <span class="comment">// Section 2: Core Pressure Update</span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Performing core pressure update (P_new = P_old + Phi).\n&quot;</span>);</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  <span class="keywordflow">for</span> (PetscInt k = zs; k &lt; ze; k++) {</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;    <span class="keywordflow">for</span> (PetscInt j = ys; j &lt; ye; j++) {</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;      <span class="keywordflow">for</span> (PetscInt i = xs; i &lt; xe; i++) {</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;        <span class="comment">// This is the fundamental pressure update in a projection method.</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        p[k][j][i] += phi[k][j][i];</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;      }</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    }</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  }</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160; </div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;  <span class="comment">// Restore arrays now that the core computation is done.</span></div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, &amp;phi);</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, &amp;p);</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160; </div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;  </div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  <span class="comment">// Section 3: Handle Periodic Boundary Condition Synchronization</span></div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;  <span class="comment">// This block is executed only if at least one boundary is periodic.</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;  <span class="comment">// The original code contained many redundant Get/Restore and update calls.</span></div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;  <span class="comment">// This refactored version performs the same effective logic but in a single,</span></div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;  <span class="comment">// efficient pass, which is numerically equivalent and much cleaner.</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0] == 7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1] == 7 ||</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;      user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2] == 7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3] == 7 ||</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4] == 7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5] == 7)</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;  {</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Synchronizing ghost cells for periodic boundaries.\n&quot;</span>);</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160; </div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;    <span class="comment">// First, update the local vectors (including ghost regions) with the new global data.</span></div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    DMGlobalToLocalBegin(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>);</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    DMGlobalToLocalEnd(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>);</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    DMGlobalToLocalBegin(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>);</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    DMGlobalToLocalEnd(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>);</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160; </div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <span class="comment">// Get pointers to all necessary local and global arrays ONCE.</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    PetscReal ***lp, ***lphi;</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>, &amp;lp);</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>, &amp;lphi);</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, &amp;p);</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, &amp;phi);</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160; </div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;    <span class="comment">// --- X-Direction Periodic Update ---</span></div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0] == 7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1] == 7) {</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;      <span class="comment">// Update left boundary physical cells from right boundary ghost cells</span></div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;      <span class="keywordflow">if</span> (xs == 0) {</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        PetscInt i = 0;</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        <span class="keywordflow">for</span> (k = zs; k &lt; ze; k++) {</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;          <span class="keywordflow">for</span> (j = ys; j &lt; ye; j++) {</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;            <span class="comment">// Note: Accessing lp[...][i-2] reads from the ghost cell region.</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;            p[k][j][i] = lp[k][j][i - 2];</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;            phi[k][j][i] = lphi[k][j][i - 2];</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;          }</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;        }</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;      }</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;      <span class="comment">// Update right boundary physical cells from left boundary ghost cells</span></div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;      <span class="keywordflow">if</span> (xe == mx) {</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;        PetscInt i = mx - 1;</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;        <span class="keywordflow">for</span> (k = zs; k &lt; ze; k++) {</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;          <span class="keywordflow">for</span> (j = ys; j &lt; ye; j++) {</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;            p[k][j][i] = lp[k][j][i + 2];</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;            phi[k][j][i] = lphi[k][j][i + 2];</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;          }</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;        }</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;      }</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    }</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160; </div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    <span class="comment">// --- Y-Direction Periodic Update ---</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2] == 7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3] == 7) {</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;      <span class="comment">// Update bottom boundary</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;      <span class="keywordflow">if</span> (ys == 0) {</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;        PetscInt j = 0;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <span class="keywordflow">for</span> (k = zs; k &lt; ze; k++) {</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;          <span class="keywordflow">for</span> (i = xs; i &lt; xe; i++) {</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;            p[k][j][i] = lp[k][j - 2][i];</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            phi[k][j][i] = lphi[k][j - 2][i];</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;          }</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;        }</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;      }</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;      <span class="comment">// Update top boundary</span></div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;      <span class="keywordflow">if</span> (ye == my) {</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;        PetscInt j = my - 1;</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;        <span class="keywordflow">for</span> (k = zs; k &lt; ze; k++) {</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;          <span class="keywordflow">for</span> (i = xs; i &lt; xe; i++) {</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;            p[k][j][i] = lp[k][j + 2][i];</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;            phi[k][j][i] = lphi[k][j + 2][i];</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;          }</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;        }</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;      }</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    }</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160; </div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    <span class="comment">// --- Z-Direction Periodic Update ---</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4] == 7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5] == 7) {</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;      <span class="comment">// Update front boundary</span></div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;      <span class="keywordflow">if</span> (zs == 0) {</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;        PetscInt k = 0;</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;        <span class="keywordflow">for</span> (j = ys; j &lt; ye; j++) {</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;          <span class="keywordflow">for</span> (i = xs; i &lt; xe; i++) {</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;            p[k][j][i] = lp[k - 2][j][i];</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;            phi[k][j][i] = lphi[k - 2][j][i];</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;          }</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        }</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;      }</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      <span class="comment">// Update back boundary</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;      <span class="keywordflow">if</span> (ze == mz) {</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        PetscInt k = mz - 1;</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        <span class="keywordflow">for</span> (j = ys; j &lt; ye; j++) {</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;          <span class="keywordflow">for</span> (i = xs; i &lt; xe; i++) {</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;            p[k][j][i] = lp[k + 2][j][i];</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;            phi[k][j][i] = lphi[k + 2][j][i];</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;          }</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;        }</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;      }</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;    }</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;    </div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;    <span class="comment">// Restore all arrays ONCE.</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;    DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>, &amp;lp);</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;    DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>, &amp;lphi);</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;    DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, &amp;p);</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;    DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, &amp;phi);</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160; </div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;    <span class="comment">// After manually updating the physical boundary cells, we must call</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    <span class="comment">// DMGlobalToLocal again to ensure all processes have the updated ghost</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    <span class="comment">// values for the *next* function that needs them.</span></div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    DMGlobalToLocalBegin(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>);</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    DMGlobalToLocalEnd(da, user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">lP</a>);</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;    DMGlobalToLocalBegin(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>);</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    DMGlobalToLocalEnd(da, user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">lPhi</a>);</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;  }</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;  </div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;  <span class="comment">// Section 4: Final Cleanup (pointers already restored)</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160; </div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;  <a class="code" href="setup_8h.html#ad5f82951adcce74b3d37cb5880acf43a">UpdateLocalGhosts</a>(user,<span class="stringliteral">&quot;P&quot;</span>);</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;  <a class="code" href="setup_8h.html#ad5f82951adcce74b3d37cb5880acf43a">UpdateLocalGhosts</a>(user,<span class="stringliteral">&quot;Phi&quot;</span>);</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;  </div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Exiting UpdatePressure.\n&quot;</span>);</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a7cf2cfc0383ba0076f827f7d3856f2ed_cgraph.svg" width="531" height="88"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a7cf2cfc0383ba0076f827f7d3856f2ed_icgraph.svg" width="584" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a49aa74e97b8b23d5bb66ac4aec7bb5f9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a49aa74e97b8b23d5bb66ac4aec7bb5f9">&#9670;&nbsp;</a></span>mymatmultadd()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static PetscErrorCode mymatmultadd </td>
          <td>(</td>
          <td class="paramtype">Mat&#160;</td>
          <td class="paramname"><em>mat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>v1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>v2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l01673">1673</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;{</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;  Vec vt;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;  VecDuplicate(v2, &amp;vt);</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;  MatMult(mat, v1, vt);</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;  VecAYPX(v2, 1., vt);</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;  VecDestroy(&amp;vt);</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;  <span class="keywordflow">return</span>(0);</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a2648a0c6cafb7916a706cd757e5b92f5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2648a0c6cafb7916a706cd757e5b92f5">&#9670;&nbsp;</a></span>PoissonNullSpaceFunction()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PoissonNullSpaceFunction </td>
          <td>(</td>
          <td class="paramtype">MatNullSpace&#160;</td>
          <td class="paramname"><em>nullsp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>X</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>ctx</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The callback function for PETSc's MatNullSpace object. </p>
<p>This function removes the null space from the Poisson solution vector by ensuring the average pressure is zero, which is necessary for problems with pure Neumann boundary conditions.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nullsp</td><td>The MatNullSpace context. </td></tr>
    <tr><td class="paramname">X</td><td>The vector to be corrected. </td></tr>
    <tr><td class="paramname">ctx</td><td>A void pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l01686">1686</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;{</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;  <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *user = (<a class="code" href="variables_8h.html#structUserCtx">UserCtx</a>*)ctx;</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160; </div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;  DM da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160; </div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;  PetscInt  lxs, lxe, lys, lye, lzs, lze;</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160; </div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;  PetscReal ***x, ***nvert;</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;  PetscInt  i, j, k;</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160; </div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="comment">/*   /\* First remove a constant from the Vec field X *\/ */</span></div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160; </div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160; </div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;  <span class="comment">/* Then apply boundary conditions */</span></div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;  DMDAVecGetArray(da, X, &amp;x);</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160; </div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;  lxs = xs; lxe = xe;</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;  lys = ys; lye = ye;</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;  lzs = zs; lze = ze;</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160; </div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <span class="keywordflow">if</span> (xs==0) lxs = xs+1;</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;  <span class="keywordflow">if</span> (ys==0) lys = ys+1;</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;  <span class="keywordflow">if</span> (zs==0) lzs = zs+1;</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160; </div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;  <span class="keywordflow">if</span> (xe==mx) lxe = xe-1;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;  <span class="keywordflow">if</span> (ye==my) lye = ye-1;</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;  <span class="keywordflow">if</span> (ze==mz) lze = ze-1;</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160; </div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;  PetscReal lsum, sum;</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;  PetscReal  lnum, num;</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160; </div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a>) PetscPrintf(PETSC_COMM_WORLD, <span class="stringliteral">&quot;MultiNullSpace!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n&quot;</span>);</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;  <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a>) {</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    lsum = 0;</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    lnum = 0;</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;        lsum += x[k][j][i];</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;        lnum ++;</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;      }</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    }</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;      }</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    }</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160; </div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;    MPI_Allreduce(&amp;lsum,&amp;sum,1,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    MPI_Allreduce(&amp;lnum,&amp;num,1,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;   <span class="comment">/*  PetscGlobalSum(&amp;lsum, &amp;sum, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="comment">/*     PetscGlobalSum(&amp;lnum, &amp;num, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    sum = sum / (-1.0 * num);</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160; </div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;        x[k][j][i] +=sum;</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;      }</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    }</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;      }</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    }</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;  }</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    lsum = 0;</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    lnum = 0;</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;      <span class="keywordflow">if</span> (k&lt;user-&gt;KSKE[2*(j*mx+i)] &amp;&amp; nvert[k][j][i]&lt;0.1) {</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;        lsum += x[k][j][i];</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;        lnum ++;</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;      }</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;    }</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;      }</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    }</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    MPI_Allreduce(&amp;lsum,&amp;sum,1,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;    MPI_Allreduce(&amp;lnum,&amp;num,1,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;   <span class="comment">/*  PetscGlobalSum(&amp;lsum, &amp;sum, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="comment">/*     PetscGlobalSum(&amp;lnum, &amp;num, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    sum /= -num;</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;      <span class="keywordflow">if</span> (k&lt;user-&gt;KSKE[2*(j*mx+i)] &amp;&amp; nvert[k][j][i]&lt;0.1) {</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        x[k][j][i] += sum;</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;      }</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    }</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;      }</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    }</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160; </div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    lsum = 0;</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;    lnum = 0;</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;      <span class="keywordflow">if</span> (k&gt;=user-&gt;<a class="code" href="variables_8h.html#a24d419b8507d91d3752afe90a3ac1de5">KSKE</a>[2*(j*mx+i)] &amp;&amp; nvert[k][j][i]&lt;0.1) {</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;        lsum += x[k][j][i];</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;        lnum ++;</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;      }</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    }</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;      }</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    }</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    MPI_Allreduce(&amp;lsum,&amp;sum,1,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    MPI_Allreduce(&amp;lnum,&amp;num,1,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;   <span class="comment">/*  PetscGlobalSum(&amp;lsum, &amp;sum, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="comment">/*     PetscGlobalSum(&amp;lnum, &amp;num, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    sum /= -num;</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;      <span class="keywordflow">if</span> (k&gt;=user-&gt;<a class="code" href="variables_8h.html#a24d419b8507d91d3752afe90a3ac1de5">KSKE</a>[2*(j*mx+i)] &amp;&amp; nvert[k][j][i]&lt;0.1) {</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;        x[k][j][i] += sum;</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;      }</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    }</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;      }</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    }</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;               </div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;  } <span class="comment">//if multinullspace</span></div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;  <span class="keywordflow">if</span> (zs == 0) {</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    k = 0;</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    x[k][j][i] = 0.;</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;      }</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    }</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;  }</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160; </div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;  <span class="keywordflow">if</span> (ze == mz) {</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    k = mz-1;</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    x[k][j][i] = 0.;</div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;      }</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    }</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;  }</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160; </div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;  <span class="keywordflow">if</span> (ys == 0) {</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    j = 0;</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    x[k][j][i] = 0.;</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;      }</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;    }</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;  }</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160; </div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;  <span class="keywordflow">if</span> (ye == my) {</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    j = my-1;</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;    x[k][j][i] = 0.;</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;      }</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    }</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;  }</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160; </div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;  <span class="keywordflow">if</span> (xs == 0) {</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    i = 0;</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    x[k][j][i] = 0.;</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;      }</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    }</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;  }</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160; </div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;  <span class="keywordflow">if</span> (xe == mx) {</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    i = mx-1;</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    x[k][j][i] = 0.;</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;      }</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    }</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;  }</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160; </div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;  <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1)</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;      x[k][j][i] = 0.;</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;      }</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    }</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;  }</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;  DMDAVecRestoreArray(da, X, &amp;x);</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160; </div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a2648a0c6cafb7916a706cd757e5b92f5_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="aa2fc17959230252f30b2278d81a16caf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa2fc17959230252f30b2278d81a16caf">&#9670;&nbsp;</a></span>MyInterpolation()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode MyInterpolation </td>
          <td>(</td>
          <td class="paramtype">Mat&#160;</td>
          <td class="paramname"><em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>X</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>F</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The callback function for the multigrid interpolation operator (MatShell). </p>
<p>Defines the coarse-to-fine grid transfer for the pressure correction.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">A</td><td>The shell matrix context. </td></tr>
    <tr><td class="paramname">X</td><td>The coarse-grid source vector. </td></tr>
    <tr><td class="paramname">F</td><td>The fine-grid destination vector. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l01879">1879</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;{</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;  <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *user;</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160; </div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;  MatShellGetContext(A, (<span class="keywordtype">void</span>**)&amp;user);</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160; </div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;  </div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;  </div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;  DM    da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160; </div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;  DM    da_c = *user-&gt;<a class="code" href="variables_8h.html#a7fb47de7893b318ba4e4e12ed46c0712">da_c</a>;</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160; </div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;  PetscInt  lxs, lxe, lys, lye, lzs, lze;</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;  </div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;  PetscReal ***f, ***x, ***nvert, ***nvert_c;</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;  PetscInt i, j, k, ic, jc, kc, ia, ja, ka;</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160; </div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;  lxs = xs; lxe = xe;</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;  lys = ys; lye = ye;</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;  lzs = zs; lze = ze;</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160; </div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;  <span class="keywordflow">if</span> (xs==0) lxs = xs+1;</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;  <span class="keywordflow">if</span> (ys==0) lys = ys+1;</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;  <span class="keywordflow">if</span> (zs==0) lzs = zs+1;</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160; </div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;  <span class="keywordflow">if</span> (xe==mx) lxe = xe-1;</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;  <span class="keywordflow">if</span> (ye==my) lye = ye-1;</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;  <span class="keywordflow">if</span> (ze==mz) lze = ze-1;</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160; </div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160; </div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;  DMDAVecGetArray(da,   F, &amp;f);</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160; </div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160; </div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;  Vec lX;</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;  DMCreateLocalVector(da_c, &amp;lX);</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160; </div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;  DMGlobalToLocalBegin(da_c, X, INSERT_VALUES, lX);</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;  DMGlobalToLocalEnd(da_c, X, INSERT_VALUES, lX);  </div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;  DMDAVecGetArray(da_c, lX, &amp;x);</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160; </div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;  DMDAVecGetArray(da_c, *(user-&gt;<a class="code" href="variables_8h.html#af21efba2f6a4f52657ce8ba6908cec7c">lNvert_c</a>), &amp;nvert_c);</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160; </div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;    <a class="code" href="poisson_8c.html#a846185bb780db2d5f6e9e58c09a08819">GridInterpolation</a>(i, j, k, ic, jc, kc, ia, ja, ka, user);</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160; </div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;      f[k][j][i] = (x[kc   ][jc   ][ic   ] * 9 +</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;            x[kc   ][jc+ja][ic   ] * 3 +</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;            x[kc   ][jc   ][ic+ia] * 3 +</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;            x[kc   ][jc+ja][ic+ia]) * 3./64. +</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        (x[kc+ka][jc   ][ic   ] * 9 +</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;         x[kc+ka][jc+ja][ic   ] * 3 +</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;         x[kc+ka][jc   ][ic+ia] * 3 +</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;         x[kc+ka][jc+ja][ic+ia]) /64.;</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;      }</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;    }</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;  }</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160; </div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;  <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160; </div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    <span class="keywordflow">if</span> (i==0) {</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;      f[k][j][i] = 0.;<span class="comment">//-f[k][j][i+1];</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    }</div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i==mx-1) {</div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;      f[k][j][i] = 0.;<span class="comment">//-f[k][j][i-1];</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;    }</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j==0) {</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;      f[k][j][i] = 0.;<span class="comment">//-f[k][j+1][i];</span></div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;    }</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j==my-1) {</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;      f[k][j][i] = 0.;<span class="comment">//-f[k][j-1][i];</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    }</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (k==0) {</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;      f[k][j][i] = 0.;<span class="comment">//-f[k+1][j][i];</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    }</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (k==mz-1) {</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;      f[k][j][i] = 0.;<span class="comment">//-f[k-1][j][i];</span></div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    }</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1) f[k][j][i] = 0.;</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160; </div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;      }</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    }</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;  }</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160; </div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  DMDAVecRestoreArray(da_c, *(user-&gt;<a class="code" href="variables_8h.html#af21efba2f6a4f52657ce8ba6908cec7c">lNvert_c</a>), &amp;nvert_c);</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160; </div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;  DMDAVecRestoreArray(da_c, lX, &amp;x);</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160; </div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;  VecDestroy(&amp;lX);</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;  DMDAVecRestoreArray(da,   F,  &amp;f);</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160; </div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160; </div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160; </div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160; </div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_aa2fc17959230252f30b2278d81a16caf_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a85e1eff3b6e34605b863323d6336eecd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a85e1eff3b6e34605b863323d6336eecd">&#9670;&nbsp;</a></span>RestrictResidual_SolidAware()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static PetscErrorCode RestrictResidual_SolidAware </td>
          <td>(</td>
          <td class="paramtype">Mat&#160;</td>
          <td class="paramname"><em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>X</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>F</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l01986">1986</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;{</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;  <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *user;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  MatShellGetContext(A, (<span class="keywordtype">void</span>**)&amp;user);</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;  </div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;  DM    da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;  DM    da_f = *user-&gt;<a class="code" href="variables_8h.html#a946cb0e8075672c1ffc8bd6d0b0dfe5c">da_f</a>;</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160; </div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;  DMDALocalInfo info;</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;  DMDAGetLocalInfo(da, &amp;info);</div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;  </div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  PetscReal ***f, ***x, ***nvert;</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;  PetscInt i, j, k, ih, jh, kh, ia, ja, ka;</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160; </div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;  DMDAVecGetArray(da,   F, &amp;f);</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160; </div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;  Vec lX;</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;  DMCreateLocalVector(da_f, &amp;lX);</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;  DMGlobalToLocalBegin(da_f, X, INSERT_VALUES, lX);</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;  DMGlobalToLocalEnd(da_f, X, INSERT_VALUES, lX);  </div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;  DMDAVecGetArray(da_f, lX, &amp;x);</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160; </div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160; </div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;  PetscReal ***nvert_f;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  DMDAVecGetArray(da_f, user-&gt;<a class="code" href="variables_8h.html#a2deb96128ed850632f645128e26e229e">user_f</a>-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert_f);</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160; </div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a03772da847da737415fd5a86a97147bd">isc</a>)) ia = 0;</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;  <span class="keywordflow">else</span> ia = 1;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160; </div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a5fd8588302a68eca03d086e01e8972c1">jsc</a>)) ja = 0;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;  <span class="keywordflow">else</span> ja = 1;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160; </div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a3e8bcd710c619c329608b6f7da5f1ea1">ksc</a>)) ka = 0;</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;  <span class="keywordflow">else</span> ka = 1;</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160; </div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;  <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;        <span class="comment">// --- CORRECTED LOGIC ---</span></div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;        <span class="comment">// First, check if the current point is a boundary point.</span></div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;        <span class="comment">// If it is, it does not contribute to the coarse grid residual.</span></div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;        <span class="keywordflow">if</span> (i==0 || i==mx-1 || j==0 || j==my-1 || k==0 || k==mz-1 || nvert[k][j][i] &gt; 0.1) {</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;            f[k][j][i] = 0.0;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;        } </div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;        <span class="comment">// Only if it&#39;s a true interior fluid point, perform the restriction.</span></div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;            <a class="code" href="poisson_8c.html#afe58ccf2bd0a359903645f7a0ee76485">GridRestriction</a>(i, j, k, &amp;ih, &amp;jh, &amp;kh, user);</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;            f[k][j][i] = 0.125 *</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;              (x[kh   ][jh   ][ih   ] * PetscMax(0., 1 - nvert_f[kh   ][jh   ][ih   ]) +</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;               x[kh   ][jh   ][ih-ia] * PetscMax(0., 1 - nvert_f[kh   ][jh   ][ih-ia]) +</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;               x[kh   ][jh-ja][ih   ] * PetscMax(0., 1 - nvert_f[kh   ][jh-ja][ih   ]) +</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;               x[kh-ka][jh   ][ih   ] * PetscMax(0., 1 - nvert_f[kh-ka][jh   ][ih   ]) +</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;               x[kh   ][jh-ja][ih-ia] * PetscMax(0., 1 - nvert_f[kh   ][jh-ja][ih-ia]) +</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;               x[kh-ka][jh-ja][ih   ] * PetscMax(0., 1 - nvert_f[kh-ka][jh-ja][ih   ]) +</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;               x[kh-ka][jh   ][ih-ia] * PetscMax(0., 1 - nvert_f[kh-ka][jh   ][ih-ia]) +</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;               x[kh-ka][jh-ja][ih-ia] * PetscMax(0., 1 - nvert_f[kh-ka][jh-ja][ih-ia]));</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;        }</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;      }</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;    }</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;  }</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160; </div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;  DMDAVecRestoreArray(da_f, user-&gt;<a class="code" href="variables_8h.html#a2deb96128ed850632f645128e26e229e">user_f</a>-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert_f);</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;  DMDAVecRestoreArray(da_f, lX, &amp;x);</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;  VecDestroy(&amp;lX);</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;  DMDAVecRestoreArray(da,   F,  &amp;f);</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160; </div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a85e1eff3b6e34605b863323d6336eecd_cgraph.svg" width="386" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a85e1eff3b6e34605b863323d6336eecd_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a5fa351d4c691fef0d76cedf5cc5cbb72"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5fa351d4c691fef0d76cedf5cc5cbb72">&#9670;&nbsp;</a></span>MyRestriction()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode MyRestriction </td>
          <td>(</td>
          <td class="paramtype">Mat&#160;</td>
          <td class="paramname"><em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>X</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>F</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The callback function for the multigrid restriction operator (MatShell). </p>
<p>Defines the fine-to-coarse grid transfer for the Poisson residual.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">A</td><td>The shell matrix context. </td></tr>
    <tr><td class="paramname">X</td><td>The fine-grid source vector. </td></tr>
    <tr><td class="paramname">F</td><td>The coarse-grid destination vector. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l02061">2061</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;{</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;  <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *user;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160; </div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;  MatShellGetContext(A, (<span class="keywordtype">void</span>**)&amp;user);</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160; </div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;  </div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;  DM    da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160; </div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;  DM    da_f = *user-&gt;<a class="code" href="variables_8h.html#a946cb0e8075672c1ffc8bd6d0b0dfe5c">da_f</a>;</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160; </div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;  DMDALocalInfo info;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;  DMDAGetLocalInfo(da, &amp;info);</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;  <span class="comment">//  PetscInt  lxs, lxe, lys, lye, lzs, lze;</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;  </div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;  PetscReal ***f, ***x, ***nvert;</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  PetscInt i, j, k, ih, jh, kh, ia, ja, ka;</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160; </div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;  DMDAVecGetArray(da,   F, &amp;f);</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160; </div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;  Vec lX;</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160; </div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;  DMCreateLocalVector(da_f, &amp;lX);</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;  DMGlobalToLocalBegin(da_f, X, INSERT_VALUES, lX);</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;  DMGlobalToLocalEnd(da_f, X, INSERT_VALUES, lX);  </div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;  DMDAVecGetArray(da_f, lX, &amp;x);</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160; </div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160; </div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;  PetscReal ***nvert_f;</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;  DMDAVecGetArray(da_f, user-&gt;<a class="code" href="variables_8h.html#a2deb96128ed850632f645128e26e229e">user_f</a>-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert_f);</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160; </div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a03772da847da737415fd5a86a97147bd">isc</a>)) ia = 0;</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;  <span class="keywordflow">else</span> ia = 1;</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160; </div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a5fd8588302a68eca03d086e01e8972c1">jsc</a>)) ja = 0;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;  <span class="keywordflow">else</span> ja = 1;</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160; </div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;  <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="variables_8h.html#a3e8bcd710c619c329608b6f7da5f1ea1">ksc</a>)) ka = 0;</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;  <span class="keywordflow">else</span> ka = 1;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160; </div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;  <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    <span class="keywordflow">if</span> (k==0) {</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;      f[k][j][i] = 0.;</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    }</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (k==mz-1) {</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;      f[k][j][i] = 0.;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;    }</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j==0) {</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;      f[k][j][i] = 0.;</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;    }</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j==my-1) {</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;      f[k][j][i] = 0.;</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    }</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i==0) {</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;      f[k][j][i] = 0.;</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    }</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i==mx-1) {</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;      f[k][j][i] = 0.;</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    }</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;      <a class="code" href="poisson_8c.html#afe58ccf2bd0a359903645f7a0ee76485">GridRestriction</a>(i, j, k, &amp;ih, &amp;jh, &amp;kh, user);</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;      f[k][j][i] = 0.125 *</div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;        (x[kh   ][jh   ][ih   ] * PetscMax(0., 1 - nvert_f[kh   ][jh   ][ih   ]) +</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;         x[kh   ][jh   ][ih-ia] * PetscMax(0., 1 - nvert_f[kh   ][jh   ][ih-ia]) +</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;         x[kh   ][jh-ja][ih   ] * PetscMax(0., 1 - nvert_f[kh   ][jh-ja][ih   ]) +</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;         x[kh-ka][jh   ][ih   ] * PetscMax(0., 1 - nvert_f[kh-ka][jh   ][ih   ]) +</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;         x[kh   ][jh-ja][ih-ia] * PetscMax(0., 1 - nvert_f[kh   ][jh-ja][ih-ia]) +</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;         x[kh-ka][jh-ja][ih   ] * PetscMax(0., 1 - nvert_f[kh-ka][jh-ja][ih   ]) +</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;         x[kh-ka][jh   ][ih-ia] * PetscMax(0., 1 - nvert_f[kh-ka][jh   ][ih-ia]) +</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;         x[kh-ka][jh-ja][ih-ia] * PetscMax(0., 1 - nvert_f[kh-ka][jh-ja][ih-ia]));</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160; </div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160; </div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160; </div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1) f[k][j][i] = 0.;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;    }</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;      }</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    }</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;  }</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160; </div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160; </div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;  DMDAVecRestoreArray(da_f, user-&gt;<a class="code" href="variables_8h.html#a2deb96128ed850632f645128e26e229e">user_f</a>-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert_f);</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160; </div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;  DMDAVecRestoreArray(da_f, lX, &amp;x);</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;  VecDestroy(&amp;lX);</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160; </div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;  DMDAVecRestoreArray(da,   F,  &amp;f);</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160; </div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160; </div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a5fa351d4c691fef0d76cedf5cc5cbb72_cgraph.svg" width="290" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a26f0e6321b7ace56b3b105e1eb10475e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26f0e6321b7ace56b3b105e1eb10475e">&#9670;&nbsp;</a></span>PoissonLHSNew()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PoissonLHSNew </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Assembles the Left-Hand Side (LHS) matrix for the Pressure Poisson Equation. </p>
<p>Assembles the Left-Hand-Side (LHS) matrix (Laplacian operator) for the Poisson equation on a single grid level.</p>
<p>This function constructs the sparse matrix <code>A</code> (the LHS) for the linear system <code>Ax = B</code>, which is the Pressure Poisson Equation (PPE). The matrix <code>A</code> represents a discrete version of the negative Laplacian operator (-), tailored for a general curvilinear, staggered grid.</p>
<p>The assembly process is highly complex and follows these main steps:</p>
<ol type="1">
<li><b>Matrix Initialization</b>: On the first call, it allocates a sparse PETSc matrix <code>A</code> pre-allocating space for a 19-point stencil per row. On subsequent calls, it simply zeroes out the existing matrix.</li>
<li><b>Metric Tensor Calculation</b>: It first computes the 9 components of the metric tensor (<code>g11</code>, <code>g12</code>, ..., <code>g33</code>) at the cell faces. These <code>g_ij</code> coefficients are essential for defining the Laplacian operator in generalized curvilinear coordinates and account for grid stretching and non-orthogonality.</li>
<li><b>Stencil Assembly Loop</b>: The function iterates through every grid point <code>(i,j,k)</code>. For each point, it determines the matrix row entries based on its status:<ul>
<li><b>Boundary/Solid Point</b>: If the point is on a domain boundary or inside an immersed solid (<code>nvert &gt; 0.1</code>), it sets an identity row (<code>A(row,row) = 1</code>), effectively removing it from the linear solve.</li>
<li><b>Fluid Point</b>: For a fluid point, it computes the 19 coefficients of the finite volume stencil. This involves summing contributions from each of the six faces of the control volume around the point.</li>
</ul>
</li>
<li><b>Boundary-Aware Stencils</b>: The stencil calculation is critically dependent on the state of neighboring cells. The code contains intricate logic to check if neighbors are fluid or solid. If a standard centered-difference stencil would cross into a solid, the scheme is automatically adapted to a one-sided difference to maintain accuracy at the fluid-solid interface.</li>
<li><b>Matrix Finalization</b>: After all rows corresponding to the local processor's grid points have been set, <code>MatAssemblyBegin/End</code> is called to finalize the global matrix, making it ready for use by a linear solver.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> struct, containing all simulation context, grid data, and the matrix <code>A</code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l02207">2207</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;{</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;  PetscFunctionBeginUser;</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Entering PoissonLHSNew to assemble Laplacian matrix.\n&quot;</span>);</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;  PetscErrorCode ierr;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;  <span class="comment">// Section 1: Initialization and Data Acquisition</span></div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160; </div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;  </div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;  <span class="comment">// --- Get simulation and grid context ---</span></div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;  <a class="code" href="variables_8h.html#structSimCtx">SimCtx</a> *simCtx = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;  DM da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, fda = user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>;</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;  PetscInt IM = user-&gt;<a class="code" href="variables_8h.html#ad1904cdee33ebeffba809c883f7e9641">IM</a>, JM = user-&gt;<a class="code" href="variables_8h.html#aa55a2a246e904b3569075eb4de0092a6">JM</a>, KM = user-&gt;<a class="code" href="variables_8h.html#a3f5ec0e4536c9ccaa3d663f14d47f904">KM</a>;</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;  PetscInt i,j,k;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160; </div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;  <span class="comment">// --- Grid dimensions ---</span></div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;  PetscInt mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;  PetscInt xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;  PetscInt ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;  PetscInt zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;  PetscInt gxs = info.gxs, gxe = gxs + info.gxm;</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;  PetscInt gys = info.gys, gye = gys + info.gym;</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;  PetscInt gzs = info.gzs, gze = gzs + info.gzm;</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160; </div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;  <span class="comment">// --- Define constants for clarity ---</span></div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;  <span class="keyword">const</span> PetscReal IBM_FLUID_THRESHOLD = 0.1;</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160; </div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;  <span class="comment">// --- Allocate the LHS matrix A on the first call ---</span></div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;  <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#a41951f47cfbe9c08def29998a76dc791">assignedA</a>) {</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;First call: Creating LHS matrix &#39;A&#39; with 19-point stencil preallocation.\n&quot;</span>);</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;    PetscInt N = mx * my * mz; <span class="comment">// Total size</span></div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;    PetscInt M;                <span class="comment">// Local size</span></div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;    VecGetLocalSize(user-&gt;<a class="code" href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">Phi</a>, &amp;M);</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;    <span class="comment">// Create a sparse AIJ matrix, preallocating for 19 non-zeros per row (d=diagonal, o=off-diagonal)</span></div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;    MatCreateAIJ(PETSC_COMM_WORLD, M, M, N, N, 19, PETSC_NULL, 19, PETSC_NULL, &amp;(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>));</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;    user-&gt;<a class="code" href="variables_8h.html#a41951f47cfbe9c08def29998a76dc791">assignedA</a> = PETSC_TRUE;</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;  }</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160; </div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;  <span class="comment">// Zero out matrix entries from the previous solve</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;  MatZeroEntries(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>);</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160; </div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;  <span class="comment">// --- Get direct pointer access to grid metric data ---</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;  <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> ***csi, ***eta, ***zet, ***icsi, ***ieta, ***izet, ***jcsi, ***jeta, ***jzet, ***kcsi, ***keta, ***kzet;</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;  PetscReal ***aj, ***iaj, ***jaj, ***kaj, ***nvert;</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>, &amp;csi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>, &amp;eta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>, &amp;zet);</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#acbf784310453bd7aec02838cdef24a66">lICsi</a>, &amp;icsi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2276cb159119246bfadea1c234dee31b">lIEta</a>, &amp;ieta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2db602ea5fce7cec91f19f507f922a74">lIZet</a>, &amp;izet);</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a63b70d5ad8338013a2888928d4106f63">lJCsi</a>, &amp;jcsi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a96938d329a797441f228ecddd8e8e607">lJEta</a>, &amp;jeta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ab7a460d0a7eaa2d76d0b6267310c3184">lJZet</a>, &amp;jzet);</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa0f10efbfba88094aa07cee1cdb0baff">lKCsi</a>, &amp;kcsi); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a508de73c1c5929cbee04a94091f2799e">lKEta</a>, &amp;keta); DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a8e6283b2989fae5d0a235baa570e929f">lKZet</a>, &amp;kzet);</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;aj); DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a4d561e219e8bc40951d121cce66d93ce">lIAj</a>, &amp;iaj); DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#ae8527c7cba1c5764994053481722eb01">lJAj</a>, &amp;jaj); DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#aee8a3f32f3bdc0dda2f862651708c0f4">lKAj</a>, &amp;kaj);</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160; </div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;  <span class="comment">// --- Create temporary vectors for the metric tensor components G_ij ---</span></div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;  Vec G11, G12, G13, G21, G22, G23, G31, G32, G33;</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;  PetscReal ***g11, ***g12, ***g13, ***g21, ***g22, ***g23, ***g31, ***g32, ***g33;</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;  VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G11); VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G12); VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G13);</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;  VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G21); VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G22); VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G23);</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;  VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G31); VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G32); VecDuplicate(user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;G33);</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;  DMDAVecGetArray(da, G11, &amp;g11); DMDAVecGetArray(da, G12, &amp;g12); DMDAVecGetArray(da, G13, &amp;g13);</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;  DMDAVecGetArray(da, G21, &amp;g21); DMDAVecGetArray(da, G22, &amp;g22); DMDAVecGetArray(da, G23, &amp;g23);</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;  DMDAVecGetArray(da, G31, &amp;g31); DMDAVecGetArray(da, G32, &amp;g32); DMDAVecGetArray(da, G33, &amp;g33);</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160; </div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;  <span class="comment">// Section 2: Pre-compute Metric Tensor Coefficients (g_ij)</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Pre-computing metric tensor components (g_ij).\n&quot;</span>);</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;  <span class="keywordflow">for</span> (k = gzs; k &lt; gze; k++) {</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;    <span class="keywordflow">for</span> (j = gys; j &lt; gye; j++) {</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;      <span class="keywordflow">for</span> (i = gxs; i &lt; gxe; i++) {</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;        <span class="comment">// These coefficients represent the dot products of the grid&#39;s contravariant base vectors,</span></div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        <span class="comment">// scaled by face area. They are the core of the Laplacian operator on a curvilinear grid.</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        <span class="keywordflow">if</span>(i&gt;-1 &amp;&amp; j&gt;-1 &amp;&amp; k&gt;-1 &amp;&amp; i&lt;IM+1 &amp;&amp; j&lt;JM+1 &amp;&amp; k&lt;KM+1){</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;            g11[k][j][i] = (icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i];</div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;            g12[k][j][i] = (ieta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + ieta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + ieta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i];</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;            g13[k][j][i] = (izet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + izet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + izet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * icsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * iaj[k][j][i];</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;            g21[k][j][i] = (jcsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + jcsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + jcsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i];</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;            g22[k][j][i] = (jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i];</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;            g23[k][j][i] = (jzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + jzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + jzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * jeta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * jaj[k][j][i];</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;            g31[k][j][i] = (kcsi[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + kcsi[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + kcsi[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i];</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;            g32[k][j][i] = (keta[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + keta[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + keta[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i];</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;            g33[k][j][i] = (kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> + kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> + kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * kzet[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>) * kaj[k][j][i];</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;        }</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;      }</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    }</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;  }</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160; </div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;  <span class="comment">// Section 3: Assemble the LHS Matrix A</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Assembling the LHS matrix A using a 19-point stencil.\n&quot;</span>);</div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160; </div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;  <span class="comment">// --- Define domain boundaries for stencil logic, accounting for periodic BCs ---</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;  PetscInt x_str, x_end, y_str, y_end, z_str, z_end;</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0] == 7) { x_end = mx - 1; x_str = 0; }</div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;  <span class="keywordflow">else</span> { x_end = mx - 2; x_str = 1; }</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2] == 7) { y_end = my - 1; y_str = 0; }</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;  <span class="keywordflow">else</span> { y_end = my - 2; y_str = 1; }</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4] == 7) { z_end = mz - 1; z_str = 0; }</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;  <span class="keywordflow">else</span> { z_end = mz - 2; z_str = 1; }</div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160; </div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;  <span class="comment">// --- Main assembly loop over all local grid points ---</span></div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;  <span class="keywordflow">for</span> (k = zs; k &lt; ze; k++) {</div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;    <span class="keywordflow">for</span> (j = ys; j &lt; ye; j++) {</div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;      <span class="keywordflow">for</span> (i = xs; i &lt; xe; i++) {</div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;        PetscScalar vol[19]; <span class="comment">// Holds the 19 stencil coefficient values for the current row</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;        PetscInt idx[19];    <span class="comment">// Holds the 19 global column indices for the current row</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;        PetscInt row = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j, k, user); <span class="comment">// Global index for the current row</span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160; </div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;        <span class="comment">// --- Handle Domain Boundary and Immersed Solid Points ---</span></div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;        <span class="comment">// For these points, we don&#39;t solve the Poisson equation. We set an identity</span></div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;        <span class="comment">// row (A_ii = 1) to effectively fix the pressure value (usually to 0).</span></div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;        <span class="keywordflow">if</span> (i == 0 || i == mx - 1 || j == 0 || j == my - 1 || k == 0 || k == mz - 1 || nvert[k][j][i] &gt; IBM_FLUID_THRESHOLD) {</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] = 1.0;</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;          idx[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] = row;</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;          MatSetValues(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>, 1, &amp;row, 1, &amp;idx[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>], &amp;vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>], INSERT_VALUES);</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;        }</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;        <span class="comment">// --- Handle Fluid Points ---</span></div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;          <span class="keywordflow">for</span> (PetscInt m = 0; m &lt; 19; m++) {</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;            vol[m] = 0.0;</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;          }</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160; </div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;<span class="comment">          /************************************************************************</span></div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="comment">           * EAST FACE CONTRIBUTION (between i and i+1)</span></div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="comment">           ************************************************************************/</span></div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;          <span class="keywordflow">if</span> (nvert[k][j][i + 1] &lt; IBM_FLUID_THRESHOLD &amp;&amp; i != x_end) { <span class="comment">// East neighbor is fluid</span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;            <span class="comment">// Primary derivative term: d/d_csi (g11 * dP/d_csi)</span></div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;            vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g11[k][j][i];</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;            vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g11[k][j][i];</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160; </div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;            <span class="comment">// Cross-derivative term: d/d_csi (g12 * dP/d_eta).</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;            <span class="comment">// This requires an average of dP/d_eta. If a neighbor is solid, the stencil</span></div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;            <span class="comment">// dynamically switches to a one-sided difference to avoid using solid points.</span></div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;          <span class="keywordflow">if</span> ((j == my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) || nvert[k][j+1][i] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i+1] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] -= g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;        }</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;          }</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] -= g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;        }</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;          }</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) || nvert[k][j-1][i] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] += g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;        }</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;          }</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] += g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g12[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g12[k][j][i] * 0.5;</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        }</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;          }</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;          <span class="keywordflow">else</span> { <span class="comment">// Centered difference</span></div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;        vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g12[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] += g12[k][j][i] * 0.25;</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;        vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g12[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] -= g12[k][j][i] * 0.25;</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;          }</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;            </div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;            <span class="comment">// Cross-derivative term: d/d_csi (g13 * dP/d_zet)</span></div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;          <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) || nvert[k+1][j][i] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i+1] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) {</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] -= g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;        }</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;          }</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == mz-2 || k==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] -= g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;        }</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;          }</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) || nvert[k-1][j][i] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] += g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;        }</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;          }</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] += g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g13[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g13[k][j][i] * 0.5;</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;        }</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;          }</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;          <span class="keywordflow">else</span> { <span class="comment">// Centered difference</span></div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g13[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] += g13[k][j][i] * 0.25;</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g13[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] -= g13[k][j][i] * 0.25;</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;          }</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;          }</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160; </div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;<span class="comment">          /************************************************************************</span></div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;<span class="comment">           * WEST FACE CONTRIBUTION (between i-1 and i)</span></div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;<span class="comment">           ************************************************************************/</span></div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;          <span class="keywordflow">if</span> (nvert[k][j][i-1] &lt; IBM_FLUID_THRESHOLD &amp;&amp; i != x_str) {</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g11[k][j][i-1];</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g11[k][j][i-1];</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160; </div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;          <span class="keywordflow">if</span> ((j == my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7) || nvert[k][j+1][i] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i-1] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] += g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;        }</div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;          }</div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k][j-1][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] += g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;        }</div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;          }</div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j-1][i] + nvert[k][j-1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] -= g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;        }</div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;          }</div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k][j-1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k][j+1][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] -= g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g12[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g12[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;        }</div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;          }</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;        vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g12[k][j][i-1] * 0.25; vol[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] -= g12[k][j][i-1] * 0.25;</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;        vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g12[k][j][i-1] * 0.25; vol[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] += g12[k][j][i-1] * 0.25;</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;          }</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160; </div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;          <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) || nvert[k+1][j][i] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i-1] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) {</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] += g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;        }</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;          }</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == mz-2 || k==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] += g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;        }</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;          }</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7) || nvert[k-1][j][i] + nvert[k-1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] -= g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;        }</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;          }</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] -= g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g13[k][j][i-1] * 0.5; vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g13[k][j][i-1] * 0.5;</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;        }</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;          }</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;        vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g13[k][j][i-1] * 0.25; vol[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] -= g13[k][j][i-1] * 0.25;</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g13[k][j][i-1] * 0.25; vol[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] += g13[k][j][i-1] * 0.25;</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;          }</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;          }</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160; </div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;<span class="comment">          /************************************************************************</span></div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;<span class="comment">           * NORTH FACE CONTRIBUTION (between j and j+1)</span></div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<span class="comment">           ************************************************************************/</span></div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;          <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; IBM_FLUID_THRESHOLD &amp;&amp; j != y_end) {</div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;          <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i+1] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j+1][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) {</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] -= g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;        }</div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;          }</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k][j+1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j+1][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] -= g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;        }</div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;          }</div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7) || nvert[k][j][i-1] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] += g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;        }</div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;          }</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp;  nvert[k][j][i-1] + nvert[k][j+1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j+1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] += g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g21[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g21[k][j][i] * 0.5;</div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;        }</div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;          }</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;        vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g21[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] += g21[k][j][i] * 0.25;</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;        vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g21[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] -= g21[k][j][i] * 0.25;</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;          }</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160; </div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g22[k][j][i];</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g22[k][j][i];</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160; </div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;          <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k+1][j][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j+1][i] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) {</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] -= g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;        }</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;          }</div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == mz-2 || k==1 ) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] -= g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;        }</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;          }</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k-1][j][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] += g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;        }</div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;          }</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2 ) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] += g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g23[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g23[k][j][i] * 0.5;</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;        }</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;          }</div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;        vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g23[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] += g23[k][j][i] * 0.25;</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;        vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g23[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] -= g23[k][j][i] * 0.25;</div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;          }</div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;          }</div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160; </div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;<span class="comment">          /************************************************************************</span></div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="comment">           * SOUTH FACE CONTRIBUTION (between j-1 and j)</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;<span class="comment">           ************************************************************************/</span></div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;          <span class="keywordflow">if</span> (nvert[k][j-1][i] &lt; IBM_FLUID_THRESHOLD &amp;&amp; j != y_str) {</div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;          <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7) || nvert[k][j][i+1] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j-1][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) {</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] += g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;        }</div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;          }</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;          <span class="keywordflow">else</span>  <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k][j-1][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k][j-1][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] += g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;        }</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;          }</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k][j-1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j-1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] -= g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;        }</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;          }</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k][j-1][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j-1][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] -= g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g21[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g21[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;        }</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;          }</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;        vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g21[k][j-1][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] -= g21[k][j-1][i] * 0.25;</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;        vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g21[k][j-1][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] += g21[k][j-1][i] * 0.25;</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;          }</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160; </div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g22[k][j-1][i];</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g22[k][j-1][i];</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160; </div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;          <span class="keywordflow">if</span> ((k == mz-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k+1][j][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j-1][i] &lt; 0.1 &amp;&amp; (k!=1 || (k==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7))) {</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] += g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;        }</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;          }</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == mz-2 || k==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k+1][j][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;        <span class="keywordflow">if</span> (nvert[k-1][j][i] + nvert[k-1][j-1][i] &lt; 0.1 ) {</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] += g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;        }</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;          }</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]!=7)|| nvert[k-1][j][i] + nvert[k-1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j-1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] -= g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;        }</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;          }</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((k == 1 || k==mz-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; nvert[k-1][j][i] + nvert[k-1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;        <span class="keywordflow">if</span> (nvert[k+1][j][i] + nvert[k+1][j-1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] -= g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g23[k][j-1][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g23[k][j-1][i] * 0.5;</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;        }</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;          }</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;        vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g23[k][j-1][i] * 0.25; vol[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] -= g23[k][j-1][i] * 0.25;</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;        vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g23[k][j-1][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] += g23[k][j-1][i] * 0.25;</div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;          }</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;          }</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160; </div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;<span class="comment">          /************************************************************************</span></div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;<span class="comment">           * TOP FACE CONTRIBUTION (between k and k+1)</span></div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;<span class="comment">           ************************************************************************/</span></div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;          <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; IBM_FLUID_THRESHOLD &amp;&amp; k != z_end) {</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;          <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i+1] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k+1][j][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) {</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] -= g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;        }</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;          }</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k+1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k+1][j][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] -= g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;        }</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;          }</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] += g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;        }</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;          }</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k+1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k+1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] += g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g31[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g31[k][j][i] * 0.5;</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;        }</div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;          }</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;        vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] += g31[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] += g31[k][j][i] * 0.25;</div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;        vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] -= g31[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] -= g31[k][j][i] * 0.25;</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;          }</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160; </div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;          <span class="keywordflow">if</span> ((j == my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j+1][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k+1][j-1][i] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] -= g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;        }</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;          }</div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i] + nvert[k+1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k+1][j-1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] -= g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;        }</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;          }</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j-1][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] += g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;        }</div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;          }</div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k+1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k+1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] += g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g32[k][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] -= g32[k][j][i] * 0.5;</div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;        }</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;          }</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;        vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] += g32[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] += g32[k][j][i] * 0.25;</div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;        vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] -= g32[k][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] -= g32[k][j][i] * 0.25;</div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;          }</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160; </div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g33[k][j][i];</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;          vol[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] += g33[k][j][i];</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;          }</div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160; </div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;<span class="comment">          /************************************************************************</span></div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;<span class="comment">           * BOTTOM FACE CONTRIBUTION (between k-1 and k)</span></div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;<span class="comment">           ************************************************************************/</span></div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;          <span class="keywordflow">if</span> (nvert[k-1][j][i] &lt; IBM_FLUID_THRESHOLD &amp;&amp; k != z_str) {</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;          <span class="keywordflow">if</span> ((i == mx-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i+1] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k-1][j][i-1] &lt; 0.1 &amp;&amp; (i!=1 || (i==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7))) {</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] += g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;        }</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;          }</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == mx-2 || i==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i+1] + nvert[k-1][j][i+1] &gt; 0.1) {</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i-1] + nvert[k-1][j][i-1] &lt; 0.1) {</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;          vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] += g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;        }</div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;          }</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]!=7)|| nvert[k][j][i-1] + nvert[k-1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k-1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] -= g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;        }</div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;          }</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((i == 1 || i==mx-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; nvert[k][j][i-1] + nvert[k-1][j][i-1] &gt; 0.1) {</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k-1][j][i+1] &lt; 0.1) {</div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;          vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] -= g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g31[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g31[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;        }</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;          }</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;        vol[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] -= g31[k-1][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] -= g31[k-1][j][i] * 0.25;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;        vol[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] += g31[k-1][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] += g31[k-1][j][i] * 0.25;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;          }</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160; </div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;          <span class="keywordflow">if</span> ((j == my-2 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j+1][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k-1][j-1][i] &lt; 0.1 &amp;&amp; (j!=1 || (j==1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7))) {</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] += g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;        }</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;          }</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == my-2 || j==1) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j+1][i] + nvert[k-1][j+1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j-1][i] + nvert[k-1][j-1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] -= g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;          vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] += g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;        }</div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;          }</div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]!=7)|| nvert[k][j-1][i] + nvert[k-1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k-1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] -= g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;        }</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;          }</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == 1 || j==my-2) &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; nvert[k][j-1][i] + nvert[k-1][j-1][i] &gt; 0.1) {</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;        <span class="keywordflow">if</span> (nvert[k][j+1][i] + nvert[k-1][j+1][i] &lt; 0.1) {</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;          vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] -= g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] += g32[k-1][j][i] * 0.5; vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g32[k-1][j][i] * 0.5;</div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;        }</div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;          }</div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;        vol[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] -= g32[k-1][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] -= g32[k-1][j][i] * 0.25;</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;        vol[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] += g32[k-1][j][i] * 0.25; vol[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] += g32[k-1][j][i] * 0.25;</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;          }</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160; </div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;          vol[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] -= g33[k-1][j][i];</div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;          vol[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] += g33[k-1][j][i];</div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;          }</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160; </div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;          <span class="comment">// --- Final scaling and insertion into the matrix ---</span></div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160; </div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;          <span class="comment">// Scale all stencil coefficients by the negative cell volume (-aj).</span></div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;          <span class="keywordflow">for</span> (PetscInt m = 0; m &lt; 19; m++) {</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;            vol[m] *= -aj[k][j][i];</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;          }</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160; </div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;          <span class="comment">// Set the global column indices for the 19 stencil points, handling periodic BCs.</span></div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;          idx[<a class="code" href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j, k, user);</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==mx-2) idx[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j, k, user);</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==1) idx[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j, k, user);</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, 1, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j+1, k, user);</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, my-2, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j-1, k, user);</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j, 1, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j, k+1, user);</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j, mz-2, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j, k-1, user);</div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; i==mx-2 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, 1, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==mx-2) idx[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j+1, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, 1, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j+1, k, user);</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; i==mx-2 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, my-2, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==mx-2) idx[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j-1, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, my-2, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j-1, k, user);</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; i==1 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, 1, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==1) idx[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j+1, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, 1, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j+1, k, user);</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; i==1 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, my-2, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==1) idx[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j-1, k, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, my-2, k, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j-1, k, user);</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; j==my-2 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, 1, 1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, 1, k+1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j+1, 1, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j+1, k+1, user);</div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; j==my-2 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, 1, mz-2, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==my-2) idx[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, 1, k-1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j+1, mz-2, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j+1, k-1, user);</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; j==1 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, my-2, 1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, my-2, k+1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j-1, 1, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j-1, k+1, user);</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; j==1 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, my-2, mz-2, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 &amp;&amp; j==1) idx[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, my-2, k-1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j-1, mz-2, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i, j-1, k-1, user);</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; i==mx-2 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j, 1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==mx-2) idx[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j, k+1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j, 1, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j, k+1, user);</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; i==mx-2 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j, mz-2, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==mx-2) idx[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(1, j, k-1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j, mz-2, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i+1, j, k-1, user);</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; i==1 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j, 1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==1) idx[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j, k+1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==mz-2) idx[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j, 1, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j, k+1, user);</div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; i==1 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j, mz-2, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 &amp;&amp; i==1) idx[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(mx-2, j, k-1, user); <span class="keywordflow">else</span> <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 &amp;&amp; k==1) idx[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j, mz-2, user); <span class="keywordflow">else</span> idx[<a class="code" href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a>] = <a class="code" href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a>(i-1, j, k-1, user);</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160; </div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;          <span class="comment">// Insert the computed row into the matrix A.</span></div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;          MatSetValues(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>, 1, &amp;row, 19, idx, vol, INSERT_VALUES);</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;        }</div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;      }</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;    }</div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;  }</div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160; </div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;  <span class="comment">// Section 4: Finalize Matrix and Cleanup</span></div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;  </div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Finalizing matrix assembly.\n&quot;</span>);</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;  MatAssemblyBegin(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>, MAT_FINAL_ASSEMBLY);</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;  MatAssemblyEnd(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>, MAT_FINAL_ASSEMBLY);</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160; </div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;  PetscReal max_A;</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160; </div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;  ierr = MatNorm(user-&gt;<a class="code" href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">A</a>,NORM_INFINITY,&amp;max_A);CHKERRQ(ierr);</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160; </div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; Max value in A matrix for level %d =  %le.\n&quot;</span>,user-&gt;<a class="code" href="variables_8h.html#a99a88d89d58073bd134175f62213c528">thislevel</a>,max_A);</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160; </div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;  <span class="comment">// if (get_log_level() &gt;= LOG_DEBUG) {</span></div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;  <span class="comment">//  ierr = MatView(user-&gt;A,PETSC_VIEWER_STDOUT_WORLD); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;  <span class="comment">// }</span></div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;  </div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;  <span class="comment">// --- Restore access to all PETSc vectors and destroy temporary ones ---</span></div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;  DMDAVecRestoreArray(da, G11, &amp;g11); DMDAVecRestoreArray(da, G12, &amp;g12); DMDAVecRestoreArray(da, G13, &amp;g13);</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;  DMDAVecRestoreArray(da, G21, &amp;g21); DMDAVecRestoreArray(da, G22, &amp;g22); DMDAVecRestoreArray(da, G23, &amp;g23);</div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;  DMDAVecRestoreArray(da, G31, &amp;g31); DMDAVecRestoreArray(da, G32, &amp;g32); DMDAVecRestoreArray(da, G33, &amp;g33);</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;  </div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;  VecDestroy(&amp;G11); VecDestroy(&amp;G12); VecDestroy(&amp;G13);</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;  VecDestroy(&amp;G21); VecDestroy(&amp;G22); VecDestroy(&amp;G23);</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;  VecDestroy(&amp;G31); VecDestroy(&amp;G32); VecDestroy(&amp;G33);</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160; </div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>, &amp;csi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>, &amp;eta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>, &amp;zet);</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#acbf784310453bd7aec02838cdef24a66">lICsi</a>, &amp;icsi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2276cb159119246bfadea1c234dee31b">lIEta</a>, &amp;ieta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a2db602ea5fce7cec91f19f507f922a74">lIZet</a>, &amp;izet);</div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a63b70d5ad8338013a2888928d4106f63">lJCsi</a>, &amp;jcsi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a96938d329a797441f228ecddd8e8e607">lJEta</a>, &amp;jeta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ab7a460d0a7eaa2d76d0b6267310c3184">lJZet</a>, &amp;jzet);</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#aa0f10efbfba88094aa07cee1cdb0baff">lKCsi</a>, &amp;kcsi); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a508de73c1c5929cbee04a94091f2799e">lKEta</a>, &amp;keta); DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a8e6283b2989fae5d0a235baa570e929f">lKZet</a>, &amp;kzet);</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;aj); DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a4d561e219e8bc40951d121cce66d93ce">lIAj</a>, &amp;iaj); DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#ae8527c7cba1c5764994053481722eb01">lJAj</a>, &amp;jaj); DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#aee8a3f32f3bdc0dda2f862651708c0f4">lKAj</a>, &amp;kaj);</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;  </div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Exiting PoissonLHSNew.\n&quot;</span>);</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a26f0e6321b7ace56b3b105e1eb10475e_cgraph.svg" width="238" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a26f0e6321b7ace56b3b105e1eb10475e_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a9340445ae2c0a3c7be290e2a1aea3d67"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9340445ae2c0a3c7be290e2a1aea3d67">&#9670;&nbsp;</a></span>PoissonRHS()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PoissonRHS </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>B</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Computes the Right-Hand-Side (RHS) of the Poisson equation, which is the divergence of the intermediate velocity field. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>The <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> for the grid level. </td></tr>
    <tr><td class="paramname">B</td><td>The PETSc Vec where the RHS result will be stored. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l02810">2810</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;{</div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160; </div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;  PetscInt      i, j, k;</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;  PetscReal ***nvert, ***aj, ***rb, dt = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>-&gt;<a class="code" href="variables_8h.html#a53b044b8b0e4a4dc8c8fa05387af564c">dt</a>;</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;  <span class="keyword">struct </span>Components{</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;    PetscReal x;</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;    PetscReal y;</div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;    PetscReal z;</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;  } *** ucont;</div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160; </div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160; </div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Entering PoissonRHS to compute pressure equation RHS.\n&quot;</span>);</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160; </div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;  DMDAVecGetArray(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, B, &amp;rb);</div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;  DMDAVecGetArray(user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>, &amp;ucont);</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;  DMDAVecGetArray(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;  DMDAVecGetArray(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;aj);</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160; </div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160; </div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;   <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Computing RHS values for each cell.\n&quot;</span>);</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;  </div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;  <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) { </div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160; </div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;    <span class="keywordflow">if</span> (i==0 || i==mx-1 || j==0 || j==my-1 ||  k==0 || k==mz-1) {</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;      rb[k][j][i] = 0.;</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;    }</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1) {</div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;      rb[k][j][i] = 0;</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;    }</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;      rb[k][j][i] = -(ucont[k][j][i].x - ucont[k][j][i-1].x +</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;              ucont[k][j][i].y - ucont[k][j-1][i].y +</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;              ucont[k][j][i].z - ucont[k-1][j][i].z) / dt</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;        * aj[k][j][i] / user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>-&gt;<a class="code" href="variables_8h.html#a3ff353812541b8ebba309e8d3ba6674b">st</a> * <a class="code" href="variables_8h.html#af0af02fbd08daea87f3523a3754981f0">COEF_TIME_ACCURACY</a>;</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;     </div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    }</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;      }</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;    }</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;  }</div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160; </div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160; </div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;  <span class="comment">// --- Check the solvability condition for the Poisson equation ---</span></div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;  <span class="comment">// The global sum of the RHS (proportional to the total divergence) must be zero.</span></div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Verifying solvability condition (sum of RHS terms).\n&quot;</span>);</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;  PetscReal lsum=0., sum=0.;</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160; </div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;  <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;      <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;    </div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;    lsum += rb[k][j][i] / aj[k][j][i]* dt/<a class="code" href="variables_8h.html#af0af02fbd08daea87f3523a3754981f0">COEF_TIME_ACCURACY</a>;</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160; </div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;      }</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;    }</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  }</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;  </div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;  MPI_Allreduce(&amp;lsum,&amp;sum,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160; </div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Global Sum of RHS (Divergence Check): %le\n&quot;</span>, sum);</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160; </div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;  user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>-&gt;<a class="code" href="variables_8h.html#aee7757dd3f6e9566fc1206526625e000">summationRHS</a> = sum;</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;    </div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;  DMDAVecRestoreArray(user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>, &amp;ucont);</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;  DMDAVecRestoreArray(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;  DMDAVecRestoreArray(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user-&gt;<a class="code" href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">lAj</a>, &amp;aj);</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;  DMDAVecRestoreArray(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, B, &amp;rb);</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160; </div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160; </div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a9340445ae2c0a3c7be290e2a1aea3d67_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a34f6242556bffd27f00a84b377c1bf9d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34f6242556bffd27f00a84b377c1bf9d">&#9670;&nbsp;</a></span>VolumeFlux_rev()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode VolumeFlux_rev </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscReal *&#160;</td>
          <td class="paramname"><em>ibm_Flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscReal *&#160;</td>
          <td class="paramname"><em>ibm_Area</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>flg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>A specialized version of VolumeFlux, likely for reversed normals. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>The <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> for the grid level. </td></tr>
    <tr><td class="paramname">ibm_Flux</td><td>(Output) The calculated net flux. </td></tr>
    <tr><td class="paramname">ibm_Area</td><td>(Output) The total surface area of the IB. </td></tr>
    <tr><td class="paramname">flg</td><td>A flag controlling the correction behavior. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l02891">2891</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;{</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160; </div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;  <span class="comment">// --- CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;  <span class="comment">// Get the master simulation context from the UserCtx.</span></div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;  <a class="code" href="variables_8h.html#structSimCtx">SimCtx</a> *simCtx = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>;</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160; </div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;  <span class="comment">// Create a local variable to mirror the legacy global for minimal code changes.</span></div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;  <span class="keyword">const</span> PetscInt NumberOfBodies = simCtx-&gt;<a class="code" href="variables_8h.html#a88c4b985c5df59d8fd0ac17910dbb85c">NumberOfBodies</a>;</div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;  <span class="comment">// --- END CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;  </div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;  DM    da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, fda = user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>;</div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160; </div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160; </div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160; </div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;  PetscInt i, j, k;</div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;  PetscInt  lxs, lys, lzs, lxe, lye, lze;</div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160; </div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;  lxs = xs; lxe = xe;</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;  lys = ys; lye = ye;</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;  lzs = zs; lze = ze;</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160; </div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;  <span class="keywordflow">if</span> (xs==0) lxs = xs+1;</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;  <span class="keywordflow">if</span> (ys==0) lys = ys+1;</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;  <span class="keywordflow">if</span> (zs==0) lzs = zs+1;</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160; </div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;  <span class="keywordflow">if</span> (xe==mx) lxe = xe-1;</div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;  <span class="keywordflow">if</span> (ye==my) lye = ye-1;</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;  <span class="keywordflow">if</span> (ze==mz) lze = ze-1;</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160; </div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;  PetscReal ***nvert, ibmval=1.5;</div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;  <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> ***ucor, ***csi, ***eta, ***zet;</div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucor);</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>, &amp;csi);</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>, &amp;eta);</div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>, &amp;zet);</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160; </div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;  PetscReal libm_Flux, libm_area;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;  libm_Flux = 0;</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;  libm_area = 0;</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &gt; ibmval-0.4 &amp;&amp; nvert[k][j][i+1] &lt; ibmval &amp;&amp; i &lt; mx-2) {</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;        libm_Flux += ucor[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;        libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;              csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;              csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;              </div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;      }</div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &gt; ibmval-0.4 &amp;&amp; nvert[k][j+1][i] &lt; ibmval &amp;&amp; j &lt; my-2) {</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;        libm_Flux += ucor[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;        libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;              eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;              eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;      }</div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &gt; ibmval-0.4 &amp;&amp; nvert[k+1][j][i] &lt; ibmval &amp;&amp; k &lt; mz-2) {</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;        libm_Flux += ucor[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;        libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;              zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;              zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;      }</div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;    }</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160; </div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; ibmval-0.4 &amp;&amp; nvert[k][j][i] &lt; ibmval) {</div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &lt; 0.1 &amp;&amp; i &lt; mx-2) {</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        libm_Flux -= ucor[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;        libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;              csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;              csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;              </div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;      }</div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; 0.1 &amp;&amp; j &lt; my-2) {</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;        libm_Flux -= ucor[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;        libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;              eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;              eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;      }</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; 0.1 &amp;&amp; k &lt; mz-2) {</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;        libm_Flux -= ucor[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;        libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;              zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;              zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;      }</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;    }</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160; </div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;      }</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;    }</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;  }</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160; </div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;  MPI_Allreduce(&amp;libm_Flux, ibm_Flux,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;  MPI_Allreduce(&amp;libm_area, ibm_Area,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160; </div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160; <span class="comment">/*  PetscGlobalSum(&amp;libm_Flux, ibm_Flux, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;<span class="comment">/*   PetscGlobalSum(&amp;libm_area, ibm_Area, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;  PetscPrintf(PETSC_COMM_WORLD, <span class="stringliteral">&quot;IBMFlux REV %le %le\n&quot;</span>, *ibm_Flux, *ibm_Area);</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160; </div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;  PetscReal correction;</div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160; </div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;  <span class="keywordflow">if</span> (*ibm_Area &gt; 1.e-15) {</div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;    <span class="keywordflow">if</span> (flg)</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;      correction = (*ibm_Flux + user-&gt;<a class="code" href="variables_8h.html#ad29bf4d78039031aef92981faa325c94">FluxIntpSum</a>) / *ibm_Area;</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;      correction = *ibm_Flux / *ibm_Area;</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;  }</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;    correction = 0;</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;  }</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160; </div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &gt; ibmval-0.4 &amp;&amp; nvert[k][j][i+1] &lt; ibmval &amp;&amp; i &lt; mx-2) {</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;        ucor[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> -= sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;                    csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;                    csi[k][j][i].z * csi[k][j][i].z) *</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;                    correction;</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;              </div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;      }</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &gt; ibmval-0.4 &amp;&amp; nvert[k][j+1][i] &lt; ibmval &amp;&amp; j &lt; my-2) {</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;        ucor[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> -= sqrt(eta[k][j][i].x * eta[k][j][i].x + </div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;                    eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;                    eta[k][j][i].z * eta[k][j][i].z) *</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;                    correction;</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;      }</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &gt; ibmval-0.4 &amp;&amp; nvert[k+1][j][i] &lt; ibmval &amp;&amp; k &lt; mz-2) {</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;        ucor[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> -= sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;                    zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;                    zet[k][j][i].z * zet[k][j][i].z) *</div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;                    correction;</div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;      }</div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;    }</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160; </div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; ibmval-0.4 &amp;&amp; nvert[k][j][i] &lt; ibmval) {</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &lt; 0.1 &amp;&amp; i &lt; mx-2) {</div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;        ucor[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;                    csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;                    csi[k][j][i].z * csi[k][j][i].z) *</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;                    correction;</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;              </div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;      }</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; 0.1 &amp;&amp; j &lt; my-2) {</div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;        ucor[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;                    eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;                    eta[k][j][i].z * eta[k][j][i].z) *</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;                    correction;</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;      }</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; 0.1 &amp;&amp; k &lt; mz-2) {</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;        ucor[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;                    zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;                    zet[k][j][i].z * zet[k][j][i].z) *</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;                    correction;</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;      }</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;    }</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160; </div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;      }</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;    }</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;  }</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;  </div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160; </div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160; </div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;  libm_Flux = 0;</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;  libm_area = 0;</div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &gt; ibmval-0.4 &amp;&amp; nvert[k][j][i+1] &lt; ibmval &amp;&amp; i &lt; mx-2) {</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;        libm_Flux += ucor[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;        libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;              csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;              csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;              </div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;      }</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &gt; ibmval-0.4 &amp;&amp; nvert[k][j+1][i] &lt; ibmval &amp;&amp; j &lt; my-2) {</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;        libm_Flux += ucor[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;        libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;              eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;              eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;      }</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &gt; ibmval-0.4 &amp;&amp; nvert[k+1][j][i] &lt; ibmval &amp;&amp; k &lt; mz-2) {</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        libm_Flux += ucor[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;        libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;              zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;              zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;      }</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;    }</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160; </div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; ibmval-0.4 &amp;&amp; nvert[k][j][i] &lt; ibmval) {</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &lt; 0.1 &amp;&amp; i &lt; mx-2) {</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;        libm_Flux -= ucor[k][j][i].<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;        libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;              csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;              csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;              </div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;      }</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; 0.1 &amp;&amp; j &lt; my-2) {</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;        libm_Flux -= ucor[k][j][i].<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;        libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;              eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;              eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;      }</div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; 0.1 &amp;&amp; k &lt; mz-2) {</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;        libm_Flux -= ucor[k][j][i].<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;        libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;              zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;              zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;      }</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;    }</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160; </div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;      }</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;    }</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;  }</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160; </div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;  MPI_Allreduce(&amp;libm_Flux, ibm_Flux,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;  MPI_Allreduce(&amp;libm_area, ibm_Area,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160; </div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160; <span class="comment">/*  PetscGlobalSum(&amp;libm_Flux, ibm_Flux, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;<span class="comment">/*   PetscGlobalSum(&amp;libm_area, ibm_Area, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;  PetscPrintf(PETSC_COMM_WORLD, <span class="stringliteral">&quot;IBMFlux22 REV %le %le\n&quot;</span>, *ibm_Flux, *ibm_Area);</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160; </div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>, &amp;csi);</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>, &amp;eta);</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>, &amp;zet);</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucor);</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160; </div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;  DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;  DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a34f6242556bffd27f00a84b377c1bf9d_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a8c4cb4c082ab40cc20db95c962fc1d5c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c4cb4c082ab40cc20db95c962fc1d5c">&#9670;&nbsp;</a></span>VolumeFlux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode VolumeFlux </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscReal *&#160;</td>
          <td class="paramname"><em>ibm_Flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscReal *&#160;</td>
          <td class="paramname"><em>ibm_Area</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>flg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the net flux across the immersed boundary surface. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>The <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> for the grid level. </td></tr>
    <tr><td class="paramname">ibm_Flux</td><td>(Output) The calculated net flux. </td></tr>
    <tr><td class="paramname">ibm_Area</td><td>(Output) The total surface area of the IB. </td></tr>
    <tr><td class="paramname">flg</td><td>A flag controlling the correction behavior. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03133">3133</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;{</div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;  <span class="comment">// --- CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;  <span class="comment">// Get the master simulation context from the UserCtx.</span></div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;  <a class="code" href="variables_8h.html#structSimCtx">SimCtx</a> *simCtx = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>;</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160; </div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;  <span class="comment">// Create local variables to mirror the legacy globals for minimal code changes.</span></div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;  <span class="keyword">const</span> PetscInt NumberOfBodies = simCtx-&gt;<a class="code" href="variables_8h.html#a88c4b985c5df59d8fd0ac17910dbb85c">NumberOfBodies</a>;</div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;  <span class="keyword">const</span> PetscInt channelz = simCtx-&gt;<a class="code" href="variables_8h.html#a2e1d74f612f5443c8ece068511563453">channelz</a>;</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;  <span class="keyword">const</span> PetscInt fish = simCtx-&gt;<a class="code" href="variables_8h.html#a1b08cdba1a7d4de048fbf472edfd5850">fish</a>;</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;  <span class="comment">// --- END CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160; </div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;  DM    da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, fda = user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>;</div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160; </div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160; </div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160; </div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;  PetscInt i, j, k,ibi;</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;  PetscInt  lxs, lys, lzs, lxe, lye, lze;</div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160; </div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;  PetscInt  gxs, gxe, gys, gye, gzs, gze;</div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;  </div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;  gxs = info.gxs; gxe = gxs + info.gxm;</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;  gys = info.gys; gye = gys + info.gym;</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;  gzs = info.gzs; gze = gzs + info.gzm;</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160; </div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;  lxs = xs; lxe = xe;</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;  lys = ys; lye = ye;</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;  lzs = zs; lze = ze;</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160; </div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;  <span class="keywordflow">if</span> (xs==0) lxs = xs+1;</div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;  <span class="keywordflow">if</span> (ys==0) lys = ys+1;</div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;  <span class="keywordflow">if</span> (zs==0) lzs = zs+1;</div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160; </div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;  <span class="keywordflow">if</span> (xe==mx) lxe = xe-1;</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;  <span class="keywordflow">if</span> (ye==my) lye = ye-1;</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;  <span class="keywordflow">if</span> (ze==mz) lze = ze-1;</div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;  </div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;  PetscReal epsilon=1.e-8;</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;  PetscReal ***nvert, ibmval=1.9999;</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;  </div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;  <span class="keyword">struct </span>Components {</div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;    PetscReal x;</div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;    PetscReal y;</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;    PetscReal z;</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;  }***ucor, ***lucor,***csi, ***eta, ***zet;</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160; </div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160; </div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;  PetscInt xend=mx-2 ,yend=my-2,zend=mz-2;</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160; </div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7) xend=mx-1;</div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7) yend=my-1;</div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7) zend=mz-1;</div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160; </div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucor);</div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>, &amp;csi);</div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>, &amp;eta);</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>, &amp;zet);</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;  DMDAVecGetArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160; </div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;  PetscReal libm_Flux, libm_area, libm_Flux_abs=0., ibm_Flux_abs;</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;  libm_Flux = 0;</div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;  libm_area = 0;</div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160; </div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Entering VolumeFlux to enforce no-penetration condition.\n&quot;</span>);</div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160; </div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;  <span class="comment">//Mohsen March 2017</span></div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;  PetscReal *lIB_Flux, *lIB_area,*IB_Flux,*IB_Area;</div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;  <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) { </div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;  </div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;    lIB_Flux=(PetscReal *)calloc(NumberOfBodies,<span class="keyword">sizeof</span>(PetscReal));</div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;    lIB_area=(PetscReal *)calloc(NumberOfBodies,<span class="keyword">sizeof</span>(PetscReal));</div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;    IB_Flux=(PetscReal *)calloc(NumberOfBodies,<span class="keyword">sizeof</span>(PetscReal));</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;    IB_Area=(PetscReal *)calloc(NumberOfBodies,<span class="keyword">sizeof</span>(PetscReal));</div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;  </div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160; </div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;    <span class="keywordflow">for</span> (ibi=0; ibi&lt;NumberOfBodies; ibi++) {</div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;      lIB_Flux[ibi]=0.0;</div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;      lIB_area[ibi]=0.0;</div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;      IB_Flux[ibi]=0.0;</div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;      IB_Area[ibi]=0.0;</div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;    }</div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;  }</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160; </div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160; </div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;  <span class="comment">// PASS 1: Calculate Uncorrected Flux and Area</span></div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;  <span class="comment">// This pass measures the total fluid &quot;leakage&quot; across the immersed boundary.</span></div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Pass 1: Measuring uncorrected flux and area.\n&quot;</span>);</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;  </div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &gt; 0.1 &amp;&amp; nvert[k][j][i+1] &lt; ibmval &amp;&amp; i &lt; xend) {</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;        </div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].x)&gt;epsilon) {</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;          libm_Flux += ucor[k][j][i].x;</div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;          <span class="keywordflow">if</span> (flg==3)</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].x)/sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;                                csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;                                csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].x);</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;          </div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;          libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;                csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;                csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;          </div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;          <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;        </div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;        ibi=(int)((nvert[k][j][i+1]-1.0)*1001);</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        lIB_Flux[ibi] += ucor[k][j][i].x;</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;        lIB_area[ibi] += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;                      csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;                      csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;          }</div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;        } <span class="keywordflow">else</span></div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;          ucor[k][j][i].x=0.;</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;        </div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;      }</div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &gt; 0.1 &amp;&amp; nvert[k][j+1][i] &lt; ibmval &amp;&amp; j &lt; yend) {</div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;        </div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].y)&gt;epsilon) {</div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;          libm_Flux += ucor[k][j][i].y;</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;          <span class="keywordflow">if</span> (flg==3)</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].y)/sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;                                eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;                                eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].y);</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;          libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;                eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;                eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;          <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;        </div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;        ibi=(int)((nvert[k][j+1][i]-1.0)*1001); </div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160; </div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;        lIB_Flux[ibi] += ucor[k][j][i].y;</div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;        lIB_area[ibi] += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;                      eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;                      eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;          }</div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;        } <span class="keywordflow">else</span></div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;          ucor[k][j][i].y=0.;</div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;      }</div>
<div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &gt; 0.1 &amp;&amp; nvert[k+1][j][i] &lt; ibmval &amp;&amp; k &lt; zend) {</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;        </div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].z)&gt;epsilon) {</div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;          libm_Flux += ucor[k][j][i].z;</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;          <span class="keywordflow">if</span> (flg==3)</div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].z)/sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;                                zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;                                zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].z);</div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;          libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;                zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;                zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;          </div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;          <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;        </div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;        ibi=(int)((nvert[k+1][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;        lIB_Flux[ibi] += ucor[k][j][i].z;</div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;        lIB_area[ibi] += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;                      zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;                      zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;          }</div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;        }<span class="keywordflow">else</span></div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;          ucor[k][j][i].z=0.;</div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;      }</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;    }</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160; </div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1 &amp;&amp; nvert[k][j][i] &lt; ibmval) {</div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;      </div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &lt; 0.1 &amp;&amp; i &lt; xend) {</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].x)&gt;epsilon) {</div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;          libm_Flux -= ucor[k][j][i].x;</div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;          <span class="keywordflow">if</span> (flg==3)</div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].x)/sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;                                csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;                                csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].x);</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;          libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;                csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;                csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;          <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;        </div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;        ibi=(int)((nvert[k][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;        lIB_Flux[ibi] -= ucor[k][j][i].x;</div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;        lIB_area[ibi] += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;                      csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;                      csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;          }</div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;              </div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;        }<span class="keywordflow">else</span></div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;          ucor[k][j][i].x=0.;</div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;      }</div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; 0.1 &amp;&amp; j &lt; yend) {</div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].y)&gt;epsilon) {</div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;          libm_Flux -= ucor[k][j][i].y;</div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;          <span class="keywordflow">if</span> (flg==3)</div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].y)/ sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;                                 eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;                                 eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].y);</div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;          libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;                eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;                eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;          <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160; </div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;        ibi=(int)((nvert[k][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;        lIB_Flux[ibi] -= ucor[k][j][i].y;</div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;        lIB_area[ibi] += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;                      eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;                      eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;          }</div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;        }<span class="keywordflow">else</span></div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;          ucor[k][j][i].y=0.;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;      }</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; 0.1 &amp;&amp; k &lt; zend) {</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].z)&gt;epsilon) {</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;          libm_Flux -= ucor[k][j][i].z;</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;          <span class="keywordflow">if</span> (flg==3)</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].z)/sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;                                zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;                                zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;        libm_Flux_abs += fabs(ucor[k][j][i].z);</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;          libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;                zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;                zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;          <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;        </div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;        ibi=(int)((nvert[k][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;        lIB_Flux[ibi] -= ucor[k][j][i].z;</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;        lIB_area[ibi] += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;                      zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;                      zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;          }</div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;        }<span class="keywordflow">else</span></div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;          ucor[k][j][i].z=0.;</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;      }</div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;    }</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;    </div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;      }</div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;    }</div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;  }</div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;  </div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;  MPI_Allreduce(&amp;libm_Flux, ibm_Flux,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;  MPI_Allreduce(&amp;libm_Flux_abs, &amp;ibm_Flux_abs,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;  MPI_Allreduce(&amp;libm_area, ibm_Area,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160; </div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;  <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) { </div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;    MPI_Allreduce(lIB_Flux,IB_Flux,NumberOfBodies,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    MPI_Allreduce(lIB_area,IB_Area,NumberOfBodies,MPI_DOUBLE,MPI_SUM,PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;  }</div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160; </div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;  PetscReal correction;</div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160; </div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;  PetscReal *Correction;</div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;  <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;      Correction=(PetscReal *)calloc(NumberOfBodies,<span class="keyword">sizeof</span>(PetscReal));</div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;      <span class="keywordflow">for</span> (ibi=0; ibi&lt;NumberOfBodies; ibi++) Correction[ibi]=0.0;</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;  }</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160; </div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;  <span class="keywordflow">if</span> (*ibm_Area &gt; 1.e-15) {</div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;    <span class="keywordflow">if</span> (flg&gt;1) </div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;      correction = (*ibm_Flux + user-&gt;<a class="code" href="variables_8h.html#ad29bf4d78039031aef92981faa325c94">FluxIntpSum</a>)/ ibm_Flux_abs;</div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg)</div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;      correction = (*ibm_Flux + user-&gt;<a class="code" href="variables_8h.html#ad29bf4d78039031aef92981faa325c94">FluxIntpSum</a>) / *ibm_Area;</div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;      correction = *ibm_Flux / *ibm_Area;</div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;    <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) </div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;      <span class="keywordflow">for</span> (ibi=0; ibi&lt;NumberOfBodies; ibi++) <span class="keywordflow">if</span> (IB_Area[ibi]&gt;1.e-15) Correction[ibi] = IB_Flux[ibi] / IB_Area[ibi];</div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;  }</div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;    correction = 0;</div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;  }</div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;  <span class="comment">// --- Log the uncorrected results and calculated correction ---</span></div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;IBM Uncorrected Flux: %g, Area: %g, Correction: %g\n&quot;</span>, *ibm_Flux, *ibm_Area, correction);</div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;  <span class="keywordflow">if</span>  (NumberOfBodies&gt;1){</div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;    <span class="keywordflow">for</span> (ibi=0; ibi&lt;NumberOfBodies; ibi++)   <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;  [Body %d] Uncorrected Flux: %g, Area: %g, Correction: %g\n&quot;</span>, ibi, IB_Flux[ibi], IB_Area[ibi], Correction[ibi]);</div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;  }</div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160; </div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;  <span class="comment">// PASS 2: Apply Correction to Velocity Field</span></div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;  <span class="comment">// This pass modifies the velocity at the boundary to enforce zero net flux.</span></div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Pass 2: Applying velocity corrections at the boundary.\n&quot;</span>);</div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;  </div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &gt; 0.1 &amp;&amp; nvert[k][j][i+1] &lt;ibmval &amp;&amp; i &lt; xend) {</div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].x)&gt;epsilon){</div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;          <span class="keywordflow">if</span> (flg==3) </div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;        ucor[k][j][i].x -=correction*fabs(ucor[k][j][i].x)/</div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;          sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;               csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;               csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg==2) </div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;        ucor[k][j][i].x -=correction*fabs(ucor[k][j][i].x);</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;        ibi=(int)((nvert[k][j][i+1]-1.0)*1001);</div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;        ucor[k][j][i].x -= sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;                    csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;                    csi[k][j][i].z * csi[k][j][i].z) *</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;          Correction[ibi];</div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;          }</div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;        ucor[k][j][i].x -= sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;                    csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;                    csi[k][j][i].z * csi[k][j][i].z) *</div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;          correction;</div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;        }</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;      }</div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &gt; 0.1 &amp;&amp; nvert[k][j+1][i] &lt; ibmval &amp;&amp; j &lt; yend) {</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].y)&gt;epsilon) {</div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;          <span class="keywordflow">if</span> (flg==3) </div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;        ucor[k][j][i].y -=correction*fabs(ucor[k][j][i].y)/</div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;          sqrt(eta[k][j][i].x * eta[k][j][i].x + </div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;               eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;               eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg==2) </div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;        ucor[k][j][i].y -=correction*fabs(ucor[k][j][i].y);</div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;        ibi=(int)((nvert[k][j+1][i]-1.0)*1001);</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;        ucor[k][j][i].y -= sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;                    eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;                    eta[k][j][i].z * eta[k][j][i].z) *</div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;          Correction[ibi];</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;          }</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;        ucor[k][j][i].y -= sqrt(eta[k][j][i].x * eta[k][j][i].x + </div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;                    eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;                    eta[k][j][i].z * eta[k][j][i].z) *</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;          correction;</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;        }</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;      }</div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &gt; 0.1 &amp;&amp; nvert[k+1][j][i] &lt; ibmval &amp;&amp; k &lt; zend) {</div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].z)&gt;epsilon) {</div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;          <span class="keywordflow">if</span> (flg==3) </div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;        ucor[k][j][i].z -= correction*fabs(ucor[k][j][i].z)/</div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;          sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;               zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;               zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg==2) </div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;        ucor[k][j][i].z -= correction*fabs(ucor[k][j][i].z);</div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;        ibi=(int)((nvert[k+1][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;        ucor[k][j][i].z -= sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;                    zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;                    zet[k][j][i].z * zet[k][j][i].z) *</div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;          Correction[ibi];</div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;          }</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;        ucor[k][j][i].z -= sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;                    zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;                    zet[k][j][i].z * zet[k][j][i].z) *</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;          correction;</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;        }</div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;      }</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    }</div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160; </div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1 &amp;&amp; nvert[k][j][i] &lt; ibmval) {</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &lt; 0.1 &amp;&amp; i &lt; xend) {</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].x)&gt;epsilon) {</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;          <span class="keywordflow">if</span> (flg==3) </div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;        ucor[k][j][i].x += correction*fabs(ucor[k][j][i].x)/</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;          sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;               csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;               csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg==2) </div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;        ucor[k][j][i].x += correction*fabs(ucor[k][j][i].x);</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;        ibi=(int)((nvert[k][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;        ucor[k][j][i].x += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;                    csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;                    csi[k][j][i].z * csi[k][j][i].z) *</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;          Correction[ibi];</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;          }</div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;        ucor[k][j][i].x += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;                    csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;                    csi[k][j][i].z * csi[k][j][i].z) *</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;          correction;</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;        }</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;      }</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; 0.1 &amp;&amp; j &lt; yend) {</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].y)&gt;epsilon) {</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;        <span class="keywordflow">if</span> (flg==3) </div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;          ucor[k][j][i].y +=correction*fabs(ucor[k][j][i].y)/</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;        sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;             eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;             eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg==2) </div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;          ucor[k][j][i].y +=correction*fabs(ucor[k][j][i].y);</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;          ibi=(int)((nvert[k][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;          ucor[k][j][i].y += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;                      eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;                      eta[k][j][i].z * eta[k][j][i].z) *</div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;        Correction[ibi];</div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;        }</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;        ucor[k][j][i].y += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;                    eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;                    eta[k][j][i].z * eta[k][j][i].z) *</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;                    correction;</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;        }</div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;      }</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; 0.1 &amp;&amp; k &lt; zend) {</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;        <span class="keywordflow">if</span> (fabs(ucor[k][j][i].z)&gt;epsilon) {</div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;        <span class="keywordflow">if</span> (flg==3) </div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;          ucor[k][j][i].z += correction*fabs(ucor[k][j][i].z)/</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;        sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;             zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;             zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flg==2) </div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;          ucor[k][j][i].z += correction*fabs(ucor[k][j][i].z);</div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;          ibi=(int)((nvert[k][j][i]-1.0)*1001);</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;          ucor[k][j][i].z += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;                      zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;                      zet[k][j][i].z * zet[k][j][i].z) *</div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;        Correction[ibi];</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;        }</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;          ucor[k][j][i].z += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;                      zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;                      zet[k][j][i].z * zet[k][j][i].z) *</div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;        correction;</div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;        }</div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;      }</div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;    }</div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;    </div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;      }</div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;    }</div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;  }</div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;  </div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;  <span class="comment">// PASS 3: Verification</span></div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;  <span class="comment">// This optional pass recalculates the flux to confirm the correction was successful.</span></div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;  <span class="comment">//================================================================================</span></div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Pass 3: Verifying corrected flux.\n&quot;</span>);</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;  </div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;  libm_Flux = 0;</div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;  libm_area = 0;</div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &gt; 0.1 &amp;&amp; nvert[k][j][i+1] &lt; ibmval &amp;&amp; i &lt; xend) {</div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;        libm_Flux += ucor[k][j][i].x;</div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;        libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;              csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;              csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;              </div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;      }</div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &gt; 0.1 &amp;&amp; nvert[k][j+1][i] &lt; ibmval &amp;&amp; j &lt; yend) {</div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;        libm_Flux += ucor[k][j][i].y;</div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;        libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;              eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;              eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;      }</div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &gt; 0.1 &amp;&amp; nvert[k+1][j][i] &lt; ibmval &amp;&amp; k &lt; zend) {</div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;        libm_Flux += ucor[k][j][i].z;</div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;        libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;              zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;              zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;      }</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;    }</div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160; </div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;    <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1 &amp;&amp; nvert[k][j][i] &lt; ibmval) {</div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] &lt; 0.1 &amp;&amp; i &lt; xend) {</div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;        libm_Flux -= ucor[k][j][i].x;</div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;        libm_area += sqrt(csi[k][j][i].x * csi[k][j][i].x +</div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;              csi[k][j][i].y * csi[k][j][i].y +</div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;              csi[k][j][i].z * csi[k][j][i].z);</div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;              </div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;      }</div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j+1][i] &lt; 0.1 &amp;&amp; j &lt; yend) {</div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;        libm_Flux -= ucor[k][j][i].y;</div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;        libm_area += sqrt(eta[k][j][i].x * eta[k][j][i].x +</div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;              eta[k][j][i].y * eta[k][j][i].y +</div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;              eta[k][j][i].z * eta[k][j][i].z);</div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;      }</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;      <span class="keywordflow">if</span> (nvert[k+1][j][i] &lt; 0.1 &amp;&amp; k &lt; zend) {</div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;        libm_Flux -= ucor[k][j][i].z;</div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;        libm_area += sqrt(zet[k][j][i].x * zet[k][j][i].x +</div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;              zet[k][j][i].y * zet[k][j][i].y +</div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;              zet[k][j][i].z * zet[k][j][i].z);</div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;      }</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;    }</div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160; </div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;      }</div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;    }</div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;  }</div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160; </div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;  MPI_Allreduce(&amp;libm_Flux, ibm_Flux,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;  MPI_Allreduce(&amp;libm_area, ibm_Area,1,MPI_DOUBLE,MPI_SUM, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160; </div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160; <span class="comment">/*  PetscGlobalSum(&amp;libm_Flux, ibm_Flux, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;<span class="comment">/*   PetscGlobalSum(&amp;libm_area, ibm_Area, PETSC_COMM_WORLD); */</span></div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;IBM Corrected (Verified) Flux: %g, Area: %g\n&quot;</span>, *ibm_Flux, *ibm_Area);</div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160; </div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160; </div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==7){</div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;    <span class="keywordflow">if</span> (xe==mx){</div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;      i=mx-2;</div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;      <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;      <span class="comment">// if(j&gt;0 &amp;&amp; k&gt;0 &amp;&amp; j&lt;user-&gt;JM &amp;&amp; k&lt;user-&gt;KM){</span></div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;        <span class="keywordflow">if</span> ((nvert[k][j][i]&gt;ibmval &amp;&amp; nvert[k][j][i+1]&lt;0.1) || (nvert[k][j][i]&lt;0.1 &amp;&amp; nvert[k][j][i+1]&gt;ibmval)) ucor[k][j][i].x=0.0;</div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;        </div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;    }</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;      }</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;    }</div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;  }</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160; </div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==7){</div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;    <span class="keywordflow">if</span> (ye==my){</div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;      j=my-2;</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;      <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;      <span class="comment">// if(i&gt;0 &amp;&amp; k&gt;0 &amp;&amp; i&lt;user-&gt;IM &amp;&amp; k&lt;user-&gt;KM){</span></div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;        <span class="keywordflow">if</span> ((nvert[k][j][i]&gt;ibmval &amp;&amp; nvert[k][j+1][i]&lt;0.1) || (nvert[k][j][i]&lt;0.1 &amp;&amp; nvert[k][j+1][i]&gt;ibmval)) ucor[k][j][i].y=0.0;</div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;    }</div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;      }</div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;    }</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;  }</div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160; </div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==7){</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;    <span class="keywordflow">if</span> (ze==mz){</div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;      k=mz-2;</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;      <span class="comment">// if(i&gt;0 &amp;&amp; j&gt;0 &amp;&amp; i&lt;user-&gt;IM &amp;&amp; j&lt;user-&gt;JM){</span></div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;        <span class="keywordflow">if</span> ((nvert[k][j][i]&gt;ibmval &amp;&amp; nvert[k+1][j][i]&lt;0.1) || (nvert[k][j][i]&lt;0.1 &amp;&amp; nvert[k+1][j][i]&gt;ibmval)) ucor[k][j][i].z=0.0;</div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;    }</div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;      }</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;    }</div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;  }</div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160; </div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160; </div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;  DMDAVecRestoreArray(da, user-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">lCsi</a>, &amp;csi);</div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">lEta</a>, &amp;eta);</div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">lZet</a>, &amp;zet);</div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucor);</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160; </div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;  DMGlobalToLocalBegin(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;  DMGlobalToLocalEnd(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160; </div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;  <span class="comment">/* periodci boundary condition update corrected flux */</span></div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;  <span class="comment">//Mohsen Dec 2015</span></div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>, &amp;lucor);</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;  DMDAVecGetArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucor);</div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;  </div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[0]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[1]==7){</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;    <span class="keywordflow">if</span> (xs==0){</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;      i=xs;</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;      <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;    <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;      <span class="keywordflow">if</span>(j&gt;0 &amp;&amp; k&gt;0 &amp;&amp; j&lt;user-&gt;JM &amp;&amp; k&lt;user-&gt;KM){</div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;        ucor[k][j][i].x=lucor[k][j][i-2].x;  </div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;      }</div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;    }</div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;      }</div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;    }</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;  }</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[2]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[3]==7){</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;    <span class="keywordflow">if</span> (ys==0){</div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;      j=ys;</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;      <span class="keywordflow">for</span> (k=zs; k&lt;ze; k++) {</div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;    <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;      <span class="keywordflow">if</span>(i&gt;0 &amp;&amp; k&gt;0 &amp;&amp; i&lt;user-&gt;IM &amp;&amp; k&lt;user-&gt;KM){</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;        ucor[k][j][i].y=lucor[k][j-2][i].y;</div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;      }</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;    }</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;      }</div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;    }</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;  }</div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;  <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[4]==7 || user-&gt;<a class="code" href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">bctype</a>[5]==7){</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;    <span class="keywordflow">if</span> (zs==0){</div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;      k=zs;</div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;      <span class="keywordflow">for</span> (j=ys; j&lt;ye; j++) {</div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;    <span class="keywordflow">for</span> (i=xs; i&lt;xe; i++) {</div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;      <span class="keywordflow">if</span>(i&gt;0 &amp;&amp; j&gt;0 &amp;&amp; i&lt;user-&gt;IM &amp;&amp; j&lt;user-&gt;JM){</div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;        ucor[k][j][i].z=lucor[k-2][j][i].z;</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;      }</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;    }</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;      }</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;    }</div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;  }</div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>, &amp;lucor);</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;  DMDAVecRestoreArray(fda, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, &amp;ucor);</div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160; </div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(user-&gt;fda, user-&gt;lUcont, INSERT_VALUES, user-&gt;Ucont); */</span></div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(user-&gt;fda, user-&gt;lUcont, INSERT_VALUES, user-&gt;Ucont); */</span></div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;  DMGlobalToLocalBegin(user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;  DMGlobalToLocalEnd(user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>, user-&gt;<a class="code" href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">Ucont</a>, INSERT_VALUES, user-&gt;<a class="code" href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">lUcont</a>);</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160; </div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;  <span class="keywordflow">if</span> (NumberOfBodies &gt; 1) {</div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;    free(lIB_Flux);</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;    free(lIB_area);</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;    free(IB_Flux);</div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;    free(IB_Area);</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;    free(Correction);</div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;  }</div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160; </div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160; <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Exiting VolumeFlux.\n&quot;</span>);</div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;  </div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a8c4cb4c082ab40cc20db95c962fc1d5c_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="aaec10e12d0e5fba6c1f53e47d62b6efe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaec10e12d0e5fba6c1f53e47d62b6efe">&#9670;&nbsp;</a></span>FullyBlocked()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode FullyBlocked </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03761">3761</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;{</div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;  DM da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;  Vec nNvert;</div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;  DMDALocalInfo info = user-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160; </div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160; </div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;  PetscInt i, j, k;</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160; </div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;  PetscInt *KSKE = user-&gt;<a class="code" href="variables_8h.html#a24d419b8507d91d3752afe90a3ac1de5">KSKE</a>;</div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;  PetscReal ***nvert;</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;  PetscBool *Blocked;</div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160; </div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;  DMDACreateNaturalVector(da, &amp;nNvert);</div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;  DMDAGlobalToNaturalBegin(da, user-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, INSERT_VALUES, nNvert);</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;  DMDAGlobalToNaturalEnd(da, user-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, INSERT_VALUES, nNvert);</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160; </div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;  VecScatter ctx;</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;  Vec Zvert;</div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;  VecScatterCreateToZero(nNvert, &amp;ctx, &amp;Zvert);</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160; </div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;  VecScatterBegin(ctx, nNvert, Zvert, INSERT_VALUES, SCATTER_FORWARD);</div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;  VecScatterEnd(ctx, nNvert, Zvert, INSERT_VALUES, SCATTER_FORWARD);</div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160; </div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;  VecScatterDestroy(&amp;ctx);</div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;  VecDestroy(&amp;nNvert);</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160; </div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;  PetscInt rank;</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;  MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank);</div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160; </div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;  <span class="keywordflow">if</span> (!rank) {</div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160; </div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;    VecGetArray3d(Zvert, mz, my, mx, 0, 0, 0, &amp;nvert);</div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;    PetscMalloc(mx*my*<span class="keyword">sizeof</span>(PetscBool), &amp;Blocked);</div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;    <span class="keywordflow">for</span> (j=1; j&lt;my-1; j++) {</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;      <span class="keywordflow">for</span> (i=1; i&lt;mx-1; i++) {</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;    Blocked[j*mx+i] = PETSC_FALSE;</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;    <span class="keywordflow">for</span> (k=0; k&lt;mz; k++) {</div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i] &gt; 0.1) {</div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;        <span class="keywordflow">if</span> (!Blocked[j*mx+i]) {</div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;          KSKE[2*(j*mx+i)] = k;</div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;          Blocked[j*mx+i] = PETSC_TRUE;</div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;        }</div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;          KSKE[2*(j*mx+i)] = PetscMin(KSKE[2*(j*mx+i)], k);</div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;        }</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;      }</div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;    }</div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;      }</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;    }</div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160; </div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160; </div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;    user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a> = PETSC_TRUE;</div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;    <span class="keywordflow">for</span> (j=1; j&lt;my-1; j++) {</div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;      <span class="keywordflow">for</span> (i=1; i&lt;mx-1; i++) {</div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;    <span class="keywordflow">if</span> (!Blocked[j*mx+i]) {</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;      user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a> = PETSC_FALSE;</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;    }</div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;      }</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;    }</div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;    PetscFree(Blocked);</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;    VecRestoreArray3d(Zvert, mz, my, mx, 0, 0, 0, &amp;nvert);</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;    MPI_Bcast(&amp;user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a>, 1, MPI_INT, 0, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a>) {</div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;      MPI_Bcast(user-&gt;<a class="code" href="variables_8h.html#a24d419b8507d91d3752afe90a3ac1de5">KSKE</a>, 2*mx*my, MPI_INT, 0, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160; </div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;    }</div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;  }</div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;    MPI_Bcast(&amp;user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a>, 1, MPI_INT, 0, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a>) {</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;      MPI_Bcast(user-&gt;<a class="code" href="variables_8h.html#a24d419b8507d91d3752afe90a3ac1de5">KSKE</a>, 2*mx*my, MPI_INT, 0, PETSC_COMM_WORLD);</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;    }</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;  }</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160; </div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160; </div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160; </div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;  VecDestroy(&amp;Zvert);</div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_aaec10e12d0e5fba6c1f53e47d62b6efe_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a0f0addfc422c642ad5eb5315ace4ff2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0f0addfc422c642ad5eb5315ace4ff2f">&#9670;&nbsp;</a></span>MyNvertRestriction()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode MyNvertRestriction </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user_c</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03844">3844</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;{</div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;  <span class="comment">//  DA        da = user_c-&gt;da, fda = user_c-&gt;fda;</span></div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160; </div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160; </div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160; </div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;  DMDALocalInfo info = user_c-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>;</div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;  PetscInt  xs = info.xs, xe = info.xs + info.xm;</div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;  PetscInt      ys = info.ys, ye = info.ys + info.ym;</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;  PetscInt  zs = info.zs, ze = info.zs + info.zm;</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;  PetscInt  mx = info.mx, my = info.my, mz = info.mz;</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160; </div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;  PetscInt i,j,k;</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;  PetscInt ih, jh, kh, ia, ja, ka;</div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;  PetscInt  lxs, lxe, lys, lye, lzs, lze;</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160; </div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;  PetscReal ***nvert, ***nvert_h;</div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160; </div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;  DMDAVecGetArray(user_h-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_h-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert_h);</div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;  DMDAVecGetArray(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160; </div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;  lxs = xs; lxe = xe;</div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;  lys = ys; lye = ye;</div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;  lzs = zs; lze = ze;</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160; </div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;  <span class="keywordflow">if</span> (xs==0) lxs = xs+1;</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;  <span class="keywordflow">if</span> (ys==0) lys = ys+1;</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;  <span class="keywordflow">if</span> (zs==0) lzs = zs+1;</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160; </div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;  <span class="keywordflow">if</span> (xe==mx) lxe = xe-1;</div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;  <span class="keywordflow">if</span> (ye==my) lye = ye-1;</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;  <span class="keywordflow">if</span> (ze==mz) lze = ze-1;</div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160; </div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;  <span class="keywordflow">if</span> ((user_c-&gt;<a class="code" href="variables_8h.html#a03772da847da737415fd5a86a97147bd">isc</a>)) ia = 0;</div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;  <span class="keywordflow">else</span> ia = 1;</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160; </div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;  <span class="keywordflow">if</span> ((user_c-&gt;<a class="code" href="variables_8h.html#a5fd8588302a68eca03d086e01e8972c1">jsc</a>)) ja = 0;</div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;  <span class="keywordflow">else</span> ja = 1;</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160; </div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;  <span class="keywordflow">if</span> ((user_c-&gt;<a class="code" href="variables_8h.html#a3e8bcd710c619c329608b6f7da5f1ea1">ksc</a>)) ka = 0;</div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;  <span class="keywordflow">else</span> ka = 1;</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160; </div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;  VecSet(user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, 0.);</div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;  <span class="keywordflow">if</span> (user_c-&gt;<a class="code" href="variables_8h.html#a99a88d89d58073bd134175f62213c528">thislevel</a> &gt; 0) {</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;      <a class="code" href="poisson_8c.html#afe58ccf2bd0a359903645f7a0ee76485">GridRestriction</a>(i, j, k, &amp;ih, &amp;jh, &amp;kh, user_c);</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;      <span class="keywordflow">if</span> (nvert_h[kh   ][jh   ][ih   ] *</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;          nvert_h[kh   ][jh   ][ih-ia] *</div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;          nvert_h[kh   ][jh-ja][ih   ] *</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;          nvert_h[kh-ka][jh   ][ih   ] *</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;          nvert_h[kh   ][jh-ja][ih-ia] *</div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;          nvert_h[kh-ka][jh   ][ih-ia] *</div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;          nvert_h[kh-ka][jh-ja][ih   ] *</div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;          nvert_h[kh-ka][jh-ja][ih-ia] &gt; 0.1) {</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;        nvert[k][j][i] = PetscMax(1., nvert[k][j][i]);</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;      }</div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;    }</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;      }</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;    }</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;  }</div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;    <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;      <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;    <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;      <a class="code" href="poisson_8c.html#afe58ccf2bd0a359903645f7a0ee76485">GridRestriction</a>(i, j, k, &amp;ih, &amp;jh, &amp;kh, user_c);</div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;      <span class="keywordflow">if</span> (nvert_h[kh   ][jh   ][ih   ] *</div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;          nvert_h[kh   ][jh   ][ih-ia] *</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;          nvert_h[kh   ][jh-ja][ih   ] *</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;          nvert_h[kh-ka][jh   ][ih   ] *</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;          nvert_h[kh   ][jh-ja][ih-ia] *</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;          nvert_h[kh-ka][jh   ][ih-ia] *</div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;          nvert_h[kh-ka][jh-ja][ih   ] *</div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;          nvert_h[kh-ka][jh-ja][ih-ia] &gt; 0.1) {</div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;        nvert[k][j][i] = PetscMax(1., nvert[k][j][i]);</div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;      }</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;    }</div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;      }</div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;    }</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;  }</div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;  DMDAVecRestoreArray(user_h-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_h-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert_h);</div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;  DMDAVecRestoreArray(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160; </div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;  DMGlobalToLocalBegin(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, INSERT_VALUES, user_c-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>);</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;  DMGlobalToLocalEnd(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, INSERT_VALUES, user_c-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>);</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;  <span class="comment">//Mohsen Dec 2015</span></div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;  DMDAVecGetArray(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;  DMDAVecGetArray(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, &amp;nvert_h);</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160; </div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;  <span class="keywordflow">for</span> (k=lzs; k&lt;lze; k++) {</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;    <span class="keywordflow">for</span> (j=lys; j&lt;lye; j++) {</div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;      <span class="keywordflow">for</span> (i=lxs; i&lt;lxe; i++) {</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;    <span class="keywordflow">if</span> (nvert_h[k][j][i] &lt; 0.1) {</div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;      <span class="keywordflow">if</span> (nvert[k][j][i+1] + nvert[k][j][i-1] &gt; 1.1 &amp;&amp;</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;          nvert[k][j+1][i] + nvert[k][j-1][i] &gt; 1.1 &amp;&amp;</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;          nvert[k+1][j][i] + nvert[k-1][j][i] &gt; 1.1) {</div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;        nvert_h[k][j][i] = 1.;</div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;      }</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;    }</div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;      }</div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;    }</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;  }</div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160; </div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;  DMDAVecRestoreArray(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>, &amp;nvert);</div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;  DMDAVecRestoreArray(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, &amp;nvert_h);</div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;  DMGlobalToLocalBegin(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, INSERT_VALUES, user_c-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>);</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;  DMGlobalToLocalEnd(user_c-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, user_c-&gt;<a class="code" href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">Nvert</a>, INSERT_VALUES, user_c-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>);</div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160; <span class="comment">/*  DMLocalToGlobalBegin(user_c-&gt;da, user_c-&gt;lNvert, INSERT_VALUES, user_c-&gt;Nvert); */</span></div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;<span class="comment">/*   DMLocalToGlobalEnd(user_c-&gt;da, user_c-&gt;lNvert, INSERT_VALUES, user_c-&gt;Nvert); */</span></div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_a0f0addfc422c642ad5eb5315ace4ff2f_cgraph.svg" width="326" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="poisson_8c_a0f0addfc422c642ad5eb5315ace4ff2f_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="acfdf6d56006b1b5f68d400deb6cf0959"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acfdf6d56006b1b5f68d400deb6cf0959">&#9670;&nbsp;</a></span>PoissonSolver_MG()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PoissonSolver_MG </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserMG">UserMG</a> *&#160;</td>
          <td class="paramname"><em>usermg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Solves the pressure-Poisson equation using a geometric multigrid method. </p>
<p>This function orchestrates the entire multigrid V-cycle for the pressure correction equation. It assembles the Laplacian matrix on all grid levels, sets up the KSP solvers, smoothers, restriction/interpolation operators, and executes the solve.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usermg</td><td>The <a class="el" href="variables_8h.html#structUserMG" title="User-level context for managing the entire multigrid hierarchy.">UserMG</a> context containing the entire multigrid hierarchy. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. </dd></dl>

<p class="definition">Definition at line <a class="el" href="poisson_8c_source.html#l03959">3959</a> of file <a class="el" href="poisson_8c_source.html">poisson.c</a>.</p>
<div class="fragment"><div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;{</div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;    <span class="comment">// --- CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;    <span class="comment">// Get the master simulation context from the first block&#39;s UserCtx on the finest level.</span></div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;    <span class="comment">// This provides access to all former global variables.</span></div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;    <a class="code" href="variables_8h.html#structSimCtx">SimCtx</a> *simCtx = usermg-&gt;<a class="code" href="variables_8h.html#ada85203a98a3e4ce033b630fd6a1b695">mgctx</a>[0].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>[0].<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>;</div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160; </div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;    <span class="comment">// Create local variables to mirror the legacy globals for minimal code changes.</span></div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;    <span class="keyword">const</span> PetscInt block_number = simCtx-&gt;<a class="code" href="variables_8h.html#a22580e0e52ca8ddccc76d24c96f00e4a">block_number</a>;</div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;    <span class="keyword">const</span> PetscInt immersed = simCtx-&gt;<a class="code" href="variables_8h.html#aef90766eec6fc6887cd39bd1d79cb6d2">immersed</a>;</div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;    <span class="keyword">const</span> PetscInt MHV = simCtx-&gt;<a class="code" href="variables_8h.html#a02fd03c4c166911f067e92b36d1820a3">MHV</a>;</div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;    <span class="keyword">const</span> PetscInt LV = simCtx-&gt;<a class="code" href="variables_8h.html#a1bec6eafffafc2eecc2efb4377e6fed1">LV</a>;</div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;    PetscMPIInt rank = simCtx-&gt;<a class="code" href="variables_8h.html#a19aa807b9181b13618527d6c4eb6fa89">rank</a>;</div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;    <span class="comment">// --- END CONTEXT ACQUISITION BLOCK ---</span></div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160; </div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;    PetscInt l, bi;</div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;    <a class="code" href="variables_8h.html#structMGCtx">MGCtx</a> *mgctx = usermg-&gt;<a class="code" href="variables_8h.html#ada85203a98a3e4ce033b630fd6a1b695">mgctx</a>;</div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;    KSP mgksp, subksp;</div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;    PC mgpc, subpc;</div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;    <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *user;</div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160; </div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;    PetscFunctionBeginUser; <span class="comment">// Moved to after variable declarations</span></div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Starting Multigrid Poisson Solve...\n&quot;</span>);</div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160; </div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;    <span class="keywordflow">for</span> (bi = 0; bi &lt; block_number; bi++) {</div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;        </div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;        <span class="comment">// ====================================================================</span></div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;        <span class="comment">//   SECTION: Immersed Boundary Specific Setup (Conditional)</span></div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;        <span class="comment">// ====================================================================</span></div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;        <span class="keywordflow">if</span> (immersed) {</div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;            <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Block %d: Performing IBM pre-solve setup (Nvert restriction, etc.).\n&quot;</span>, bi);</div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;            <span class="keywordflow">for</span> (l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1; l &gt; 0; l--) {</div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;                mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>[bi].<a class="code" href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">multinullspace</a> = PETSC_FALSE;</div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;                <a class="code" href="poisson_8c.html#a0f0addfc422c642ad5eb5315ace4ff2f">MyNvertRestriction</a>(&amp;mgctx[l].user[bi], &amp;mgctx[l-1].user[bi]);</div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;            }</div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;            <span class="comment">// Coarsest level check for disconnected domains due to IBM</span></div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;            l = 0;</div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;            user = mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>;</div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;            ierr = PetscMalloc1(user[bi].info.mx * user[bi].info.my * 2, &amp;user[bi].KSKE); CHKERRQ(ierr);</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;            <a class="code" href="poisson_8c.html#aaec10e12d0e5fba6c1f53e47d62b6efe">FullyBlocked</a>(&amp;user[bi]);</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;        }</div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;        </div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160; </div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;        l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1;</div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;        user = mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>;</div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;        </div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;        <span class="comment">// --- 1. Compute RHS of the Poisson Equation ---</span></div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Block %d: Computing Poisson RHS...\n&quot;</span>, bi);</div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;        ierr = VecDuplicate(user[bi].P, &amp;user[bi].B); CHKERRQ(ierr);</div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;        </div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;        PetscReal ibm_Flux, ibm_Area;</div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;        PetscInt flg = immersed - 1;</div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160; </div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;        <span class="comment">// Calculate volume flux source terms (often from IBM)</span></div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;        <a class="code" href="poisson_8c.html#a8c4cb4c082ab40cc20db95c962fc1d5c">VolumeFlux</a>(&amp;user[bi], &amp;ibm_Flux, &amp;ibm_Area, flg);</div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;        <span class="keywordflow">if</span> (MHV || LV) {</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;            flg = ((MHV &gt; 1 || LV) &amp;&amp; bi == 0) ? 1 : 0;</div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;            <a class="code" href="poisson_8c.html#a34f6242556bffd27f00a84b377c1bf9d">VolumeFlux_rev</a>(&amp;user[bi], &amp;ibm_Flux, &amp;ibm_Area, flg);</div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;        }</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;        <span class="comment">// Calculate the main divergence term</span></div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;        <a class="code" href="poisson_8c.html#a9340445ae2c0a3c7be290e2a1aea3d67">PoissonRHS</a>(&amp;user[bi], user[bi].B);</div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;        </div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;        <span class="comment">// --- 2. Assemble LHS Matrix (Laplacian) on all MG levels ---</span></div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Block %d: Assembling Poisson LHS on all levels...\n&quot;</span>, bi);</div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;        <span class="keywordflow">for</span> (l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1; l &gt;= 0; l--) {</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;            user = mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>;</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; Calculating LHS for Level %d.\n&quot;</span>,l);</div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;            <a class="code" href="poisson_8c.html#a26f0e6321b7ace56b3b105e1eb10475e">PoissonLHSNew</a>(&amp;user[bi]);</div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;        }</div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160; </div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;        <span class="comment">// --- 3. Setup PETSc KSP and PCMG (Multigrid Preconditioner) ---</span></div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Block %d: Configuring KSP and PCMG...\n&quot;</span>, bi);</div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160; </div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;    ierr = KSPCreate(PETSC_COMM_WORLD, &amp;mgksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;        ierr = KSPAppendOptionsPrefix(mgksp, <span class="stringliteral">&quot;ps_&quot;</span>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160; </div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;    <span class="comment">// =======================================================================</span></div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;        <a class="code" href="logging_8h.html#structDualMonitorCtx">DualMonitorCtx</a> *monctx;</div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;        <span class="keywordtype">char</span>           filen[128];</div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;        PetscBool      has_monitor_option;</div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160; </div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;        <span class="comment">// 1. Allocate the context and set it up.</span></div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;        ierr = PetscNew(&amp;monctx); CHKERRQ(ierr);</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160; </div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;    monctx-&gt;<a class="code" href="logging_8h.html#a64100408e773bad5a0c07581dc3ab039">step</a> = simCtx-&gt;<a class="code" href="variables_8h.html#ac9684d6e871566d55c997416270b5b99">step</a>;</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;    monctx-&gt;<a class="code" href="logging_8h.html#aeb27d528b5c766bb8c213bb2112a79f6">block_id</a> = bi;</div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;    monctx-&gt;<a class="code" href="logging_8h.html#ae5af09d0145fba810375f6a2069c7098">file_handle</a> = NULL;</div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160; </div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;    <span class="comment">// Only rank 0 handles the file.</span></div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;        <span class="keywordflow">if</span> (!rank) {</div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;      sprintf(filen, <span class="stringliteral">&quot;%s/Poisson_Solver_Convergence_History_Block_%d.log&quot;</span>, simCtx-&gt;<a class="code" href="variables_8h.html#a922566a9e001486fa838d96925a6f102">log_dir</a>,bi);</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;      <span class="comment">// On the very first step of the entire simulation, TRUNCATE the file.</span></div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;      <span class="keywordflow">if</span> (simCtx-&gt;<a class="code" href="variables_8h.html#ac9684d6e871566d55c997416270b5b99">step</a> == simCtx-&gt;<a class="code" href="variables_8h.html#a6a5533a086f46652d5587ae84ec62c9f">StartStep</a>) {</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;        monctx-&gt;<a class="code" href="logging_8h.html#ae5af09d0145fba810375f6a2069c7098">file_handle</a> = fopen(filen, <span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;      } <span class="keywordflow">else</span> { <span class="comment">// For all subsequent steps, APPEND to the file.</span></div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;        monctx-&gt;<a class="code" href="logging_8h.html#ae5af09d0145fba810375f6a2069c7098">file_handle</a> = fopen(filen, <span class="stringliteral">&quot;a&quot;</span>);</div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;      }</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160; </div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;            <span class="keywordflow">if</span> (monctx-&gt;<a class="code" href="logging_8h.html#ae5af09d0145fba810375f6a2069c7098">file_handle</a>) {</div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;                PetscFPrintf(PETSC_COMM_SELF, monctx-&gt;<a class="code" href="logging_8h.html#ae5af09d0145fba810375f6a2069c7098">file_handle</a>, <span class="stringliteral">&quot;--- Convergence for Timestep %d, Block %d ---\n&quot;</span>, (<span class="keywordtype">int</span>)simCtx-&gt;<a class="code" href="variables_8h.html#ac9684d6e871566d55c997416270b5b99">step</a>, bi);</div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;                SETERRQ1(PETSC_COMM_SELF, PETSC_ERR_FILE_OPEN, <span class="stringliteral">&quot;Could not open KSP monitor log file: %s&quot;</span>, filen);</div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;            }</div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;        }</div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160; </div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;        ierr = PetscOptionsHasName(NULL, NULL, <span class="stringliteral">&quot;-ps_ksp_pic_monitor_true_residual&quot;</span>, &amp;has_monitor_option); CHKERRQ(ierr);</div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;        monctx-&gt;<a class="code" href="logging_8h.html#a34c7203eac55e4ac9f075e106a7afe5f">log_to_console</a> = has_monitor_option;</div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160; </div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;        ierr = KSPMonitorSet(mgksp, <a class="code" href="logging_8h.html#ab0414bd7dfd804d39019da707808a819">DualKSPMonitor</a>, monctx, <a class="code" href="logging_8h.html#a26f628c9bae473d94674a1a97641b474">DualMonitorDestroy</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;        <span class="comment">// =======================================================================</span></div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;    </div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;        ierr = KSPGetPC(mgksp, &amp;mgpc); CHKERRQ(ierr);</div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;        ierr = PCSetType(mgpc, PCMG); CHKERRQ(ierr);</div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160; </div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;    ierr = PCMGSetLevels(mgpc, usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a>, PETSC_NULL); CHKERRQ(ierr);</div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;        ierr = PCMGSetCycleType(mgpc, PC_MG_CYCLE_V); CHKERRQ(ierr);</div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;        ierr = PCMGSetType(mgpc, PC_MG_MULTIPLICATIVE); CHKERRQ(ierr);</div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160; </div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;        <span class="comment">// --- 4. Define Restriction and Interpolation Operators for MG ---</span></div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;        <span class="keywordflow">for</span> (l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1; l &gt; 0; l--) {</div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160; </div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;         <span class="comment">// Get stable pointers directly from the main mgctx array.</span></div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;         <span class="comment">// These pointers point to memory that will persist.</span></div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;      <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *fine_user_ctx   = &amp;mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>[bi];</div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;      <a class="code" href="variables_8h.html#structUserCtx">UserCtx</a> *coarse_user_ctx = &amp;mgctx[l-1].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>[bi];</div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160; </div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;      <span class="comment">// --- Configure the context pointers ---</span></div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;      <span class="comment">// The coarse UserCtx needs to know about the fine grid for restriction.</span></div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;      coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#a946cb0e8075672c1ffc8bd6d0b0dfe5c">da_f</a>     = &amp;(fine_user_ctx-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>);</div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;      coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#a2deb96128ed850632f645128e26e229e">user_f</a>   = fine_user_ctx;</div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160; </div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;      <span class="comment">// The fine UserCtx needs to know about the coarse grid for interpolation.</span></div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;      fine_user_ctx-&gt;<a class="code" href="variables_8h.html#a7fb47de7893b318ba4e4e12ed46c0712">da_c</a>       = &amp;(coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>);</div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;      fine_user_ctx-&gt;<a class="code" href="variables_8h.html#a8420a45c7f75054e71e9d8530e52ee8e">user_c</a>     = coarse_user_ctx;</div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;      fine_user_ctx-&gt;<a class="code" href="variables_8h.html#af21efba2f6a4f52657ce8ba6908cec7c">lNvert_c</a>   = &amp;(coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">lNvert</a>);</div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160; </div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;      <span class="comment">// --- Get matrix dimensions ---</span></div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;      PetscInt m_c = (coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.xm * coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.ym * coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.zm);</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;      PetscInt m_f = (fine_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.xm * fine_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.ym * fine_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.zm);</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;      PetscInt M_c = (coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.mx * coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.my * coarse_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.mz);</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;      PetscInt M_f = (fine_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.mx * fine_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.my * fine_user_ctx-&gt;<a class="code" href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">info</a>.mz);</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160; </div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;      <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot;level = %d; m_c = %d; m_f = %d; M_c = %d; M_f = %d.\n&quot;</span>,l,m_c,m_f,M_c,M_f);</div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;      <span class="comment">// --- Create the MatShell objects ---</span></div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;      <span class="comment">// Pass the STABLE pointer coarse_user_ctx as the context for restriction.</span></div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;      ierr = MatCreateShell(PETSC_COMM_WORLD, m_c, m_f, M_c, M_f, (<span class="keywordtype">void</span>*)coarse_user_ctx, &amp;fine_user_ctx-&gt;<a class="code" href="variables_8h.html#ad397aa8cb29c2ca1d2335b897e2f7690">MR</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;    </div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;      <span class="comment">// Pass the STABLE pointer fine_user_ctx as the context for interpolation.</span></div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;      ierr = MatCreateShell(PETSC_COMM_WORLD, m_f, m_c, M_f, M_c, (<span class="keywordtype">void</span>*)fine_user_ctx, &amp;fine_user_ctx-&gt;MP); CHKERRQ(ierr);</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;    </div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;      <span class="comment">// --- Set the operations for the MatShells ---</span></div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;      ierr = MatShellSetOperation(fine_user_ctx-&gt;<a class="code" href="variables_8h.html#ad397aa8cb29c2ca1d2335b897e2f7690">MR</a>, MATOP_MULT, (<span class="keywordtype">void</span>(*)(<span class="keywordtype">void</span>))<a class="code" href="poisson_8c.html#a85e1eff3b6e34605b863323d6336eecd">RestrictResidual_SolidAware</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;      ierr = MatShellSetOperation(fine_user_ctx-&gt;<a class="code" href="variables_8h.html#ac5212e2fb1eeb3323ab8c063aef6a498">MP</a>, MATOP_MULT, (<span class="keywordtype">void</span>(*)(<span class="keywordtype">void</span>))<a class="code" href="poisson_8c.html#aa2fc17959230252f30b2278d81a16caf">MyInterpolation</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;    </div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;      <span class="comment">// --- Register the operators with PCMG ---</span></div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;      ierr = PCMGSetRestriction(mgpc, l, fine_user_ctx-&gt;<a class="code" href="variables_8h.html#ad397aa8cb29c2ca1d2335b897e2f7690">MR</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;      ierr = PCMGSetInterpolation(mgpc, l, fine_user_ctx-&gt;<a class="code" href="variables_8h.html#ac5212e2fb1eeb3323ab8c063aef6a498">MP</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;      </div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;        }</div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;        </div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;        <span class="comment">// --- 5. Configure Solvers on Each MG Level ---</span></div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;        <span class="keywordflow">for</span> (l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1; l &gt;= 0; l--) {</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;            user = mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>;</div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;            <span class="keywordflow">if</span> (l &gt; 0) { <span class="comment">// Smoother for fine levels</span></div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;                ierr = PCMGGetSmoother(mgpc, l, &amp;subksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;            } <span class="keywordflow">else</span> { <span class="comment">// Direct or iterative solver for the coarsest level</span></div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;                ierr = PCMGGetCoarseSolve(mgpc, &amp;subksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;                ierr = KSPSetTolerances(subksp, 1.e-8, PETSC_DEFAULT, PETSC_DEFAULT, 40); CHKERRQ(ierr);</div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;            } </div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;            </div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;            ierr = KSPSetOperators(subksp, user[bi].A, user[bi].A); CHKERRQ(ierr);</div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;        ierr = KSPSetFromOptions(subksp); CHKERRQ(ierr); </div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;            ierr = KSPGetPC(subksp, &amp;subpc); CHKERRQ(ierr);</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;        ierr = PCSetType(subpc, PCBJACOBI); CHKERRQ(ierr);</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;        </div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;        KSP *subsubksp;</div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;        PC subsubpc;</div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;        PetscInt nlocal;</div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160; </div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;        <span class="comment">// This logic is required for both the smoother and the coarse solve</span></div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;        <span class="comment">// since both use PCBJACOBI.</span></div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;        ierr = KSPSetUp(subksp); CHKERRQ(ierr); <span class="comment">// Set up KSP to allow access to sub-KSPs</span></div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;        ierr = PCBJacobiGetSubKSP(subpc, &amp;nlocal, NULL, &amp;subsubksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160; </div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;        <span class="keywordflow">for</span> (PetscInt abi = 0; abi &lt; nlocal; abi++) {</div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;          ierr = KSPGetPC(subsubksp[abi], &amp;subsubpc); CHKERRQ(ierr);</div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;          <span class="comment">// Add the critical shift amount</span></div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;          ierr = PCFactorSetShiftAmount(subsubpc, 1.e-10); CHKERRQ(ierr);</div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;        }</div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;        </div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;        ierr = MatNullSpaceCreate(PETSC_COMM_WORLD, PETSC_TRUE, 0, PETSC_NULL, &amp;user[bi].nullsp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;            ierr = MatNullSpaceSetFunction(user[bi].nullsp, <a class="code" href="poisson_8c.html#a2648a0c6cafb7916a706cd757e5b92f5">PoissonNullSpaceFunction</a>, &amp;user[bi]); CHKERRQ(ierr);</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;            ierr = MatSetNullSpace(user[bi].A, user[bi].nullsp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;            </div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;            ierr = PCMGSetResidual(mgpc, l, PCMGResidualDefault, user[bi].A); CHKERRQ(ierr);</div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;            ierr = KSPSetUp(subksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160; </div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;            <span class="keywordflow">if</span> (l &lt; usermg-&gt;mglevels - 1) {</div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;                ierr = MatCreateVecs(user[bi].A, &amp;user[bi].R, PETSC_NULL); CHKERRQ(ierr);</div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;                ierr = PCMGSetRhs(mgpc, l, user[bi].R); CHKERRQ(ierr);</div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;            }</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;        }</div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160; </div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;        <span class="comment">// --- 6. Set Final KSP Operators and Solve ---</span></div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;        l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1;</div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;        user = mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>;</div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;        </div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Block %d: Setting KSP operators and solving...\n&quot;</span>, bi);</div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;        ierr = KSPSetOperators(mgksp, user[bi].A, user[bi].A); CHKERRQ(ierr);</div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;        ierr = MatSetNullSpace(user[bi].A, user[bi].nullsp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;        ierr = KSPSetFromOptions(mgksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;        ierr = KSPSetUp(mgksp); CHKERRQ(ierr);</div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;        ierr = KSPSolve(mgksp, user[bi].B, user[bi].Phi); CHKERRQ(ierr);</div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160; </div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;        <span class="comment">// --- 7. Cleanup for this block ---</span></div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;        <span class="keywordflow">for</span> (l = usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a> - 1; l &gt;= 0; l--) {</div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;            user = mgctx[l].<a class="code" href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">user</a>;</div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;            MatNullSpaceDestroy(&amp;user[bi].nullsp);</div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;            MatDestroy(&amp;user[bi].A);</div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;            user[bi].<a class="code" href="variables_8h.html#a41951f47cfbe9c08def29998a76dc791">assignedA</a> = PETSC_FALSE;</div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;            <span class="keywordflow">if</span> (l &gt; 0) {</div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;                MatDestroy(&amp;user[bi].MR);</div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;                MatDestroy(&amp;user[bi].MP);</div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l==0 &amp;&amp; immersed) {</div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;                PetscFree(user[bi].KSKE);</div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;            }</div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;            <span class="keywordflow">if</span> (l &lt; usermg-&gt;mglevels - 1) {</div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;                VecDestroy(&amp;user[bi].R);</div>
<div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;            }</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;        }</div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;        </div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;        KSPDestroy(&amp;mgksp);</div>
<div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;        VecDestroy(&amp;mgctx[usermg-&gt;<a class="code" href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">mglevels</a>-1].user[bi].B);</div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;        </div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;    } <span class="comment">// End of loop over blocks</span></div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160; </div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Multigrid Poisson Solve complete.\n&quot;</span>);</div>
<div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_acfdf6d56006b1b5f68d400deb6cf0959_cgraph.svg" width="576" height="544"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="poisson_8c_acfdf6d56006b1b5f68d400deb6cf0959_icgraph.svg" width="602" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="avariables_8h_html_aee8a3f32f3bdc0dda2f862651708c0f4"><div class="ttname"><a href="variables_8h.html#aee8a3f32f3bdc0dda2f862651708c0f4">UserCtx::lKAj</a></div><div class="ttdeci">Vec lKAj</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00704">variables.h:704</a></div></div>
<div class="ttc" id="avariables_8h_html_ada2db2a63cf3a9fe7ad2abf01cedc818"><div class="ttname"><a href="variables_8h.html#ada2db2a63cf3a9fe7ad2abf01cedc818">UserCtx::Nvert</a></div><div class="ttdeci">Vec Nvert</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_ad032e456f7f4b32b9ac0d94be05de204"><div class="ttname"><a href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">Cmpnts::y</a></div><div class="ttdeci">PetscScalar y</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00101">variables.h:101</a></div></div>
<div class="ttc" id="avariables_8h_html_a69c3a361d1aac3bdc14f971bda57e032"><div class="ttname"><a href="variables_8h.html#a69c3a361d1aac3bdc14f971bda57e032">UserCtx::Ucont</a></div><div class="ttdeci">Vec Ucont</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="apoisson_8c_html_a580a88f98668df1ac5e1683cae31c0b3"><div class="ttname"><a href="poisson_8c.html#a580a88f98668df1ac5e1683cae31c0b3">BS</a></div><div class="ttdeci">#define BS</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00903">poisson.c:903</a></div></div>
<div class="ttc" id="avariables_8h_html_aac8e0dd714804b073dbb32c0ad84b2eb"><div class="ttname"><a href="variables_8h.html#aac8e0dd714804b073dbb32c0ad84b2eb">UserMG::mglevels</a></div><div class="ttdeci">PetscInt mglevels</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00434">variables.h:434</a></div></div>
<div class="ttc" id="apoisson_8c_html_a84909b16209480034c40276c4f84f975"><div class="ttname"><a href="poisson_8c.html#a84909b16209480034c40276c4f84f975">BW</a></div><div class="ttdeci">#define BW</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00907">poisson.c:907</a></div></div>
<div class="ttc" id="avariables_8h_html_a2276cb159119246bfadea1c234dee31b"><div class="ttname"><a href="variables_8h.html#a2276cb159119246bfadea1c234dee31b">UserCtx::lIEta</a></div><div class="ttdeci">Vec lIEta</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00702">variables.h:702</a></div></div>
<div class="ttc" id="avariables_8h_html_ae0a7a10f0bc2adac4b621178b64aa6f6"><div class="ttname"><a href="variables_8h.html#ae0a7a10f0bc2adac4b621178b64aa6f6">UserCtx::multinullspace</a></div><div class="ttdeci">PetscBool multinullspace</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00693">variables.h:693</a></div></div>
<div class="ttc" id="apoisson_8c_html_a78add0c4a98afa82e663ee5cfb1bdc9f"><div class="ttname"><a href="poisson_8c.html#a78add0c4a98afa82e663ee5cfb1bdc9f">BE</a></div><div class="ttdeci">#define BE</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00905">poisson.c:905</a></div></div>
<div class="ttc" id="apoisson_8c_html_af972ebfdd064fdb489daf84443a12f35"><div class="ttname"><a href="poisson_8c.html#af972ebfdd064fdb489daf84443a12f35">TP</a></div><div class="ttdeci">#define TP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00892">poisson.c:892</a></div></div>
<div class="ttc" id="avariables_8h_html_ad744b47ca3c5f3df2d1b737e432d6f07"><div class="ttname"><a href="variables_8h.html#ad744b47ca3c5f3df2d1b737e432d6f07">UserCtx::Cent</a></div><div class="ttdeci">Vec Cent</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00700">variables.h:700</a></div></div>
<div class="ttc" id="avariables_8h_html_af0af02fbd08daea87f3523a3754981f0"><div class="ttname"><a href="variables_8h.html#af0af02fbd08daea87f3523a3754981f0">COEF_TIME_ACCURACY</a></div><div class="ttdeci">#define COEF_TIME_ACCURACY</div><div class="ttdoc">Coefficient controlling the temporal accuracy scheme (e.g., 1.5 for BDF2).</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00057">variables.h:57</a></div></div>
<div class="ttc" id="avariables_8h_html_ac9684d6e871566d55c997416270b5b99"><div class="ttname"><a href="variables_8h.html#ac9684d6e871566d55c997416270b5b99">SimCtx::step</a></div><div class="ttdeci">PetscInt step</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00546">variables.h:546</a></div></div>
<div class="ttc" id="avariables_8h_html_a3e8bcd710c619c329608b6f7da5f1ea1"><div class="ttname"><a href="variables_8h.html#a3e8bcd710c619c329608b6f7da5f1ea1">UserCtx::ksc</a></div><div class="ttdeci">PetscInt ksc</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00670">variables.h:670</a></div></div>
<div class="ttc" id="avariables_8h_html_a2e1d74f612f5443c8ece068511563453"><div class="ttname"><a href="variables_8h.html#a2e1d74f612f5443c8ece068511563453">SimCtx::channelz</a></div><div class="ttdeci">PetscInt channelz</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00589">variables.h:589</a></div></div>
<div class="ttc" id="apoisson_8c_html_a6594e57d1fff186da0a254a3742dcff7"><div class="ttname"><a href="poisson_8c.html#a6594e57d1fff186da0a254a3742dcff7">CP</a></div><div class="ttdeci">#define CP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00886">poisson.c:886</a></div></div>
<div class="ttc" id="avariables_8h_html_a322702c716e6e140d71515d0b3e111b1"><div class="ttname"><a href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">UserCtx::simCtx</a></div><div class="ttdeci">SimCtx * simCtx</div><div class="ttdoc">Back-pointer to the master simulation context.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00660">variables.h:660</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a></div><div class="ttdeci">@ LOG_DEBUG</div><div class="ttdoc">Detailed debugging information.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00033">logging.h:33</a></div></div>
<div class="ttc" id="avariables_8h_html_a8420a45c7f75054e71e9d8530e52ee8e"><div class="ttname"><a href="variables_8h.html#a8420a45c7f75054e71e9d8530e52ee8e">UserCtx::user_c</a></div><div class="ttdeci">UserCtx * user_c</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00717">variables.h:717</a></div></div>
<div class="ttc" id="avariables_8h_html_aef90766eec6fc6887cd39bd1d79cb6d2"><div class="ttname"><a href="variables_8h.html#aef90766eec6fc6887cd39bd1d79cb6d2">SimCtx::immersed</a></div><div class="ttdeci">PetscInt immersed</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00563">variables.h:563</a></div></div>
<div class="ttc" id="alogging_8h_html_ab0414bd7dfd804d39019da707808a819"><div class="ttname"><a href="logging_8h.html#ab0414bd7dfd804d39019da707808a819">DualKSPMonitor</a></div><div class="ttdeci">PetscErrorCode DualKSPMonitor(KSP ksp, PetscInt it, PetscReal rnorm, void *ctx)</div><div class="ttdoc">A custom KSP monitor that logs to a file and optionally to the console.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8c_source.html#l00778">logging.c:778</a></div></div>
<div class="ttc" id="avariables_8h_html_a718a09fbedf450248eaf7019a980e139"><div class="ttname"><a href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">Cmpnts::x</a></div><div class="ttdeci">PetscScalar x</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00101">variables.h:101</a></div></div>
<div class="ttc" id="avariables_8h_html_a5a73aa2bc6be44bc1ff8847cf0a1b6af"><div class="ttname"><a href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">UserCtx::P</a></div><div class="ttdeci">Vec P</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_a6a5533a086f46652d5587ae84ec62c9f"><div class="ttname"><a href="variables_8h.html#a6a5533a086f46652d5587ae84ec62c9f">SimCtx::StartStep</a></div><div class="ttdeci">PetscInt StartStep</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00548">variables.h:548</a></div></div>
<div class="ttc" id="apoisson_8c_html_aecd69d9a67487cc45c38eb184c50538a"><div class="ttname"><a href="poisson_8c.html#aecd69d9a67487cc45c38eb184c50538a">SP</a></div><div class="ttdeci">#define SP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00891">poisson.c:891</a></div></div>
<div class="ttc" id="avariables_8h_html_a1bec6eafffafc2eecc2efb4377e6fed1"><div class="ttname"><a href="variables_8h.html#a1bec6eafffafc2eecc2efb4377e6fed1">SimCtx::LV</a></div><div class="ttdeci">PetscInt LV</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00568">variables.h:568</a></div></div>
<div class="ttc" id="apoisson_8c_html_a3d538200fed5b9ee9d1ef391bb61036c"><div class="ttname"><a href="poisson_8c.html#a3d538200fed5b9ee9d1ef391bb61036c">Gidx</a></div><div class="ttdeci">static PetscInt Gidx(PetscInt i, PetscInt j, PetscInt k, UserCtx *user)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00833">poisson.c:833</a></div></div>
<div class="ttc" id="apoisson_8c_html_afe58ccf2bd0a359903645f7a0ee76485"><div class="ttname"><a href="poisson_8c.html#afe58ccf2bd0a359903645f7a0ee76485">GridRestriction</a></div><div class="ttdeci">static PetscErrorCode GridRestriction(PetscInt i, PetscInt j, PetscInt k, PetscInt *ih, PetscInt *jh, PetscInt *kh, UserCtx *user)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00853">poisson.c:853</a></div></div>
<div class="ttc" id="apoisson_8c_html_a26f0e6321b7ace56b3b105e1eb10475e"><div class="ttname"><a href="poisson_8c.html#a26f0e6321b7ace56b3b105e1eb10475e">PoissonLHSNew</a></div><div class="ttdeci">PetscErrorCode PoissonLHSNew(UserCtx *user)</div><div class="ttdoc">Assembles the Left-Hand Side (LHS) matrix for the Pressure Poisson Equation.</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l02207">poisson.c:2207</a></div></div>
<div class="ttc" id="apoisson_8c_html_a0f0addfc422c642ad5eb5315ace4ff2f"><div class="ttname"><a href="poisson_8c.html#a0f0addfc422c642ad5eb5315ace4ff2f">MyNvertRestriction</a></div><div class="ttdeci">PetscErrorCode MyNvertRestriction(UserCtx *user_h, UserCtx *user_c)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l03844">poisson.c:3844</a></div></div>
<div class="ttc" id="apoisson_8c_html_aaec10e12d0e5fba6c1f53e47d62b6efe"><div class="ttname"><a href="poisson_8c.html#aaec10e12d0e5fba6c1f53e47d62b6efe">FullyBlocked</a></div><div class="ttdeci">PetscErrorCode FullyBlocked(UserCtx *user)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l03761">poisson.c:3761</a></div></div>
<div class="ttc" id="avariables_8h_html_structSimCtx"><div class="ttname"><a href="variables_8h.html#structSimCtx">SimCtx</a></div><div class="ttdoc">The master context for the entire simulation.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00538">variables.h:538</a></div></div>
<div class="ttc" id="avariables_8h_html_ace2eeedc863d73caaf51bb83aa993e44"><div class="ttname"><a href="variables_8h.html#ace2eeedc863d73caaf51bb83aa993e44">UserCtx::lUcat</a></div><div class="ttdeci">Vec lUcat</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_a41951f47cfbe9c08def29998a76dc791"><div class="ttname"><a href="variables_8h.html#a41951f47cfbe9c08def29998a76dc791">UserCtx::assignedA</a></div><div class="ttdeci">PetscBool assignedA</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00696">variables.h:696</a></div></div>
<div class="ttc" id="avariables_8h_html_a96938d329a797441f228ecddd8e8e607"><div class="ttname"><a href="variables_8h.html#a96938d329a797441f228ecddd8e8e607">UserCtx::lJEta</a></div><div class="ttdeci">Vec lJEta</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00703">variables.h:703</a></div></div>
<div class="ttc" id="apoisson_8c_html_af9cccf331f045b89a9f12366df5f7687"><div class="ttname"><a href="poisson_8c.html#af9cccf331f045b89a9f12366df5f7687">NW</a></div><div class="ttdeci">#define NW</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00898">poisson.c:898</a></div></div>
<div class="ttc" id="alogging_8h_html_a3758dd5d300a594312c95bc393378df0"><div class="ttname"><a href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a></div><div class="ttdeci">#define LOCAL</div><div class="ttdoc">Logging scope definitions for controlling message output.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00044">logging.h:44</a></div></div>
<div class="ttc" id="apoisson_8c_html_a82b271e081de4cfb35eb87b0c13dddba"><div class="ttname"><a href="poisson_8c.html#a82b271e081de4cfb35eb87b0c13dddba">BP</a></div><div class="ttdeci">#define BP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00893">poisson.c:893</a></div></div>
<div class="ttc" id="apoisson_8c_html_a91c0a910ad7ea895ed9093c9286df2f2"><div class="ttname"><a href="poisson_8c.html#a91c0a910ad7ea895ed9093c9286df2f2">TE</a></div><div class="ttdeci">#define TE</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00904">poisson.c:904</a></div></div>
<div class="ttc" id="avariables_8h_html_a8e6283b2989fae5d0a235baa570e929f"><div class="ttname"><a href="variables_8h.html#a8e6283b2989fae5d0a235baa570e929f">UserCtx::lKZet</a></div><div class="ttdeci">Vec lKZet</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00704">variables.h:704</a></div></div>
<div class="ttc" id="avariables_8h_html_ad4296b10d8eb7b065165582f5cc85897"><div class="ttname"><a href="variables_8h.html#ad4296b10d8eb7b065165582f5cc85897">UserCtx::lEta</a></div><div class="ttdeci">Vec lEta</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00700">variables.h:700</a></div></div>
<div class="ttc" id="avariables_8h_html_a2f3825691b122a0bf2ed5728b70bc9b1"><div class="ttname"><a href="variables_8h.html#a2f3825691b122a0bf2ed5728b70bc9b1">UserCtx::Phi</a></div><div class="ttdeci">Vec Phi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_ad1904cdee33ebeffba809c883f7e9641"><div class="ttname"><a href="variables_8h.html#ad1904cdee33ebeffba809c883f7e9641">UserCtx::IM</a></div><div class="ttdeci">PetscInt IM</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00666">variables.h:666</a></div></div>
<div class="ttc" id="avariables_8h_html_ad29bf4d78039031aef92981faa325c94"><div class="ttname"><a href="variables_8h.html#ad29bf4d78039031aef92981faa325c94">UserCtx::FluxIntpSum</a></div><div class="ttdeci">PetscReal FluxIntpSum</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00681">variables.h:681</a></div></div>
<div class="ttc" id="alogging_8h_html_a5fe7257f46131945aacf9a35e9de5874"><div class="ttname"><a href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a></div><div class="ttdeci">#define PROFILE_FUNCTION_END</div><div class="ttdoc">Marks the end of a profiled code block.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00731">logging.h:731</a></div></div>
<div class="ttc" id="apoisson_8c_html_a9340445ae2c0a3c7be290e2a1aea3d67"><div class="ttname"><a href="poisson_8c.html#a9340445ae2c0a3c7be290e2a1aea3d67">PoissonRHS</a></div><div class="ttdeci">PetscErrorCode PoissonRHS(UserCtx *user, Vec B)</div><div class="ttdoc">Computes the Right-Hand-Side (RHS) of the Poisson equation, which is the divergence of the intermedia...</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l02810">poisson.c:2810</a></div></div>
<div class="ttc" id="avariables_8h_html_a24d419b8507d91d3752afe90a3ac1de5"><div class="ttname"><a href="variables_8h.html#a24d419b8507d91d3752afe90a3ac1de5">UserCtx::KSKE</a></div><div class="ttdeci">PetscInt * KSKE</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00692">variables.h:692</a></div></div>
<div class="ttc" id="avariables_8h_html_structUserCtx"><div class="ttname"><a href="variables_8h.html#structUserCtx">UserCtx</a></div><div class="ttdoc">User-defined context containing data specific to a single computational grid level.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00657">variables.h:657</a></div></div>
<div class="ttc" id="avariables_8h_html_ac5212e2fb1eeb3323ab8c063aef6a498"><div class="ttname"><a href="variables_8h.html#ac5212e2fb1eeb3323ab8c063aef6a498">UserCtx::MP</a></div><div class="ttdeci">Mat MP</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00695">variables.h:695</a></div></div>
<div class="ttc" id="avariables_8h_html_acd99423029a666652ee1f5bf573619bc"><div class="ttname"><a href="variables_8h.html#acd99423029a666652ee1f5bf573619bc">UserCtx::info</a></div><div class="ttdeci">DMDALocalInfo info</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00664">variables.h:664</a></div></div>
<div class="ttc" id="avariables_8h_html_acb5123619f6844033498dbbd1f46b8d0"><div class="ttname"><a href="variables_8h.html#acb5123619f6844033498dbbd1f46b8d0">UserCtx::lAj</a></div><div class="ttdeci">Vec lAj</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00700">variables.h:700</a></div></div>
<div class="ttc" id="asetup_8h_html_a515c9a96eb4bcac29f79e78c8882d7aa"><div class="ttname"><a href="setup_8h.html#a515c9a96eb4bcac29f79e78c8882d7aa">Contra2Cart</a></div><div class="ttdeci">PetscErrorCode Contra2Cart(UserCtx *user)</div><div class="ttdoc">Reconstructs Cartesian velocity (Ucat) at cell centers from contravariant velocity (Ucont) defined on...</div><div class="ttdef"><b>Definition:</b> <a href="setup_8c_source.html#l01881">setup.c:1881</a></div></div>
<div class="ttc" id="avariables_8h_html_a3279024cc316f957e89c05949a1ab441"><div class="ttname"><a href="variables_8h.html#a3279024cc316f957e89c05949a1ab441">SimCtx::rans</a></div><div class="ttdeci">PetscInt rans</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00605">variables.h:605</a></div></div>
<div class="ttc" id="alogging_8h_html_aeb27d528b5c766bb8c213bb2112a79f6"><div class="ttname"><a href="logging_8h.html#aeb27d528b5c766bb8c213bb2112a79f6">DualMonitorCtx::block_id</a></div><div class="ttdeci">PetscInt block_id</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00060">logging.h:60</a></div></div>
<div class="ttc" id="arhs_8h_html_aecbb71daf364f9c5810052e4b9ad1840"><div class="ttname"><a href="rhs_8h.html#aecbb71daf364f9c5810052e4b9ad1840">CalculateNormalAndArea</a></div><div class="ttdeci">PetscErrorCode CalculateNormalAndArea(Cmpnts csi, Cmpnts eta, Cmpnts zet, double ni[3], double nj[3], double nk[3], double *Ai, double *Aj, double *Ak)</div><div class="ttdef"><b>Definition:</b> <a href="rhs_8c_source.html#l00040">rhs.c:40</a></div></div>
<div class="ttc" id="avariables_8h_html_ad397aa8cb29c2ca1d2335b897e2f7690"><div class="ttname"><a href="variables_8h.html#ad397aa8cb29c2ca1d2335b897e2f7690">UserCtx::MR</a></div><div class="ttdeci">Mat MR</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00695">variables.h:695</a></div></div>
<div class="ttc" id="apoisson_8c_html_aaade3232ef08cf18b4f3a20a0a2c6fb6"><div class="ttname"><a href="poisson_8c.html#aaade3232ef08cf18b4f3a20a0a2c6fb6">TS</a></div><div class="ttdeci">#define TS</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00902">poisson.c:902</a></div></div>
<div class="ttc" id="avariables_8h_html_af21efba2f6a4f52657ce8ba6908cec7c"><div class="ttname"><a href="variables_8h.html#af21efba2f6a4f52657ce8ba6908cec7c">UserCtx::lNvert_c</a></div><div class="ttdeci">Vec * lNvert_c</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00719">variables.h:719</a></div></div>
<div class="ttc" id="avariables_8h_html_a22580e0e52ca8ddccc76d24c96f00e4a"><div class="ttname"><a href="variables_8h.html#a22580e0e52ca8ddccc76d24c96f00e4a">SimCtx::block_number</a></div><div class="ttdeci">PetscInt block_number</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00589">variables.h:589</a></div></div>
<div class="ttc" id="avariables_8h_html_aa60ee4e3f8eca251ee470427f1ebac13"><div class="ttname"><a href="variables_8h.html#aa60ee4e3f8eca251ee470427f1ebac13">SimCtx::wallfunction</a></div><div class="ttdeci">PetscInt wallfunction</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00606">variables.h:606</a></div></div>
<div class="ttc" id="alogging_8h_html_aa987297fa072943c2409f3b2cc4e31f9"><div class="ttname"><a href="logging_8h.html#aa987297fa072943c2409f3b2cc4e31f9">LOG_LOOP_ALLOW_EXACT</a></div><div class="ttdeci">#define LOG_LOOP_ALLOW_EXACT(scope, level, var, val, fmt,...)</div><div class="ttdoc">Logs a custom message if a variable equals a specific value.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00347">logging.h:347</a></div></div>
<div class="ttc" id="avariables_8h_html_ada85203a98a3e4ce033b630fd6a1b695"><div class="ttname"><a href="variables_8h.html#ada85203a98a3e4ce033b630fd6a1b695">UserMG::mgctx</a></div><div class="ttdeci">MGCtx * mgctx</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00437">variables.h:437</a></div></div>
<div class="ttc" id="avariables_8h_html_a02fd03c4c166911f067e92b36d1820a3"><div class="ttname"><a href="variables_8h.html#a02fd03c4c166911f067e92b36d1820a3">SimCtx::MHV</a></div><div class="ttdeci">PetscInt MHV</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00568">variables.h:568</a></div></div>
<div class="ttc" id="apoisson_8c_html_a5af9139e882aef6c820ae908589a40d6"><div class="ttname"><a href="poisson_8c.html#a5af9139e882aef6c820ae908589a40d6">NE</a></div><div class="ttdeci">#define NE</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00896">poisson.c:896</a></div></div>
<div class="ttc" id="avariables_8h_html_a6ef13ed6ab8f82c44bd8a81739ff90e2"><div class="ttname"><a href="variables_8h.html#a6ef13ed6ab8f82c44bd8a81739ff90e2">BCS::Ubcs</a></div><div class="ttdeci">Vec Ubcs</div><div class="ttdoc">Boundary condition velocity values. (Comment: &quot;An ugly hack, waste of memory&quot;)</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00121">variables.h:121</a></div></div>
<div class="ttc" id="avariables_8h_html_a88c4b985c5df59d8fd0ac17910dbb85c"><div class="ttname"><a href="variables_8h.html#a88c4b985c5df59d8fd0ac17910dbb85c">SimCtx::NumberOfBodies</a></div><div class="ttdeci">PetscInt NumberOfBodies</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00583">variables.h:583</a></div></div>
<div class="ttc" id="avariables_8h_html_a7fb47de7893b318ba4e4e12ed46c0712"><div class="ttname"><a href="variables_8h.html#a7fb47de7893b318ba4e4e12ed46c0712">UserCtx::da_c</a></div><div class="ttdeci">DM * da_c</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00718">variables.h:718</a></div></div>
<div class="ttc" id="apoisson_8c_html_a2648a0c6cafb7916a706cd757e5b92f5"><div class="ttname"><a href="poisson_8c.html#a2648a0c6cafb7916a706cd757e5b92f5">PoissonNullSpaceFunction</a></div><div class="ttdeci">PetscErrorCode PoissonNullSpaceFunction(MatNullSpace nullsp, Vec X, void *ctx)</div><div class="ttdoc">The callback function for PETSc's MatNullSpace object.</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l01686">poisson.c:1686</a></div></div>
<div class="ttc" id="avariables_8h_html_a2db602ea5fce7cec91f19f507f922a74"><div class="ttname"><a href="variables_8h.html#a2db602ea5fce7cec91f19f507f922a74">UserCtx::lIZet</a></div><div class="ttdeci">Vec lIZet</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00702">variables.h:702</a></div></div>
<div class="ttc" id="awallfunction_8h_html_a74ed1b371c557b826d503a1627351eec"><div class="ttname"><a href="wallfunction_8h.html#a74ed1b371c557b826d503a1627351eec">wall_function</a></div><div class="ttdeci">void wall_function(UserCtx *user, double sc, double sb, Cmpnts Ua, Cmpnts Uc, Cmpnts *Ub, PetscReal *ustar, double nx, double ny, double nz)</div><div class="ttdef"><b>Definition:</b> <a href="wallfunction_8c_source.html#l00245">wallfunction.c:245</a></div></div>
<div class="ttc" id="apoisson_8c_html_a1d0ece5ecf0d2437c47afedee891058c"><div class="ttname"><a href="poisson_8c.html#a1d0ece5ecf0d2437c47afedee891058c">BN</a></div><div class="ttdeci">#define BN</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00901">poisson.c:901</a></div></div>
<div class="ttc" id="avariables_8h_html_a2deb96128ed850632f645128e26e229e"><div class="ttname"><a href="variables_8h.html#a2deb96128ed850632f645128e26e229e">UserCtx::user_f</a></div><div class="ttdeci">UserCtx * user_f</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00717">variables.h:717</a></div></div>
<div class="ttc" id="avariables_8h_html_ad87ed7266a1bc272ab8d4cea4e39d4d2"><div class="ttname"><a href="variables_8h.html#ad87ed7266a1bc272ab8d4cea4e39d4d2">SimCtx::les</a></div><div class="ttdeci">PetscInt les</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00605">variables.h:605</a></div></div>
<div class="ttc" id="avariables_8h_html_aee7757dd3f6e9566fc1206526625e000"><div class="ttname"><a href="variables_8h.html#aee7757dd3f6e9566fc1206526625e000">SimCtx::summationRHS</a></div><div class="ttdeci">PetscReal summationRHS</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00633">variables.h:633</a></div></div>
<div class="ttc" id="avariables_8h_html_a4d561e219e8bc40951d121cce66d93ce"><div class="ttname"><a href="variables_8h.html#a4d561e219e8bc40951d121cce66d93ce">UserCtx::lIAj</a></div><div class="ttdeci">Vec lIAj</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00702">variables.h:702</a></div></div>
<div class="ttc" id="avariables_8h_html_a922566a9e001486fa838d96925a6f102"><div class="ttname"><a href="variables_8h.html#a922566a9e001486fa838d96925a6f102">SimCtx::log_dir</a></div><div class="ttdeci">char log_dir[PETSC_MAX_PATH_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00560">variables.h:560</a></div></div>
<div class="ttc" id="avariables_8h_html_a19aa807b9181b13618527d6c4eb6fa89"><div class="ttname"><a href="variables_8h.html#a19aa807b9181b13618527d6c4eb6fa89">SimCtx::rank</a></div><div class="ttdeci">PetscMPIInt rank</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00541">variables.h:541</a></div></div>
<div class="ttc" id="apoisson_8c_html_a846185bb780db2d5f6e9e58c09a08819"><div class="ttname"><a href="poisson_8c.html#a846185bb780db2d5f6e9e58c09a08819">GridInterpolation</a></div><div class="ttdeci">#define GridInterpolation(i, j, k, ic, jc, kc, ia, ja, ka, user)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00798">poisson.c:798</a></div></div>
<div class="ttc" id="avariables_8h_html_ab7a460d0a7eaa2d76d0b6267310c3184"><div class="ttname"><a href="variables_8h.html#ab7a460d0a7eaa2d76d0b6267310c3184">UserCtx::lJZet</a></div><div class="ttdeci">Vec lJZet</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00703">variables.h:703</a></div></div>
<div class="ttc" id="avariables_8h_html_a77c29afd999c79749fc4a0163da98d2e"><div class="ttname"><a href="variables_8h.html#a77c29afd999c79749fc4a0163da98d2e">UserCtx::Bcs</a></div><div class="ttdeci">BCS Bcs</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00678">variables.h:678</a></div></div>
<div class="ttc" id="avariables_8h_html_a2f213dcdaf9617bfb44e4f22857f2e56"><div class="ttname"><a href="variables_8h.html#a2f213dcdaf9617bfb44e4f22857f2e56">UserCtx::lNvert</a></div><div class="ttdeci">Vec lNvert</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="alogging_8h_html_a3de33738fd3c7e77bffbcfaefc3e7645"><div class="ttname"><a href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a></div><div class="ttdeci">#define GLOBAL</div><div class="ttdoc">Scope for global logging across all processes.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00045">logging.h:45</a></div></div>
<div class="ttc" id="alogging_8h_html_structDualMonitorCtx"><div class="ttname"><a href="logging_8h.html#structDualMonitorCtx">DualMonitorCtx</a></div><div class="ttdoc">Context for a dual-purpose KSP monitor.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00055">logging.h:55</a></div></div>
<div class="ttc" id="avariables_8h_html_structCmpnts"><div class="ttname"><a href="variables_8h.html#structCmpnts">Cmpnts</a></div><div class="ttdoc">A 3D point or vector with PetscScalar components.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00100">variables.h:100</a></div></div>
<div class="ttc" id="avariables_8h_html_a63b70d5ad8338013a2888928d4106f63"><div class="ttname"><a href="variables_8h.html#a63b70d5ad8338013a2888928d4106f63">UserCtx::lJCsi</a></div><div class="ttdeci">Vec lJCsi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00703">variables.h:703</a></div></div>
<div class="ttc" id="avariables_8h_html_aa55a2a246e904b3569075eb4de0092a6"><div class="ttname"><a href="variables_8h.html#aa55a2a246e904b3569075eb4de0092a6">UserCtx::JM</a></div><div class="ttdeci">PetscInt JM</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00666">variables.h:666</a></div></div>
<div class="ttc" id="apoisson_8c_html_a2c73b81722187c48d6186148091162fb"><div class="ttname"><a href="poisson_8c.html#a2c73b81722187c48d6186148091162fb">WP</a></div><div class="ttdeci">#define WP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00889">poisson.c:889</a></div></div>
<div class="ttc" id="apoisson_8c_html_aa2fc17959230252f30b2278d81a16caf"><div class="ttname"><a href="poisson_8c.html#aa2fc17959230252f30b2278d81a16caf">MyInterpolation</a></div><div class="ttdeci">PetscErrorCode MyInterpolation(Mat A, Vec X, Vec F)</div><div class="ttdoc">The callback function for the multigrid interpolation operator (MatShell).</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l01879">poisson.c:1879</a></div></div>
<div class="ttc" id="alogging_8h_html_a34c7203eac55e4ac9f075e106a7afe5f"><div class="ttname"><a href="logging_8h.html#a34c7203eac55e4ac9f075e106a7afe5f">DualMonitorCtx::log_to_console</a></div><div class="ttdeci">PetscBool log_to_console</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00057">logging.h:57</a></div></div>
<div class="ttc" id="apoisson_8c_html_a6046e36e2334fa29a86d652a0b8f0593"><div class="ttname"><a href="poisson_8c.html#a6046e36e2334fa29a86d652a0b8f0593">GhostNodeVelocity</a></div><div class="ttdeci">static PetscErrorCode GhostNodeVelocity(UserCtx *user)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00008">poisson.c:8</a></div></div>
<div class="ttc" id="avariables_8h_html_ac8ba12826d60a51ec54fa7c047d806e1"><div class="ttname"><a href="variables_8h.html#ac8ba12826d60a51ec54fa7c047d806e1">UserCtx::lUcont</a></div><div class="ttdeci">Vec lUcont</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_a0e8eb238051c8b5f37a260a8cde481c4"><div class="ttname"><a href="variables_8h.html#a0e8eb238051c8b5f37a260a8cde481c4">MGCtx::user</a></div><div class="ttdeci">UserCtx * user</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00427">variables.h:427</a></div></div>
<div class="ttc" id="apoisson_8c_html_a18bbe716f5be6adbd2150139244c0262"><div class="ttname"><a href="poisson_8c.html#a18bbe716f5be6adbd2150139244c0262">SE</a></div><div class="ttdeci">#define SE</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00897">poisson.c:897</a></div></div>
<div class="ttc" id="avariables_8h_html_a5fd8588302a68eca03d086e01e8972c1"><div class="ttname"><a href="variables_8h.html#a5fd8588302a68eca03d086e01e8972c1">UserCtx::jsc</a></div><div class="ttdeci">PetscInt jsc</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00670">variables.h:670</a></div></div>
<div class="ttc" id="avariables_8h_html_ab5bb12623002e01eff7d41bb9f537054"><div class="ttname"><a href="variables_8h.html#ab5bb12623002e01eff7d41bb9f537054">UserCtx::bctype</a></div><div class="ttdeci">PetscInt bctype[6]</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00680">variables.h:680</a></div></div>
<div class="ttc" id="alogging_8h_html_ae5af09d0145fba810375f6a2069c7098"><div class="ttname"><a href="logging_8h.html#ae5af09d0145fba810375f6a2069c7098">DualMonitorCtx::file_handle</a></div><div class="ttdeci">FILE * file_handle</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00056">logging.h:56</a></div></div>
<div class="ttc" id="asetup_8h_html_ad5f82951adcce74b3d37cb5880acf43a"><div class="ttname"><a href="setup_8h.html#ad5f82951adcce74b3d37cb5880acf43a">UpdateLocalGhosts</a></div><div class="ttdeci">PetscErrorCode UpdateLocalGhosts(UserCtx *user, const char *fieldName)</div><div class="ttdoc">Updates the local vector (including ghost points) from its corresponding global vector.</div><div class="ttdef"><b>Definition:</b> <a href="setup_8c_source.html#l00832">setup.c:832</a></div></div>
<div class="ttc" id="avariables_8h_html_a99a88d89d58073bd134175f62213c528"><div class="ttname"><a href="variables_8h.html#a99a88d89d58073bd134175f62213c528">UserCtx::thislevel</a></div><div class="ttdeci">PetscInt thislevel</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00716">variables.h:716</a></div></div>
<div class="ttc" id="avariables_8h_html_a3f5ec0e4536c9ccaa3d663f14d47f904"><div class="ttname"><a href="variables_8h.html#a3f5ec0e4536c9ccaa3d663f14d47f904">UserCtx::KM</a></div><div class="ttdeci">PetscInt KM</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00666">variables.h:666</a></div></div>
<div class="ttc" id="avariables_8h_html_a3ff353812541b8ebba309e8d3ba6674b"><div class="ttname"><a href="variables_8h.html#a3ff353812541b8ebba309e8d3ba6674b">SimCtx::st</a></div><div class="ttdeci">PetscReal st</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00577">variables.h:577</a></div></div>
<div class="ttc" id="avariables_8h_html_a69966d928601d61d4f526636f84396c5"><div class="ttname"><a href="variables_8h.html#a69966d928601d61d4f526636f84396c5">UserCtx::fda</a></div><div class="ttdeci">DM fda</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00663">variables.h:663</a></div></div>
<div class="ttc" id="alogging_8h_html_a4a671b0e347e0a22b0df806f246d5d11"><div class="ttname"><a href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a></div><div class="ttdeci">#define LOG_ALLOW(scope, level, fmt,...)</div><div class="ttdoc">Logging macro that checks both the log level and whether the calling function is in the allowed-funct...</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00199">logging.h:199</a></div></div>
<div class="ttc" id="apoisson_8c_html_a34f6242556bffd27f00a84b377c1bf9d"><div class="ttname"><a href="poisson_8c.html#a34f6242556bffd27f00a84b377c1bf9d">VolumeFlux_rev</a></div><div class="ttdeci">PetscErrorCode VolumeFlux_rev(UserCtx *user, PetscReal *ibm_Flux, PetscReal *ibm_Area, PetscInt flg)</div><div class="ttdoc">A specialized version of VolumeFlux, likely for reversed normals.</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l02891">poisson.c:2891</a></div></div>
<div class="ttc" id="avariables_8h_html_ae8527c7cba1c5764994053481722eb01"><div class="ttname"><a href="variables_8h.html#ae8527c7cba1c5764994053481722eb01">UserCtx::lJAj</a></div><div class="ttdeci">Vec lJAj</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00703">variables.h:703</a></div></div>
<div class="ttc" id="alogging_8h_html_a26f628c9bae473d94674a1a97641b474"><div class="ttname"><a href="logging_8h.html#a26f628c9bae473d94674a1a97641b474">DualMonitorDestroy</a></div><div class="ttdeci">PetscErrorCode DualMonitorDestroy(void **ctx)</div><div class="ttdoc">Destroys the DualMonitorCtx.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8c_source.html#l00746">logging.c:746</a></div></div>
<div class="ttc" id="avariables_8h_html_structMGCtx"><div class="ttname"><a href="variables_8h.html#structMGCtx">MGCtx</a></div><div class="ttdoc">Context for Multigrid operations.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00426">variables.h:426</a></div></div>
<div class="ttc" id="avariables_8h_html_a9f0c002a2c7cde3b6ac843ab9185f4d4"><div class="ttname"><a href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">Cmpnts::z</a></div><div class="ttdeci">PetscScalar z</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00101">variables.h:101</a></div></div>
<div class="ttc" id="avariables_8h_html_a508de73c1c5929cbee04a94091f2799e"><div class="ttname"><a href="variables_8h.html#a508de73c1c5929cbee04a94091f2799e">UserCtx::lKEta</a></div><div class="ttdeci">Vec lKEta</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00704">variables.h:704</a></div></div>
<div class="ttc" id="avariables_8h_html_a1b08cdba1a7d4de048fbf472edfd5850"><div class="ttname"><a href="variables_8h.html#a1b08cdba1a7d4de048fbf472edfd5850">SimCtx::fish</a></div><div class="ttdeci">PetscInt fish</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00568">variables.h:568</a></div></div>
<div class="ttc" id="avariables_8h_html_a58d3237c97d6f16130867370858d5bad"><div class="ttname"><a href="variables_8h.html#a58d3237c97d6f16130867370858d5bad">UserCtx::lUstar</a></div><div class="ttdeci">Vec lUstar</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00679">variables.h:679</a></div></div>
<div class="ttc" id="apoisson_8c_html_adda1ea75ba8153e72cfb5c87606c55a6"><div class="ttname"><a href="poisson_8c.html#adda1ea75ba8153e72cfb5c87606c55a6">TN</a></div><div class="ttdeci">#define TN</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00900">poisson.c:900</a></div></div>
<div class="ttc" id="avariables_8h_html_a555f83bde847a6f7bde6e372ca74dd4b"><div class="ttname"><a href="variables_8h.html#a555f83bde847a6f7bde6e372ca74dd4b">UserCtx::A</a></div><div class="ttdeci">Mat A</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00691">variables.h:691</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a></div><div class="ttdeci">@ LOG_INFO</div><div class="ttdoc">Informational messages about program execution.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00032">logging.h:32</a></div></div>
<div class="ttc" id="apoisson_8c_html_a85e1eff3b6e34605b863323d6336eecd"><div class="ttname"><a href="poisson_8c.html#a85e1eff3b6e34605b863323d6336eecd">RestrictResidual_SolidAware</a></div><div class="ttdeci">static PetscErrorCode RestrictResidual_SolidAware(Mat A, Vec X, Vec F)</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l01986">poisson.c:1986</a></div></div>
<div class="ttc" id="avariables_8h_html_aa1823d873982755996b7335f43732af4"><div class="ttname"><a href="variables_8h.html#aa1823d873982755996b7335f43732af4">UserCtx::Ucat</a></div><div class="ttdeci">Vec Ucat</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_a53b044b8b0e4a4dc8c8fa05387af564c"><div class="ttname"><a href="variables_8h.html#a53b044b8b0e4a4dc8c8fa05387af564c">SimCtx::dt</a></div><div class="ttdeci">PetscReal dt</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00552">variables.h:552</a></div></div>
<div class="ttc" id="avariables_8h_html_a95078248cc49ce19d5d05b14e1701888"><div class="ttname"><a href="variables_8h.html#a95078248cc49ce19d5d05b14e1701888">UserCtx::lP</a></div><div class="ttdeci">Vec lP</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_a7a1cf0e107351a96b27ae00160e60271"><div class="ttname"><a href="variables_8h.html#a7a1cf0e107351a96b27ae00160e60271">UserCtx::lPhi</a></div><div class="ttdeci">Vec lPhi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="avariables_8h_html_aa0f10efbfba88094aa07cee1cdb0baff"><div class="ttname"><a href="variables_8h.html#aa0f10efbfba88094aa07cee1cdb0baff">UserCtx::lKCsi</a></div><div class="ttdeci">Vec lKCsi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00704">variables.h:704</a></div></div>
<div class="ttc" id="avariables_8h_html_a414751d7a391a78834cdce87b52a066f"><div class="ttname"><a href="variables_8h.html#a414751d7a391a78834cdce87b52a066f">UserCtx::lZet</a></div><div class="ttdeci">Vec lZet</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00700">variables.h:700</a></div></div>
<div class="ttc" id="apoisson_8c_html_a051c83d6554c006261a198d0682d84e4"><div class="ttname"><a href="poisson_8c.html#a051c83d6554c006261a198d0682d84e4">TW</a></div><div class="ttdeci">#define TW</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00906">poisson.c:906</a></div></div>
<div class="ttc" id="apoisson_8c_html_a8c4cb4c082ab40cc20db95c962fc1d5c"><div class="ttname"><a href="poisson_8c.html#a8c4cb4c082ab40cc20db95c962fc1d5c">VolumeFlux</a></div><div class="ttdeci">PetscErrorCode VolumeFlux(UserCtx *user, PetscReal *ibm_Flux, PetscReal *ibm_Area, PetscInt flg)</div><div class="ttdoc">Calculates the net flux across the immersed boundary surface.</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l03133">poisson.c:3133</a></div></div>
<div class="ttc" id="avariables_8h_html_ac12eb831808e07c80a03e393a986f93f"><div class="ttname"><a href="variables_8h.html#ac12eb831808e07c80a03e393a986f93f">SimCtx::U_bc</a></div><div class="ttdeci">PetscReal U_bc</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00600">variables.h:600</a></div></div>
<div class="ttc" id="avariables_8h_html_a9693ebf5c9ea601d5ebaf6d24cc60721"><div class="ttname"><a href="variables_8h.html#a9693ebf5c9ea601d5ebaf6d24cc60721">UserCtx::lCsi</a></div><div class="ttdeci">Vec lCsi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00700">variables.h:700</a></div></div>
<div class="ttc" id="alogging_8h_html_a64100408e773bad5a0c07581dc3ab039"><div class="ttname"><a href="logging_8h.html#a64100408e773bad5a0c07581dc3ab039">DualMonitorCtx::step</a></div><div class="ttdeci">PetscInt step</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00059">logging.h:59</a></div></div>
<div class="ttc" id="avariables_8h_html_acbf784310453bd7aec02838cdef24a66"><div class="ttname"><a href="variables_8h.html#acbf784310453bd7aec02838cdef24a66">UserCtx::lICsi</a></div><div class="ttdeci">Vec lICsi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00702">variables.h:702</a></div></div>
<div class="ttc" id="apoisson_8c_html_ab04c88bedc6b2be8ddfe7aa8d3e93f06"><div class="ttname"><a href="poisson_8c.html#ab04c88bedc6b2be8ddfe7aa8d3e93f06">NP</a></div><div class="ttdeci">#define NP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00890">poisson.c:890</a></div></div>
<div class="ttc" id="avariables_8h_html_a03772da847da737415fd5a86a97147bd"><div class="ttname"><a href="variables_8h.html#a03772da847da737415fd5a86a97147bd">UserCtx::isc</a></div><div class="ttdeci">PetscInt isc</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00670">variables.h:670</a></div></div>
<div class="ttc" id="apoisson_8c_html_adb5bf6fbe6405b09bad71e89e1da5850"><div class="ttname"><a href="poisson_8c.html#adb5bf6fbe6405b09bad71e89e1da5850">EP</a></div><div class="ttdeci">#define EP</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00888">poisson.c:888</a></div></div>
<div class="ttc" id="alogging_8h_html_ace99f3e207ccb2e46e9b782f9e57732e"><div class="ttname"><a href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a></div><div class="ttdeci">#define PROFILE_FUNCTION_BEGIN</div><div class="ttdoc">Marks the beginning of a profiled code block (typically a function).</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00722">logging.h:722</a></div></div>
<div class="ttc" id="avariables_8h_html_af031acb43b014d5ac788aa9003491e75"><div class="ttname"><a href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">UserCtx::da</a></div><div class="ttdeci">DM da</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00663">variables.h:663</a></div></div>
<div class="ttc" id="avariables_8h_html_a946cb0e8075672c1ffc8bd6d0b0dfe5c"><div class="ttname"><a href="variables_8h.html#a946cb0e8075672c1ffc8bd6d0b0dfe5c">UserCtx::da_f</a></div><div class="ttdeci">DM * da_f</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00718">variables.h:718</a></div></div>
<div class="ttc" id="apoisson_8c_html_a4b95e941f44a20ea60512bbe2065f0b6"><div class="ttname"><a href="poisson_8c.html#a4b95e941f44a20ea60512bbe2065f0b6">SW</a></div><div class="ttdeci">#define SW</div><div class="ttdef"><b>Definition:</b> <a href="poisson_8c_source.html#l00899">poisson.c:899</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="poisson_8c.html">poisson.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
