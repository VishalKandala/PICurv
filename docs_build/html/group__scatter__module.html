<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PICurv: Particle-to-Grid Scattering</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PICurv
   &#160;<span id="projectnumber">0.1.0</span>
   </div>
   <div id="projectbrief">A Parallel Particle-In-Cell Solver for Curvilinear LES</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('group__scatter__module.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Modules</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Particle-to-Grid Scattering</div>  </div>
</div><!--header-->
<div class="contents">

<p>Functions for scattering particle data (scalar or vector) onto Eulerian grid fields by averaging contributions within each cell.  
<a href="#details">More...</a></p>
<div class="dynheader">
Collaboration diagram for Particle-to-Grid Scattering:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="group__scatter__module.svg" width="394" height="51"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Modules</h2></td></tr>
<tr class="memitem:group__scatter__module__internal"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__scatter__module__internal.html">Internal Scattering Helpers</a></td></tr>
<tr class="memdesc:group__scatter__module__internal"><td class="mdescLeft">&#160;</td><td class="mdescRight">Lower-level functions used by the main scattering routines. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga16dc04f7710ac752691f269400381913"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__scatter__module.html#ga16dc04f7710ac752691f269400381913">GetScatterTargetInfo</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, const char *particleFieldName, DM *targetDM, PetscInt *expected_dof)</td></tr>
<tr class="memdesc:ga16dc04f7710ac752691f269400381913"><td class="mdescLeft">&#160;</td><td class="mdescRight">Determines the target Eulerian DM and expected DOF for scattering a given particle field.  <a href="group__scatter__module.html#ga16dc04f7710ac752691f269400381913">More...</a><br /></td></tr>
<tr class="separator:ga16dc04f7710ac752691f269400381913"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa6642e53fe1be75dcc180dab3cf3f692"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__scatter__module.html#gaa6642e53fe1be75dcc180dab3cf3f692">ScatterParticleFieldToEulerField</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, const char *particleFieldName, Vec eulerFieldAverageVec)</td></tr>
<tr class="memdesc:gaa6642e53fe1be75dcc180dab3cf3f692"><td class="mdescLeft">&#160;</td><td class="mdescRight">Scatters a particle field (scalar or vector) to the corresponding Eulerian field average.  <a href="group__scatter__module.html#gaa6642e53fe1be75dcc180dab3cf3f692">More...</a><br /></td></tr>
<tr class="separator:gaa6642e53fe1be75dcc180dab3cf3f692"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga84b852e1186804ff34e9228fab1764c6"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__scatter__module.html#ga84b852e1186804ff34e9228fab1764c6">ScatterAllParticleFieldsToEulerFields</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:ga84b852e1186804ff34e9228fab1764c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Scatters a predefined set of particle fields to their corresponding Eulerian fields.  <a href="group__scatter__module.html#ga84b852e1186804ff34e9228fab1764c6">More...</a><br /></td></tr>
<tr class="separator:ga84b852e1186804ff34e9228fab1764c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga81cfdf7b32472d8f614b44e30005ec6c"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__scatter__module.html#ga81cfdf7b32472d8f614b44e30005ec6c">CalculateParticleCountPerCell</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:ga81cfdf7b32472d8f614b44e30005ec6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Counts particles in each cell of the DMDA 'da' and stores the result in user-&gt;ParticleCount.  <a href="group__scatter__module.html#ga81cfdf7b32472d8f614b44e30005ec6c">More...</a><br /></td></tr>
<tr class="separator:ga81cfdf7b32472d8f614b44e30005ec6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Functions for scattering particle data (scalar or vector) onto Eulerian grid fields by averaging contributions within each cell. </p>
<p>This file provides a modular set of functions to perform particle-to-grid projection, specifically calculating cell-averaged quantities from particle properties. It assumes a PETSc environment using DMDA for the grids and DMSwarm for particles.</p>
<p>Key Features:</p><ul>
<li>Handles both scalar (DOF=1) and vector (DOF=3) particle fields.</li>
<li>Uses a pre-calculated particle count vector (<code>ParticleCount</code>) for normalization.</li>
<li>Implicitly determines the target Eulerian DM (typically <code>user-&gt;da</code> for scalars, <code>user-&gt;fda</code> for vectors) based on standard field names ("P", "Nvert", "Ucat", "Ucont","Psi").</li>
<li>Modifies existing Eulerian field vectors (e.g., <code>user-&gt;P</code>, <code>user-&gt;Ucat</code>,user-&gt;Psi<code>) in place.</code></li>
<li><code>Provides a high-level wrapper function (</code>ScatterAllParticleFieldsToEulerFields`) to easily scatter a standard set of fields.</li>
<li>Uses only the base <code>SETERRQ</code> macro for error reporting to maximize compiler compatibility.</li>
</ul>
<p>Dependencies:</p><ul>
<li>PETSc library (DMDA, DMSwarm, Vec, IS, PetscLog, etc.)</li>
<li>A <code><a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a></code> struct (defined elsewhere, e.g., "userctx.h") containing pointers to relevant DMs (<code>da</code>, <code>fda</code>), Vecs (<code>ParticleCount</code>, <code>P</code>, <code>Nvert</code>, <code>Ucat</code>, etc.), and the <code>DMSwarm</code> object (<code>swarm</code>).</li>
<li>A custom DMSwarm field named <code>"DMSwarm_CellID"</code> (blockSize=3, type=PETSC_INT) must be registered and populated with the local cell indices for each particle.</li>
<li>Logging infrastructure (<code>LOG_ALLOW</code>, etc.) assumed to be defined elsewhere. </li>
</ul>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga16dc04f7710ac752691f269400381913"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga16dc04f7710ac752691f269400381913">&#9670;&nbsp;</a></span>GetScatterTargetInfo()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode GetScatterTargetInfo </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>particleFieldName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DM *&#160;</td>
          <td class="paramname"><em>targetDM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>expected_dof</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Determines the target Eulerian DM and expected DOF for scattering a given particle field. </p>
<p>Based on hardcoded rules mapping particle field names to user context DMs (da/fda). This function encapsulates the policy of where different fields should be scattered.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> containing da and fda. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">particleFieldName</td><td>Name of the particle field (e.g., "P", "Ucat"). </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">targetDM</td><td>Pointer to store the determined target DM (da or fda). </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">expected_dof</td><td>Pointer to store the expected DOF (1 or 3) for this field.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success, PETSC_ERR_ARG_UNKNOWN if field name is not recognized, or PETSC_ERR_ARG_NULL for NULL inputs.</dd></dl>
<p>Based on hardcoded rules mapping particle field names ("P", "Nvert", "Ucat", "Ucont") to user context DMs (<code>user-&gt;da</code> or <code>user-&gt;fda</code>). This function encapsulates the policy of where different fields should be scattered. Modify this function to add rules for custom fields.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> containing required DMs (<code>da</code>, <code>fda</code>). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">particleFieldName</td><td>Name of the particle field. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">targetDM</td><td>Pointer to store the determined target DM (<code>user-&gt;da</code> or <code>user-&gt;fda</code>). </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">expected_dof</td><td>Pointer to store the expected DOF (1 or 3) for this field.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success. Error codes:<ul>
<li><code>PETSC_ERR_ARG_NULL</code> if required inputs are NULL.</li>
<li><code>PETSC_ERR_ARG_WRONG</code> if <code>particleFieldName</code> is not recognized. </li>
</ul>
</dd></dl>

<p class="definition">Definition at line <a class="el" href="interpolation_8c_source.html#l01611">1611</a> of file <a class="el" href="interpolation_8c_source.html">interpolation.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;{</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;    <span class="keywordtype">char</span>           msg[<a class="code" href="interpolation_8c.html#a8a60be44abd6bcc3c5912e23b8b940c4">ERROR_MSG_BUFFER_SIZE</a>]; <span class="comment">// Buffer for formatted error messages</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160; </div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160; </div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    <span class="comment">// --- Input Validation ---</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    <span class="comment">// Check for NULL pointers in essential inputs</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <span class="keywordflow">if</span> (!user) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx pointer is NULL.&quot;</span>);</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;da is NULL.&quot;</span>);</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;fda is NULL.&quot;</span>); <span class="comment">// Needed for vector fields</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <span class="keywordflow">if</span> (!particleFieldName) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;particleFieldName is NULL.&quot;</span>);</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    <span class="keywordflow">if</span> (!targetDM) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Output targetDM pointer is NULL.&quot;</span>);</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;    <span class="keywordflow">if</span> (!expected_dof) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Output expected_dof pointer is NULL.&quot;</span>);</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160; </div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;    <span class="comment">// --- Determine Target DM and DOF based on Field Name ---</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;    <span class="comment">// Compare the input field name with known scalar fields targeting &#39;da&#39;</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    <span class="keywordflow">if</span> (strcmp(particleFieldName, <span class="stringliteral">&quot;Psi&quot;</span>) == 0 || strcmp(particleFieldName, <span class="stringliteral">&quot;Nvert&quot;</span>) == 0) {</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        *expected_dof = 1;      <span class="comment">// Scalar fields have DOF 1</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        *targetDM = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;   <span class="comment">// Target the primary scalar DMDA</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;GetScatterTargetInfo: Field &#39;%s&#39; targets DM &#39;da&#39; (DOF=1).\n&quot;</span>, particleFieldName);</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;    }</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    <span class="comment">// Compare with known vector fields targeting &#39;fda&#39;</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(particleFieldName, <span class="stringliteral">&quot;Ucat&quot;</span>) == 0 || strcmp(particleFieldName, <span class="stringliteral">&quot;Ucont&quot;</span>) == 0) {</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;        *expected_dof = 3;      <span class="comment">// Vector fields have DOF 3</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        *targetDM = user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>;  <span class="comment">// Target the vector DMDA (often node-based)</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;GetScatterTargetInfo: Field &#39;%s&#39; targets DM &#39;fda&#39; (DOF=3).\n&quot;</span>, particleFieldName);</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;    }</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;    <span class="comment">// --- Add rules for other fields here ---</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;    <span class="comment">// else if (strcmp(particleFieldName, &quot;SomeOtherScalar&quot;) == 0) { *expected_dof = 1; *targetDM = user-&gt;da; }</span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;    <span class="comment">// else if (strcmp(particleFieldName, &quot;SomeOtherVector&quot;) == 0) { *expected_dof = 3; *targetDM = user-&gt;someOtherDM; }</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;        <span class="comment">// The provided field name doesn&#39;t match any known rules</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        *targetDM = NULL; <span class="comment">// Indicate failure</span></div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        *expected_dof = 0;</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;        <span class="comment">// Format the error message manually</span></div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        PetscSNPrintf(msg, <span class="keyword">sizeof</span>(msg), <span class="stringliteral">&quot;GetScatterTargetInfo: Field name &#39;%s&#39; is not recognized for automatic DM selection.&quot;</span>, particleFieldName);</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        <span class="comment">// Use SETERRQ with the formatted message and appropriate error code</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_WRONG, msg); <span class="comment">// Use WRONG argument error code</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    }</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160; </div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160; </div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="group__scatter__module_ga16dc04f7710ac752691f269400381913_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="gaa6642e53fe1be75dcc180dab3cf3f692"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa6642e53fe1be75dcc180dab3cf3f692">&#9670;&nbsp;</a></span>ScatterParticleFieldToEulerField()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode ScatterParticleFieldToEulerField </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>particleFieldName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Vec&#160;</td>
          <td class="paramname"><em>eulerFieldAverageVec</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Scatters a particle field (scalar or vector) to the corresponding Eulerian field average. </p>
<p>This is the main user-facing function. It determines the target Eulerian DM based on the <code>particleFieldName</code>, validates the provided <code>eulerFieldAverageVec</code> against the target DM, and then orchestrates the scatter operation by calling the internal helper function <code>ScatterParticleFieldToEulerField_Internal</code>. The final averaged result is stored IN-PLACE in <code>eulerFieldAverageVec</code>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">user</td><td>Pointer to <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> containing da, fda, swarm, ParticleCount. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">particleFieldName</td><td>Name of the field in the DMSwarm (e.g., "P", "Ucat"). </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">eulerFieldAverageVec</td><td>Pre-created Vec associated with the correct target DM (implicitly da or fda). Result stored here.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. Errors on NULL input, unrecognized field name, or incompatible target vector.</dd></dl>
<p>This is the primary user-facing function for scattering a single field. It determines the target Eulerian DM (<code>user-&gt;da</code> or <code>user-&gt;fda</code>) based on the <code>particleFieldName</code>, validates that the provided <code>eulerFieldAverageVec</code> is compatible with that target DM, and then orchestrates the scatter operation by calling an internal helper function. The final averaged result is stored IN-PLACE in the <code>eulerFieldAverageVec</code>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">user</td><td>Pointer to <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> containing <code>da</code>, <code>fda</code>, <code>swarm</code>, <code>ParticleCount</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">particleFieldName</td><td>Name of the field in the DMSwarm (e.g., "Psi", "Ucat"). </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">eulerFieldAverageVec</td><td>Pre-created Vec associated with the correct target DM (implicitly <code>da</code> or <code>fda</code>). Result stored here. This vector should be zeroed by the caller if desired before this function (e.g., using <code>VecSet</code>). The wrapper <code>ScatterAllParticleFieldsToEulerFields</code> handles this zeroing.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. Errors on NULL input, unrecognized field name, incompatible target vector, or if the particle field doesn't exist. </dd></dl>

<p class="definition">Definition at line <a class="el" href="interpolation_8c_source.html#l02009">2009</a> of file <a class="el" href="interpolation_8c_source.html">interpolation.c</a>.</p>
<div class="fragment"><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;{</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    DM             targetDM = NULL;       <span class="comment">// Will point to user-&gt;da or user-&gt;fda</span></div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    PetscInt       expected_dof = 0;      <span class="comment">// Will be 1 or 3</span></div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;    <span class="keywordtype">char</span>           msg[<a class="code" href="interpolation_8c.html#a8a60be44abd6bcc3c5912e23b8b940c4">ERROR_MSG_BUFFER_SIZE</a>]; <span class="comment">// Buffer for formatted error messages</span></div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160; </div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160; </div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160; </div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;    <span class="comment">// --- Essential Input Validation ---</span></div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    <span class="keywordflow">if</span> (!user) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx pointer is NULL.&quot;</span>);</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;    <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;swarm is NULL.&quot;</span>);</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#aa194db376ea0f68ec7090718804488ab">ParticleCount</a>) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;ParticleCount is NULL.&quot;</span>);</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    <span class="keywordflow">if</span> (!eulerFieldAverageVec) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Output eulerFieldAverageVec is NULL.&quot;</span>);</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    <span class="comment">// particleFieldName validity checked within GetScatterTargetInfo</span></div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160; </div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    <span class="comment">// --- Determine Target DM &amp; DOF using the helper function ---</span></div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;    ierr = <a class="code" href="group__scatter__module__internal.html#ga16dc04f7710ac752691f269400381913">GetScatterTargetInfo</a>(user, particleFieldName, &amp;targetDM, &amp;expected_dof); CHKERRQ(ierr);</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    <span class="comment">// If GetScatterTargetInfo failed (e.g., unknown name), CHKERRQ would have returned.</span></div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160; </div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;    <span class="comment">// --- Validate the provided Target Vec&#39;s Compatibility ---</span></div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    DM vec_dm;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    PetscInt vec_dof;</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;    <span class="comment">// Check that the provided average vector has a DM associated with it</span></div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;    ierr = VecGetDM(eulerFieldAverageVec, &amp;vec_dm); CHKERRQ(ierr);</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;    <span class="keywordflow">if</span> (!vec_dm) {</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;         PetscSNPrintf(msg, <span class="keyword">sizeof</span>(msg), <span class="stringliteral">&quot;Provided eulerFieldAverageVec for field &#39;%s&#39; does not have an associated DM.&quot;</span>, particleFieldName);</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;         SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_WRONGSTATE, msg);</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    }</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;    <span class="comment">// Get the block size (DOF) of the provided vector</span></div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    ierr = VecGetBlockSize(eulerFieldAverageVec, &amp;vec_dof); CHKERRQ(ierr);</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    <span class="comment">// Compare the vector&#39;s associated DM with the one determined by the field name</span></div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    <span class="keywordflow">if</span> (vec_dm != targetDM) {</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *target_dm_name = <span class="stringliteral">&quot;targetDM&quot;</span>, *vec_dm_name = <span class="stringliteral">&quot;vec_dm&quot;</span>;</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;        <span class="comment">// Get actual names if possible for a more informative error message</span></div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;        PetscObjectGetName((PetscObject)targetDM, &amp;target_dm_name);</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;        PetscObjectGetName((PetscObject)vec_dm, &amp;vec_dm_name);</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;        PetscSNPrintf(msg, <span class="keyword">sizeof</span>(msg), <span class="stringliteral">&quot;Provided eulerFieldAverageVec associated with DM &#39;%s&#39;, but field &#39;%s&#39; requires scatter to DM &#39;%s&#39;.&quot;</span>, vec_dm_name, particleFieldName, target_dm_name);</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_INCOMP, msg);</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    }</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    <span class="comment">// Compare the vector&#39;s DOF with the one expected for the field name</span></div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    <span class="keywordflow">if</span> (vec_dof != expected_dof) {</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;         PetscSNPrintf(msg, <span class="keyword">sizeof</span>(msg), <span class="stringliteral">&quot;Field &#39;%s&#39; requires DOF %d, but provided eulerFieldAverageVec has DOF %d.&quot;</span>, particleFieldName, expected_dof, vec_dof);</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;         SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_INCOMP, msg);</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    }</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160; </div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    <span class="comment">// --- Perform Scatter using Internal Helper ---</span></div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    <span class="comment">// Log intent before calling the core logic</span></div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;ScatterParticleFieldToEulerField: Scattering field &#39;%s&#39; (DOF=%d).\n&quot;</span>, particleFieldName, expected_dof);</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;    ierr = <a class="code" href="group__scatter__module__internal.html#gac35f52bb41ee862f912a146e86f1affd">ScatterParticleFieldToEulerField_Internal</a>(user, <span class="comment">// Pass user context</span></div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;                                                     particleFieldName, <span class="comment">// Name of particle field</span></div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;                                                     targetDM, <span class="comment">// Determined target DM (da or fda)</span></div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;                                                     expected_dof, <span class="comment">// Determined DOF (1 or 3)</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;                                                     eulerFieldAverageVec); <span class="comment">// The output vector</span></div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;    CHKERRQ(ierr); <span class="comment">// Handle potential errors from the internal function</span></div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160; </div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;ScatterParticleFieldToEulerField: Successfully scattered field &#39;%s&#39;.\n&quot;</span>, particleFieldName);</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;   </div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;   </div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="group__scatter__module_gaa6642e53fe1be75dcc180dab3cf3f692_cgraph.svg" width="100%" height="410"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="group__scatter__module_gaa6642e53fe1be75dcc180dab3cf3f692_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="ga84b852e1186804ff34e9228fab1764c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga84b852e1186804ff34e9228fab1764c6">&#9670;&nbsp;</a></span>ScatterAllParticleFieldsToEulerFields()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode ScatterAllParticleFieldsToEulerFields </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Scatters a predefined set of particle fields to their corresponding Eulerian fields. </p>
<p>This convenience function calls the unified <code>ScatterParticleFieldToEulerField</code> for a standard set of fields ("P", potentially others). It assumes the target Eulerian Vec objects (e.g., <code>user-&gt;P</code>, <code>user-&gt;Ucat</code>) exist in the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure and are correctly associated with their respective DMs (<code>user-&gt;da</code> or <code>user-&gt;fda</code>). It zeros the target Vecs before scattering.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing all required DMs, Vecs (<code>ParticleCount</code>, target Eulerian fields like <code>P</code>, <code>Ucat</code>), and <code>swarm</code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. Errors if prerequisites (like ParticleCount) are missing or if underlying scatter calls fail.</dd></dl>
<p>This convenience function calls the unified <code>ScatterParticleFieldToEulerField</code> for a standard set of fields (currently just "Psi", others commented out). It assumes the target Eulerian Vec objects (e.g., <code>user-&gt;Psi</code>, <code>user-&gt;Ucat</code>) exist in the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure and are correctly associated with their respective DMs (<code>user-&gt;da</code> or <code>user-&gt;fda</code>).</p>
<p><b>IMPORTANT:</b> It zeros the target Vecs before scattering. Ensure <code>user-&gt;ParticleCount</code> has been computed accurately <em>before</em> calling this function, reflecting the current particle distribution.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing all required DMs, Vecs (<code>ParticleCount</code>, target Eulerian fields like <code>P</code>, <code>Ucat</code>), and <code>swarm</code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success. Errors if prerequisites (like ParticleCount) are missing or if underlying scatter calls fail (e.g., particle field missing). </dd></dl>

<p class="definition">Definition at line <a class="el" href="interpolation_8c_source.html#l02098">2098</a> of file <a class="el" href="interpolation_8c_source.html">interpolation.c</a>.</p>
<div class="fragment"><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;{</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160; </div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Starting scattering of specified particle fields to Eulerian grids.\n&quot;</span>);</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160; </div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    <span class="comment">// --- Pre-computation Check: Ensure Particle Counts are Ready ---</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="variables_8h.html#aa194db376ea0f68ec7090718804488ab">ParticleCount</a>) {</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_WRONGSTATE, <span class="stringliteral">&quot;UserCtx-&gt;ParticleCount is NULL. Compute counts before calling ScatterAllParticleFieldsToEulerFields.&quot;</span>);</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    }</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160; </div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    <span class="comment">// --- Scatter Particle Field &quot;Psi&quot; -&gt; Eulerian Field user-&gt;P (on da) ---</span></div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    <span class="comment">// Check if the target Eulerian vector &#39;user-&gt;P&#39; exists.</span></div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#af8df0703ce4dab73db61fa500a7c5f2b">Psi</a>) {</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;        </div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Scattering particle field &#39;Psi&#39; to user-&gt;Psi.\n&quot;</span>);</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;        <span class="comment">// Zero the target vector before accumulating the new average for this step/call.</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160; </div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;    <span class="comment">// Debug Verification ------------------------------------------------</span></div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    Vec swarm_Psi;</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    PetscReal Avg_Psi,Avg_swarm_Psi;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;         </div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;    ierr = VecMean(user-&gt;<a class="code" href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">P</a>,&amp;Avg_Psi);</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; Average of Scalar(Psi) before scatter: %.4f.\n&quot;</span>,Avg_Psi);</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;         </div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;    ierr = DMSwarmCreateGlobalVectorFromField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>,<span class="stringliteral">&quot;Psi&quot;</span>,&amp;swarm_Psi);</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    ierr = VecMean(swarm_Psi,&amp;Avg_swarm_Psi);</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160; </div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; Average of Particle Scalar(Psi): %.4f.\n&quot;</span>,Avg_swarm_Psi);</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160; </div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    ierr = DMSwarmDestroyGlobalVectorFromField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>,<span class="stringliteral">&quot;Psi&quot;</span>,&amp;swarm_Psi);</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    <span class="comment">// Debug----------------------------------------------------------------</span></div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;      </div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;    <span class="comment">//ierr = VecSet(user-&gt;P, 0.0); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        <span class="comment">// Call the unified scatter function. It will handle DM determination and validation.</span></div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;        <span class="comment">// It will also error out if the *particle* field &quot;Psi&quot; doesn&#39;t exist in the swarm.</span></div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;        ierr = <a class="code" href="group__scatter__module.html#gaa6642e53fe1be75dcc180dab3cf3f692">ScatterParticleFieldToEulerField</a>(user, <span class="stringliteral">&quot;Psi&quot;</span>, user-&gt;<a class="code" href="variables_8h.html#af8df0703ce4dab73db61fa500a7c5f2b">Psi</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    ierr = VecMean(user-&gt;<a class="code" href="variables_8h.html#af8df0703ce4dab73db61fa500a7c5f2b">Psi</a>,&amp;Avg_Psi);</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    </div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; Average of Scalar(Psi) after  scatter: %.4f.\n&quot;</span>,Avg_Psi);</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;        <span class="comment">// Only log a warning if the target Eulerian field is missing in the context.</span></div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400">LOG_WARNING</a>, <span class="stringliteral">&quot;Skipping scatter for &#39;Psi&#39;: UserCtx-&gt;Psi is NULL.\n&quot;</span>);</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;    }</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160; </div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    <span class="comment">// --- (Commented Out) Scatter Other Fields ---</span></div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    <span class="comment">// To enable scattering for other fields, uncomment the relevant block</span></div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;    <span class="comment">// AND ensure:</span></div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    <span class="comment">// 1. The corresponding particle field (e.g., &quot;Nvert&quot;, &quot;Ucat&quot;) exists in user-&gt;swarm.</span></div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    <span class="comment">// 2. The corresponding target Eulerian Vec (e.g., user-&gt;Nvert, user-&gt;Ucat) exists in user-&gt;ctx.</span></div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    <span class="comment">// 3. The target Eulerian Vec is associated with the correct DM (da for Nvert, fda for Ucat).</span></div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160; </div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;<span class="comment">    // Scatter Particle Field &quot;Nvert&quot; -&gt; Eulerian Field user-&gt;Nvert (on da)</span></div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;<span class="comment">    if (user-&gt;Nvert) {</span></div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;<span class="comment">        LOG_ALLOW(GLOBAL, LOG_DEBUG, &quot;Scattering particle field &#39;Nvert&#39; to user-&gt;Nvert.\n&quot;);</span></div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;<span class="comment">        ierr = VecSet(user-&gt;Nvert, 0.0); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;<span class="comment">        ierr = ScatterParticleFieldToEulerField(user, &quot;Nvert&quot;, user-&gt;Nvert); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<span class="comment">    } else {</span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="comment">         LOG_ALLOW(GLOBAL, LOG_WARNING, &quot;Skipping scatter for &#39;Nvert&#39;: UserCtx-&gt;Nvert is NULL.\n&quot;);</span></div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160; </div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;<span class="comment">    // Scatter Particle Field &quot;Ucat&quot; -&gt; Eulerian Field user-&gt;Ucat (on fda)</span></div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;<span class="comment">    if (user-&gt;Ucat) {</span></div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;<span class="comment">        LOG_ALLOW(GLOBAL, LOG_DEBUG, &quot;Scattering particle field &#39;Ucat&#39; to user-&gt;Ucat.\n&quot;);</span></div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;<span class="comment">        ierr = VecSet(user-&gt;Ucat, 0.0); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;<span class="comment">        ierr = ScatterParticleFieldToEulerField(user, &quot;Ucat&quot;, user-&gt;Ucat); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;<span class="comment">    } else {</span></div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;<span class="comment">        LOG_ALLOW(GLOBAL, LOG_WARNING, &quot;Skipping scatter for &#39;Ucat&#39;: UserCtx-&gt;Ucat is NULL.\n&quot;);</span></div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160; </div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;<span class="comment">     // Scatter Particle Field &quot;Ucont&quot; -&gt; Eulerian Field user-&gt;Ucont (on fda)</span></div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;<span class="comment">    if (user-&gt;Ucont) {</span></div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;<span class="comment">        LOG_ALLOW(GLOBAL, LOG_DEBUG, &quot;Scattering particle field &#39;Ucont&#39; to user-&gt;Ucont.\n&quot;);</span></div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;<span class="comment">        ierr = VecSet(user-&gt;Ucont, 0.0); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;<span class="comment">        ierr = ScatterParticleFieldToEulerField(user, &quot;Ucont&quot;, user-&gt;Ucont); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;<span class="comment">    } else {</span></div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="comment">        LOG_ALLOW(GLOBAL, LOG_WARNING, &quot;Skipping scatter for &#39;Ucont&#39;: UserCtx-&gt;Ucont is NULL.\n&quot;);</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160; </div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;    <span class="comment">// Add more fields as needed following the pattern above...</span></div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160; </div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Finished scattering specified particle fields.\n&quot;</span>);</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="group__scatter__module_ga84b852e1186804ff34e9228fab1764c6_cgraph.svg" width="100%" height="410"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="group__scatter__module_ga84b852e1186804ff34e9228fab1764c6_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="ga81cfdf7b32472d8f614b44e30005ec6c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga81cfdf7b32472d8f614b44e30005ec6c">&#9670;&nbsp;</a></span>CalculateParticleCountPerCell()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode CalculateParticleCountPerCell </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Counts particles in each cell of the DMDA 'da' and stores the result in user-&gt;ParticleCount. </p>
<p>Zeros the user-&gt;ParticleCount vector, then iterates through local particles. Reads the <b>GLOBAL</b> cell index (I, J, K) stored in the "DMSwarm_CellID" field. Uses DMDAVecGetArray to access the local portion of the count vector and increments the count at the global index (I, J, K) if it belongs to the local patch (including ghosts).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing da, swarm, and ParticleCount.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success, non-zero on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00602">602</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                                                            {</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    DM             da = user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    DM             swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    Vec            countVec = user-&gt;<a class="code" href="variables_8h.html#aa194db376ea0f68ec7090718804488ab">ParticleCount</a>;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    PetscInt       nlocal, p;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    PetscInt       *global_cell_id_arr; <span class="comment">// Read GLOBAL cell IDs</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    PetscScalar    ***count_arr_3d;     <span class="comment">// Use 3D accessor</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    PetscInt64       *PID_arr;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <span class="keywordtype">char</span>           msg[<a class="code" href="ParticleMotion_8c.html#a8a60be44abd6bcc3c5912e23b8b940c4">ERROR_MSG_BUFFER_SIZE</a>];</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    PetscInt       particles_counted_locally = 0;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160; </div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160; </div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="comment">// --- Input Validation ---</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keywordflow">if</span> (!da) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;da is NULL.&quot;</span>);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">if</span> (!swarm) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;swarm is NULL.&quot;</span>);</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keywordflow">if</span> (!countVec) SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;UserCtx-&gt;ParticleCount is NULL.&quot;</span>);</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="comment">// Check DOF of da</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    PetscInt count_dof;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    ierr = DMDAGetInfo(da, NULL, NULL, NULL, NULL, NULL, NULL, NULL, &amp;count_dof, NULL, NULL, NULL, NULL, NULL); CHKERRQ(ierr);</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;     <span class="keywordflow">if</span> (count_dof != 1) { PetscSNPrintf(msg, <span class="keyword">sizeof</span>(msg), <span class="stringliteral">&quot;countDM must have DOF=1, got %d.&quot;</span>, count_dof); SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_WRONG, msg); }</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160; </div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="comment">// --- Zero the count vector ---</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    ierr = VecSet(countVec, 0.0); CHKERRQ(ierr);</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160; </div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="comment">// --- Get Particle Data ---</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell: Accessing particle data.\n&quot;</span>);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nlocal); CHKERRQ(ierr);</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    ierr = DMSwarmGetField(swarm,<span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;global_cell_id_arr); CHKERRQ(ierr);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    ierr = DMSwarmGetField(swarm,<span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,NULL,NULL,(<span class="keywordtype">void</span> **)&amp;PID_arr);CHKERRQ(ierr);</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160; </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="comment">// --- Get Grid Vector Array using DMDA accessor ---</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell: Accessing ParticleCount vector array (using DMDAVecGetArray).\n&quot;</span>);</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    ierr = DMDAVecGetArray(da, countVec, &amp;count_arr_3d); CHKERRQ(ierr);</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160; </div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="comment">// Get local owned range for validation/logging if needed, but not for indexing with DMDAVecGetArray</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    PetscInt xs, ys, zs, xm, ym, zm;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    ierr = DMDAGetCorners(da, &amp;xs, &amp;ys, &amp;zs, &amp;xm, &amp;ym, &amp;zm); CHKERRQ(ierr);</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160; </div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="comment">// --- Accumulate Counts Locally ---</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell (Rank %d): Processing %d local particles using GLOBAL CellIDs.\n&quot;</span>,rank,nlocal);</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">for</span> (p = 0; p &lt; nlocal; p++) {</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="comment">// Read the GLOBAL indices stored for this particle</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        PetscInt64 i = global_cell_id_arr[p * 3 + 0]; <span class="comment">// Global i index</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        PetscInt64 j = global_cell_id_arr[p * 3 + 1]; <span class="comment">// Global j index</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        PetscInt64 k = global_cell_id_arr[p * 3 + 2]; <span class="comment">// Global k index</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160; </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <span class="comment">// *** Bounds check is implicitly handled by DMDAVecGetArray for owned+ghost region ***</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        <span class="comment">// However, accessing outside this region using global indices WILL cause an error.</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <span class="comment">// A preliminary check might still be wise if global IDs could be wild.</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        <span class="comment">// We rely on LocateAllParticles to provide valid global indices [0..IM-1] etc.</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="comment">// *** ADD PRINTF HERE ***</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <a class="code" href="logging_8h.html#a1543cd95db1569c7d901fd4b9a3a43d7">LOG_LOOP_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,p,100,<span class="stringliteral">&quot;[Rank %d CalcCount] Read CellID for p=%d, PID = %ld: (%ld, %ld, %ld)\n&quot;</span>, rank, p,PID_arr[p],i, j, k);</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="comment">// *** END PRINTF ***</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        <span class="comment">// *** Access the local array using GLOBAL indices ***</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        <span class="comment">// DMDAVecGetArray allows this, mapping global (I,J,K) to the correct</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="comment">// location within the local ghosted array segment.</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        <span class="comment">// This assumes (I,J,K) corresponds to a cell within the local owned+ghost region.</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="comment">// If (I,J,K) is for a cell owned by *another* rank (and not in the ghost region</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        <span class="comment">// of this rank), accessing count_arr_3d[K][J][I] will likely lead to a crash</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        <span class="comment">// or incorrect results. This highlights why storing LOCAL indices is preferred</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        <span class="comment">// for parallel runs. But proceeding with GLOBAL as requested:</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="keywordflow">if</span> (i &gt;= xs &amp;&amp; i &lt; xs + xm  &amp;&amp; </div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;            j &gt;= ys &amp;&amp; j &lt; ys + ym  &amp;&amp; <span class="comment">// Adjust based on actual ghost width</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            k &gt;= zs &amp;&amp; k &lt; zs + zm  )   <span class="comment">// This check prevents definite crashes but doesn&#39;t guarantee ownership</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        {</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;             <span class="comment">// Increment count at the location corresponding to GLOBAL index (I,J,K)</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;      <span class="comment">//  LOG_ALLOW(LOCAL, LOG_DEBUG, &quot;CalculateParticleCountPerCell (Rank %d): Particle %d with global CellID (%d, %d, %d) incremented with a particle.\n&quot;,rank, p, i, j, k);</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;             count_arr_3d[k][j][i] += 1.0;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;             particles_counted_locally++;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;         } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;              <span class="comment">// This particle&#39;s global ID is likely outside the range this rank handles (even ghosts)</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;              <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell (Rank %d): Skipping particle %ld with global CellID (%ld, %ld, %ld) - likely outside local+ghost range.\n&quot;</span>,rank, PID_arr[p] , i, j, k);</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    }</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    }</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell (Rank %d): Local counting finished. Processed %d particles locally.\n&quot;</span>, rank, particles_counted_locally);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160; </div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="comment">// --- Restore Access ---</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    ierr = DMDAVecRestoreArray(da, countVec, &amp;count_arr_3d); CHKERRQ(ierr);</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    ierr = DMSwarmRestoreField(swarm,<span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;global_cell_id_arr); CHKERRQ(ierr);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    ierr = DMSwarmRestoreField(swarm,<span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,NULL,NULL,(<span class="keywordtype">void</span> **)&amp;PID_arr);CHKERRQ(ierr);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="comment">// --- Assemble Global Vector ---</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell: Assembling global ParticleCount vector.\n&quot;</span>);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    ierr = VecAssemblyBegin(countVec); CHKERRQ(ierr);</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    ierr = VecAssemblyEnd(countVec); CHKERRQ(ierr);</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160; </div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="comment">// --- Verification Logging ---</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    PetscReal total_counted_particles = 0.0, max_count_in_cell = 0.0;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    ierr = VecSum(countVec, &amp;total_counted_particles); CHKERRQ(ierr);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    PetscInt max_idx_global = -1;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    ierr = VecMax(countVec, &amp;max_idx_global, &amp;max_count_in_cell); CHKERRQ(ierr);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell: Total counted globally = %.0f, Max count in cell = %.0f\n&quot;</span>,</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;              total_counted_particles, max_count_in_cell);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160; </div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="comment">// --- ADD THIS DEBUGGING BLOCK ---</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">if</span> (max_idx_global &gt;= 0) { <span class="comment">// Check if VecMax found a location</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;         <span class="comment">// Need to convert the flat global index back to 3D global index (I, J, K)</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;         <span class="comment">// Get global grid dimensions (Nodes, NOT Cells IM/JM/KM)</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;         PetscInt M, N, P;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;         ierr = DMDAGetInfo(da, NULL, &amp;M, &amp;N, &amp;P, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL); CHKERRQ(ierr);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;         <span class="comment">// Note: Assuming DOF=1 for countVec, index mapping uses node dimensions M,N,P from DMDA creation (IM+1, etc)</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;         <span class="comment">// Re-check if your DMDA uses cell counts (IM) or node counts (IM+1) for Vec layout. Let&#39;s assume Node counts M,N,P.</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;         PetscInt Kmax = max_idx_global / (M * N);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;         PetscInt Jmax = (max_idx_global % (M * N)) / M;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;         PetscInt Imax = max_idx_global % M;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;         <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;  -&gt; Max count located at global index (I,J,K) = (%d, %d, %d) [Flat index: %d]\n&quot;</span>,</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                   (<span class="keywordtype">int</span>)Imax, (<span class="keywordtype">int</span>)Jmax, (<span class="keywordtype">int</span>)Kmax, (<span class="keywordtype">int</span>)max_idx_global);</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="comment">// Also, let&#39;s explicitly check the count at (0,0,0)</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        PetscScalar count_at_origin = 0.0;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        PetscScalar ***count_arr_for_check;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        ierr = DMDAVecGetArrayRead(da, countVec, &amp;count_arr_for_check); CHKERRQ(ierr);</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        <span class="comment">// Check bounds before accessing - crucial if using global indices</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        PetscInt xs, ys, zs, xm, ym, zm;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        ierr = DMDAGetCorners(da, &amp;xs, &amp;ys, &amp;zs, &amp;xm, &amp;ym, &amp;zm); CHKERRQ(ierr);</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        <span class="keywordflow">if</span> (0 &gt;= xs &amp;&amp; 0 &lt; xs+xm &amp;&amp; 0 &gt;= ys &amp;&amp; 0 &lt; ys+ym &amp;&amp; 0 &gt;= zs &amp;&amp; 0 &lt; zs+zm) {</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;             count_at_origin = count_arr_for_check[0][0][0]; <span class="comment">// Access using global index (0,0,0)</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;            <span class="comment">// Origin is not on this rank (relevant for parallel, but check anyway)</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            count_at_origin = -999.0; <span class="comment">// Indicate it wasn&#39;t accessible locally</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        }</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        ierr = DMDAVecRestoreArrayRead(da, countVec, &amp;count_arr_for_check); CHKERRQ(ierr);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;  -&gt; Count at global index (0,0,0) = %.1f\n&quot;</span>, count_at_origin);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160; </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;         <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400">LOG_WARNING</a>, <span class="stringliteral">&quot;  -&gt; VecMax did not return a location for the maximum value.\n&quot;</span>);</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    }</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="comment">// --- END DEBUGGING BLOCK ---</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;CalculateParticleCountPerCell: Particle counting complete.\n&quot;</span>);</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160; </div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="group__scatter__module_ga81cfdf7b32472d8f614b44e30005ec6c_icgraph.svg" width="100%" height="416"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a></div><div class="ttdeci">@ LOG_DEBUG</div><div class="ttdoc">Detailed debugging information.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00033">logging.h:33</a></div></div>
<div class="ttc" id="avariables_8h_html_a5a73aa2bc6be44bc1ff8847cf0a1b6af"><div class="ttname"><a href="variables_8h.html#a5a73aa2bc6be44bc1ff8847cf0a1b6af">UserCtx::P</a></div><div class="ttdeci">Vec P</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00684">variables.h:684</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400">LOG_WARNING</a></div><div class="ttdeci">@ LOG_WARNING</div><div class="ttdoc">Non-critical issues that warrant attention.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00030">logging.h:30</a></div></div>
<div class="ttc" id="ainterpolation_8c_html_a8a60be44abd6bcc3c5912e23b8b940c4"><div class="ttname"><a href="interpolation_8c.html#a8a60be44abd6bcc3c5912e23b8b940c4">ERROR_MSG_BUFFER_SIZE</a></div><div class="ttdeci">#define ERROR_MSG_BUFFER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="interpolation_8c_source.html#l00016">interpolation.c:16</a></div></div>
<div class="ttc" id="alogging_8h_html_a3758dd5d300a594312c95bc393378df0"><div class="ttname"><a href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a></div><div class="ttdeci">#define LOCAL</div><div class="ttdoc">Logging scope definitions for controlling message output.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00044">logging.h:44</a></div></div>
<div class="ttc" id="alogging_8h_html_a5fe7257f46131945aacf9a35e9de5874"><div class="ttname"><a href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a></div><div class="ttdeci">#define PROFILE_FUNCTION_END</div><div class="ttdoc">Marks the end of a profiled code block.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00731">logging.h:731</a></div></div>
<div class="ttc" id="agroup__scatter__module_html_gaa6642e53fe1be75dcc180dab3cf3f692"><div class="ttname"><a href="group__scatter__module.html#gaa6642e53fe1be75dcc180dab3cf3f692">ScatterParticleFieldToEulerField</a></div><div class="ttdeci">PetscErrorCode ScatterParticleFieldToEulerField(UserCtx *user, const char *particleFieldName, Vec eulerFieldAverageVec)</div><div class="ttdoc">Scatters a particle field (scalar or vector) to the corresponding Eulerian field average.</div><div class="ttdef"><b>Definition:</b> <a href="interpolation_8c_source.html#l02009">interpolation.c:2009</a></div></div>
<div class="ttc" id="alogging_8h_html_a3de33738fd3c7e77bffbcfaefc3e7645"><div class="ttname"><a href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a></div><div class="ttdeci">#define GLOBAL</div><div class="ttdoc">Scope for global logging across all processes.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00045">logging.h:45</a></div></div>
<div class="ttc" id="agroup__scatter__module__internal_html_gac35f52bb41ee862f912a146e86f1affd"><div class="ttname"><a href="group__scatter__module__internal.html#gac35f52bb41ee862f912a146e86f1affd">ScatterParticleFieldToEulerField_Internal</a></div><div class="ttdeci">static PetscErrorCode ScatterParticleFieldToEulerField_Internal(UserCtx *user, const char *particleFieldName, DM targetDM, PetscInt expected_dof, Vec eulerFieldAverageVec)</div><div class="ttdoc">Internal helper function to orchestrate the scatter operation (accumulate + normalize).</div><div class="ttdef"><b>Definition:</b> <a href="interpolation_8c_source.html#l01924">interpolation.c:1924</a></div></div>
<div class="ttc" id="avariables_8h_html_aa194db376ea0f68ec7090718804488ab"><div class="ttname"><a href="variables_8h.html#aa194db376ea0f68ec7090718804488ab">UserCtx::ParticleCount</a></div><div class="ttdeci">Vec ParticleCount</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00724">variables.h:724</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a8a60be44abd6bcc3c5912e23b8b940c4"><div class="ttname"><a href="ParticleMotion_8c.html#a8a60be44abd6bcc3c5912e23b8b940c4">ERROR_MSG_BUFFER_SIZE</a></div><div class="ttdeci">#define ERROR_MSG_BUFFER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l00007">ParticleMotion.c:7</a></div></div>
<div class="ttc" id="alogging_8h_html_a1543cd95db1569c7d901fd4b9a3a43d7"><div class="ttname"><a href="logging_8h.html#a1543cd95db1569c7d901fd4b9a3a43d7">LOG_LOOP_ALLOW</a></div><div class="ttdeci">#define LOG_LOOP_ALLOW(scope, level, iterVar, interval, fmt,...)</div><div class="ttdoc">Logs a message inside a loop, but only every interval iterations.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00311">logging.h:311</a></div></div>
<div class="ttc" id="avariables_8h_html_af8df0703ce4dab73db61fa500a7c5f2b"><div class="ttname"><a href="variables_8h.html#af8df0703ce4dab73db61fa500a7c5f2b">UserCtx::Psi</a></div><div class="ttdeci">Vec Psi</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00725">variables.h:725</a></div></div>
<div class="ttc" id="avariables_8h_html_a69966d928601d61d4f526636f84396c5"><div class="ttname"><a href="variables_8h.html#a69966d928601d61d4f526636f84396c5">UserCtx::fda</a></div><div class="ttdeci">DM fda</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00663">variables.h:663</a></div></div>
<div class="ttc" id="alogging_8h_html_a4a671b0e347e0a22b0df806f246d5d11"><div class="ttname"><a href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a></div><div class="ttdeci">#define LOG_ALLOW(scope, level, fmt,...)</div><div class="ttdoc">Logging macro that checks both the log level and whether the calling function is in the allowed-funct...</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00199">logging.h:199</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a></div><div class="ttdeci">@ LOG_INFO</div><div class="ttdoc">Informational messages about program execution.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00032">logging.h:32</a></div></div>
<div class="ttc" id="avariables_8h_html_a1675749ea3b2429f00405a1ee3203d18"><div class="ttname"><a href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">UserCtx::swarm</a></div><div class="ttdeci">DM swarm</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00722">variables.h:722</a></div></div>
<div class="ttc" id="agroup__scatter__module__internal_html_ga16dc04f7710ac752691f269400381913"><div class="ttname"><a href="group__scatter__module__internal.html#ga16dc04f7710ac752691f269400381913">GetScatterTargetInfo</a></div><div class="ttdeci">PetscErrorCode GetScatterTargetInfo(UserCtx *user, const char *particleFieldName, DM *targetDM, PetscInt *expected_dof)</div><div class="ttdoc">Determines the target Eulerian DM and expected DOF for scattering a given particle field.</div><div class="ttdef"><b>Definition:</b> <a href="interpolation_8c_source.html#l01611">interpolation.c:1611</a></div></div>
<div class="ttc" id="alogging_8h_html_ace99f3e207ccb2e46e9b782f9e57732e"><div class="ttname"><a href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a></div><div class="ttdeci">#define PROFILE_FUNCTION_BEGIN</div><div class="ttdoc">Marks the beginning of a profiled code block (typically a function).</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00722">logging.h:722</a></div></div>
<div class="ttc" id="avariables_8h_html_af031acb43b014d5ac788aa9003491e75"><div class="ttname"><a href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">UserCtx::da</a></div><div class="ttdeci">DM da</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00663">variables.h:663</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
