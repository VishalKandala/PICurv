<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PICurv: ParticleMotion.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PICurv
   &#160;<span id="projectnumber">0.1.0</span>
   </div>
   <div id="projectbrief">A Parallel Particle-In-Cell Solver for Curvilinear LES</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ParticleMotion_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ParticleMotion.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;petsc.h&gt;</code><br />
<code>#include &lt;petscdmswarm.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;petscsys.h&gt;</code><br />
<code>#include &lt;math.h&gt;</code><br />
<code>#include &quot;<a class="el" href="variables_8h_source.html">variables.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="logging_8h_source.html">logging.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="walkingsearch_8h_source.html">walkingsearch.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for ParticleMotion.h:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h__incl.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h__dep__incl.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
</div>
<p><a href="ParticleMotion_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a030c51d171d2f725c708cd334f51ef2c"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a030c51d171d2f725c708cd334f51ef2c">UpdateParticlePosition</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, <a class="el" href="variables_8h.html#structCmpnts">Cmpnts</a> *position, const <a class="el" href="variables_8h.html#structCmpnts">Cmpnts</a> *velocity)</td></tr>
<tr class="memdesc:a030c51d171d2f725c708cd334f51ef2c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates a particle's position based on its velocity and the timestep dt (stored in user-&gt;dt).  <a href="ParticleMotion_8h.html#a030c51d171d2f725c708cd334f51ef2c">More...</a><br /></td></tr>
<tr class="separator:a030c51d171d2f725c708cd334f51ef2c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74bec635d0f085bd2e8aef6c61aac629"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a74bec635d0f085bd2e8aef6c61aac629">UpdateAllParticlePositions</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a74bec635d0f085bd2e8aef6c61aac629"><td class="mdescLeft">&#160;</td><td class="mdescRight">Loops over all local particles in the DMSwarm, updating their positions based on velocity and the global timestep user-&gt;dt.  <a href="ParticleMotion_8h.html#a74bec635d0f085bd2e8aef6c61aac629">More...</a><br /></td></tr>
<tr class="separator:a74bec635d0f085bd2e8aef6c61aac629"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55852c79d34ca903c6e631941e210975"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a55852c79d34ca903c6e631941e210975">CheckAndRemoveOutOfBoundsParticles</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, PetscInt *removedCountLocal, PetscInt *removedCountGlobal, const <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *bboxlist)</td></tr>
<tr class="memdesc:a55852c79d34ca903c6e631941e210975"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks for particles outside the physical domain boundaries and removes them using DMSwarmRemovePointAtIndex.  <a href="ParticleMotion_8h.html#a55852c79d34ca903c6e631941e210975">More...</a><br /></td></tr>
<tr class="separator:a55852c79d34ca903c6e631941e210975"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb793f591b8baf11864bb85040730b28"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#acb793f591b8baf11864bb85040730b28">CheckAndRemoveLostParticles</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, PetscInt *removedCountLocal, PetscInt *removedCountGlobal)</td></tr>
<tr class="memdesc:acb793f591b8baf11864bb85040730b28"><td class="mdescLeft">&#160;</td><td class="mdescRight">Removes particles that have been definitively flagged as LOST by the location algorithm.  <a href="ParticleMotion_8h.html#acb793f591b8baf11864bb85040730b28">More...</a><br /></td></tr>
<tr class="separator:acb793f591b8baf11864bb85040730b28"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8e1c87062a6a1a20332434483deb0b70"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a8e1c87062a6a1a20332434483deb0b70">DefineBasicMigrationPattern</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a8e1c87062a6a1a20332434483deb0b70"><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines the basic migration pattern for particles within the swarm.  <a href="ParticleMotion_8h.html#a8e1c87062a6a1a20332434483deb0b70">More...</a><br /></td></tr>
<tr class="separator:a8e1c87062a6a1a20332434483deb0b70"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3f5ce9a37376259f6bd2989176b2a68"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#ae3f5ce9a37376259f6bd2989176b2a68">PerformBasicMigration</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:ae3f5ce9a37376259f6bd2989176b2a68"><td class="mdescLeft">&#160;</td><td class="mdescRight">Performs the basic migration of particles based on the defined migration pattern.  <a href="ParticleMotion_8h.html#ae3f5ce9a37376259f6bd2989176b2a68">More...</a><br /></td></tr>
<tr class="separator:ae3f5ce9a37376259f6bd2989176b2a68"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acf00ed7232c9aa111858b5a4cff43922"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#acf00ed7232c9aa111858b5a4cff43922">IdentifyMigratingParticles</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, const <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *bboxlist, <a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> **migrationList, PetscInt *migrationCount, PetscInt *listCapacity)</td></tr>
<tr class="memdesc:acf00ed7232c9aa111858b5a4cff43922"><td class="mdescLeft">&#160;</td><td class="mdescRight">Identifies particles leaving the local bounding box and finds their target neighbor rank.  <a href="ParticleMotion_8h.html#acf00ed7232c9aa111858b5a4cff43922">More...</a><br /></td></tr>
<tr class="separator:acf00ed7232c9aa111858b5a4cff43922"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a461def358c0f7c5337c283ba06dd65a0"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a461def358c0f7c5337c283ba06dd65a0">SetMigrationRanks</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, const <a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> *migrationList, PetscInt migrationCount)</td></tr>
<tr class="memdesc:a461def358c0f7c5337c283ba06dd65a0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the target rank field (DMSwarmPICField_rank) for particles scheduled for migration.  <a href="ParticleMotion_8h.html#a461def358c0f7c5337c283ba06dd65a0">More...</a><br /></td></tr>
<tr class="separator:a461def358c0f7c5337c283ba06dd65a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af68865be3bc987bdf1be2c5c7a1903fa"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#af68865be3bc987bdf1be2c5c7a1903fa">PerformMigration</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:af68865be3bc987bdf1be2c5c7a1903fa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Performs particle migration based on the pre-populated DMSwarmPICField_rank field.  <a href="ParticleMotion_8h.html#af68865be3bc987bdf1be2c5c7a1903fa">More...</a><br /></td></tr>
<tr class="separator:af68865be3bc987bdf1be2c5c7a1903fa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga81cfdf7b32472d8f614b44e30005ec6c"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__scatter__module.html#ga81cfdf7b32472d8f614b44e30005ec6c">CalculateParticleCountPerCell</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:ga81cfdf7b32472d8f614b44e30005ec6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Counts particles in each cell of the DMDA 'da' and stores the result in user-&gt;ParticleCount.  <a href="group__scatter__module.html#ga81cfdf7b32472d8f614b44e30005ec6c">More...</a><br /></td></tr>
<tr class="separator:ga81cfdf7b32472d8f614b44e30005ec6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a38b5e7348bc556d505e2c4b31c29b086"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a38b5e7348bc556d505e2c4b31c29b086">ResizeSwarmGlobally</a> (DM swarm, PetscInt N_target)</td></tr>
<tr class="separator:a38b5e7348bc556d505e2c4b31c29b086"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0c7489fc52fda6c92cd1f22c3f50c38"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#ae0c7489fc52fda6c92cd1f22c3f50c38">PreCheckAndResizeSwarm</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, PetscInt ti, const char *ext)</td></tr>
<tr class="memdesc:ae0c7489fc52fda6c92cd1f22c3f50c38"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks particle count in the reference file and resizes the swarm if needed.  <a href="ParticleMotion_8h.html#ae0c7489fc52fda6c92cd1f22c3f50c38">More...</a><br /></td></tr>
<tr class="separator:ae0c7489fc52fda6c92cd1f22c3f50c38"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab2eeab12258446f697695ebdaef3f011"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#ab2eeab12258446f697695ebdaef3f011">PerformSingleParticleMigrationCycle</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, const <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *bboxlist, <a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> **migrationList_p, PetscInt *migrationCount_p, PetscInt *migrationListCapacity_p, PetscReal currentTime, PetscInt step, const char *migrationCycleName, PetscInt *globalMigrationCount_out)</td></tr>
<tr class="memdesc:ab2eeab12258446f697695ebdaef3f011"><td class="mdescLeft">&#160;</td><td class="mdescRight">Performs one full cycle of particle migration: identify, set ranks, and migrate.  <a href="ParticleMotion_8h.html#ab2eeab12258446f697695ebdaef3f011">More...</a><br /></td></tr>
<tr class="separator:ab2eeab12258446f697695ebdaef3f011"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abb62172d12ae65122070a3674196c8e2"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#abb62172d12ae65122070a3674196c8e2">ReinitializeParticlesOnInletSurface</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, PetscReal currentTime, PetscInt step)</td></tr>
<tr class="memdesc:abb62172d12ae65122070a3674196c8e2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Re-initializes the positions of particles currently on this rank if this rank owns part of the designated inlet surface.  <a href="ParticleMotion_8h.html#abb62172d12ae65122070a3674196c8e2">More...</a><br /></td></tr>
<tr class="separator:abb62172d12ae65122070a3674196c8e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5d388b62daa726aa7ea467a71313a328"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a5d388b62daa726aa7ea467a71313a328">GetLocalPIDSnapshot</a> (const PetscInt64 pid_field[], PetscInt n_local, PetscInt64 **pids_snapshot_out)</td></tr>
<tr class="memdesc:a5d388b62daa726aa7ea467a71313a328"><td class="mdescLeft">&#160;</td><td class="mdescRight">Creates a sorted snapshot of all <a class="el" href="variables_8h.html#structParticle" title="Defines a particle&#39;s core properties for Lagrangian tracking.">Particle</a> IDs (PIDs) from a raw data array.  <a href="ParticleMotion_8h.html#a5d388b62daa726aa7ea467a71313a328">More...</a><br /></td></tr>
<tr class="separator:a5d388b62daa726aa7ea467a71313a328"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a43df9caf0f5cbb317050f6258ac46fff"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a43df9caf0f5cbb317050f6258ac46fff">AddToMigrationList</a> (<a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> **migration_list_p, PetscInt *capacity_p, PetscInt *count_p, PetscInt particle_local_idx, PetscMPIInt destination_rank)</td></tr>
<tr class="memdesc:a43df9caf0f5cbb317050f6258ac46fff"><td class="mdescLeft">&#160;</td><td class="mdescRight">Safely adds a new migration task to a dynamically sized list.  <a href="ParticleMotion_8h.html#a43df9caf0f5cbb317050f6258ac46fff">More...</a><br /></td></tr>
<tr class="separator:a43df9caf0f5cbb317050f6258ac46fff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad247152a0dd47d07243fad4c2fd89c0a"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#ad247152a0dd47d07243fad4c2fd89c0a">FlagNewcomersForLocation</a> (DM swarm, PetscInt n_local_before, const PetscInt64 pids_before[])</td></tr>
<tr class="memdesc:ad247152a0dd47d07243fad4c2fd89c0a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Identifies newly arrived particles after migration and flags them for a location search.  <a href="ParticleMotion_8h.html#ad247152a0dd47d07243fad4c2fd89c0a">More...</a><br /></td></tr>
<tr class="separator:ad247152a0dd47d07243fad4c2fd89c0a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a92bb4f9eac7970b9e8911104404571a9"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a92bb4f9eac7970b9e8911104404571a9">LocateAllParticlesInGrid</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a92bb4f9eac7970b9e8911104404571a9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Locates all particles within the grid and calculates their interpolation weights.  <a href="ParticleMotion_8h.html#a92bb4f9eac7970b9e8911104404571a9">More...</a><br /></td></tr>
<tr class="separator:a92bb4f9eac7970b9e8911104404571a9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a727054a4a467fd8504a19caed5a5916b"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a727054a4a467fd8504a19caed5a5916b">LocateAllParticlesInGrid_TEST</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user, <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *bboxlist)</td></tr>
<tr class="memdesc:a727054a4a467fd8504a19caed5a5916b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Orchestrates the complete particle location and migration process for one timestep.  <a href="ParticleMotion_8h.html#a727054a4a467fd8504a19caed5a5916b">More...</a><br /></td></tr>
<tr class="separator:a727054a4a467fd8504a19caed5a5916b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8be73031fbe89d58cd8f7ad2f312d2e9"><td class="memItemLeft" align="right" valign="top">PetscErrorCode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ParticleMotion_8h.html#a8be73031fbe89d58cd8f7ad2f312d2e9">ResetAllParticleStatuses</a> (<a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *user)</td></tr>
<tr class="memdesc:a8be73031fbe89d58cd8f7ad2f312d2e9"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function is designed to be called at the end of a full timestep, after all particle-based calculations are complete.  <a href="ParticleMotion_8h.html#a8be73031fbe89d58cd8f7ad2f312d2e9">More...</a><br /></td></tr>
<tr class="separator:a8be73031fbe89d58cd8f7ad2f312d2e9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a030c51d171d2f725c708cd334f51ef2c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a030c51d171d2f725c708cd334f51ef2c">&#9670;&nbsp;</a></span>UpdateParticlePosition()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode UpdateParticlePosition </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structCmpnts">Cmpnts</a> *&#160;</td>
          <td class="paramname"><em>position</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="variables_8h.html#structCmpnts">Cmpnts</a> *&#160;</td>
          <td class="paramname"><em>velocity</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Updates a particle's position based on its velocity and the timestep dt (stored in user-&gt;dt). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">user</td><td>Pointer to your <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> (must contain user-&gt;dt). </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">position</td><td>Pointer to the particle's current position (<a class="el" href="variables_8h.html#structCmpnts" title="A 3D point or vector with PetscScalar components.">Cmpnts</a>). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">velocity</td><td>Pointer to the particle's velocity (<a class="el" href="variables_8h.html#structCmpnts" title="A 3D point or vector with PetscScalar components.">Cmpnts</a>).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success, or an error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00022">22</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;{</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  PetscFunctionBeginUser; <span class="comment">// PETSc macro for error/stack tracing</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  PetscReal  dt = user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>-&gt;<a class="code" href="variables_8h.html#a53b044b8b0e4a4dc8c8fa05387af564c">dt</a>;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160; </div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  <span class="comment">/* Update the position with velocity * dt */</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  position-&gt;<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> += velocity-&gt;<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> * dt;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  position-&gt;<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> += velocity-&gt;<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> * dt;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  position-&gt;<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> += velocity-&gt;<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> * dt;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160; </div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160; </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a030c51d171d2f725c708cd334f51ef2c_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a74bec635d0f085bd2e8aef6c61aac629"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a74bec635d0f085bd2e8aef6c61aac629">&#9670;&nbsp;</a></span>UpdateAllParticlePositions()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode UpdateAllParticlePositions </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Loops over all local particles in the DMSwarm, updating their positions based on velocity and the global timestep user-&gt;dt. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> (must contain dt).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success, or an error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00048">48</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  PetscErrorCode ierr;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  DM swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  PetscInt       nLocal, p;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  PetscReal        *pos = NULL;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  PetscReal        *vel = NULL;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  PetscMPIInt rank;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> temp_pos, temp_vel; </div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  ierr = MPI_Comm_rank(PETSC_COMM_WORLD,&amp;rank);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160; </div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  PetscFunctionBeginUser;  <span class="comment">// PETSc macro for error/stack tracing</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="comment">// 1) Get the number of local particles</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  ierr = DMSwarmGetLocalSize(swarm, &amp;nLocal); CHKERRQ(ierr);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keywordflow">if</span> (nLocal == 0) {</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot;[Rank %d] No particles to move/transport. \n&quot;</span>,rank);</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    PetscFunctionReturn(0);   <span class="comment">// nothing to do, no fields held </span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  }</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="comment">// 2) Access the &quot;position&quot; and &quot;velocity&quot; fields</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;position&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pos); CHKERRQ(ierr);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;velocity&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;vel); CHKERRQ(ierr);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160; </div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; [Rank %d] No.of Particles to update: %d.\n&quot;</span>,rank,nLocal);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160; </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="comment">// 3) Loop over all local particles, updating each position by velocity * dt</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordflow">for</span> (p = 0; p &lt; nLocal; p++) {</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">// update temporary position struct</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    temp_pos.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = pos[3*p];</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    temp_pos.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = pos[3*p + 1];</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    temp_pos.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = pos[3*p + 2];</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">// update temporary velocity struct</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    temp_vel.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a> = vel[3*p];</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    temp_vel.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a> = vel[3*p + 1];</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    temp_vel.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a> = vel[3*p + 2];    </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    ierr = <a class="code" href="ParticleMotion_8c.html#a030c51d171d2f725c708cd334f51ef2c">UpdateParticlePosition</a>(user, &amp;temp_pos, &amp;temp_vel); CHKERRQ(ierr);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">// update swarm from temporary position struct</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    pos[3*p] = temp_pos.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    pos[3*p + 1] = temp_pos.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    pos[3*p + 2] = temp_pos.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    vel[3*p] = temp_vel.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    vel[3*p + 1] = temp_vel.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    vel[3*p + 2] = temp_vel.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="comment">// 4) Restore the fields</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;position&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pos); CHKERRQ(ierr);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;velocity&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;vel); CHKERRQ(ierr);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot;Particle moved/transported successfully on Rank %d.\n&quot;</span>,rank);</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  PetscFunctionReturn(0);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a74bec635d0f085bd2e8aef6c61aac629_cgraph.svg" width="424" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a74bec635d0f085bd2e8aef6c61aac629_icgraph.svg" width="504" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a55852c79d34ca903c6e631941e210975"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55852c79d34ca903c6e631941e210975">&#9670;&nbsp;</a></span>CheckAndRemoveOutOfBoundsParticles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode CheckAndRemoveOutOfBoundsParticles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>removedCountLocal</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>removedCountGlobal</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *&#160;</td>
          <td class="paramname"><em>bboxlist</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Checks for particles outside the physical domain boundaries and removes them using DMSwarmRemovePointAtIndex. </p>
<p>This function iterates through all particles local to the current MPI rank. It checks if a particle's position (x, y, or z) is outside the specified physical domain boundaries [xMin, xMax], [yMin, yMax], [zMin, zMax].</p>
<p>If a particle is found out of bounds, it is removed using DMSwarmRemovePointAtIndex. NOTE: Removing points changes the indices of subsequent points in the iteration. Therefore, it's crucial to iterate BACKWARDS or carefully manage indices after a removal. Iterating backwards is generally safer.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountLocal</td><td>Pointer to store the number of particles removed <em>on this rank</em>. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountGlobal</td><td>Pointer to store the total number of particles removed <em>across all ranks</em>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bboxlist</td><td>An array of <a class="el" href="variables_8h.html#structBoundingBox" title="Defines a 3D axis-aligned bounding box.">BoundingBox</a> structures for ALL MPI ranks, indexed 0 to (size-1). This array must be up-to-date and available on all ranks.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure.</dd></dl>
<p>Checks for particles outside the physical domain boundaries and removes them using DMSwarmRemovePointAtIndex.</p>
<p>This function iterates through all particles local to the current MPI rank. It determines if a particle's physical position is outside of ALL subdomains owned by the MPI processes. To perform this check, it requires a list of the bounding boxes for every MPI rank's subdomain.</p>
<p>If a particle is not found within any of the subdomains, it is considered "out of bounds" and is permanently removed from the simulation using DMSwarmRemovePointAtIndex().</p>
<p>The function is carefully designed to handle modifications to the DMSwarm during iteration safely. It does this by:</p><ol type="1">
<li>Iterating BACKWARDS through the local particle list, so removing an element at index 'p' does not affect the indices of subsequent elements to be checked (p-1, p-2, ...).</li>
<li>Using a robust "Restore-Remove-Reacquire" pattern. When a particle is removed, all pointers to swarm data are first restored, the removal operation is performed, and then the pointers are re-acquired for the remainder of the loop.</li>
</ol>
<dl class="section warning"><dt>Warning</dt><dd>This function contains a collective MPI operation (MPI_Allreduce) at the end. To avoid deadlocks, it MUST be called by ALL ranks in the communicator, even if a rank has no local particles. Do not place this call inside rank-specific conditional logic in your main loop.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>This function can be redundant as the robust particle location scheme (e.g., one that sets a <code>LOST</code> status) and a corresponding cleanup function are already in use.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing the swarm and MPI info. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountLocal</td><td>Pointer to an integer that will store the number of particles removed on THIS rank. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountGlobal</td><td>Pointer to an integer that will store the total number of particles removed ACROSS ALL ranks. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bboxlist</td><td>An array of <a class="el" href="variables_8h.html#structBoundingBox" title="Defines a 3D axis-aligned bounding box.">BoundingBox</a> structures for ALL MPI ranks, indexed 0 to (size-1). This array must be up-to-date and available on every rank.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00165">165</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;{</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    DM             swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    PetscInt       nLocalInitial;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    PetscReal      *pos_p = NULL;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    PetscInt64     *pid_p = NULL; <span class="comment">// For better logging</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    PetscInt       local_removed_count = 0;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    PetscMPIInt    global_removed_count_mpi = 0;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    PetscMPIInt    rank, size;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160; </div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    ierr = MPI_Comm_size(PETSC_COMM_WORLD, &amp;size); CHKERRQ(ierr);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d] Checking for out-of-bounds particles...&quot;</span>, rank);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="comment">// Initialize output parameters to ensure clean state</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    *removedCountLocal = 0;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordflow">if</span> (removedCountGlobal) *removedCountGlobal = 0;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nLocalInitial); CHKERRQ(ierr);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="comment">// Only proceed if there are particles to check on this rank.</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="comment">// All ranks will still participate in the final collective MPI_Allreduce.</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">if</span> (nLocalInitial &gt; 0) {</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment">// Get access to swarm fields once before the loop begins.</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;position&quot;</span>,    NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160; </div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="comment">// --- Iterate BACKWARDS to handle index changes safely during removal ---</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="keywordflow">for</span> (PetscInt p = nLocalInitial - 1; p &gt;= 0; p--) {</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            PetscBool isInsideAnyBox = PETSC_FALSE;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a> current_pos = {pos_p[3*p + 0], pos_p[3*p + 1], pos_p[3*p + 2]};</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            <span class="comment">// Check if the particle is inside ANY of the rank bounding boxes</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="keywordflow">for</span> (PetscMPIInt proc = 0; proc &lt; size; proc++) {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="ParticleMotion_8c.html#ad2b9ac6b5e4d13799fa82dcd34432da4">IsParticleInBox</a>(&amp;bboxlist[proc], &amp;current_pos)) {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                    isInsideAnyBox = PETSC_TRUE;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                    <span class="keywordflow">break</span>; <span class="comment">// Particle is inside a valid domain, stop checking.</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <span class="keywordflow">if</span> (!isInsideAnyBox) {</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Rank %d: Removing out-of-bounds particle [PID %lld] at local index %d. Pos: (%g, %g, %g)\n&quot;</span>,</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                          rank, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)pid_p[p], p, current_pos.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>, current_pos.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>, current_pos.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                <span class="comment">// --- Safe Removal Pattern: Restore -&gt; Remove -&gt; Reacquire ---</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                <span class="comment">// This is the fix for the double-restore bug. Pointers are managed carefully</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                <span class="comment">// within this block and then restored cleanly after the loop.</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                <span class="comment">// 1. Restore all fields BEFORE modifying the swarm structure. This invalidates pos_p and pid_p.</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;position&quot;</span>,    NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                <span class="comment">// 2. Remove the particle at the current local index &#39;p&#39;.</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                ierr = DMSwarmRemovePointAtIndex(swarm, p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                local_removed_count++;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                <span class="comment">// 3. After removal, re-acquire pointers ONLY if the loop is not finished.</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                PetscInt nLocalCurrent;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                ierr = DMSwarmGetLocalSize(swarm, &amp;nLocalCurrent); CHKERRQ(ierr);</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                <span class="keywordflow">if</span> (nLocalCurrent &gt; 0 &amp;&amp; p &gt; 0) { <span class="comment">// Check if there are particles left AND iterations left</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;position&quot;</span>,    NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                    <span class="comment">// All remaining particles were removed OR this was the last particle (p=0).</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                    <span class="comment">// Invalidate pointers to prevent the final restore call and exit the loop.</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                    pos_p = NULL;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                    pid_p = NULL;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                }</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            }</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        } <span class="comment">// End of backwards loop</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160; </div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="comment">// At the end, restore any valid pointers. This handles three cases:</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="comment">// 1. No particles were removed: restores the original pointers.</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="comment">// 2. Particles were removed mid-loop: restores the pointers from the last re-acquisition.</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="comment">// 3. All particles were removed: pointers are NULL, so nothing is done.</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        <span class="keywordflow">if</span> (pos_p) { ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;position&quot;</span>,    NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p); CHKERRQ(ierr); }</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="keywordflow">if</span> (pid_p) { ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p); CHKERRQ(ierr); }</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    } <span class="comment">// End of if (nLocalInitial &gt; 0)</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    PetscInt nLocalFinal;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nLocalFinal); CHKERRQ(ierr);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d] Finished removing %d out-of-bounds particles. Final local size: %d.\n&quot;</span>, rank, local_removed_count, nLocalFinal);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160; </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="comment">// --- Synchronize counts across all ranks ---</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    *removedCountLocal = local_removed_count;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordflow">if</span> (removedCountGlobal) {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        ierr = MPI_Allreduce(&amp;local_removed_count, &amp;global_removed_count_mpi, 1, MPI_INT, MPI_SUM, PetscObjectComm((PetscObject)swarm)); CHKERRQ(ierr);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        *removedCountGlobal = global_removed_count_mpi;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="comment">// Use a synchronized log message so only one rank prints the global total.</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <a class="code" href="logging_8h.html#a2ebe7667b52c478f7ff365f296d4c8ae">LOG_ALLOW_SYNC</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d] Removed %d out-of-bounds particles globally.\n&quot;</span>, rank, *removedCountGlobal);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    }</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160; </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a55852c79d34ca903c6e631941e210975_cgraph.svg" width="404" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a55852c79d34ca903c6e631941e210975_icgraph.svg" width="536" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="acb793f591b8baf11864bb85040730b28"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acb793f591b8baf11864bb85040730b28">&#9670;&nbsp;</a></span>CheckAndRemoveLostParticles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode CheckAndRemoveLostParticles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>removedCountLocal</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>removedCountGlobal</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Removes particles that have been definitively flagged as LOST by the location algorithm. </p>
<p>This function is the designated cleanup utility. It should be called after the <code>LocateAllParticlesInGrid</code> orchestrator has run and every particle's status has been definitively determined.</p>
<p>It iterates through all locally owned particles and checks their <code>DMSwarm_location_status</code> field. If a particle's status is <code>LOST</code>, it is permanently removed from the simulation using <code>DMSwarmRemovePointAtIndex</code>.</p>
<p>This approach centralizes the removal logic, making the <code>DMSwarm_location_status</code> the single source of truth for a particle's validity, which is more robust than relying on secondary geometric checks (like bounding boxes).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing the swarm. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountLocal</td><td>Pointer to store the number of particles removed on this rank. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountGlobal</td><td>Pointer to store the total number of particles removed across all ranks.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure.</dd></dl>
<p>This function is the designated cleanup utility for particles that have exited the physical domain or could not be located for any other reason. It should be called after a particle location and migration phase is complete.</p>
<p>It iterates through all locally owned particles and checks their <code>DMSwarm_location_status</code> field. If a particle's status is <code>LOST</code>, it is permanently removed from the simulation using <code>DMSwarmRemovePointAtIndex</code>.</p>
<p>The function is carefully designed to handle modifications to the DMSwarm during iteration safely. It does this by:</p><ol type="1">
<li>Iterating BACKWARDS through the local particle list, so removing an element at index 'p' does not affect the indices of subsequent elements to be checked (p-1, p-2, ...).</li>
<li>Using a robust "Restore-Remove-Reacquire" pattern. When a particle is removed, all pointers to swarm data are first restored, the removal operation is performed, and then the pointers are re-acquired for the remainder of the loop.</li>
</ol>
<dl class="section warning"><dt>Warning</dt><dd>This function contains a collective MPI operation (MPI_Allreduce) at the end. To avoid deadlocks, it MUST be called by ALL ranks in the communicator, even if a rank has no local particles. Do not place this call inside rank-specific conditional logic in your main loop.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing the swarm. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountLocal</td><td>Pointer to an integer that will store the number of particles removed on THIS rank. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">removedCountGlobal</td><td>Pointer to an integer that will store the total number of particles removed ACROSS ALL ranks.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00416">416</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;{</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    DM             swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    PetscInt       nLocalInitial;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    PetscInt       *status_p = NULL;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    PetscInt64     *pid_p = NULL; <span class="comment">// For better logging</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    PetscReal      *pos_p = NULL; <span class="comment">// For better logging</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    PetscInt       local_removed_count = 0;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    PetscMPIInt    global_removed_count_mpi = 0;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160; </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Rank %d: Checking for and removing LOST particles...&quot;</span>, rank);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160; </div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">// Initialize output parameters to ensure clean state</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    *removedCountLocal = 0;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">if</span> (removedCountGlobal) *removedCountGlobal = 0;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nLocalInitial); CHKERRQ(ierr);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="comment">// Only proceed if there are particles to check on this rank.</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="comment">// All ranks will still participate in the final collective MPI_Allreduce.</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">if</span> (nLocalInitial &gt; 0) {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="comment">// Get access to all swarm fields once before the loop begins.</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;status_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;position&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160; </div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="comment">// --- Iterate BACKWARDS to handle index changes safely during removal ---</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="keywordflow">for</span> (PetscInt p = nLocalInitial - 1; p &gt;= 0; p--) {</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;            <span class="keywordflow">if</span> (status_p[p] == <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581a339435bd0d4a842c6107333c908a5317">LOST</a>) {</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Rank %d: Removing LOST particle [PID %lld] at local index %d. Position: (%.4f, %.4f, %.4f).\n&quot;</span>,</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                          rank, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)pid_p[p], p, pos_p[3*p], pos_p[3*p+1], pos_p[3*p+2]);</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160; </div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                <span class="comment">// --- Safe Removal Pattern: Restore -&gt; Remove -&gt; Reacquire ---</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                <span class="comment">// This is the fix for the double-restore bug. Pointers are managed carefully</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                <span class="comment">// within this block and then restored cleanly after the loop.</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160; </div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="comment">// 1. Restore all fields BEFORE modifying the swarm structure. This invalidates all pointers.</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;status_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;position&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160; </div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                <span class="comment">// 2. Remove the particle at the current local index &#39;p&#39;.</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                ierr = DMSwarmRemovePointAtIndex(swarm, p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                local_removed_count++;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160; </div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                <span class="comment">// 3. After removal, re-acquire pointers ONLY if the loop is not finished.</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                PetscInt nLocalCurrent;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                ierr = DMSwarmGetLocalSize(swarm, &amp;nLocalCurrent); CHKERRQ(ierr);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160; </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                <span class="keywordflow">if</span> (nLocalCurrent &gt; 0 &amp;&amp; p &gt; 0) { <span class="comment">// Check if there are particles left AND iterations left</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;status_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;position&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                    <span class="comment">// All remaining particles were removed OR this was the last particle (p=0).</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                    <span class="comment">// Invalidate pointers to prevent the final restore call and exit the loop.</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                    status_p = NULL;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                    pid_p = NULL;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                    pos_p = NULL;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                }</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            }</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        } <span class="comment">// End of backwards loop</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160; </div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="comment">// At the end, restore any valid pointers. This handles three cases:</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">// 1. No particles were removed: restores the original pointers.</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        <span class="comment">// 2. Particles were removed mid-loop: restores the pointers from the last re-acquisition.</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <span class="comment">// 3. All particles were removed: pointers are NULL, so nothing is done.</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        <span class="keywordflow">if</span> (status_p) { ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;status_p); CHKERRQ(ierr); }</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <span class="keywordflow">if</span> (pid_p)    { ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pid_p);    CHKERRQ(ierr); }</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="keywordflow">if</span> (pos_p)    { ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;position&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span> **)&amp;pos_p);    CHKERRQ(ierr); }</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    } <span class="comment">// End of if (nLocalInitial &gt; 0)</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160; </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    PetscInt nLocalFinal;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nLocalFinal); CHKERRQ(ierr);</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Rank %d: Finished removing %d LOST particles. Final local size: %d.\n&quot;</span>, rank, local_removed_count, nLocalFinal);</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160; </div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="comment">// --- Synchronize counts across all ranks ---</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    *removedCountLocal = local_removed_count;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">if</span> (removedCountGlobal) {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        ierr = MPI_Allreduce(&amp;local_removed_count, &amp;global_removed_count_mpi, 1, MPI_INT, MPI_SUM, PetscObjectComm((PetscObject)swarm)); CHKERRQ(ierr);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        *removedCountGlobal = global_removed_count_mpi;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="comment">// Use a synchronized log message so only one rank prints the global total.</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <a class="code" href="logging_8h.html#a2ebe7667b52c478f7ff365f296d4c8ae">LOG_ALLOW_SYNC</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d] Removed %d LOST particles globally.\n&quot;</span>, rank, *removedCountGlobal);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    </div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_acb793f591b8baf11864bb85040730b28_icgraph.svg" width="534" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a8e1c87062a6a1a20332434483deb0b70"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8e1c87062a6a1a20332434483deb0b70">&#9670;&nbsp;</a></span>DefineBasicMigrationPattern()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode DefineBasicMigrationPattern </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Defines the basic migration pattern for particles within the swarm. </p>
<p>This function establishes the migration pattern that dictates how particles move between different MPI ranks in the simulation. It initializes a migration list where each particle is assigned a target rank based on predefined conditions. The migration pattern can be customized to implement various migration behaviors.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing simulation context.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success, non-zero on failure. </dd></dl>

</div>
</div>
<a id="ae3f5ce9a37376259f6bd2989176b2a68"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3f5ce9a37376259f6bd2989176b2a68">&#9670;&nbsp;</a></span>PerformBasicMigration()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PerformBasicMigration </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Performs the basic migration of particles based on the defined migration pattern. </p>
<p>This function updates the positions of particles within the swarm by migrating them to target MPI ranks as specified in the migration list. It handles the migration process by setting the 'DMSwarm_rank' field for each particle and invokes the DMSwarm migration mechanism to relocate particles across MPI processes. After migration, it cleans up allocated resources and ensures synchronization across all MPI ranks.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing simulation context.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns 0 on success, non-zero on failure. </dd></dl>

</div>
</div>
<a id="acf00ed7232c9aa111858b5a4cff43922"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acf00ed7232c9aa111858b5a4cff43922">&#9670;&nbsp;</a></span>IdentifyMigratingParticles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode IdentifyMigratingParticles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *&#160;</td>
          <td class="paramname"><em>bboxlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> **&#160;</td>
          <td class="paramname"><em>migrationList</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>migrationCount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>listCapacity</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Identifies particles leaving the local bounding box and finds their target neighbor rank. </p>
<p>Iterates local particles, checks against local bounding box. If outside, checks the pre-computed immediate neighbors (user-&gt;neighbors) using the global bboxlist to see if the particle landed in one of them. Populates the migrationList. Does NOT handle particles leaving the global domain (assumes CheckAndRemove was called).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> (contains local bbox and neighbors). </td></tr>
    <tr><td class="paramname">bboxlist</td><td>Array of <a class="el" href="variables_8h.html#structBoundingBox" title="Defines a 3D axis-aligned bounding box.">BoundingBox</a> structs for all ranks (for checking neighbor boxes). </td></tr>
    <tr><td class="paramname">migrationList</td><td>Pointer to an array of <a class="el" href="variables_8h.html#structMigrationInfo" title="Information needed to migrate a single particle between MPI ranks.">MigrationInfo</a> structs (output, allocated/reallocated by this func). </td></tr>
    <tr><td class="paramname">migrationCount</td><td>Pointer to the number of particles marked for migration (output). </td></tr>
    <tr><td class="paramname">listCapacity</td><td>Pointer to the current allocated capacity of migrationList (in/out).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure. </dd></dl>

</div>
</div>
<a id="a461def358c0f7c5337c283ba06dd65a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a461def358c0f7c5337c283ba06dd65a0">&#9670;&nbsp;</a></span>SetMigrationRanks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode SetMigrationRanks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> *&#160;</td>
          <td class="paramname"><em>migrationList</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>migrationCount</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets the target rank field (DMSwarmPICField_rank) for particles scheduled for migration. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>Pointer to <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> pa(contains swarm). </td></tr>
    <tr><td class="paramname">migrationList</td><td>Array of <a class="el" href="variables_8h.html#structMigrationInfo" title="Information needed to migrate a single particle between MPI ranks.">MigrationInfo</a> structs containing local indices and target ranks. </td></tr>
    <tr><td class="paramname">migrationCount</td><td>Number of particles in the migrationList.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00525">525</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;{</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    DM             swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    PetscInt       p_idx;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    PetscInt      *rankField = NULL; <span class="comment">// Field storing target rank</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160; </div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160; </div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="comment">// Ensure the migration rank field exists</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_rank&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;rankField); CHKERRQ(ierr);</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="comment">// Set the target rank for migrating particles</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">for</span>(p_idx = 0; p_idx &lt; migrationCount; ++p_idx) {</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        rankField[migrationList[p_idx].<a class="code" href="variables_8h.html#a4381464fc6d367c0619eea12d6c28dfe">local_index</a>] = migrationList[p_idx].target_rank;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    }</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160; </div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_rank&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span> **)&amp;rankField); CHKERRQ(ierr);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160; </div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a461def358c0f7c5337c283ba06dd65a0_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="af68865be3bc987bdf1be2c5c7a1903fa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af68865be3bc987bdf1be2c5c7a1903fa">&#9670;&nbsp;</a></span>PerformMigration()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PerformMigration </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Performs particle migration based on the pre-populated DMSwarmPICField_rank field. </p>
<p>Assumes SetMigrationRanks has already been called to mark particles with their target ranks. Calls DMSwarmMigrate to execute the communication and removal of un-migrated particles.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing the swarm.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00562">562</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;{</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    DM swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    PetscMPIInt rank;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Rank %d: Starting DMSwarmMigrate...\n&quot;</span>, rank);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="comment">// Perform the migration - PETSC_TRUE removes particles that fail to land</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="comment">// in a valid cell on the target rank (or were marked with an invalid rank).</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    ierr = DMSwarmMigrate(swarm, PETSC_TRUE); CHKERRQ(ierr);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160; </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Rank %d: Migration complete.\n&quot;</span>, rank);</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_af68865be3bc987bdf1be2c5c7a1903fa_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a38b5e7348bc556d505e2c4b31c29b086"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a38b5e7348bc556d505e2c4b31c29b086">&#9670;&nbsp;</a></span>ResizeSwarmGlobally()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode ResizeSwarmGlobally </td>
          <td>(</td>
          <td class="paramtype">DM&#160;</td>
          <td class="paramname"><em>swarm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>N_target</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00749">749</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;{</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    PetscInt       N_current, nlocal_current;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    MPI_Comm       comm;</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160; </div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    ierr = PetscObjectGetComm((PetscObject)swarm, &amp;comm); CHKERRQ(ierr);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    ierr = MPI_Comm_rank(comm, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    ierr = DMSwarmGetSize(swarm, &amp;N_current); CHKERRQ(ierr);</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nlocal_current); CHKERRQ(ierr);</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160; </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    PetscInt delta = N_target - N_current;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160; </div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">if</span> (delta == 0) {</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        PetscFunctionReturn(0); <span class="comment">// Nothing to do</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    }</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160; </div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keywordflow">if</span> (delta &lt; 0) { <span class="comment">// Remove particles</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        PetscInt num_to_remove_global = -delta;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;ResizeSwarmGlobally: Current size %d &gt; target size %d. Removing %d particles globally.\n&quot;</span>, N_current, N_target, num_to_remove_global);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="comment">// --- Strategy: Remove the globally last &#39;num_to_remove_global&#39; particles ---</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="comment">// Each rank needs to determine how many of its *local* particles fall</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="comment">// within the range of global indices [N_target, N_current - 1].</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160; </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        PetscInt rstart = 0;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    PetscInt  rend;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="comment">// Global range owned by this rank [rstart, rend)</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160; </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    ierr = MPI_Exscan(&amp;nlocal_current, &amp;rstart, 1, MPIU_INT, MPI_SUM, comm); CHKERRMPI(ierr); <span class="comment">// Use CHKERRMPI for MPI calls</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160; </div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    rend = rstart + nlocal_current;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    </div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160; </div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        <span class="comment">// Calculate how many local particles have global indices &gt;= N_target</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        PetscInt nlocal_remove_count = 0;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <span class="keywordflow">if</span> (rend &gt; N_target) { <span class="comment">// If this rank owns any particles slated for removal</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            PetscInt start_remove_local_idx = (N_target &gt; rstart) ? (N_target - rstart) : 0;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;            nlocal_remove_count = nlocal_current - start_remove_local_idx;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        }</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160; </div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;        <span class="keywordflow">if</span> (nlocal_remove_count &lt; 0) nlocal_remove_count = 0; <span class="comment">// Sanity check</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        <span class="keywordflow">if</span> (nlocal_remove_count &gt; nlocal_current) nlocal_remove_count = nlocal_current; <span class="comment">// Sanity check</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160; </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Rank %d: Global range [%d, %d). Target size %d. Need to remove %d local particles (from end).\n&quot;</span>, rank, rstart, rend, N_target, nlocal_remove_count);</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160; </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="comment">// Remove the last &#39;nlocal_remove_count&#39; particles *locally* by iterating backwards</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        PetscInt removal_ops_done = 0;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        <span class="keywordflow">for</span> (PetscInt p = nlocal_current - 1; p &gt;= 0 &amp;&amp; removal_ops_done &lt; nlocal_remove_count; --p) {</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;            ierr = DMSwarmRemovePointAtIndex(swarm, p); CHKERRQ(ierr);</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;            removal_ops_done++;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        }</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160; </div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        <span class="keywordflow">if</span> (removal_ops_done != nlocal_remove_count) {</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;             SETERRQ(comm, PETSC_ERR_PLIB, <span class="stringliteral">&quot;Rank %d: Failed to remove the expected number of local particles (%d != %d)&quot;</span>, rank, removal_ops_done, nlocal_remove_count);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        }</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;         <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Rank %d: Removed %d local particles.\n&quot;</span>, rank, removal_ops_done);</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160; </div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <span class="comment">// Barrier to ensure all removals are done before size check</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        ierr = MPI_Barrier(comm); CHKERRMPI(ierr);</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160; </div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    } <span class="keywordflow">else</span> { <span class="comment">// delta &gt; 0: Add particles</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        PetscInt num_to_add_global = delta;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;ResizeSwarmGlobally: Current size %d &lt; target size %d. Adding %d particles globally.\n&quot;</span>, N_current, N_target, num_to_add_global);</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        ierr = DMSwarmAddNPoints(swarm, num_to_add_global); CHKERRQ(ierr);</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="comment">// Note: Added particles will have uninitialized field data. Reading will overwrite.</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    }</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160; </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="comment">// Verify final size</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    PetscInt N_final;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    ierr = DMSwarmGetSize(swarm, &amp;N_final); CHKERRQ(ierr);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">if</span> (N_final != N_target) {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        SETERRQ(comm, PETSC_ERR_PLIB, <span class="stringliteral">&quot;Failed to resize swarm: expected %d particles, got %d&quot;</span>, N_target, N_final);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    }</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;ResizeSwarmGlobally: Swarm successfully resized to %d particles.\n&quot;</span>, N_final);</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a38b5e7348bc556d505e2c4b31c29b086_icgraph.svg" width="100%" height="366"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="ae0c7489fc52fda6c92cd1f22c3f50c38"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0c7489fc52fda6c92cd1f22c3f50c38">&#9670;&nbsp;</a></span>PreCheckAndResizeSwarm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PreCheckAndResizeSwarm </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>ti</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>ext</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Checks particle count in the reference file and resizes the swarm if needed. </p>
<p>Reads the specified field file (e.g., position) into a temporary Vec to determine the number of particles (<code>N_file</code>) represented in that file for the given timestep. Compares <code>N_file</code> with the current swarm size (<code>N_current</code>). If they differ, resizes the swarm globally (adds or removes particles) to match <code>N_file</code>. Removal assumes excess particles are the globally last ones.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing the DMSwarm. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fieldName</td><td>Name of the reference field (e.g., "position"). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ti</td><td>Time index for constructing the file name. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext</td><td>File extension (e.g., "dat"). </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">skipStep</td><td>Pointer to boolean flag, set to PETSC_TRUE if the step should be skipped (e.g., file not found), PETSC_FALSE otherwise.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on critical failure. If the reference file is not found, returns 0 and sets skipStep = PETSC_TRUE.</dd></dl>
<p>Checks particle count in the reference file and resizes the swarm if needed.</p>
<p>This function uses a robust parallel pattern: only Rank 0 reads the reference position file to determine the total number of particles saved (<code>N_file</code>). This count is then broadcast to all other ranks. Finally, each rank compares N_file with the current swarm size and participates in resizing if necessary.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing the DMSwarm. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ti</td><td>Time index for constructing the file name. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext</td><td>File extension (e.g., "dat").</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00848">848</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;{</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="keywordtype">char</span>           filename[PETSC_MAX_PATH_LEN];</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    PetscInt       N_file = 0; <span class="comment">// The number of particles determined from the file</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    PetscInt       N_current = 0;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    MPI_Comm       comm;</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>    *refFieldName = <span class="stringliteral">&quot;position&quot;</span>;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keyword">const</span> PetscInt bs = 3;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    </div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="comment">// NOTE: Your filename format has a hardcoded &quot;_0&quot; which is typical for</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="comment">// PETSc when writing a parallel object from a single rank.</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="comment">// If you ever write in parallel, PETSc might create one file per rank.</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="comment">// The current logic assumes a single file written by one process.</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span>      placeholder_int = 0;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160; </div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    ierr = PetscObjectGetComm((PetscObject)user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, &amp;comm); CHKERRQ(ierr);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    ierr = MPI_Comm_rank(comm, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        <span class="comment">// --- Construct filename using the specified format ---</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <span class="comment">// results/%s%05&lt;PetscInt_FMT&gt;_%d.%s</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    ierr = PetscSNPrintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;results/%s%05&quot;</span> PetscInt_FMT <span class="stringliteral">&quot;_%d.%s&quot;</span>,</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                         refFieldName, ti, placeholder_int, ext); CHKERRQ(ierr);</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <span class="comment">// Note: Make sure the &quot;results&quot; directory exists or handle directory creation elsewhere.</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160; </div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;PreCheckAndResizeSwarm: Checking particle count for timestep %d using ref file &#39;%s&#39;.\n&quot;</span>, ti, filename);</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160; </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="comment">// --- Rank 0 reads the file to determine the size ---</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keywordflow">if</span> (rank == 0) {</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        PetscBool fileExists = PETSC_FALSE;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        ierr = PetscTestFile(filename, <span class="charliteral">&#39;r&#39;</span>, &amp;fileExists); CHKERRQ(ierr);</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160; </div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        <span class="keywordflow">if</span> (!fileExists) {</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;            <span class="comment">// Set a special value to indicate file not found, then broadcast it.</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;            N_file = -1;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;            <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a230506cce5c68c3bac5a821c42ed3473">LOG_ERROR</a>, <span class="stringliteral">&quot;Rank 0: Mandatory reference file &#39;%s&#39; not found for timestep %d.\n&quot;</span>, filename, ti);</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            PetscViewer viewer;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            Vec         tmpVec;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            PetscInt    vecSize;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            </div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            ierr = VecCreate(PETSC_COMM_SELF, &amp;tmpVec); CHKERRQ(ierr); <span class="comment">// Create a SEQUENTIAL vector</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            ierr = PetscViewerBinaryOpen(PETSC_COMM_SELF, filename, FILE_MODE_READ, &amp;viewer); CHKERRQ(ierr);</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            ierr = VecLoad(tmpVec, viewer); CHKERRQ(ierr);</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            ierr = PetscViewerDestroy(&amp;viewer); CHKERRQ(ierr);</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160; </div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;            ierr = VecGetSize(tmpVec, &amp;vecSize); CHKERRQ(ierr);</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;            ierr = VecDestroy(&amp;tmpVec); CHKERRQ(ierr);</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160; </div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;            <span class="keywordflow">if</span> (vecSize % bs != 0) {</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                N_file = -2; <span class="comment">// Special error code for bad file format</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a230506cce5c68c3bac5a821c42ed3473">LOG_ERROR</a>, <span class="stringliteral">&quot;Rank 0: Vector size %d from file &#39;%s&#39; is not divisible by block size %d.\n&quot;</span>, vecSize, filename, bs);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                N_file = vecSize / bs;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Rank 0: Found %d particles in file.\n&quot;</span>, N_file);</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;            }</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        }</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    }</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160; </div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    <span class="comment">// --- Broadcast the particle count (or error code) from Rank 0 to all other ranks ---</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    ierr = MPI_Bcast(&amp;N_file, 1, MPIU_INT, 0, comm); CHKERRMPI(ierr);</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160; </div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="comment">// --- All ranks check for errors and abort if necessary ---</span></div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="keywordflow">if</span> (N_file == -1) {</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        SETERRQ(comm, PETSC_ERR_FILE_OPEN, <span class="stringliteral">&quot;Mandatory reference file &#39;%s&#39; not found for timestep %d (as determined by Rank 0).&quot;</span>, filename, ti);</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    }</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="keywordflow">if</span> (N_file == -2) {</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        SETERRQ(comm, PETSC_ERR_FILE_READ, <span class="stringliteral">&quot;Reference file &#39;%s&#39; has incorrect format (as determined by Rank 0).&quot;</span>, filename);</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    }</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordflow">if</span> (N_file &lt; 0) {</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;         SETERRQ(comm, PETSC_ERR_PLIB, <span class="stringliteral">&quot;Received invalid particle count %d from Rank 0.&quot;</span>, N_file);</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    }</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160; </div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160; </div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="comment">// --- Now all ranks have the correct N_file, compare and resize if needed ---</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    ierr = DMSwarmGetSize(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, &amp;N_current); CHKERRQ(ierr);</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160; </div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="keywordflow">if</span> (N_file != N_current) {</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Swarm size %d differs from file size %d. Resizing swarm globally.\n&quot;</span>, N_current, N_file);</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        ierr = <a class="code" href="ParticleMotion_8c.html#a38b5e7348bc556d505e2c4b31c29b086">ResizeSwarmGlobally</a>(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, N_file); CHKERRQ(ierr);</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;Swarm size (%d) already matches file size. No resize needed.\n&quot;</span>, N_current);</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    }</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    </div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">// Also update the context</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>-&gt;<a class="code" href="variables_8h.html#a5eedf611da6dd4f59cc65753b777b957">np</a> = N_file;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160; </div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_ae0c7489fc52fda6c92cd1f22c3f50c38_cgraph.svg" width="419" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_ae0c7489fc52fda6c92cd1f22c3f50c38_icgraph.svg" width="530" height="88"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="ab2eeab12258446f697695ebdaef3f011"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab2eeab12258446f697695ebdaef3f011">&#9670;&nbsp;</a></span>PerformSingleParticleMigrationCycle()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode PerformSingleParticleMigrationCycle </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *&#160;</td>
          <td class="paramname"><em>bboxlist</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> **&#160;</td>
          <td class="paramname"><em>migrationList_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>migrationCount_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>migrationListCapacity_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscReal&#160;</td>
          <td class="paramname"><em>currentTime</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>migrationCycleName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>globalMigrationCount_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Performs one full cycle of particle migration: identify, set ranks, and migrate. </p>
<p>This function encapsulates the three main steps of migrating particles between MPI ranks:</p><ol type="1">
<li>Identify particles on the local rank that need to move based on their current positions and the domain decomposition (<code>bboxlist</code>).</li>
<li>Determine the destination rank for each migrating particle.</li>
<li>Perform the actual migration using PETSc's <code>DMSwarmMigrate</code>. It also calculates and logs the global number of particles migrated.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">bboxlist</td><td>Array of <a class="el" href="variables_8h.html#structBoundingBox" title="Defines a 3D axis-aligned bounding box.">BoundingBox</a> structures defining the spatial domain of each MPI rank. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">migrationList_p</td><td>Pointer to a pointer for the <a class="el" href="variables_8h.html#structMigrationInfo" title="Information needed to migrate a single particle between MPI ranks.">MigrationInfo</a> array. This array will be allocated/reallocated by <code>IdentifyMigratingParticles</code> if necessary. The caller is responsible for freeing this list eventually. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">migrationCount_p</td><td>Pointer to store the number of particles identified for migration on the local rank. This is reset to 0 after migration for the current cycle. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">migrationListCapacity_p</td><td>Pointer to store the current capacity of the <code>migrationList_p</code> array. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">currentTime</td><td>Current simulation time (used for logging). </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">step</td><td>Current simulation step number (used for logging). </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">migrationCycleName</td><td>A descriptive name for this migration cycle (e.g., "Preliminary Sort", "Main Loop") for logging purposes. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">globalMigrationCount_out</td><td>Pointer to store the total number of particles migrated across all MPI ranks during this cycle. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure. </dd></dl>

</div>
</div>
<a id="abb62172d12ae65122070a3674196c8e2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abb62172d12ae65122070a3674196c8e2">&#9670;&nbsp;</a></span>ReinitializeParticlesOnInletSurface()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode ReinitializeParticlesOnInletSurface </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscReal&#160;</td>
          <td class="paramname"><em>currentTime</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>step</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Re-initializes the positions of particles currently on this rank if this rank owns part of the designated inlet surface. </p>
<p>This function is intended for <code>user-&gt;ParticleInitialization == 0</code> (Surface Initialization mode) and is typically called after an initial migration step (e.g., in <code>PerformInitialSetup</code>). It ensures that all particles that should originate from the inlet surface and are now on the correct MPI rank are properly distributed across that rank's portion of the inlet.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure, containing simulation settings and grid information. </td></tr>
    <tr><td class="paramname">currentTime</td><td>Current simulation time (used for logging). </td></tr>
    <tr><td class="paramname">step</td><td>Current simulation step number (used for logging). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, non-zero on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l00961">961</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;{</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    PetscMPIInt    rank;                        <span class="comment">// MPI rank of the current process</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    DM             swarm = user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>;         <span class="comment">// The particle swarm DM</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    PetscReal      *positions_field = NULL;     <span class="comment">// Pointer to swarm field for physical positions</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    PetscInt64     *particleIDs = NULL;         <span class="comment">// Pointer to swarm field for Particle IDs (for logging)</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    PetscInt       *cell_ID_field = NULL;       <span class="comment">// Pointer to swarm field for Cell IDs (for resetting after migration)</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="keyword">const</span> <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a>   ***coor_nodes_local_array;   <span class="comment">// Read-only access to local node coordinates</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    Vec            Coor_local;                  <span class="comment">// Local vector for node coordinates</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    DMDALocalInfo  info;                        <span class="comment">// Local grid information (node-based) from user-&gt;da</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    PetscInt       xs_gnode_rank, ys_gnode_rank, zs_gnode_rank; <span class="comment">// Local starting node indices (incl. ghosts) of rank&#39;s DA</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    PetscInt       IM_nodes_global, JM_nodes_global, KM_nodes_global; <span class="comment">// Global node counts</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160; </div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    PetscRandom    rand_logic_reinit_i, rand_logic_reinit_j, rand_logic_reinit_k; <span class="comment">// RNGs for re-placement</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    PetscInt       nlocal_current;                <span class="comment">// Number of particles currently on this rank</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    PetscInt       particles_actually_reinitialized_count = 0; <span class="comment">// Counter for logging</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    PetscBool      can_this_rank_service_inlet = PETSC_FALSE;  <span class="comment">// Flag</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160; </div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160; </div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160; </div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="comment">// This function is only relevant for surface initialization mode and if an inlet face is defined.</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">simCtx</a>-&gt;<a class="code" href="variables_8h.html#ae3ce8967b15c2e6be9e829b745da4090">ParticleInitialization</a> != 0 || !user-&gt;<a class="code" href="variables_8h.html#a1300c167a3006a58c71fe8759ebf5ef1">inletFaceDefined</a>) {</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        PetscFunctionReturn(0);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    }</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160; </div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;nlocal_current); CHKERRQ(ierr);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160; </div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    <span class="comment">// If no particles on this rank, nothing to do.</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    <span class="keywordflow">if</span> (nlocal_current == 0) {</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[T=%.4f, Step=%d] Rank %d has no local particles to re-initialize on inlet.\n&quot;</span>, currentTime, step, rank);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;        PetscFunctionReturn(0);</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    }</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160; </div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="comment">// Get DMDA information for the node-centered coordinate grid (user-&gt;da)</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    ierr = DMDAGetLocalInfo(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, &amp;info); CHKERRQ(ierr);</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    ierr = DMDAGetInfo(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, NULL, &amp;IM_nodes_global, &amp;JM_nodes_global, &amp;KM_nodes_global, NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL); CHKERRQ(ierr);</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    ierr = DMDAGetGhostCorners(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, &amp;xs_gnode_rank, &amp;ys_gnode_rank, &amp;zs_gnode_rank, NULL, NULL, NULL); CHKERRQ(ierr);</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160; </div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="comment">// Check if this rank is responsible for (part of) the designated inlet surface</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    ierr = <a class="code" href="Boundaries_8h.html#ab679d620b2d750179fbc2363fc562a1f">CanRankServiceInletFace</a>(user, &amp;info, IM_nodes_global, JM_nodes_global, KM_nodes_global, &amp;can_this_rank_service_inlet); CHKERRQ(ierr);</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160; </div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keywordflow">if</span> (!can_this_rank_service_inlet) {</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[T=%.4f, Step=%d] Rank %d cannot service inlet face %d. Skipping re-initialization of %d particles.\n&quot;</span>, currentTime, step, rank, user-&gt;<a class="code" href="variables_8h.html#a27bce072860da2f1a8a54d94b2b9497f">identifiedInletBCFace</a>, nlocal_current);</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        PetscFunctionReturn(0);</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    }</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160; </div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[T=%.4f, Step=%d] Rank %d is on inlet face %d. Attempting to re-place %d local particles.\n&quot;</span>, currentTime, step, rank, user-&gt;<a class="code" href="variables_8h.html#a27bce072860da2f1a8a54d94b2b9497f">identifiedInletBCFace</a>, nlocal_current);</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160; </div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">// Get coordinate array and swarm fields for modification</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    ierr = DMGetCoordinatesLocal(user-&gt;<a class="code" href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">da</a>, &amp;Coor_local); CHKERRQ(ierr);</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    ierr = DMDAVecGetArrayRead(user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>, Coor_local, (<span class="keywordtype">void</span>*)&amp;coor_nodes_local_array); CHKERRQ(ierr);</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;position&quot;</span>,       NULL, NULL, (<span class="keywordtype">void</span>**)&amp;positions_field); CHKERRQ(ierr);</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,    NULL, NULL, (<span class="keywordtype">void</span>**)&amp;particleIDs);    CHKERRQ(ierr); <span class="comment">// For logging</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;cell_ID_field);  CHKERRQ(ierr);</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160; </div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="comment">// Initialize fresh RNGs for this re-placement to ensure good distribution</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    ierr = <a class="code" href="ParticleSwarm_8h.html#ab723e91906e01ec26aab97de6623000c">InitializeLogicalSpaceRNGs</a>(&amp;rand_logic_reinit_i, &amp;rand_logic_reinit_j, &amp;rand_logic_reinit_k); CHKERRQ(ierr);</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <span class="comment">// Optional: Seed RNGs for deterministic behavior if required, e.g., based on rank and step.</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="comment">// PetscRandomSetSeed(rand_logic_i, (unsigned long)rank*1000 + step + 100); PetscRandomSeed(rand_logic_i); // Example</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160; </div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    <span class="comment">// Loop over all particles currently local to this rank</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="keywordflow">for</span> (PetscInt p = 0; p &lt; nlocal_current; p++) {</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        PetscInt  ci_metric_lnode, cj_metric_lnode, ck_metric_lnode; <span class="comment">// Local node indices (of rank&#39;s DA patch) for cell origin</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        PetscReal xi_metric_logic, eta_metric_logic, zta_metric_logic; <span class="comment">// Intra-cell logical coordinates</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        <a class="code" href="variables_8h.html#structCmpnts">Cmpnts</a>    phys_coords; <span class="comment">// To store newly calculated physical coordinates</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160; </div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        <span class="comment">// Get random cell on this rank&#39;s portion of the inlet and random logical coords within it</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        ierr = <a class="code" href="Boundaries_8h.html#ac07befc354128d23bac8ed5f2612ffdf">GetRandomCellAndLogicOnInletFace</a>(user, &amp;info, xs_gnode_rank, ys_gnode_rank, zs_gnode_rank,</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                                                IM_nodes_global, JM_nodes_global, KM_nodes_global,</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                                                &amp;rand_logic_reinit_i, &amp;rand_logic_reinit_j, &amp;rand_logic_reinit_k,</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                                                &amp;ci_metric_lnode, &amp;cj_metric_lnode, &amp;ck_metric_lnode,</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                                                &amp;xi_metric_logic, &amp;eta_metric_logic, &amp;zta_metric_logic); CHKERRQ(ierr);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        </div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        <span class="comment">// Convert these logical coordinates to physical coordinates</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        ierr = <a class="code" href="Metric_8h.html#af0ba1966641e609476ac6fc3d5cdbbfc">MetricLogicalToPhysical</a>(user, coor_nodes_local_array,</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                                       ci_metric_lnode, cj_metric_lnode, ck_metric_lnode,</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                                       xi_metric_logic, eta_metric_logic, zta_metric_logic,</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                                       &amp;phys_coords); CHKERRQ(ierr);</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160; </div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        <span class="comment">// Update the particle&#39;s position in the swarm fields</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        positions_field[3*p+0] = phys_coords.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>; </div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        positions_field[3*p+1] = phys_coords.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>; </div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;        positions_field[3*p+2] = phys_coords.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>;</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        particles_actually_reinitialized_count++;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    cell_ID_field[3*p+0] = -1;</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    cell_ID_field[3*p+1] = -1;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    cell_ID_field[3*p+2] = -1;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160; </div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        <a class="code" href="logging_8h.html#a1543cd95db1569c7d901fd4b9a3a43d7">LOG_LOOP_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, p, (nlocal_current &gt; 20 ? nlocal_current/10 : 1), <span class="comment">// Sampled logging</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            <span class="stringliteral">&quot;ReInit - Rank %d: PID %ld (idx %ld) RE-PLACED. CellOriginNode(locDAIdx):(%d,%d,%d). LogicCoords: (%.2e,%.2f,%.2f). PhysCoords: (%.6f,%.6f,%.6f).\n&quot;</span>,</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;            rank, particleIDs[p], (<span class="keywordtype">long</span>)p, </div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;            ci_metric_lnode, cj_metric_lnode, ck_metric_lnode,</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;            xi_metric_logic, eta_metric_logic, zta_metric_logic, </div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            phys_coords.<a class="code" href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">x</a>, phys_coords.<a class="code" href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">y</a>, phys_coords.<a class="code" href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">z</a>);</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    }</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160; </div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="comment">// Logging summary of re-initialization</span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="keywordflow">if</span> (particles_actually_reinitialized_count &gt; 0) {</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[T=%.4f, Step=%d] Rank %d (on inlet face %d) successfully re-initialized %d of %d local particles.\n&quot;</span>, currentTime, step, rank, user-&gt;<a class="code" href="variables_8h.html#a27bce072860da2f1a8a54d94b2b9497f">identifiedInletBCFace</a>, particles_actually_reinitialized_count, nlocal_current);</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nlocal_current &gt; 0) { <span class="comment">// This case should ideally not be hit if can_this_rank_service_inlet was true and particles were present.</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;         <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400">LOG_WARNING</a>, <span class="stringliteral">&quot;[T=%.4f, Step=%d] Rank %d claimed to service inlet face %d, but re-initialized 0 of %d local particles. This may indicate an issue if particles were expected to be re-placed.\n&quot;</span>, currentTime, step, rank, user-&gt;<a class="code" href="variables_8h.html#a27bce072860da2f1a8a54d94b2b9497f">identifiedInletBCFace</a>, nlocal_current);</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    }</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160; </div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="comment">// Cleanup: Destroy RNGs and restore swarm fields/coordinate array</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    ierr = PetscRandomDestroy(&amp;rand_logic_reinit_i); CHKERRQ(ierr);</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    ierr = PetscRandomDestroy(&amp;rand_logic_reinit_j); CHKERRQ(ierr);</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    ierr = PetscRandomDestroy(&amp;rand_logic_reinit_k); CHKERRQ(ierr);</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160; </div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;position&quot;</span>,       NULL, NULL, (<span class="keywordtype">void</span>**)&amp;positions_field); CHKERRQ(ierr);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,    NULL, NULL, (<span class="keywordtype">void</span>**)&amp;particleIDs);    CHKERRQ(ierr);</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;cell_ID_field);  CHKERRQ(ierr);</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    ierr = DMDAVecRestoreArrayRead(user-&gt;<a class="code" href="variables_8h.html#a69966d928601d61d4f526636f84396c5">fda</a>, Coor_local, (<span class="keywordtype">void</span>*)&amp;coor_nodes_local_array); CHKERRQ(ierr);</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160; </div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160; </div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_abb62172d12ae65122070a3674196c8e2_cgraph.svg" width="100%" height="461"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_abb62172d12ae65122070a3674196c8e2_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a5d388b62daa726aa7ea467a71313a328"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d388b62daa726aa7ea467a71313a328">&#9670;&nbsp;</a></span>GetLocalPIDSnapshot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode GetLocalPIDSnapshot </td>
          <td>(</td>
          <td class="paramtype">const PetscInt64&#160;</td>
          <td class="paramname"><em>pid_field</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>n_local</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt64 **&#160;</td>
          <td class="paramname"><em>pids_snapshot_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Creates a sorted snapshot of all <a class="el" href="variables_8h.html#structParticle" title="Defines a particle&#39;s core properties for Lagrangian tracking.">Particle</a> IDs (PIDs) from a raw data array. </p>
<p>This function is a crucial helper for the migration process. It captures the state of which particles are on the current MPI rank <em>before</em> migration occurs by taking a pointer to the swarm's raw PID data array. The resulting sorted array can then be used with an efficient binary search to quickly identify newcomer particles after migration.</p>
<p>This function does NOT call DMSwarmGetField/RestoreField. It is the caller's responsibility to acquire the <code>pid_field</code> pointer before calling and restore it afterward.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pid_field</td><td>A read-only pointer to the raw array of PIDs for the local swarm. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n_local</td><td>The number of particles currently on the local rank. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pids_snapshot_out</td><td>A pointer to a <code>PetscInt64*</code> array. This function will allocate memory for this array, and the caller is responsible for freeing it with <code>PetscFree()</code> when it is no longer needed.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l01117">1117</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;{</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160; </div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160; </div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160; </div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="comment">// --- 1. Input Validation ---</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="keywordflow">if</span> (!pids_snapshot_out) {</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Output pointer pids_snapshot_out is NULL.&quot;</span>);</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    }</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="comment">// If n_local &gt; 0, pid_field must not be NULL.</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <span class="keywordflow">if</span> (n_local &gt; 0 &amp;&amp; !pid_field) {</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Input pid_field pointer is NULL for n_local &gt; 0.&quot;</span>);</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    }</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    </div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[Rank %d]: Creating PID snapshot for %d local particles.\n&quot;</span>, rank, n_local);</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160; </div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    <span class="comment">// If there are no local particles, the snapshot is empty (NULL).</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordflow">if</span> (n_local == 0) {</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        *pids_snapshot_out = NULL;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160; </div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        PetscFunctionReturn(0);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    }</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    </div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    <span class="comment">// --- 2. Allocate Memory for the Snapshot ---</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    ierr = PetscMalloc1(n_local, pids_snapshot_out); CHKERRQ(ierr);</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160; </div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <span class="comment">// --- 3. Copy Data ---</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="comment">// Perform a fast memory copy from the provided array to our new snapshot array.</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    ierr = PetscMemcpy(*pids_snapshot_out, pid_field, n_local * <span class="keyword">sizeof</span>(PetscInt64)); CHKERRQ(ierr);</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[Rank %d]: Copied %d PIDs.\n&quot;</span>, rank, n_local);</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160; </div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <span class="comment">// --- 4. Sort the Snapshot Array ---</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    <span class="comment">// Sorting enables fast binary search lookups later.</span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    ierr = PetscSortInt64(n_local, *pids_snapshot_out); CHKERRQ(ierr);</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[Rank %d]: PID snapshot sorted successfully.\n&quot;</span>, rank);</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160; </div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160; </div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    PetscFunctionReturn(0); </div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a5d388b62daa726aa7ea467a71313a328_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a43df9caf0f5cbb317050f6258ac46fff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43df9caf0f5cbb317050f6258ac46fff">&#9670;&nbsp;</a></span>AddToMigrationList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode AddToMigrationList </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> **&#160;</td>
          <td class="paramname"><em>migration_list_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>capacity_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt *&#160;</td>
          <td class="paramname"><em>count_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>particle_local_idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscMPIInt&#160;</td>
          <td class="paramname"><em>destination_rank</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Safely adds a new migration task to a dynamically sized list. </p>
<p>This utility function manages a dynamic array of <a class="el" href="variables_8h.html#structMigrationInfo" title="Information needed to migrate a single particle between MPI ranks.">MigrationInfo</a> structs. It appends a new entry to the list and automatically doubles the array's capacity using <code>PetscRealloc</code> if the current capacity is exceeded. This prevents buffer overflows and avoids the need to know the number of migrating particles in advance.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">migration_list_p</td><td>A pointer to the <a class="el" href="variables_8h.html#structMigrationInfo" title="Information needed to migrate a single particle between MPI ranks.">MigrationInfo</a> array pointer. The function will update this pointer if the array is reallocated. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">capacity_p</td><td>A pointer to an integer holding the current allocated capacity of the list (in number of elements). This will be updated upon reallocation. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">count_p</td><td>A pointer to an integer holding the current number of items in the list. This will be incremented by one. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">particle_local_idx</td><td>The local index (from 0 to nlocal-1) of the particle that needs to be migrated. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">destination_rank</td><td>The target MPI rank for the particle.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure (e.g., from memory allocation). </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l01189">1189</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;{</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160; </div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160; </div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160; </div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="comment">// --- 1. Input Validation ---</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    <span class="keywordflow">if</span> (!migration_list_p || !capacity_p || !count_p) {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Null pointer provided to AddToMigrationList for list management.&quot;</span>);</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    }</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160; </div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;    <span class="comment">// --- 2. Check if the list needs to be resized ---</span></div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    <span class="keywordflow">if</span> (*count_p &gt;= *capacity_p) {</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        PetscInt old_capacity = *capacity_p;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        <span class="comment">// Start with a reasonable base capacity, then double for subsequent reallocations.</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        PetscInt new_capacity = (old_capacity == 0) ? 16 : old_capacity * 2;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160; </div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        <span class="comment">// Use PetscRealloc for safe memory reallocation.</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        <span class="comment">// It handles allocating new memory, copying old data, and freeing the old block.</span></div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        <span class="comment">// The first argument to PetscRealloc is the new size in BYTES.</span></div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        ierr = PetscRealloc(new_capacity * <span class="keyword">sizeof</span>(<a class="code" href="variables_8h.html#structMigrationInfo">MigrationInfo</a>), migration_list_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        *capacity_p = new_capacity; <span class="comment">// Update the capacity tracker</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160; </div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;AddToMigrationList [Rank %d]: Reallocated migrationList capacity from %d to %d.\n&quot;</span>,</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;                  rank, old_capacity, new_capacity);</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    }</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160; </div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    <span class="comment">// --- 3. Add the new migration data to the list ---</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <span class="comment">// Dereference the pointer-to-a-pointer to get the actual array.</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <a class="code" href="variables_8h.html#structMigrationInfo">MigrationInfo</a> *<a class="code" href="variables_8h.html#structlist">list</a> = *migration_list_p;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160; </div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <a class="code" href="variables_8h.html#structlist">list</a>[*count_p].local_index = particle_local_idx;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <a class="code" href="variables_8h.html#structlist">list</a>[*count_p].target_rank = destination_rank;</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160; </div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="comment">// --- 4. Increment the count of items in the list ---</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    (*count_p)++;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    </div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160; </div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a43df9caf0f5cbb317050f6258ac46fff_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="ad247152a0dd47d07243fad4c2fd89c0a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad247152a0dd47d07243fad4c2fd89c0a">&#9670;&nbsp;</a></span>FlagNewcomersForLocation()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode FlagNewcomersForLocation </td>
          <td>(</td>
          <td class="paramtype">DM&#160;</td>
          <td class="paramname"><em>swarm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PetscInt&#160;</td>
          <td class="paramname"><em>n_local_before</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PetscInt64&#160;</td>
          <td class="paramname"><em>pids_before</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Identifies newly arrived particles after migration and flags them for a location search. </p>
<p>This function is a critical component of the iterative migration process managed by the main particle settlement orchestrator (e.g., <code>SettleParticles</code>). After a <code>DMSwarmMigrate</code> call, each rank's local particle list is a new mix of resident particles and newly received ones. This function's job is to efficiently identify these "newcomers" and set their <code>DMSwarm_location_status</code> field to <code>NEEDS_LOCATION</code>.</p>
<p>This ensures that in the subsequent pass of the migration <code>do-while</code> loop, only the newly arrived particles are processed by the expensive location algorithm, preventing redundant work on particles that are already settled on the current rank.</p>
<p>The identification is done by comparing the PIDs of particles currently on the rank against a "snapshot" of PIDs taken <em>before</em> the migration occurred.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">swarm</td><td>The DMSwarm object, which has just completed a migration. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n_local_before</td><td>The number of particles that were on this rank <em>before</em> the migration was performed. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pids_before</td><td>A pre-sorted array of the PIDs that were on this rank before the migration. This is used for fast lookups.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>This function assumes the <code>pids_before</code> array is sorted in ascending order to enable the use of an efficient binary search. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l01271">1271</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;{</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    PetscInt       n_local_after;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    PetscInt       newcomer_count = 0;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    </div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="comment">// Pointers to the swarm data fields we will read and modify</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    PetscInt64 *pid_field_after    = NULL;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    PetscInt   *status_field_after = NULL;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    PetscInt   *cell_field_after = NULL;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160; </div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160; </div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160; </div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="comment">// --- 1. Input Validation and Basic Setup ---</span></div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    <span class="keywordflow">if</span> (!swarm) {</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_WRONGSTATE, <span class="stringliteral">&quot;Input DMSwarm is NULL in FlagNewcomersForLocation.&quot;</span>);</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    }</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="comment">// If n_local_before &gt; 0, the corresponding PID array must not be null.</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    <span class="keywordflow">if</span> (n_local_before &gt; 0 &amp;&amp; !pids_before) {</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_NULL, <span class="stringliteral">&quot;Input pids_before array is NULL for n_local_before &gt; 0.&quot;</span>);</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    }</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160; </div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    </div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    <span class="comment">// Get the number of particles on this rank *after* the migration.</span></div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    ierr = DMSwarmGetLocalSize(swarm, &amp;n_local_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    </div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;FlagNewcomersForLocation [Rank %d]: Checking for newcomers. Size before: %d, Size after: %d\n&quot;</span>,</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;              rank, n_local_before, n_local_after);</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160; </div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;    <span class="comment">// If there are no particles now, there&#39;s nothing to do.</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    <span class="keywordflow">if</span> (n_local_after == 0) {</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        PetscFunctionReturn(0);</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    }</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    </div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    <span class="comment">// --- 2. Access Swarm Data ---</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;    <span class="comment">// Get read-only access to the PIDs and read-write access to the status field.</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pid_field_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;status_field_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    ierr = DMSwarmGetField(swarm, <span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>,          NULL, NULL, (<span class="keywordtype">void</span>**)&amp;cell_field_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    <span class="keywordflow">if</span> (!pid_field_after || !status_field_after) {</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        SETERRQ(PETSC_COMM_SELF, PETSC_ERR_ARG_WRONGSTATE, <span class="stringliteral">&quot;Failed to get required swarm fields in FlagNewcomersForLocation.&quot;</span>);</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;    }</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160; </div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    <span class="comment">// --- 3. Identify and Flag Newcomers ---</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    <span class="comment">// Loop through all particles currently on this rank.</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="keywordflow">for</span> (PetscInt p_idx = 0; p_idx &lt; n_local_after; ++p_idx) {</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        PetscInt64 current_pid = pid_field_after[p_idx];</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;        PetscBool  is_found_in_before_list;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160; </div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="comment">// Use our custom, efficient helper function for the lookup.</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        ierr = <a class="code" href="setup_8h.html#acd8d87dc85f19ba3e32811a623bf5b36">BinarySearchInt64</a>(n_local_before, pids_before, current_pid, &amp;is_found_in_before_list); CHKERRQ(ierr);</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160; </div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        <span class="comment">// If the PID was NOT found in the &quot;before&quot; list, it must be a newcomer.</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;        <span class="keywordflow">if</span> (!is_found_in_before_list) {</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;          <span class="comment">// Flag it for processing in the next pass of the migration loop.</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;          status_field_after[p_idx] = <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581a73a50b46251a0e24a0e2ed0e0082003a">NEEDS_LOCATION</a>;</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;      <span class="comment">// cell_field_after[3*p_idx+0] = -1;</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;      <span class="comment">// cell_field_after[3*p_idx+1] = -1; </span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;      <span class="comment">// cell_field_after[3*p_idx+2] = -1; </span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;            newcomer_count++;</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;            </div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;            <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[Rank %d]: Flagged newcomer PID %ld at local index %d as NEEDS_LOCATION.\n&quot;</span>,</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;                      rank, current_pid, p_idx);</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        }</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    }</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160; </div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="comment">// --- 4. Restore Swarm Fields ---</span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <span class="comment">// Release the locks on the swarm data arrays.</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pid_field_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;status_field_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    ierr = DMSwarmRestoreField(swarm, <span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>,          NULL, NULL, (<span class="keywordtype">void</span>**)&amp;cell_field_after); CHKERRQ(ierr);</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160; </div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordflow">if</span> (newcomer_count &gt; 0) {</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d]: Identified and flagged %d newcomers.\n&quot;</span>, rank, newcomer_count);</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    }</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160; </div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160; </div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_ad247152a0dd47d07243fad4c2fd89c0a_cgraph.svg" width="403" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_ad247152a0dd47d07243fad4c2fd89c0a_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a92bb4f9eac7970b9e8911104404571a9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a92bb4f9eac7970b9e8911104404571a9">&#9670;&nbsp;</a></span>LocateAllParticlesInGrid()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode LocateAllParticlesInGrid </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Locates all particles within the grid and calculates their interpolation weights. </p>
<p>This function iterates through all particles currently local to this MPI rank. For each particle, it first checks if the particle is within the rank's pre-calculated bounding box (<code>user-&gt;bbox</code>). If it is, it calls the <code>LocateParticleInGrid</code> function to perform the walking search.</p>
<p><code>LocateParticleInGrid</code> is responsible for finding the containing cell <code>(i,j,k)</code> and calculating the corresponding interpolation weights <code>(w1,w2,w3)</code>. It updates the <code>particle-&gt;cell</code> and <code>particle-&gt;weights</code> fields directly upon success. If the search fails (particle not found within MAX_TRAVERSAL, goes out of bounds, or gets stuck without resolution), <code>LocateParticleInGrid</code> sets the particle's <code>cell</code> to <code>{-1,-1,-1}</code> and <code>weights</code> to <code>{0.0, 0.0, 0.0}</code>.</p>
<p>After attempting location, this function updates the corresponding entries in the DMSwarm's "DMSwarm_CellID" and "weight" fields using the potentially modified data from the <code>particle</code> struct.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> structure containing grid, swarm, and bounding box info.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode Returns <code>0</code> on success, non-zero on failure (e.g., errors accessing DMSwarm fields).</dd></dl>
<dl class="section note"><dt>Note</dt><dd>Assumes <code>user-&gt;bbox</code> is correctly initialized for the local rank. </dd>
<dd>
Assumes <code>InitializeParticle</code> correctly populates the temporary <code>particle</code> struct. </dd>
<dd>
Assumes <code>UpdateSwarmFields</code> correctly writes data back to the DMSwarm. </dd></dl>

</div>
</div>
<a id="a727054a4a467fd8504a19caed5a5916b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a727054a4a467fd8504a19caed5a5916b">&#9670;&nbsp;</a></span>LocateAllParticlesInGrid_TEST()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode LocateAllParticlesInGrid_TEST </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structBoundingBox">BoundingBox</a> *&#160;</td>
          <td class="paramname"><em>bboxlist</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Orchestrates the complete particle location and migration process for one timestep. </p>
<p>This function is the master orchestrator for ensuring every particle is on its correct MPI rank and has a valid host cell index. It is designed to be called once per timestep after particle positions have been updated.</p>
<p>The function uses a robust, iterative "Guess and Verify" strategy within a do-while loop to handle complex particle motion across processor boundaries, especially on curvilinear grids.</p>
<ol type="1">
<li><b>State Snapshot:</b> At the start of each pass, it captures a list of all <a class="el" href="variables_8h.html#structParticle" title="Defines a particle&#39;s core properties for Lagrangian tracking.">Particle</a> IDs (PIDs) on the current rank.</li>
<li>**"Guess" (Heuristic):** For particles that are "lost" (no valid host cell), it first attempts a fast, bounding-box-based guess to find a potential new owner rank.</li>
<li>**"Verify" (Robust Walk):** For all other particles, or if the guess fails, it uses a robust cell-walking algorithm (<code>LocateParticleOrFindMigrationTarget</code>) that determines the particle's status: located locally, needs migration, or is lost.</li>
<li><b>Migration:</b> After identifying all migrating particles on a pass, it performs the MPI communication using the <code>SetMigrationRanks</code> and <code>PerformMigration</code> helpers.</li>
<li><b>Newcomer Flagging:</b> After migration, it uses the PID snapshot from step 1 to efficiently identify newly arrived particles and flag them for location on the next pass.</li>
<li><b>Iteration:</b> The process repeats in a <code>do-while</code> loop until a pass occurs where no particles migrate, ensuring the entire swarm is in a stable, consistent state.</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a>, containing the swarm and all necessary domain topology information (bboxlist, RankCellInfoMap, etc.). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bboxlist</td><td>An array of <a class="el" href="variables_8h.html#structBoundingBox" title="Defines a 3D axis-aligned bounding box.">BoundingBox</a> structures for ALL MPI ranks, indexed 0 to (size-1). This array must be up-to-date and available on all ranks. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l01528">1528</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;{</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;    PetscInt       passes = 0;</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;    <span class="keyword">const</span> PetscInt MAX_MIGRATION_PASSES = 10; <span class="comment">// Safety break for runaway loops</span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    PetscInt       global_migrations_this_pass;</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    PetscMPIInt    rank;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160; </div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    ierr = MPI_Comm_rank(PETSC_COMM_WORLD, &amp;rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;LocateAllParticlesInGrid (Orchestrator) - Beginning particle settlement process.\n&quot;</span>);</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160; </div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    <span class="comment">// This loop ensures that particles that jump across multiple ranks are</span></div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;    <span class="comment">// handled correctly in successive, iterative handoffs.</span></div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    <span class="keywordflow">do</span> {</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;        passes++;</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;        <a class="code" href="logging_8h.html#a2ebe7667b52c478f7ff365f296d4c8ae">LOG_ALLOW_SYNC</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d] Starting migration pass %d.\n&quot;</span>, rank, passes);</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160; </div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        <span class="comment">// --- STAGE 1: PER-PASS INITIALIZATION ---</span></div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        <a class="code" href="variables_8h.html#structMigrationInfo">MigrationInfo</a>  *migrationList = NULL;</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        PetscInt       local_migration_count = 0;</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        PetscInt       migrationListCapacity = 0;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;        PetscInt       nlocal_before;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        PetscInt64     *pids_before_snapshot = NULL;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    PetscInt       local_lost_count = 0;</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160; </div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        ierr = DMSwarmGetLocalSize(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, &amp;nlocal_before); CHKERRQ(ierr);</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[Rank %d] Pass %d begins with %d local particles.\n&quot;</span>, rank, passes, nlocal_before);</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160; </div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160; </div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;        <span class="comment">// --- STAGE 2: PRE-MIGRATION SNAPSHOT &amp; MAIN PROCESSING LOOP ---</span></div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        <span class="keywordflow">if</span> (nlocal_before &gt; 0) {</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;            <span class="comment">// Get pointers to all fields needed for this pass</span></div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;            PetscReal  *pos_p, *weights_p, *vel_p;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;            PetscInt   *cell_p, *status_p;</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;            PetscInt64 *pid_p;</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;            ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;position&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pos_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;            ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;velocity&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span>**)&amp;vel_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;            ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;weight&quot;</span>,                  NULL, NULL, (<span class="keywordtype">void</span>**)&amp;weights_p);  CHKERRQ(ierr);</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;            ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>,          NULL, NULL, (<span class="keywordtype">void</span>**)&amp;cell_p);     CHKERRQ(ierr);</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;            ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pid_p);      CHKERRQ(ierr);</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;            ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;status_p);   CHKERRQ(ierr);</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160; </div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;            <span class="comment">// Create a sorted snapshot of current PIDs to identify newcomers after migration.</span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;            <span class="comment">// This helper requires a raw pointer, which we just acquired.</span></div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;            ierr = <a class="code" href="ParticleMotion_8c.html#a5d388b62daa726aa7ea467a71313a328">GetLocalPIDSnapshot</a>(pid_p, nlocal_before, &amp;pids_before_snapshot); CHKERRQ(ierr);</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160; </div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;            <span class="keywordflow">for</span> (PetscInt p_idx = 0; p_idx &lt; nlocal_before; p_idx++) {</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160; </div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;                <span class="comment">// OPTIMIZATION: Skip particles already settled in a previous pass of this do-while loop.</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160; </div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;          <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;            <span class="stringliteral">&quot;p_idx=%d, PID=%ld, status=%d, cell=(%d, %d, %d)\n&quot;</span>,</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;            p_idx,</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;            (<span class="keywordtype">long</span>)pid_p[p_idx],</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;            status_p[p_idx],</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;            cell_p[3*p_idx],</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;            cell_p[3*p_idx+1],</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;            cell_p[3*p_idx+2]);</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160; </div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                <span class="keywordflow">if</span> (status_p[p_idx] == <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581a97d609accacbcc1a41e4da5ac052f253">ACTIVE_AND_LOCATED</a>) {</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;          <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>,<a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>,<span class="stringliteral">&quot; [rank %d][PID %ld] skipped in pass %d as it is already located at (%d,%d,%d).\n&quot;</span>,rank,pid_p[p_idx],passes,cell_p[3*p_idx],cell_p[3*p_idx + 1],cell_p[3*p_idx + 2]);</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;                }</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160; </div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;                <span class="comment">// UNPACK: Create a temporary C struct for easier processing using our helper.</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;                <a class="code" href="variables_8h.html#structParticle">Particle</a> current_particle;</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160; </div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <span class="comment">//  LOG_ALLOW(LOCAL,LOG_DEBUG,&quot;about to unpack p_idx=%d (PID=%ld)\n&quot;,p_idx, (long)pid_p[p_idx]);</span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;        </div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;                ierr = <a class="code" href="ParticleSwarm_8h.html#aa353055e357151aab1542bbad367c657">UnpackSwarmFields</a>(p_idx, pid_p, weights_p, pos_p, cell_p, vel_p, status_p, &amp;current_particle); CHKERRQ(ierr);</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160; </div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <span class="comment">//      LOG_ALLOW(LOCAL,LOG_DEBUG,&quot;unpacked p_idx=%d → cell[0]=%d, status=%d\n&quot;,p_idx, current_particle.cell[0], current_particle.location_status);</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160; </div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;        <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581">ParticleLocationStatus</a> final_status = (<a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581">ParticleLocationStatus</a>)status_p[p_idx];</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160; </div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160; </div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;        <span class="comment">// CASE 1: Particle has a valid prior cell index.</span></div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                <span class="comment">// It has moved, so we only need to run the robust walk from its last known location.</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;                <span class="keywordflow">if</span> (current_particle.<a class="code" href="variables_8h.html#a2b65d08959f82092f0802feecbf46bee">cell</a>[0] &gt;= 0) {</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;          <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[PID %ld] has valid prior cell. Strategy: Robust Walk from previous cell.\n&quot;</span>, current_particle.<a class="code" href="variables_8h.html#aecd4cd7f1da07e3f3d6e1fb6cf71a44b">PID</a>);</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;          ierr = <a class="code" href="walkingsearch_8h.html#a0b63dfe82e0fdee5c2c3bdd477f9901f">LocateParticleOrFindMigrationTarget_TEST</a>(user, &amp;current_particle, &amp;final_status); CHKERRQ(ierr);</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;                } </div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160; </div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        <span class="comment">/*      </span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment">                // --- &quot;GUESS&quot; FAST PATH for lost particles ---</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment">                if (current_particle.cell[0] &lt; 0) {</span></div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="comment">                    LOG_ALLOW(LOCAL, LOG_DEBUG, &quot;[PID %ld] is lost or uninitialzied (cell=%d), attempting fast guess.\n&quot;,current_particle.PID, current_particle.cell[0]);</span></div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="comment">                    ierr = GuessParticleOwnerWithBBox(user, &amp;current_particle, bboxlist, &amp;destination_rank); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="comment">                    if (destination_rank != MPI_PROC_NULL &amp;&amp; destination_rank != rank) {</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;<span class="comment">                        final_status = MIGRATING_OUT;</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="comment">                        // The particle struct&#39;s destination rank must be updated for consistency</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="comment">                        current_particle.destination_rank = destination_rank;</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="comment">                    }</span></div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="comment">        LOG_ALLOW(LOCAL,LOG_DEBUG,&quot;[PID %ld] Particle status after Initial Guess:%d \n&quot;,current_particle.PID,final_status);</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="comment">                // --- &quot;VERIFY&quot; ROBUST WALK if guess didn&#39;t resolve it ---</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="comment">                if (final_status == NEEDS_LOCATION  || UNINITIALIZED) {</span></div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;<span class="comment">                    LOG_ALLOW(LOCAL, LOG_DEBUG, &quot;[PID %ld] Not resolved by guess, starting robust walk.\n&quot;, current_particle.PID);</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="comment">                    // This function will update the particle&#39;s status and destination rank internally.</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="comment">             ierr = LocateParticleOrFindMigrationTarget_TEST(user, &amp;current_particle, &amp;final_status); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="comment">                    destination_rank = current_particle.destination_rank; // Retrieve the result</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="comment">                // --- PROCESS THE FINAL STATUS AND TAKE ACTION ---</span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="comment">                if (final_status == MIGRATING_OUT) {</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="comment">                    status_p[p_idx] = MIGRATING_OUT; // Mark for removal by DMSwarm</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="comment">                    ierr = AddToMigrationList(&amp;migrationList, &amp;migrationListCapacity, &amp;local_migration_count, p_idx, destination_rank); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="comment">                    LOG_ALLOW(LOCAL, LOG_DEBUG, &quot;[PID %ld] at local index %d marked for migration to rank %d.\n&quot;,current_particle.PID, p_idx, destination_rank);</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="comment">                } else {</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="comment">                     // Particle&#39;s final status is either LOCATED or LOST; update its state in the swarm arrays.</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;<span class="comment">                     current_particle.location_status = final_status;</span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="comment">                     // PACK: Use the helper to write results back to the swarm arrays.</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="comment">                     ierr = UpdateSwarmFields(p_idx, &amp;current_particle, weights_p, cell_p, status_p); CHKERRQ(ierr);</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                <span class="comment">// CASE 2: Particle is &quot;lost&quot; (cell = -1). Strategy: Guess -&gt; Verify.</span></div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;          <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[PID %ld] has invalid cell. Strategy: Guess Owner -&gt; Find Cell.\n&quot;</span>,current_particle.<a class="code" href="variables_8h.html#aecd4cd7f1da07e3f3d6e1fb6cf71a44b">PID</a>);</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;                    </div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;          PetscMPIInt guessed_owner_rank = MPI_PROC_NULL;</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;          ierr = <a class="code" href="ParticleMotion_8c.html#a1050c4075c2fb507d4579008921dd7b6">GuessParticleOwnerWithBBox</a>(user, &amp;current_particle, bboxlist, &amp;guessed_owner_rank); CHKERRQ(ierr);</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160; </div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;          <span class="comment">// If the guess finds a DIFFERENT rank, we can mark for migration and skip the walk.</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;          <span class="keywordflow">if</span> (guessed_owner_rank != MPI_PROC_NULL &amp;&amp; guessed_owner_rank != rank) {</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;            <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[PID %ld] Guess SUCCESS: Found migration target Rank %d. Finalizing.\n&quot;</span>, current_particle.<a class="code" href="variables_8h.html#aecd4cd7f1da07e3f3d6e1fb6cf71a44b">PID</a>, guessed_owner_rank);</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;            final_status = <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581af0c3b8144a24d2379a1580a6cd48d329">MIGRATING_OUT</a>;</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;            current_particle.<a class="code" href="variables_8h.html#a76cdf3edbcd6aa56f5a2ba8645e999ea">destination_rank</a> = guessed_owner_rank;</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;          } </div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;          <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160; </div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;            <span class="comment">// This block runs if the guess either failed (rank is NULL) or found the particle is local (rank is self).</span></div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;            <span class="comment">// In BOTH cases, the situation is unresolved, and we MUST fall back to the robust walk.</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;            <span class="keywordflow">if</span> (guessed_owner_rank == rank) {</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;              <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a>, <span class="stringliteral">&quot;[PID %ld] Guess determined particle is local. Proceeding to robust walk to find cell.\n&quot;</span>, current_particle.<a class="code" href="variables_8h.html#aecd4cd7f1da07e3f3d6e1fb6cf71a44b">PID</a>);</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;            } <span class="keywordflow">else</span> { <span class="comment">// guessed_owner_rank == MPI_PROC_NULL</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;              <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400">LOG_WARNING</a>, <span class="stringliteral">&quot;[PID %ld] Guess FAILED to find an owner. Proceeding to robust walk for definitive search.\n&quot;</span>, current_particle.<a class="code" href="variables_8h.html#aecd4cd7f1da07e3f3d6e1fb6cf71a44b">PID</a>);</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;            }</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                        </div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;            ierr = <a class="code" href="walkingsearch_8h.html#a0b63dfe82e0fdee5c2c3bdd477f9901f">LocateParticleOrFindMigrationTarget_TEST</a>(user, &amp;current_particle, &amp;final_status); CHKERRQ(ierr);</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;          }</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;                }</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        </div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;                <span class="comment">// --- PROCESS THE FINAL, DEFINITIVE STATUS ---</span></div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;                current_particle.<a class="code" href="variables_8h.html#a88a45e3c57c861d03160f28aaa786414">location_status</a> = final_status;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                ierr = <a class="code" href="ParticleSwarm_8h.html#ac52b9e4afa9d1f2ba3bf59dc45b610d1">UpdateSwarmFields</a>(p_idx, &amp;current_particle, weights_p, cell_p, status_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;                </div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;                <span class="keywordflow">if</span> (final_status == <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581af0c3b8144a24d2379a1580a6cd48d329">MIGRATING_OUT</a>) {</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;          ierr = <a class="code" href="ParticleMotion_8c.html#a43df9caf0f5cbb317050f6258ac46fff">AddToMigrationList</a>(&amp;migrationList, &amp;migrationListCapacity, &amp;local_migration_count, p_idx, current_particle.<a class="code" href="variables_8h.html#a76cdf3edbcd6aa56f5a2ba8645e999ea">destination_rank</a>); CHKERRQ(ierr);</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (final_status == <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581a339435bd0d4a842c6107333c908a5317">LOST</a>) {</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;          local_lost_count++;</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;                }</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;                </div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;            } <span class="comment">// End of main particle processing loop</span></div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160; </div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;            <span class="comment">// Restore all the fields acquired for this pass.</span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;            ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;position&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pos_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;            ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;velocity&quot;</span>,                NULL, NULL, (<span class="keywordtype">void</span>**)&amp;vel_p);    CHKERRQ(ierr);</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;            ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;weight&quot;</span>,                  NULL, NULL, (<span class="keywordtype">void</span>**)&amp;weights_p);  CHKERRQ(ierr);</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;            ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_CellID&quot;</span>,          NULL, NULL, (<span class="keywordtype">void</span>**)&amp;cell_p);     CHKERRQ(ierr);</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_pid&quot;</span>,             NULL, NULL, (<span class="keywordtype">void</span>**)&amp;pid_p);      CHKERRQ(ierr);</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;status_p);   CHKERRQ(ierr);</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        }</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160; </div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;        <span class="comment">// --- STAGE 3: ACTION &amp; MPI COMMUNICATION ---</span></div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;[Rank %d] Pass %d: Identified %d particles to migrate out.\n&quot;</span>, rank, passes, local_migration_count);</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160; </div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;    <span class="comment">// --- STAGE 3: SYNCHRONIZE AND DECIDE ---</span></div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        <span class="comment">// FIRST, determine if any rank wants to migrate. This call is safe because</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="comment">// all ranks have finished their local work and can participate.</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        ierr = MPI_Allreduce(&amp;local_migration_count, &amp;global_migrations_this_pass, 1, MPIU_INT, MPI_SUM, PETSC_COMM_WORLD); CHKERRQ(ierr);  </div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160; </div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <span class="keywordflow">if</span>(global_migrations_this_pass &gt; 0 ){</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160; </div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Pass %d: Migrating %d particles globally.\n&quot;</span>, passes, global_migrations_this_pass);</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;        </div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;        ierr = <a class="code" href="ParticleMotion_8c.html#a461def358c0f7c5337c283ba06dd65a0">SetMigrationRanks</a>(user, migrationList, local_migration_count); CHKERRQ(ierr);</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;        ierr = <a class="code" href="ParticleMotion_8c.html#af68865be3bc987bdf1be2c5c7a1903fa">PerformMigration</a>(user); CHKERRQ(ierr);</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160; </div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;        <span class="comment">// --- STAGE 4: POST-MIGRATION RESET ---</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;        <span class="comment">// Identify newly arrived particles and flag them with NEEDS_LOCATION so they are</span></div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;        <span class="comment">// processed in the next pass. This uses the snapshot taken in STAGE 2.</span></div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;        ierr = <a class="code" href="ParticleMotion_8c.html#ad247152a0dd47d07243fad4c2fd89c0a">FlagNewcomersForLocation</a>(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, nlocal_before, pids_before_snapshot); CHKERRQ(ierr);</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    }</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;        <span class="comment">// --- STAGE 5: LOOP SYNCHRONIZATION AND CLEANUP ---</span></div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160; </div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        ierr = PetscFree(pids_before_snapshot);</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        ierr = PetscFree(migrationList);</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160; </div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;End of LocateAllParticlesInGrid pass %d. Total particles migrated globally: %d.\n&quot;</span>, passes, global_migrations_this_pass);</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160; </div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    } <span class="keywordflow">while</span> (global_migrations_this_pass &gt; 0 &amp;&amp; passes &lt; MAX_MIGRATION_PASSES);</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160; </div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    <span class="comment">// --- FINAL CHECKS ---</span></div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;    <span class="keywordflow">if</span> (passes &gt;= MAX_MIGRATION_PASSES) {</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;        SETERRQ(PETSC_COMM_WORLD, PETSC_ERR_CONV_FAILED, <span class="stringliteral">&quot;Particle migration failed to converge after %d passes. Check for particles oscillating between ranks.&quot;</span>, MAX_MIGRATION_PASSES);</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    }</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160; </div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    <a class="code" href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a>(<a class="code" href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a>, <a class="code" href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a>, <span class="stringliteral">&quot;Particle Location completed in %d passes.\n&quot;</span>, passes);</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160; </div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a727054a4a467fd8504a19caed5a5916b_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a727054a4a467fd8504a19caed5a5916b_icgraph.svg" width="100%" height="414"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a8be73031fbe89d58cd8f7ad2f312d2e9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8be73031fbe89d58cd8f7ad2f312d2e9">&#9670;&nbsp;</a></span>ResetAllParticleStatuses()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PetscErrorCode ResetAllParticleStatuses </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="variables_8h.html#structUserCtx">UserCtx</a> *&#160;</td>
          <td class="paramname"><em>user</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function is designed to be called at the end of a full timestep, after all particle-based calculations are complete. </p>
<p>It prepares the swarm for the next timestep by ensuring that after the next position update, every particle will be re-evaluated by the LocateAllParticlesInGrid orchestrator.</p>
<p>It iterates through all locally owned particles and sets their <code>DMSwarm_location_status</code> field to <code>NEEDS_LOCATION</code>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">user</td><td>Pointer to the <a class="el" href="variables_8h.html#structUserCtx" title="User-defined context containing data specific to a single computational grid level.">UserCtx</a> containing the swarm. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PetscErrorCode 0 on success, or a non-zero PETSc error code on failure. </dd></dl>

<p class="definition">Definition at line <a class="el" href="ParticleMotion_8c_source.html#l01750">1750</a> of file <a class="el" href="ParticleMotion_8c_source.html">ParticleMotion.c</a>.</p>
<div class="fragment"><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;{</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    PetscErrorCode ierr;</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    PetscInt       n_local;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    PetscInt      *status_p;</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160; </div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    PetscFunctionBeginUser;</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160; </div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <a class="code" href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a>;</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160; </div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    ierr = DMSwarmGetLocalSize(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, &amp;n_local); CHKERRQ(ierr);</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160; </div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <span class="keywordflow">if</span> (n_local &gt; 0) {</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;        <span class="comment">// Get write access to the status field</span></div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;        ierr = DMSwarmGetField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;status_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        </div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        <span class="keywordflow">for</span> (PetscInt p = 0; p &lt; n_local; ++p) {</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;            <span class="comment">// Only reset particles that are considered settled. This is a small optimization</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;            <span class="comment">// to avoid changing the status of a LOST particle, though resetting all would also be fine.</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;            <span class="keywordflow">if</span> (status_p[p] == <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581a97d609accacbcc1a41e4da5ac052f253">ACTIVE_AND_LOCATED</a>) {</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;                status_p[p] = <a class="code" href="variables_8h.html#a347829443e8a679209e21f7f04f51581a73a50b46251a0e24a0e2ed0e0082003a">NEEDS_LOCATION</a>;</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;            }</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        }</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        </div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;        <span class="comment">// Restore the field</span></div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;        ierr = DMSwarmRestoreField(user-&gt;<a class="code" href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">swarm</a>, <span class="stringliteral">&quot;DMSwarm_location_status&quot;</span>, NULL, NULL, (<span class="keywordtype">void</span>**)&amp;status_p); CHKERRQ(ierr);</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    }</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160; </div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160; </div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    <a class="code" href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a>;</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    PetscFunctionReturn(0);</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="ParticleMotion_8h_a8be73031fbe89d58cd8f7ad2f312d2e9_icgraph.svg" width="100%" height="404"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="avariables_8h_html_ad032e456f7f4b32b9ac0d94be05de204"><div class="ttname"><a href="variables_8h.html#ad032e456f7f4b32b9ac0d94be05de204">Cmpnts::y</a></div><div class="ttdeci">PetscScalar y</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00101">variables.h:101</a></div></div>
<div class="ttc" id="avariables_8h_html_a347829443e8a679209e21f7f04f51581a97d609accacbcc1a41e4da5ac052f253"><div class="ttname"><a href="variables_8h.html#a347829443e8a679209e21f7f04f51581a97d609accacbcc1a41e4da5ac052f253">ACTIVE_AND_LOCATED</a></div><div class="ttdeci">@ ACTIVE_AND_LOCATED</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00137">variables.h:137</a></div></div>
<div class="ttc" id="avariables_8h_html_a4381464fc6d367c0619eea12d6c28dfe"><div class="ttname"><a href="variables_8h.html#a4381464fc6d367c0619eea12d6c28dfe">MigrationInfo::local_index</a></div><div class="ttdeci">PetscInt local_index</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00190">variables.h:190</a></div></div>
<div class="ttc" id="avariables_8h_html_a322702c716e6e140d71515d0b3e111b1"><div class="ttname"><a href="variables_8h.html#a322702c716e6e140d71515d0b3e111b1">UserCtx::simCtx</a></div><div class="ttdeci">SimCtx * simCtx</div><div class="ttdoc">Back-pointer to the master simulation context.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00660">variables.h:660</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9ab9f002c6ffbfd511da8090213227454e">LOG_DEBUG</a></div><div class="ttdeci">@ LOG_DEBUG</div><div class="ttdoc">Detailed debugging information.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00033">logging.h:33</a></div></div>
<div class="ttc" id="avariables_8h_html_a718a09fbedf450248eaf7019a980e139"><div class="ttname"><a href="variables_8h.html#a718a09fbedf450248eaf7019a980e139">Cmpnts::x</a></div><div class="ttdeci">PetscScalar x</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00101">variables.h:101</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a8f6fe15bfe15104da6d1b360194a5400">LOG_WARNING</a></div><div class="ttdeci">@ LOG_WARNING</div><div class="ttdoc">Non-critical issues that warrant attention.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00030">logging.h:30</a></div></div>
<div class="ttc" id="avariables_8h_html_structMigrationInfo"><div class="ttname"><a href="variables_8h.html#structMigrationInfo">MigrationInfo</a></div><div class="ttdoc">Information needed to migrate a single particle between MPI ranks.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00189">variables.h:189</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a030c51d171d2f725c708cd334f51ef2c"><div class="ttname"><a href="ParticleMotion_8c.html#a030c51d171d2f725c708cd334f51ef2c">UpdateParticlePosition</a></div><div class="ttdeci">PetscErrorCode UpdateParticlePosition(UserCtx *user, Cmpnts *position, const Cmpnts *velocity)</div><div class="ttdoc">Updates a particle's position based on its velocity and the timestep dt (stored in user-&gt;dt).</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l00022">ParticleMotion.c:22</a></div></div>
<div class="ttc" id="avariables_8h_html_a27bce072860da2f1a8a54d94b2b9497f"><div class="ttname"><a href="variables_8h.html#a27bce072860da2f1a8a54d94b2b9497f">UserCtx::identifiedInletBCFace</a></div><div class="ttdeci">BCFace identifiedInletBCFace</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00677">variables.h:677</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a5d388b62daa726aa7ea467a71313a328"><div class="ttname"><a href="ParticleMotion_8c.html#a5d388b62daa726aa7ea467a71313a328">GetLocalPIDSnapshot</a></div><div class="ttdeci">PetscErrorCode GetLocalPIDSnapshot(const PetscInt64 pid_field[], PetscInt n_local, PetscInt64 **pids_snapshot_out)</div><div class="ttdoc">Creates a sorted snapshot of all Particle IDs (PIDs) from a raw data array.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l01117">ParticleMotion.c:1117</a></div></div>
<div class="ttc" id="alogging_8h_html_a2ebe7667b52c478f7ff365f296d4c8ae"><div class="ttname"><a href="logging_8h.html#a2ebe7667b52c478f7ff365f296d4c8ae">LOG_ALLOW_SYNC</a></div><div class="ttdeci">#define LOG_ALLOW_SYNC(scope, level, fmt,...)</div><div class="ttdoc">----— DEBUG ---------------------------------------— #define LOG_ALLOW(scope, level,...</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00266">logging.h:266</a></div></div>
<div class="ttc" id="avariables_8h_html_a347829443e8a679209e21f7f04f51581"><div class="ttname"><a href="variables_8h.html#a347829443e8a679209e21f7f04f51581">ParticleLocationStatus</a></div><div class="ttdeci">ParticleLocationStatus</div><div class="ttdoc">Defines the state of a particle with respect to its location and migration status during the iterativ...</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00135">variables.h:135</a></div></div>
<div class="ttc" id="alogging_8h_html_a3758dd5d300a594312c95bc393378df0"><div class="ttname"><a href="logging_8h.html#a3758dd5d300a594312c95bc393378df0">LOCAL</a></div><div class="ttdeci">#define LOCAL</div><div class="ttdoc">Logging scope definitions for controlling message output.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00044">logging.h:44</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a43df9caf0f5cbb317050f6258ac46fff"><div class="ttname"><a href="ParticleMotion_8c.html#a43df9caf0f5cbb317050f6258ac46fff">AddToMigrationList</a></div><div class="ttdeci">PetscErrorCode AddToMigrationList(MigrationInfo **migration_list_p, PetscInt *capacity_p, PetscInt *count_p, PetscInt particle_local_idx, PetscMPIInt destination_rank)</div><div class="ttdoc">Safely adds a new migration task to a dynamically sized list.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l01189">ParticleMotion.c:1189</a></div></div>
<div class="ttc" id="avariables_8h_html_a88a45e3c57c861d03160f28aaa786414"><div class="ttname"><a href="variables_8h.html#a88a45e3c57c861d03160f28aaa786414">Particle::location_status</a></div><div class="ttdeci">ParticleLocationStatus location_status</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00171">variables.h:171</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_ad2b9ac6b5e4d13799fa82dcd34432da4"><div class="ttname"><a href="ParticleMotion_8c.html#ad2b9ac6b5e4d13799fa82dcd34432da4">IsParticleInBox</a></div><div class="ttdeci">static PetscBool IsParticleInBox(const BoundingBox *bbox, const Cmpnts *pos)</div><div class="ttdoc">Checks if a particle position is within the bounds of a given bounding box.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l00120">ParticleMotion.c:120</a></div></div>
<div class="ttc" id="alogging_8h_html_a5fe7257f46131945aacf9a35e9de5874"><div class="ttname"><a href="logging_8h.html#a5fe7257f46131945aacf9a35e9de5874">PROFILE_FUNCTION_END</a></div><div class="ttdeci">#define PROFILE_FUNCTION_END</div><div class="ttdoc">Marks the end of a profiled code block.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00731">logging.h:731</a></div></div>
<div class="ttc" id="aParticleSwarm_8h_html_ac52b9e4afa9d1f2ba3bf59dc45b610d1"><div class="ttname"><a href="ParticleSwarm_8h.html#ac52b9e4afa9d1f2ba3bf59dc45b610d1">UpdateSwarmFields</a></div><div class="ttdeci">PetscErrorCode UpdateSwarmFields(PetscInt i, const Particle *particle, PetscReal *weights, PetscInt *cellIndices, PetscInt *status_field)</div><div class="ttdoc">Updates DMSwarm fields with data from a Particle struct.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleSwarm_8c_source.html#l00983">ParticleSwarm.c:983</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9a230506cce5c68c3bac5a821c42ed3473"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a230506cce5c68c3bac5a821c42ed3473">LOG_ERROR</a></div><div class="ttdeci">@ LOG_ERROR</div><div class="ttdoc">Critical errors that may halt the program.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00029">logging.h:29</a></div></div>
<div class="ttc" id="aParticleSwarm_8h_html_ab723e91906e01ec26aab97de6623000c"><div class="ttname"><a href="ParticleSwarm_8h.html#ab723e91906e01ec26aab97de6623000c">InitializeLogicalSpaceRNGs</a></div><div class="ttdeci">PetscErrorCode InitializeLogicalSpaceRNGs(PetscRandom *rand_logic_i, PetscRandom *rand_logic_j, PetscRandom *rand_logic_k)</div><div class="ttdoc">Initializes random number generators for logical space operations [0.0, 1.0).</div><div class="ttdef"><b>Definition:</b> <a href="ParticleSwarm_8c_source.html#l00173">ParticleSwarm.c:173</a></div></div>
<div class="ttc" id="aParticleSwarm_8h_html_aa353055e357151aab1542bbad367c657"><div class="ttname"><a href="ParticleSwarm_8h.html#aa353055e357151aab1542bbad367c657">UnpackSwarmFields</a></div><div class="ttdeci">PetscErrorCode UnpackSwarmFields(PetscInt i, const PetscInt64 *PIDs, const PetscReal *weights, const PetscReal *positions, const PetscInt *cellIndices, PetscReal *velocities, PetscInt *LocStatus, Particle *particle)</div><div class="ttdoc">Initializes a Particle struct with data from DMSwarm fields.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleSwarm_8c_source.html#l00901">ParticleSwarm.c:901</a></div></div>
<div class="ttc" id="avariables_8h_html_a2b65d08959f82092f0802feecbf46bee"><div class="ttname"><a href="variables_8h.html#a2b65d08959f82092f0802feecbf46bee">Particle::cell</a></div><div class="ttdeci">PetscInt cell[3]</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00167">variables.h:167</a></div></div>
<div class="ttc" id="asetup_8h_html_acd8d87dc85f19ba3e32811a623bf5b36"><div class="ttname"><a href="setup_8h.html#acd8d87dc85f19ba3e32811a623bf5b36">BinarySearchInt64</a></div><div class="ttdeci">PetscErrorCode BinarySearchInt64(PetscInt n, const PetscInt64 arr[], PetscInt64 key, PetscBool *found)</div><div class="ttdoc">Performs a binary search for a key in a sorted array of PetscInt64.</div><div class="ttdef"><b>Definition:</b> <a href="setup_8c_source.html#l02120">setup.c:2120</a></div></div>
<div class="ttc" id="avariables_8h_html_a347829443e8a679209e21f7f04f51581af0c3b8144a24d2379a1580a6cd48d329"><div class="ttname"><a href="variables_8h.html#a347829443e8a679209e21f7f04f51581af0c3b8144a24d2379a1580a6cd48d329">MIGRATING_OUT</a></div><div class="ttdeci">@ MIGRATING_OUT</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00138">variables.h:138</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_ad247152a0dd47d07243fad4c2fd89c0a"><div class="ttname"><a href="ParticleMotion_8c.html#ad247152a0dd47d07243fad4c2fd89c0a">FlagNewcomersForLocation</a></div><div class="ttdeci">PetscErrorCode FlagNewcomersForLocation(DM swarm, PetscInt n_local_before, const PetscInt64 pids_before[])</div><div class="ttdoc">Identifies newly arrived particles after migration and flags them for a location search.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l01271">ParticleMotion.c:1271</a></div></div>
<div class="ttc" id="alogging_8h_html_a3de33738fd3c7e77bffbcfaefc3e7645"><div class="ttname"><a href="logging_8h.html#a3de33738fd3c7e77bffbcfaefc3e7645">GLOBAL</a></div><div class="ttdeci">#define GLOBAL</div><div class="ttdoc">Scope for global logging across all processes.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00045">logging.h:45</a></div></div>
<div class="ttc" id="avariables_8h_html_structCmpnts"><div class="ttname"><a href="variables_8h.html#structCmpnts">Cmpnts</a></div><div class="ttdoc">A 3D point or vector with PetscScalar components.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00100">variables.h:100</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a461def358c0f7c5337c283ba06dd65a0"><div class="ttname"><a href="ParticleMotion_8c.html#a461def358c0f7c5337c283ba06dd65a0">SetMigrationRanks</a></div><div class="ttdeci">PetscErrorCode SetMigrationRanks(UserCtx *user, const MigrationInfo *migrationList, PetscInt migrationCount)</div><div class="ttdoc">Sets the target rank field (DMSwarmPICField_rank) for particles scheduled for migration.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l00525">ParticleMotion.c:525</a></div></div>
<div class="ttc" id="avariables_8h_html_a347829443e8a679209e21f7f04f51581a73a50b46251a0e24a0e2ed0e0082003a"><div class="ttname"><a href="variables_8h.html#a347829443e8a679209e21f7f04f51581a73a50b46251a0e24a0e2ed0e0082003a">NEEDS_LOCATION</a></div><div class="ttdeci">@ NEEDS_LOCATION</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00136">variables.h:136</a></div></div>
<div class="ttc" id="avariables_8h_html_a347829443e8a679209e21f7f04f51581a339435bd0d4a842c6107333c908a5317"><div class="ttname"><a href="variables_8h.html#a347829443e8a679209e21f7f04f51581a339435bd0d4a842c6107333c908a5317">LOST</a></div><div class="ttdeci">@ LOST</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00139">variables.h:139</a></div></div>
<div class="ttc" id="avariables_8h_html_a76cdf3edbcd6aa56f5a2ba8645e999ea"><div class="ttname"><a href="variables_8h.html#a76cdf3edbcd6aa56f5a2ba8645e999ea">Particle::destination_rank</a></div><div class="ttdeci">PetscMPIInt destination_rank</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00172">variables.h:172</a></div></div>
<div class="ttc" id="aBoundaries_8h_html_ac07befc354128d23bac8ed5f2612ffdf"><div class="ttname"><a href="Boundaries_8h.html#ac07befc354128d23bac8ed5f2612ffdf">GetRandomCellAndLogicOnInletFace</a></div><div class="ttdeci">PetscErrorCode GetRandomCellAndLogicOnInletFace(UserCtx *user, const DMDALocalInfo *info, PetscInt xs_gnode_rank, PetscInt ys_gnode_rank, PetscInt zs_gnode_rank, PetscInt IM_nodes_global, PetscInt JM_nodes_global, PetscInt KM_nodes_global, PetscRandom *rand_logic_i_ptr, PetscRandom *rand_logic_j_ptr, PetscRandom *rand_logic_k_ptr, PetscInt *ci_metric_lnode_out, PetscInt *cj_metric_lnode_out, PetscInt *ck_metric_lnode_out, PetscReal *xi_metric_logic_out, PetscReal *eta_metric_logic_out, PetscReal *zta_metric_logic_out)</div><div class="ttdoc">Assuming the current rank services the inlet face, this function selects a random cell (owned by this...</div><div class="ttdef"><b>Definition:</b> <a href="Boundaries_8c_source.html#l00239">Boundaries.c:239</a></div></div>
<div class="ttc" id="avariables_8h_html_a5eedf611da6dd4f59cc65753b777b957"><div class="ttname"><a href="variables_8h.html#a5eedf611da6dd4f59cc65753b777b957">SimCtx::np</a></div><div class="ttdeci">PetscInt np</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00612">variables.h:612</a></div></div>
<div class="ttc" id="aBoundaries_8h_html_ab679d620b2d750179fbc2363fc562a1f"><div class="ttname"><a href="Boundaries_8h.html#ab679d620b2d750179fbc2363fc562a1f">CanRankServiceInletFace</a></div><div class="ttdeci">PetscErrorCode CanRankServiceInletFace(UserCtx *user, const DMDALocalInfo *info, PetscInt IM_nodes_global, PetscInt JM_nodes_global, PetscInt KM_nodes_global, PetscBool *can_service_inlet_out)</div><div class="ttdoc">Determines if the current MPI rank owns any part of the globally defined inlet face,...</div><div class="ttdef"><b>Definition:</b> <a href="Boundaries_8c_source.html#l00025">Boundaries.c:25</a></div></div>
<div class="ttc" id="alogging_8h_html_a1543cd95db1569c7d901fd4b9a3a43d7"><div class="ttname"><a href="logging_8h.html#a1543cd95db1569c7d901fd4b9a3a43d7">LOG_LOOP_ALLOW</a></div><div class="ttdeci">#define LOG_LOOP_ALLOW(scope, level, iterVar, interval, fmt,...)</div><div class="ttdoc">Logs a message inside a loop, but only every interval iterations.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00311">logging.h:311</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_af68865be3bc987bdf1be2c5c7a1903fa"><div class="ttname"><a href="ParticleMotion_8c.html#af68865be3bc987bdf1be2c5c7a1903fa">PerformMigration</a></div><div class="ttdeci">PetscErrorCode PerformMigration(UserCtx *user)</div><div class="ttdoc">Performs particle migration based on the pre-populated DMSwarmPICField_rank field.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l00562">ParticleMotion.c:562</a></div></div>
<div class="ttc" id="avariables_8h_html_a69966d928601d61d4f526636f84396c5"><div class="ttname"><a href="variables_8h.html#a69966d928601d61d4f526636f84396c5">UserCtx::fda</a></div><div class="ttdeci">DM fda</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00663">variables.h:663</a></div></div>
<div class="ttc" id="alogging_8h_html_a4a671b0e347e0a22b0df806f246d5d11"><div class="ttname"><a href="logging_8h.html#a4a671b0e347e0a22b0df806f246d5d11">LOG_ALLOW</a></div><div class="ttdeci">#define LOG_ALLOW(scope, level, fmt,...)</div><div class="ttdoc">Logging macro that checks both the log level and whether the calling function is in the allowed-funct...</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00199">logging.h:199</a></div></div>
<div class="ttc" id="avariables_8h_html_a9f0c002a2c7cde3b6ac843ab9185f4d4"><div class="ttname"><a href="variables_8h.html#a9f0c002a2c7cde3b6ac843ab9185f4d4">Cmpnts::z</a></div><div class="ttdeci">PetscScalar z</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00101">variables.h:101</a></div></div>
<div class="ttc" id="avariables_8h_html_ae3ce8967b15c2e6be9e829b745da4090"><div class="ttname"><a href="variables_8h.html#ae3ce8967b15c2e6be9e829b745da4090">SimCtx::ParticleInitialization</a></div><div class="ttdeci">PetscInt ParticleInitialization</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00616">variables.h:616</a></div></div>
<div class="ttc" id="alogging_8h_html_aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837"><div class="ttname"><a href="logging_8h.html#aca1fd1d8935433e6ba2e3918214e07f9a6e98ff471e3ce6c4ef2d75c37ee51837">LOG_INFO</a></div><div class="ttdeci">@ LOG_INFO</div><div class="ttdoc">Informational messages about program execution.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00032">logging.h:32</a></div></div>
<div class="ttc" id="avariables_8h_html_a1675749ea3b2429f00405a1ee3203d18"><div class="ttname"><a href="variables_8h.html#a1675749ea3b2429f00405a1ee3203d18">UserCtx::swarm</a></div><div class="ttdeci">DM swarm</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00722">variables.h:722</a></div></div>
<div class="ttc" id="avariables_8h_html_a53b044b8b0e4a4dc8c8fa05387af564c"><div class="ttname"><a href="variables_8h.html#a53b044b8b0e4a4dc8c8fa05387af564c">SimCtx::dt</a></div><div class="ttdeci">PetscReal dt</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00552">variables.h:552</a></div></div>
<div class="ttc" id="avariables_8h_html_structlist"><div class="ttname"><a href="variables_8h.html#structlist">list</a></div><div class="ttdoc">Head of a generic C-style linked list.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00350">variables.h:350</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a38b5e7348bc556d505e2c4b31c29b086"><div class="ttname"><a href="ParticleMotion_8c.html#a38b5e7348bc556d505e2c4b31c29b086">ResizeSwarmGlobally</a></div><div class="ttdeci">PetscErrorCode ResizeSwarmGlobally(DM swarm, PetscInt N_target)</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l00749">ParticleMotion.c:749</a></div></div>
<div class="ttc" id="aMetric_8h_html_af0ba1966641e609476ac6fc3d5cdbbfc"><div class="ttname"><a href="Metric_8h.html#af0ba1966641e609476ac6fc3d5cdbbfc">MetricLogicalToPhysical</a></div><div class="ttdeci">PetscErrorCode MetricLogicalToPhysical(UserCtx *user, const Cmpnts ***X, PetscInt i, PetscInt j, PetscInt k, PetscReal xi, PetscReal eta, PetscReal zta, Cmpnts *Xp)</div><div class="ttdoc">Public wrapper: map (cell index, ξ,η,ζ) to (x,y,z).</div><div class="ttdef"><b>Definition:</b> <a href="Metric_8c_source.html#l00077">Metric.c:77</a></div></div>
<div class="ttc" id="avariables_8h_html_structParticle"><div class="ttname"><a href="variables_8h.html#structParticle">Particle</a></div><div class="ttdoc">Defines a particle's core properties for Lagrangian tracking.</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00165">variables.h:165</a></div></div>
<div class="ttc" id="awalkingsearch_8h_html_a0b63dfe82e0fdee5c2c3bdd477f9901f"><div class="ttname"><a href="walkingsearch_8h.html#a0b63dfe82e0fdee5c2c3bdd477f9901f">LocateParticleOrFindMigrationTarget_TEST</a></div><div class="ttdeci">PetscErrorCode LocateParticleOrFindMigrationTarget_TEST(UserCtx *user, Particle *particle, ParticleLocationStatus *status_out)</div><div class="ttdoc">Locates a particle's host cell or identifies its migration target using a robust walk search.</div><div class="ttdef"><b>Definition:</b> <a href="walkingsearch_8c_source.html#l01155">walkingsearch.c:1155</a></div></div>
<div class="ttc" id="avariables_8h_html_aecd4cd7f1da07e3f3d6e1fb6cf71a44b"><div class="ttname"><a href="variables_8h.html#aecd4cd7f1da07e3f3d6e1fb6cf71a44b">Particle::PID</a></div><div class="ttdeci">PetscInt64 PID</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00166">variables.h:166</a></div></div>
<div class="ttc" id="aParticleMotion_8c_html_a1050c4075c2fb507d4579008921dd7b6"><div class="ttname"><a href="ParticleMotion_8c.html#a1050c4075c2fb507d4579008921dd7b6">GuessParticleOwnerWithBBox</a></div><div class="ttdeci">PetscErrorCode GuessParticleOwnerWithBBox(UserCtx *user, const Particle *particle, const BoundingBox *bboxlist, PetscMPIInt *guess_rank_out)</div><div class="ttdoc">Provides a fast, heuristic-based guess for a particle's owner rank using bounding boxes.</div><div class="ttdef"><b>Definition:</b> <a href="ParticleMotion_8c_source.html#l01384">ParticleMotion.c:1384</a></div></div>
<div class="ttc" id="avariables_8h_html_a1300c167a3006a58c71fe8759ebf5ef1"><div class="ttname"><a href="variables_8h.html#a1300c167a3006a58c71fe8759ebf5ef1">UserCtx::inletFaceDefined</a></div><div class="ttdeci">PetscBool inletFaceDefined</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00676">variables.h:676</a></div></div>
<div class="ttc" id="alogging_8h_html_ace99f3e207ccb2e46e9b782f9e57732e"><div class="ttname"><a href="logging_8h.html#ace99f3e207ccb2e46e9b782f9e57732e">PROFILE_FUNCTION_BEGIN</a></div><div class="ttdeci">#define PROFILE_FUNCTION_BEGIN</div><div class="ttdoc">Marks the beginning of a profiled code block (typically a function).</div><div class="ttdef"><b>Definition:</b> <a href="logging_8h_source.html#l00722">logging.h:722</a></div></div>
<div class="ttc" id="avariables_8h_html_af031acb43b014d5ac788aa9003491e75"><div class="ttname"><a href="variables_8h.html#af031acb43b014d5ac788aa9003491e75">UserCtx::da</a></div><div class="ttdeci">DM da</div><div class="ttdef"><b>Definition:</b> <a href="variables_8h_source.html#l00663">variables.h:663</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li><li class="navelem"><a class="el" href="ParticleMotion_8h.html">ParticleMotion.h</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
